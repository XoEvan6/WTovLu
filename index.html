<!DOCTYPE html>
<!-- 中文注释：这是整个HTML文档的开始 -->
<html lang="ja">
<!-- 中文注释：上面这行是网页的头部信息区域 -->
<head>
    <!-- 中文注释：设置网页使用UTF-8编码，这是国际通用的标准，可以防止中文乱码 -->
    <meta charset="UTF-8">
    <!-- 中文注释：这是针对手机等移动设备的重要设置，让网页能更好地适应不同大小的屏幕 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- 中文注释：下面这些是专门为苹果iOS设备设置的，当用户把这个网页添加到手机主屏幕时，它看起来会更像一个真正的App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="プラタナス">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/h4y5qkCL/IMG-3987.jpg">

    <!-- 中文注释：这是网页的标题，会显示在浏览器的标签页上 -->
    <title>プラタナス</title>
    
    <!-- 中文注释：下面这些是引用的外部文件，它们提供了图标、地图、字体等功能和样式 -->
    <!-- 中文注释：Font Awesome图标库，提供了你在页面上看到的各种小图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- 中文注释：将地图相关的样式(CSS)和脚本(JS)文件提前到这里加载，确保在使用前它们已经准备就绪 -->
    <!-- 中文注释：Leaflet地图库的样式文件，定义了地图的外观 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- 中文注释：Leaflet地图搜索框插件的样式文件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- 中文注释：Leaflet地图库的核心脚本文件，提供了地图功能 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 中文注释：Leaflet地图搜索框插件的脚本文件 -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- 中文注释：IndexedDB的辅助库，让数据存储操作更简单 -->
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <!-- 中文注释：一个用于农历和公历转换的库 -->
    <script src="https://unpkg.com/solarlunar@2.0.7/solarlunar.min.js"></script>
    <!-- 中文注释：用于“导出为图片”功能的库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- 中文注释：从Google Fonts加载网络字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 【优化】预加载一个包含大量字体的样式表，确保所有字体可选 -->
    <link id="google-fonts-link" href="https://fonts.googleapis.com/css2?family=Anton&family=Baloo+2&family=Bebas+Neue&family=Bitter&family=Caveat&family=Cormorant&family=Dancing+Script&family=EB+Garamond&family=Gochi+Hand&family=Honk&family=Indie+Flower&family=Inconsolata&family=Kalam&family=Kosugi+Maru&family=Lato&family=Lobster&family=Long+Cang&family=Lora&family=LXGW+WenKai&family=M+PLUS+Rounded+1c&family=Ma+Shan+Zheng&family=Merriweather&family=Montserrat&family=Noto+Sans+JP&family=Noto+Sans+KR&family=Noto+Sans+SC&family=Noto+Sans+TC&family=Noto+Serif+SC&family=Nunito&family=Open+Sans&family=Oswald&family=Pacifico&family=Patrick+Hand&family=Permanent+Marker&family=Pixelify+Sans&family=Playfair+Display&family=Poppins&family=Raleway&family=Righteous&family=Roboto+Mono&family=Roboto+Slab&family=Roboto&family=Shadows+Into+Light&family=Smiley+Sans&family=Source+Code+Pro&family=Space+Mono&family=Varela+Round&family=ZCOOL+KuaiLe&family=ZCOOL+KuHei&family=ZCOOL+XiaoWei&family=Zeyada&family=Zhi+Mang+Xing&display=swap" rel="stylesheet">


    <!-- 中文注释：下面是CSS样式部分，它决定了网页的所有外观，比如颜色、布局、大小等 -->
    <style>
        /* 中文注释：CSS样式部分开始 */

        /* 中文注释：定义全局的设计变量，比如颜色、字体等，方便统一修改 */
        :root {
            /* 全局颜色变量 */
            --global-bg: #f0f2f5; /* 全局背景色 */
            --primary-text: #333; /* 主要文字颜色 */
            --secondary-text: #888; /* 次要文字颜色，比如时间戳 */
            --card-bg: #ffffff; /* 卡片背景色 */
            --nav-bg: #ffffff; /* 导航栏背景色 */
            --nav-icon-color: #999; /* 导航栏图标颜色 */
            --nav-icon-active-color: #007aff; /* 导航栏当前选中项的图标颜色 */
            --accent-color: #007aff; /* 强调色，比如按钮、链接 */
            --border-color: #e0e0e0; /* 边框颜色 */
            --diary-header-bg: #f7f7f7; /* 日记卡片头部的背景色 */
            --danger-color: #ff3b30; /* 危险操作颜色，比如删除按钮 */
            --global-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* 全局默认字体 */
            --income-color: #28a745; /* 记账本中“收入”的颜色 */
            --expense-color: #dc3545; /* 记账本中“支出”的颜色 */
        }

        /* 中文注释：黑夜模式下的颜色变量 */
        .dark-mode {
            /* 修正黑夜模式颜色 */
            --global-bg: #000000;
            --primary-text: #f5f5f7;
            --secondary-text: #8e8e93;
            --card-bg: #1c1c1e;
            --nav-bg: #1c1c1e;
            --nav-icon-color: #8e8e93;
            --nav-icon-active-color: var(--accent-color);
            --border-color: #3a3a3c;
            --diary-header-bg: #2c2c2e;
            --danger-color: #ff453a;
            --income-color: #34c759;
            --expense-color: #ff453a;
        }

        /* 中文注释：基础样式重置，清除所有元素的默认边距和内边距，让所有东西从零开始，方便我们自己控制 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* 点击元素时去除手机上的默认高亮效果 */
        }

        /* 中文注释：让html和body元素占满整个屏幕 */
        html, body {
            overflow: hidden; /* 隐藏滚动条，由内部的 content-area 区域来滚动 */
            height: 100%;
            width: 100%;
        }

        /* 中文注释：整个页面的基础样式 */
        body {
            font-family: var(--global-font-family); /* 使用我们定义的全局字体 */
            background-color: var(--theme-global-bg-color, var(--global-bg)); /* 使用主题背景色，如果没有就用默认的 */
            background-image: var(--theme-global-bg-image); /* 使用主题背景图片 */
            background-repeat: no-repeat; /* 背景图不重复 */
            background-size: cover; /* 背景图铺满 */
            background-position: center; /* 背景图居中 */
            color: var(--primary-text); /* 使用主题主文字颜色 */
            transition: background-color 0.3s, color 0.3s; /* 颜色变化时有0.3秒的过渡动画 */
            font-size: 16px; /* 默认字号 */
        }
        /* 中文注释：如果设置了全局背景图，做一些特殊处理 */
        body.has-global-bg-image {
            background-color: transparent !important; /* 背景色设为透明 */
        }
        body.has-global-bg-image .app-container,
        body.has-global-bg-image .content-area {
            background-color: transparent !important; /* 应用容器和内容区的背景也设为透明 */
        }


        /* 中文注释：整个应用的主容器，它是一个垂直排列的弹性盒子 */
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--global-bg);
        }

        /* 中文注释：页面内容区域，它会占据除了顶部和底部导航栏之外的所有空间 */
        .content-area {
            flex-grow: 1; /* 占据所有剩余空间 */
            overflow-y: auto; /* 内容超出时可以垂直滚动 */
            padding-bottom: 60px; /* 底部留出空间，防止被导航栏遮挡 */
            background-color: transparent;
            -webkit-overflow-scrolling: touch; /* 在iOS上实现更平滑的滚动效果 */
        }

        /* 中文注释：每一个功能页面（如日记、我的、日历）的通用样式 */
        .page {
            display: none; /* 默认隐藏 */
            animation: fadeIn 0.3s ease-in-out; /* 出现时有淡入动画 */
            background-color: transparent;
            padding: 15px; /* 页面内边距 */
            padding-top: 85px; /* 顶部留出空间，防止被顶部栏遮挡 */
        }
        
        /* 中文注释：为特定页面设置自定义背景 */
        #diary-page { background-color: var(--theme-diary-page-bg-color); background-image: var(--theme-diary-page-bg-image); }

        /* 中文注释：当前显示的页面的样式 */
        .page.active {
            display: block; /* 设置为块级元素，使其显示出来 */
        }

        /* 中文注释：定义一个名为fadeIn的动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; } /* 从完全透明开始 */
            to { opacity: 1; } /* 到完全不透明结束 */
        }

      
        /* 底部导航栏样式 */
        .bottom-nav {
            position: fixed;
            bottom: 25px; /* 稍微抬高 */
            left: 5%; 
            right: 5%;
            width: 90%; 
            height: 60px;
            background-color: var(--nav-bg);
            border-radius: 35px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            /* 修改这里：四周都有阴影，更凝聚，颜色稍微深一点点 */
            box-shadow: 0 0 8px rgba(0,0,0,0.2); 
            z-index: 100;
            flex-shrink: 0;
            backdrop-filter: blur(10px); /* 增加一点毛玻璃感 */
        }
        .dark-mode .bottom-nav {
            box-shadow: 0 0 6px rgba(255,255,255,0.2);
            background-color: rgba(44, 44, 46, 0.95);
        }
        

        /* 中文注释：底部导航栏里每一个项目的样式 */
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--nav-icon-color); font-size: 12px; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; } /* 图标样式 */
        .nav-item.active { color: var(--nav-icon-active-color); } /* 选中项的样式 */

        /* 中文注释：顶部栏样式 */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px; /* 上下10，左右15 */
            padding-top: 15px; /* 稍微留一点点状态栏空间即可，不用30那么大 */
            background-color: var(--card-bg);
            z-index: 90;
            border-bottom: 1px solid var(--border-color);
            transition: opacity 0.3s;
        }
        
        /* 中文注释：当在“我的”页面或有独立头部的页面时，隐藏这个通用的顶部栏 */
        body.my-page-active .top-bar,
        body.page-with-header .top-bar {
            opacity: 0;
            pointer-events: none; /* 不可点击 */
        }
        .top-bar-title-container { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .top-bar-title { font-size: 24px; font-weight: bold; } /* 标题样式 */
        .top-bar-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; object-fit: cover; flex-shrink: 0; margin-left: 15px; } /* 头像样式 */
        
        /* 中文注释：顶部栏右侧的功能区图标样式 (日记本、搜索) */
        .top-bar-actions { display: flex; align-items: center; gap: 15px; }
        .notebook-icon, .search-icon { cursor: pointer; font-size: 20px; color: var(--primary-text); }
        
        /* 中文注释：搜索框的样式和动画 */
        .search-container { display: flex; align-items: center; width: 0; opacity: 0; transition: width 0.3s, opacity 0.3s; overflow: hidden; }
        .search-container.active { width: calc(100% - 200px); opacity: 1; } /* 激活时展开 */
        #diary-search-input { width: 100%; font-size: 14px; margin-bottom: 0; }

        /* 中文注释：快速日记编辑器的样式 */
        #quick-diary-editor {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        /* 中文注释：编辑器收起时的样式 */
        .editor-collapsed-view { display: flex; align-items: center; cursor: pointer; }
        .editor-collapsed-view img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .editor-collapsed-view span { color: var(--secondary-text); }
        /* 中文注释：编辑器展开时的样式 */
        .editor-expanded-view { display: none; }
        #quick-diary-editor.expanded .editor-collapsed-view { display: none; }
        #quick-diary-editor.expanded .editor-expanded-view { display: block; }
        
        /* 中文注释：富文本编辑工具栏样式 */
        .editor-toolbar {
            display: flex;
            gap: 15px;
            padding: 8px 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .editor-toolbar button {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 5px;
        }
        .editor-toolbar button:hover {
            color: var(--primary-text);
        }

        /* 中文注释：快速日记的文本输入框样式 */
        #quick-diary-textarea { width: 100%; min-height: 100px; border: none; background: transparent; color: var(--primary-text); resize: vertical; font-size: 16px; padding: 0; }
        #quick-diary-textarea:focus { outline: none; } /* 获得焦点时去掉边框 */
        /* 中文注释：编辑器底部的操作区样式 */
        .editor-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .editor-actions .action-buttons { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
        .editor-actions .action-buttons i { font-size: 20px; color: var(--secondary-text); cursor: pointer; }
        .editor-actions .send-btn { background-color: var(--accent-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .editor-actions .send-btn:disabled { background-color: #999; cursor: not-allowed; } /* 发送按钮禁用时的样式 */

        /* 中文注释：日记卡片样式 */
        .diary-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; color: var(--theme-diary-primary-text-color, var(--primary-text)); contain: content; position: relative; }
        .diary-card-header { background-color: var(--diary-header-bg); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; }
        .diary-author { display: flex; align-items: center; }
        .diary-author-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .diary-author-info .name { font-weight: bold; font-size: 16px; color: var(--theme-diary-primary-text-color, var(--primary-text)); }
        .diary-author-info .id { font-size: 12px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); }
        .diary-meta { display: flex; flex-direction: column; align-items: flex-end; }
        .diary-meta .mood-weather { font-size: 12px; text-align: right; margin-top: 4px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); }
        .diary-timestamp { font-size: 12px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); text-align: right; }
        .diary-card-body { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .diary-card-content { line-height: 1.7; white-space: pre-wrap; font-size: 15px; word-break: break-word; color: var(--theme-diary-primary-text-color, var(--primary-text)); }
        /* 中文注释：处理日记内容中的粗体、斜体等格式 */
        .diary-card-content b, .diary-card-content strong { font-weight: bold; }
        .diary-card-content i, .diary-card-content em { font-style: italic; }
        .diary-card-content u { text-decoration: underline; }
        .diary-card-content del, .diary-card-content s { text-decoration: line-through; }
        .diary-card-content a { color: var(--accent-color); text-decoration: none; }
        .diary-card-content a:hover { text-decoration: underline; }
        
        /* 中文注释：置顶图标样式 */
        .pinned-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            color: var(--accent-color);
        }

        /* 中文注释：日记中的图片、视频、音频的网格布局 */
        .diary-media { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; }
        .media-item { width: 100%; height: 100px; position: relative; cursor: pointer; background-color: #eee; border-radius: 8px; overflow: hidden; }
        .dark-mode .media-item { background-color: #333; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
        .media-item .video-play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5); pointer-events: none; }
        .media-item.audio-player { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; }
        .media-item.audio-player i { font-size: 30px; margin-bottom: 10px; color: var(--primary-text); }
        .media-item.audio-player audio { display: block; width: 100%; height: 30px; }

        /* 中文注释：日记卡片底部的页脚UI */
        .diary-card-footer { padding: 8px 15px; font-size: 12px; color: var(--secondary-text); display: flex; justify-content: space-between; align-items: center; }
        .diary-footer-left { display: flex; align-items: center; gap: 10px; }
        .diary-footer-right { display: flex; align-items: center; gap: 18px; }
        .diary-footer-right i { cursor: pointer; font-size: 16px; color: var(--secondary-text); transition: color 0.2s, transform 0.2s; }
        .diary-footer-right .favorite-btn.favorited { color: var(--accent-color); transform: scale(1.2); } /* 收藏按钮激活后的样式 */
        .diary-footer-right .comment-toggle-btn.active { color: var(--accent-color); }

        /* 中文注释：评论区UI */
        .comment-section { padding: 10px 15px; display: none; border-top: 1px solid var(--border-color); }
        .comment-section.active { display: block; }
        .comment-input-area { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .comment-input-area input { flex-grow: 1; margin-bottom: 0; }
        .comment-input-area .send-comment-btn {
            flex-shrink: 0;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }
        .view-more-comments { color: var(--accent-color); cursor: pointer; font-size: 14px; margin-top: 10px; }
        .comment { display: flex; margin-top: 10px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .comment-body { flex-grow: 1; }
        .comment-header { font-size: 12px; color: var(--secondary-text); margin-bottom: 4px; }
        .comment-header .id { font-weight: bold; color: var(--primary-text); }
        .comment-content { font-size: 14px; word-break: break-word; color: var(--primary-text); }

        /* 中文注释：模态框/弹窗的通用样式 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); width: 90%; max-width: 500px; border-radius: 15px; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { font-size: 20px; font-weight: bold; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; background-color: var(--global-bg); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }
        .dark-mode .modal-footer { background-color: var(--card-bg); }

        /* 中文注释：自定义的确认/输入/菜单弹窗样式 */
        .custom-modal-content { text-align: center; padding: 30px 20px; max-width: 340px; }
        .custom-modal-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .custom-modal-message { font-size: 14px; color: var(--secondary-text); margin-bottom: 20px; padding: 0; }
        .custom-modal-input { margin: 0 0 20px; }
        .custom-modal-footer { display: flex; border-top: 1px solid var(--border-color); padding: 0; margin: 0 -20px -30px; }
        .custom-modal-footer button { flex: 1; background: transparent; border: none; padding: 15px; font-size: 16px; cursor: pointer; }
        .custom-modal-footer button:first-child { border-right: 1px solid var(--border-color); color: var(--secondary-text); }
        .custom-modal-footer button.confirm-ok { color: var(--accent-color); font-weight: bold; }
        .action-menu-modal .menu-section { margin: -20px; }

        /* 中文注释：表单元素（输入框、选择框等）的通用样式 */
        textarea, input[type="text"], input[type="password"], input[type="datetime-local"], input[type="date"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--global-bg); color: var(--primary-text); font-size: 16px; margin-bottom: 10px; }
        .dark-mode textarea, .dark-mode input[type="text"], .dark-mode input[type="password"], .dark-mode input[type="datetime-local"], .dark-mode input[type="date"], .dark-mode input[type="number"], .dark-mode select { background-color: #333; color: var(--primary-text); border-color: #444; }
        textarea { min-height: 150px; resize: vertical; }
        .button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 10px; }
        .button-primary { background-color: var(--accent-color); color: white; }
        .button-secondary { background-color: var(--border-color); color: var(--primary-text); }
        
        /* 中文注释："我的" 页面样式 */
        #my-page { padding: 0; padding-top: 0; }
        #my-page .profile-header { position: relative; height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); padding-top: 50px; margin-bottom: -30px; }
        #my-page .profile-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        #my-page .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); object-fit: cover; margin-bottom: 10px; }
        #my-page .profile-info-wrapper { text-align: center; position: relative; }
        #my-page .profile-name { font-size: 22px; font-weight: bold; }
        #my-page .profile-id { font-size: 13px; background-color: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; margin-top: 5px; }
        #my-page .profile-bio { font-size: 14px; margin-top: 8px; }
        #my-page .profile-stats { display: flex; justify-content: space-around; padding: 20px; background-color: var(--card-bg); margin: 0 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; z-index: 1; }
        .stat-item { text-align: center; }
        .stat-item .count { font-size: 20px; font-weight: bold; }
        .stat-item .label { font-size: 12px; color: var(--secondary-text); }
        #my-page-content { padding: 15px; }

        /* 中文注释：从右侧滑出的侧边功能菜单样式 */
        .side-menu { position: fixed; top: 0; right: -100%; width: 80%; max-width: 320px; height: 100%; background-color: var(--global-bg); box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1001; transition: right 0.3s ease-in-out; padding: 20px; padding-top: 50px; overflow-y: auto; }
        .side-menu.active { right: 0; }
        .side-menu-header { display: flex; align-items: center; margin-bottom: 30px; }
        .side-menu-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .side-menu-info .name { font-size: 18px; font-weight: bold; }
        .side-menu-info .bio { font-size: 14px; color: var(--secondary-text); }
        .menu-section { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .menu-item { display: flex; align-items: center; padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .menu-item:last-child { border-bottom: none; }
        .menu-item i { width: 20px; margin-right: 15px; color: var(--secondary-text); text-align: center; }
        .menu-item svg { width: 20px; height: 20px; margin-right: 15px; fill: currentColor; color: var(--secondary-text); }
        
        /* 中文注释：日记本选择的悬浮弹窗样式 */
        .notebook-popup {
            position: absolute;
            top: 75px;
            right: 60px;
            width: 280px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 95;
            padding: 10px;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        .notebook-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5px 10px 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .notebook-popup-header h3 { font-size: 16px; margin: 0; }
        #add-notebook-popup-btn { background: none; border: none; color: var(--accent-color); font-size: 22px; cursor: pointer; }
        .notebook-popup-list { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 5px 5px 5px; max-height: 200px; overflow-y: auto; }
        .notebook-popup-item { width: 55px; height: 80px; border-radius: 4px; background-color: #e9e9e9; cursor: pointer; position: relative; display: flex; align-items: flex-end; padding: 8px 5px; overflow: hidden; border: 2px solid transparent; transition: border-color 0.2s; }
        .dark-mode .notebook-popup-item { background-color: #3a3a3c; }
        .notebook-popup-item.active { border-color: var(--accent-color); }
        .notebook-popup-item-cover { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        /* 修改后的代码 */
        .notebook-popup-item-name { 
            position: relative; 
            z-index: 2; 
            color: white; 
            font-size: 14px; /* 字号稍微改大一点点 */
            font-weight: bold; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.7); 
            writing-mode: vertical-rl; /* 竖排模式 */
            text-orientation: upright; /* 让文字直立，不倒下 */
            white-space: nowrap; 
            /* transform: rotate(180deg); 已删除 */
            margin-left: auto; 
            margin-right: auto; 
            letter-spacing: 2px; /* 增加一点字间距 */
        }
        .notebook-popup-item-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%); z-index: 1; }


        /* 中文注释：地图页面样式 */
        #map-page { padding: 0; height: 100vh; position: relative; }
        #map { width: 100%; height: 100%; z-index: 400; }
        #map-back-btn { position: absolute; top: 80px; right: 15px; left: auto; z-index: 401; background: rgba(255,255,255,0.8); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .dark-mode #map-back-btn { background: rgba(30,30,30,0.8); color: white; }
        #map-selection-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 401;
            background-color: var(--card-bg);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        /* 中文注释：确保地图搜索框在深色模式下也清晰可见 */
        .leaflet-control-geocoder { z-index: 402 !important; }
        .leaflet-control-geocoder-form input {
            background-color: var(--card-bg) !important;
            color: var(--primary-text) !important;
            border: 1px solid var(--border-color) !important;
        }
        .leaflet-control-geocoder-alternatives {
            background-color: var(--card-bg) !important;
        }
        .leaflet-control-geocoder-alternatives a {
            color: var(--primary-text) !important;
        }
        .leaflet-control-geocoder-alternatives a:hover {
            background-color: var(--global-bg) !important;
        }

        /* 中文注释：遮罩层样式，用于弹出侧边栏时覆盖主页面 */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1000; display: none; }
        .overlay.active { display: block; }
        
        /* 中文注释：日历样式 */
        .calendar-container { background-color: var(--card-bg); border-radius: 12px; padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 18px; font-weight: bold; }
        .calendar-toggles-container { font-size: 12px; display: flex; align-items: center; gap: 15px; font-weight: normal; margin-bottom: 15px; justify-content: flex-end; }
        .calendar-toggles-container > div { display: flex; align-items: center; gap: 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .calendar-weekday { padding: 5px 0; font-size: 14px; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 38px; }
        .calendar-weekday { color: var(--secondary-text); font-weight: bold; }
        .calendar-day { cursor: pointer; position: relative; border-radius: 50%; }
        .calendar-day.other-month { color: var(--secondary-text); opacity: 0.5; }
        .calendar-day.today { background-color: var(--accent-color); color: white; }
        .calendar-day.today .lunar-date { color: white; }
        .calendar-day.selected { border: 2px solid var(--accent-color); }
        
        /* 修改后的：日记数量数字样式 */
        .calendar-diary-count {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px; /* 字号很小 */
            font-weight: bold;
            color: var(--accent-color);
            line-height: 1;
        }
        .calendar-day.is-holiday::before { content: '●'; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--danger-color); } /* 节假日上面有个小点 */
        .dark-mode .calendar-day.today { color: var(--primary-text); }
        .lunar-date { font-size: 10px; color: var(--secondary-text); }
        .lunar-date.is-festival { color: var(--danger-color); font-weight: bold; }
        #selected-date-info { text-align: center; margin-top: 15px; padding: 10px; background-color: var(--card-bg); border-radius: 8px; font-size: 14px; color: var(--danger-color); font-weight: bold; }

        /* 中文注释：图片/视频全屏查看器样式 */
        #media-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #media-viewer img, #media-viewer video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        /* 修改后的代码 */
        #media-viewer-close {
            position: absolute;
            top: 50px; /* 稍微往下挪一点，避开刘海屏 */
            right: 20px;
            font-size: 24px;
            color: white;
            cursor: pointer;
            z-index: 2001;
            /* 下面是新增的样式，让它变成一个黑底圆圈 */
            background-color: rgba(0, 0, 0, 0.6);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        /* 中文注释：通用的页面头部样式（用于收藏、设置等页面） */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 15px;
            padding-top: 30px;
            background-color: var(--card-bg);
            z-index: 90;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header .back-btn {
            font-size: 20px;
            cursor: pointer;
            width: 40px;
        }
        .page-header .title {
            flex-grow: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-right: 40px; /* 为右侧按钮留出空间 */
        }
        .page-header .actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            padding-top: 15px; /* 适配padding-top */
        }
        .page-header .actions .action-btn {
            font-size: 20px;
            color: var(--primary-text);
            cursor: pointer;
        }
        
        /* 中文注释：收藏、字体、主题等带头部的页面专属样式 */
        #favorites-page, #font-settings-page, #theme-settings-page, #anniversary-page, #accounting-page, #snippets-page, #games-page { padding: 0; }
        #favorites-list-container, #font-settings-content, .page-content {
            padding: 15px;
            padding-top: 85px; /* 85px = 70px header + 15px padding */
        }
        
        /* 中文注释：字体预设相关样式 */
        .font-url-container { display: flex; align-items: center; gap: 10px; }
        .font-url-container input { flex-grow: 1; margin: 0 !important; }
        .font-url-container .button { margin-left: 0; flex-shrink: 0; }
        .delete-preset-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .delete-preset-item:last-child { border-bottom: none; }
        .delete-preset-item button { background-color: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }

        /* 中文注释：纪念日页面样式 */
        .anniversary-item { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        .anniversary-item .pinned-icon { top: 15px; left: 15px; }
        .anniversary-item-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.3);
            z-index: 1;
            display: none;
        }
        .anniversary-item.has-background .anniversary-item-overlay { display: block; }
        .anniversary-item.has-background .anniversary-info,
        .anniversary-item.has-background .anniversary-days,
        .anniversary-item.has-background .pinned-icon {
            position: relative;
            z-index: 2;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .anniversary-info .name { font-size: 18px; font-weight: bold; }
        .anniversary-info .date { font-size: 12px; color: var(--secondary-text); }
        .anniversary-item.has-background .anniversary-info .date { color: rgba(255,255,255,0.8); }
        .anniversary-days .count { font-size: 24px; font-weight: bold; color: var(--accent-color); }
        .anniversary-item.has-background .anniversary-days .count { color: white; }
        .anniversary-days .label { font-size: 12px; color: var(--secondary-text); text-align: right; }
        .anniversary-item.has-background .anniversary-days .label { color: rgba(255,255,255,0.8); }

        /* 中文注释：记账本页面样式 */
        .accounting-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .accounting-controls .view-toggle {
            display: flex;
            background-color: var(--global-bg);
            border-radius: 6px;
            padding: 2px;
        }
        .accounting-controls .view-toggle button {
            padding: 5px 10px;
            border: none;
            background: transparent;
            color: var(--secondary-text);
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
        }
        .accounting-controls .view-toggle button.active {
            background-color: var(--card-bg);
            color: var(--primary-text);
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .accounting-controls .date-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .accounting-controls .date-nav button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--primary-text);
        }
        .accounting-controls .date-nav #accounting-current-period {
            font-weight: bold;
            font-size: 16px;
        }

        .accounting-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .summary-card { background-color: var(--card-bg); border-radius: 12px; padding: 15px; text-align: center; }
        .summary-card .label { font-size: 14px; color: var(--secondary-text); }
        .summary-card .amount { font-size: 22px; font-weight: bold; margin-top: 5px; }
        .summary-card .amount.income { color: var(--income-color); }
        .summary-card .amount.expense { color: var(--expense-color); }
        .summary-card.balance .amount { color: var(--primary-text); }
        .accounting-summary .summary-card:nth-child(3) { grid-column: span 2; }
        .transaction-group { margin-bottom: 15px; }
        .transaction-group-header {
            font-size: 14px;
            font-weight: bold;
            color: var(--secondary-text);
            padding: 5px 15px;
            background-color: var(--global-bg);
            border-radius: 6px;
            margin-bottom: 5px;
        }
        .transaction-item { background-color: var(--card-bg); border-radius: 8px; padding: 10px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .transaction-info .desc { font-size: 16px; }
        .transaction-info .date { font-size: 12px; color: var(--secondary-text); }
        .transaction-amount.income { color: var(--income-color); font-weight: bold; }
        .transaction-amount.expense { color: var(--expense-color); font-weight: bold; }

        /* 中文注释：言语集页面样式 */
        .snippet-collection { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .snippet-collection-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1;
            display: none;
        }
        .snippet-collection.has-background .snippet-collection-overlay { display: block; }
        /* 修改后的代码 */
        .snippet-collection.has-background .snippet-collection-header,
        .snippet-collection.has-background .snippet-item,
        .snippet-collection.has-background .snippet-collection-body, /* 新增了这一行 */
        .snippet-collection.has-background .add-snippet-form {
            position: relative;
            z-index: 2;
            color: white;
            border-color: rgba(255,255,255,0.2) !important;
        }
        .snippet-collection.has-background .snippet-collection-header h3,
        .snippet-collection.has-background .snippet-collection-header i,
        .snippet-collection.has-background .snippet-item .timestamp {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .snippet-collection-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .snippet-collection-header h3 { margin: 0; }
        .snippet-collection-header .actions { display: flex; align-items: center; gap: 15px; }
        .snippet-collection-header .actions i { color: var(--secondary-text); transition: transform 0.3s; }
        .snippet-collection.expanded .snippet-collection-header .actions i { transform: rotate(180deg); }
        .snippet-collection-body { padding: 0 15px 15px; display: none; }
        .snippet-collection.expanded .snippet-collection-body { display: block; }
        .snippet-item { border-top: 1px solid var(--border-color); padding: 10px 0; display: flex; align-items: center; gap: 10px; }
        .snippet-item .content { white-space: pre-wrap; word-break: break-word; flex-grow: 1; }
        .snippet-item .timestamp { font-size: 12px; color: var(--secondary-text); margin-top: 5px; text-align: right; }
        .add-snippet-form {
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .add-snippet-form textarea {
            min-height: 60px;
            margin-bottom: 10px;
        }
        .add-snippet-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .add-snippet-form-actions .button {
            margin-left: 0;
            padding: 5px 15px;
        }
        /* 中文注释：言语集管理模式样式 */
        .snippet-delete-checkbox { display: none; }
        .snippet-collection.manage-mode .snippet-delete-checkbox { display: inline-block; }
        .snippet-collection.manage-mode .add-snippet-btn-container { display: none; }
        .snippet-collection-manage-header { display: none; padding: 15px; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .snippet-collection.manage-mode .snippet-collection-header { display: none; }
        .snippet-collection.manage-mode .snippet-collection-manage-header { display: flex; }
        
        /* ======================================================================= */
        /* 中文注释：小游戏页面样式 */
        /* ======================================================================= */
        .game-selection-menu {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .game-selection-menu .button {
            margin-left: 0;
            flex-basis: 100px;
            flex-grow: 1;
        }
        .game-container {
            display: none;
            flex-direction: column;
            align-items: center;
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 10px;
        }
        .game-container.active {
            display: flex;
        }
        .game-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        .game-controls select, .game-controls .button {
            width: auto;
            margin-bottom: 0;
            flex-shrink: 0;
        }
        .game-status {
            font-weight: bold;
            font-size: 16px;
            min-height: 24px;
            text-align: center;
            width: 100%;
            margin-bottom: 10px;
        }

        /* 井字棋样式 */
        #tictactoe-board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; width: 240px; height: 240px; background-color: var(--primary-text); padding: 5px; border-radius: 5px; }
        .tictactoe-cell { background-color: var(--card-bg); cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 48px; font-weight: bold; }
        .tictactoe-cell:hover { background-color: var(--global-bg); }

        /* 五子棋样式 */
        #gobang-board { display: grid; grid-template-columns: repeat(15, 1fr); border: 2px solid var(--primary-text); width: 100%; max-width: 450px; aspect-ratio: 1 / 1; background-color: #e3b778; position: relative; }
        .dark-mode #gobang-board { background-color: #6a5638; }
        .gobang-cell { position: relative; width: 100%; height: 100%; cursor: pointer; }
        .gobang-cell::before, .gobang-cell::after { content: ''; position: absolute; background-color: var(--primary-text); pointer-events: none; }
        .gobang-cell::before { width: 100%; height: 1px; top: 50%; left: 0; transform: translateY(-50%); }
        .gobang-cell::after { width: 1px; height: 100%; left: 50%; top: 0; transform: translateX(-50%); }
        .gobang-piece { position: absolute; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 1px 1px 3px rgba(0,0,0,0.4); pointer-events: none; }
        .gobang-piece.black { background: radial-gradient(circle at 30% 30%, #555, #000); }
        .gobang-piece.white { background: radial-gradient(circle at 30% 30%, #fff, #ccc); }

        /* 扫雷样式 */
        #minesweeper-grid { display: grid; gap: 1px; background-color: var(--border-color); border: 1px solid var(--border-color); }
        .minesweeper-cell { width: 25px; height: 25px; background-color: #bdbdbd; font-size: 14px; font-weight: bold; display: flex; justify-content: center; align-items: center; cursor: pointer; user-select: none; }
        .dark-mode .minesweeper-cell { background-color: #424242; }
        .minesweeper-cell.revealed { background-color: #e0e0e0; }
        .dark-mode .minesweeper-cell.revealed { background-color: #212121; }
        .minesweeper-cell.mine { background-color: var(--danger-color); }
        .minesweeper-cell[data-mines="1"] { color: #007aff; } .minesweeper-cell[data-mines="2"] { color: #34c759; } .minesweeper-cell[data-mines="3"] { color: #ff453a; } .minesweeper-cell[data-mines="4"] { color: #5856d6; } .minesweeper-cell[data-mines="5"] { color: #ff9500; } .minesweeper-cell[data-mines="6"] { color: #5ac8fa; } .minesweeper-cell[data-mines="7"] { color: #ff2d55; } .minesweeper-cell[data-mines="8"] { color: #af52de; }

        /* 贪吃蛇 & 俄罗斯方块 & 星球保卫战 共用方向盘/按键样式 */
        .dpad-container { display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 10px; margin-top: 20px; }
        .button-layout-container { display: flex; gap: 10px; margin-top: 20px; }
        .dpad-btn { width: 50px; height: 50px; background-color: var(--secondary-text); border-radius: 50%; color: white; font-size: 24px; border: none; display: flex; justify-content: center; align-items: center; }
        .dpad-btn:active { background-color: var(--primary-text); }
        .dpad-btn[data-dir="up"] { grid-area: up; } .dpad-btn[data-dir="down"] { grid-area: down; } .dpad-btn[data-dir="left"] { grid-area: left; } .dpad-btn[data-dir="right"] { grid-area: right; }

        /* 贪吃蛇样式 */
        #snake-canvas { border: 2px solid var(--primary-text); max-width: 100%; background-image: linear-gradient(var(--border-color) 1px, transparent 1px), linear-gradient(to right, var(--border-color) 1px, transparent 1px); background-size: 20px 20px; background-color: #c7fec7; }
        .dark-mode #snake-canvas { background-color: #0b2e0b; }
        
        /* 俄罗斯方块样式 */
        .tetris-layout { display: flex; justify-content: center; align-items: flex-start; gap: 15px; width: 100%; flex-wrap: wrap; }
        #tetris-canvas { background-color: #1a1a1a; border: 2px solid var(--primary-text); }
        .tetris-side-panel { display: flex; flex-direction: column; gap: 10px; }
        .tetris-next-piece { background: #1a1a1a; padding: 5px; border-radius: 5px; border: 1px solid var(--primary-text); }
        
        /* 2048 样式 */
        #game2048-board { width: 100%; max-width: 450px; aspect-ratio: 1 / 1; background-color: #bbada0; border-radius: 6px; display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr); gap: 10px; padding: 10px; position: relative; }
        .game2048-cell { background-color: #cdc1b4; border-radius: 3px; }
        .game2048-tile { position: absolute; border-radius: 3px; font-weight: bold; display: flex; justify-content: center; align-items: center; transition: all 0.1s ease-in-out; }
        .game2048-tile[data-value="2"] { background: #eee4da; color: #776e65; } .game2048-tile[data-value="4"] { background: #ede0c8; color: #776e65; } .game2048-tile[data-value="8"] { background: #f2b179; color: #f9f6f2; } .game2048-tile[data-value="16"] { background: #f59563; color: #f9f6f2; } .game2048-tile[data-value="32"] { background: #f67c5f; color: #f9f6f2; } .game2048-tile[data-value="64"] { background: #f65e3b; color: #f9f6f2; } .game2048-tile[data-value="128"] { background: #edcf72; color: #f9f6f2; } .game2048-tile[data-value="256"] { background: #edcc61; color: #f9f6f2; } .game2048-tile[data-value="512"] { background: #edc850; color: #f9f6f2; } .game2048-tile[data-value="1024"] { background: #edc53f; color: #f9f6f2; } .game2048-tile[data-value="2048"] { background: #edc22e; color: #f9f6f2; }
        
        /* 21点 (Blackjack) 样式 */
        #blackjack-table { width: 100%; max-width: 450px; background-color: #006400; border: 5px solid #8B4513; border-radius: 12px; padding: 15px; display: flex; flex-direction: column; gap: 20px; }
        .blackjack-hand { display: flex; min-height: 90px; }
        .blackjack-hand .blackjack-card { margin-left: -30px; }
        .blackjack-hand .blackjack-card:first-child { margin-left: 0; }
        .blackjack-card { width: 60px; height: 90px; background-color: white; border: 1px solid black; border-radius: 5px; position: relative; box-shadow: 2px 2px 5px rgba(0,0,0,0.3); font-size: 20px; font-weight: bold; }
        .blackjack-card.hidden { background-image: repeating-linear-gradient(45deg, #6ca0fc, #6ca0fc 10px, #4c88ed 10px, #4c88ed 20px); }
        .blackjack-card span { position: absolute; }
        .blackjack-card .rank { top: 5px; left: 5px; }
        .blackjack-card .suit { bottom: 5px; right: 5px; font-size: 24px; }
        .blackjack-card.red { color: red; } .blackjack-card.black { color: black; }
        .blackjack-area h4 { color: white; text-shadow: 1px 1px 2px black; }

        /* 数独 (Sudoku) 样式 */
        #sudoku-board { display: grid; grid-template-columns: repeat(9, 1fr); border: 2px solid var(--primary-text); width: 100%; max-width: 450px; aspect-ratio: 1 / 1; }
        .sudoku-row { display: contents; } /* Make row a non-visual grid element */
        .sudoku-cell { display: flex; justify-content: center; align-items: center; border: 1px solid var(--border-color); font-size: clamp(16px, 4vw, 24px); cursor: pointer; aspect-ratio: 1 / 1; }
        .sudoku-cell:nth-child(3n) { border-right-width: 2px; border-right-color: var(--primary-text); }
        #sudoku-board .sudoku-row:nth-child(3n) .sudoku-cell { border-bottom-width: 2px; border-bottom-color: var(--primary-text); }
        .sudoku-cell.selected { background-color: var(--accent-color) !important; color: white !important; }
        .sudoku-cell.given { font-weight: bold; background-color: var(--global-bg); color: var(--secondary-text); cursor: not-allowed; }
        .sudoku-cell.error { color: var(--danger-color) !important; background-color: #ff3b3020 !important; }
        #sudoku-numpad { display: flex; gap: 5px; margin-top: 10px; flex-wrap: wrap; justify-content: center; }
        #sudoku-numpad button { flex-basis: 35px; font-size: 18px; padding: 10px 5px; }

        /* 星球保卫战 & 是人就下100层 样式 */
        .fullscreen-canvas-container { width: 100%; max-width: 450px; aspect-ratio: 3 / 4; }
        #planetdefender-canvas, #doodlejump-canvas { background-color: #000; border: 2px solid var(--primary-text); width: 100%; height: 100%; }
        
        /* 点灯游戏 样式 */
        #lightsout-grid { display: grid; gap: 5px; padding: 5px; background-color: var(--primary-text); border-radius: 5px; }
        .lightsout-cell { aspect-ratio: 1 / 1; border-radius: 50%; cursor: pointer; transition: background-color 0.2s; }
        .lightsout-cell.on { background-color: #fdd835; box-shadow: 0 0 10px #fdd835; }
        .lightsout-cell.off { background-color: #424242; }
        
        /* === 新增：言语集网格模式（书架） === */
        .snippet-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 一行三个，类似图三 */
            gap: 15px;
            padding: 10px;
        }
        .snippet-book-card {
            aspect-ratio: 2 / 3; /* 长方形比例 */
            background-color: #e0e0e0;
            border-radius: 8px;
            position: relative;
            cursor: pointer;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .snippet-book-card:active { transform: scale(0.95); }
        .snippet-book-cover {
            width: 100%; height: 100%; object-fit: cover;
            position: absolute; top:0; left:0; z-index: 1;
        }
        .snippet-book-info {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 5px;
            background: rgba(0,0,0,0.5);
            color: white; font-size: 12px; text-align: center;
            z-index: 2;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        
        /* === 新增：言语集详情页（新的独立页面） === */
        #snippet-detail-page {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--global-bg);
            z-index: 200; /* 盖住其他页面 */
            flex-direction: column;
            background-size: cover; background-position: center;
        }
        #snippet-detail-page.active { display: flex; }
        /* 1. 修复背景遮罩太厚导致纹理看不清的问题 */
        .snippet-detail-overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            /* 把透明度从 0.85 改为 0.2，让背景纹理能透出来 */
            background-color: rgba(255,255,255,0.2); 
            z-index: -1;
            backdrop-filter: blur(5px); /* 加一点毛玻璃让字看清 */
        }
        .dark-mode .snippet-detail-overlay { 
            background-color: rgba(0,0,0,0.4); 
        }
        
        .snippet-detail-header {
            height: 60px; padding: 0 15px; display: flex; align-items: center; justify-content: space-between;
            background: transparent; flex-shrink: 0; padding-top: 10px;
        }
        /* 2. 列表容器设置，确保能滑动 */
        .snippet-detail-body {
            flex-grow: 1; 
            overflow-y: auto; /* 允许滑动 */
            padding: 15px 10px; 
            padding-bottom: 90px; /* 底部留够空间给输入框 */
            -webkit-overflow-scrolling: touch; /* 丝滑滚动 */
        }
        
        /* 言语集底部悬浮输入栏 */
        /* === 修复后的底部输入栏样式 === */
        .snippet-input-bar {
            position: fixed;
            bottom: 30px;
            left: 5%;
            width: 90%;
            height: 60px; /*稍微加高一点，不那么挤*/
            background-color: var(--card-bg); /* 外层容器背景 */
            border-radius: 30px; /* 大圆角 */
            padding: 0 10px 0 15px; /* 调整内边距 */
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 210;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        /* 修复输入框是方形的问题 */
        .snippet-input-bar input {
            flex-grow: 1;
            height: 40px; /* 固定高度 */
            background-color: var(--global-bg); /* 输入框背景色，与卡片区分 */
            border: none;
            border-radius: 20px; /* 关键：给输入框本身加圆角 */
            padding: 0 15px; /* 文字内边距 */
            font-size: 15px;
            margin-bottom: 0; /* 消除默认边距 */
            outline: none; /* 去除点击时的蓝框 */
        }
        
        .snippet-input-bar .send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-color); /* 发送按钮背景色，比如蓝色 */
            color: white; /* 图标颜色 */
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0; /* 防止被挤扁 */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* 按钮加点阴影 */
        }

        /* === 修复后的言语列表样式 (纯圆润风) === */
        /* 3. 新版言语条目：横向排列 */
        /* 1. 列表条目：强制移除横线 */
        .snippet-item {
            display: flex;
            align-items: center; /* 垂直居中 */
            margin-bottom: 15px; /* 增加一点间距 */
            width: 100%;
            padding: 0 5px;
            position: relative;
            border: none !important; /* 【关键】强制去掉所有边框/横线 */
        }

        /* 2. 爱心图标：圆形包裹 + 颜色适配 */
        .snippet-heart-icon {
            /* 固定大小形成正圆 */
            width: 44px; 
            height: 44px;
            border-radius: 50%; /* 圆形 */
            
            /* 让图标在圆里居中 */
            display: flex;
            align-items: center;
            justify-content: center;
            
            margin-right: 8px; /* 与右边气泡的间距 */
            flex-shrink: 0; /* 防止被挤扁 */
            
            /* 样式设置 */
            font-size: 18px; /* 爱心大小 */
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); /* 淡淡的阴影，和气泡一致 */
            
            /* 【白天模式】 */
            background-color: var(--card-bg); /* 背景色：跟随气泡（卡片背景） */
            color: black; /* 爱心颜色：黑色 */
        }

        /* 【黑夜模式适配】 */
        .dark-mode .snippet-heart-icon {
            background-color: rgba(44, 44, 46, 0.8); /* 背景色：跟随黑夜气泡 */
            color: white; /* 爱心颜色：白色 */
        }

        /* 长条胶囊背景 */
        .snippet-bubble {
            flex-grow: 1; /* 占满剩余宽度 */
            background-color: var(--card-bg);
            border-radius: 50px; /* 椭圆胶囊形状 */
            padding: 12px 20px;
            display: flex;
            justify-content: space-between; /* 内容靠左，时间靠右 */
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05); /* 淡淡的阴影 */
            min-height: 48px;
        }
        .dark-mode .snippet-bubble {
            background-color: rgba(44, 44, 46, 0.8);
        }

        /* 文字内容 */
        .snippet-content-text {
            font-size: 15px;
            color: var(--primary-text);
            line-height: 1.4;
            margin-right: 10px;
            word-break: break-word;
        }

        /* 时间样式 - 在最右边，字小 */
        .snippet-time-tag {
            font-size: 11px; /* 字小一点 */
            color: var(--secondary-text);
            flex-shrink: 0; /* 防止时间被挤压 */
            white-space: nowrap;
        }

        /* 批量选择框样式修正 */
        .snippet-select-checkbox {
            display: none;
            margin-right: 10px;
            width: 20px; height: 20px;
        }
        .snippet-item.select-mode .snippet-select-checkbox { display: block; }
        

        /* 批量管理时的样式 */
        .snippet-item.select-mode {
            flex-direction: row;
            align-items: center;
        }
        .snippet-item.select-mode .snippet-select-checkbox {
            margin-right: 10px;
            display: block;
            position: static;
            transform: none;
        }
        
        /* 纪念日颜色选择器美化 */
        .ann-color-swatch {
            width: 30px; height: 30px; border-radius: 50%; 
            display: inline-block; cursor: pointer;
            border: 2px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .ann-color-swatch.selected { border-color: var(--primary-text); transform: scale(1.1); }
        
        
        /* === 纪念日新样式 (仿DaysMatter) === */
        /* 列表项样式 */
        .dm-list-item {
            background-color: var(--card-bg);
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            height: 60px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
        }
        .dm-list-strip { width: 10px; height: 100%; flex-shrink: 0; } /* 左侧颜色条 */
        .dm-list-content { flex-grow: 1; padding: 0 15px; display: flex; align-items: center; justify-content: space-between; }
        .dm-list-name { font-size: 16px; font-weight: bold; }
        .dm-list-days { font-size: 20px; font-weight: bold; padding: 5px 10px; border-radius: 5px; background: rgba(0,0,0,0.05); color: var(--primary-text); }
        .dm-list-days.blue { color: #007aff; }
        .dm-list-days.orange { color: #ff9500; }
        .dm-list-days.red { color: #ff3b30; }

        /* 置顶大卡片样式 */
        .dm-pinned-card {
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            position: relative;
            min-height: 160px;
            display: flex; flex-direction: column;
        }
        .dm-header { padding: 10px 15px; font-size: 14px; background: rgba(0,0,0,0.1); display: flex; justify-content: space-between; }
        .dm-body { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .dm-days-big { font-size: 60px; font-weight: bold; line-height: 1; }
        .dm-label { font-size: 16px; margin-top: 5px; opacity: 0.9; }
        .dm-footer { padding: 10px 15px; font-size: 13px; background: rgba(0,0,0,0.1); text-align: center; }

        /* === 纪念日详情页 (高级版) === */
        #anniversary-detail-page {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--global-bg);
            z-index: 200; flex-direction: column;
            background-size: cover; background-position: center;
        }
        #anniversary-detail-page.active { display: flex; }
        
        /* 页面背景遮罩 */
        #anniversary-page-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; background-size: cover; background-position: center;
        }
        
        /* 详情页卡片容器 - 居中偏上 */
        #anniversary-detail-content {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; /* 改为从上开始 */
            padding-top: 10vh; /* 距离顶部 10% 的高度 */
            overflow-y: auto;
            padding-bottom: 50px;
        }

        /* 核心大卡片 */
        .dm-detail-card {
            width: 85%;
            max-width: 350px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            display: flex; flex-direction: column;
            background-color: transparent; /* 背景由内部决定 */
            position: relative;
            flex-shrink: 0; /* 防止被压缩 */
        }
        
        /* 纸张堆叠效果 (底部) */
        .dm-paper-stack {
            height: 12px;
            background-color: #f0f0f0;
            border-top: 1px solid #ddd;
            position: relative;
            background-image: repeating-linear-gradient(to right, #f0f0f0, #f0f0f0 10px, #e0e0e0 10px, #e0e0e0 11px);
        }
        .dark-mode .dm-paper-stack {
            background-color: #2c2c2e; border-top: 1px solid #444;
            background-image: repeating-linear-gradient(to right, #2c2c2e, #2c2c2e 10px, #3a3a3c 10px, #3a3a3c 11px);
        }

        /* 头部和身体区域 */
        .dm-detail-header-area { padding: 20px 20px 15px; color: white; min-height: 80px; position: relative; }
        .dm-detail-body-area { 
            padding: 40px 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background-color: white; color: #333; 
            position: relative; flex-grow: 1; cursor: pointer; 
            min-height: 200px;
            background-size: cover; background-position: center;
        }
        .dark-mode .dm-detail-body-area { background-color: #1c1c1e; color: white; }

        /* === 纹理库 === */
        .dm-tex-flat { }
        .dm-tex-polka { background-image: radial-gradient(rgba(255,255,255,0.15) 15%, transparent 16%); background-size: 20px 20px; }
        .dm-tex-stripe { background-image: linear-gradient(45deg, rgba(255,255,255,0.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.1) 75%, transparent 75%, transparent); background-size: 20px 20px; }
        .dm-tex-grid { background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 20px 20px; }
        .dm-tex-wave { background: repeating-radial-gradient(circle at 0 0, transparent 0, rgba(255,255,255,0.05) 10px), repeating-linear-gradient(rgba(255,255,255,0.05), rgba(255,255,255,0.05)); }
        
        /* 列表视图样式 (仿DaysMatter列表) */
        .dm-milestone-list {
            background-color: white;
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            font-size: 14px;
        }
        .dark-mode .dm-milestone-list { background-color: #1c1c1e; }
        .dm-milestone-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark-mode .dm-milestone-item { border-bottom: 1px solid rgba(255,255,255,0.05); }
        .dm-ms-label { color: var(--secondary-text); }
        .dm-ms-value { font-weight: bold; font-size: 16px; color: var(--accent-color); }
        .dm-ms-date { font-size: 12px; color: #999; margin-top: 2px; }

        /* 修复模态框滚动问题 */
        .modal-body { overflow-y: auto; max-height: 70vh; -webkit-overflow-scrolling: touch; }
        
        /* 设置项分组 */
        .setting-group { background: rgba(0,0,0,0.03); padding: 10px; border-radius: 8px; margin-bottom: 15px; }
        .setting-label { font-size: 13px; font-weight: bold; margin-bottom: 5px; color: var(--secondary-text); display: block;}
        
        /* 新版主题设置页面样式 - 简约高级风 */
        .theme-section {
            margin-bottom: 30px;
        }
        .theme-section h3 {
            font-size: 14px;
            color: var(--secondary-text);
            margin-bottom: 10px;
            padding-left: 5px;
            font-weight: normal;
        }
        .theme-card-group {
            background-color: var(--card-bg);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .theme-setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--card-bg);
        }
        .theme-setting-item:last-child {
            border-bottom: none;
        }
        .theme-setting-item label {
            font-size: 16px;
            font-weight: 500;
            color: var(--primary-text);
        }
        .theme-setting-item .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        /* 颜色选择器美化 - 圆形 */
        input[type="color"] {
            width: 32px;
            height: 32px;
            padding: 0;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            overflow: hidden;
            background: none;
            cursor: pointer;
            -webkit-appearance: none;
        }
        input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
        input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
        
        .theme-setting-item .button-secondary {
            padding: 6px 12px;
            font-size: 13px;
            border-radius: 15px;
            background-color: var(--global-bg);
            margin: 0;
        }

    </style>
</head>
<!-- 中文注释：网页的主体部分开始，所有可见内容都在这里 -->
<body>

    <!-- 中文注释：整个应用的主容器 -->
    <div class="app-container">

        <!-- 中文注释：顶部通用栏 -->
        <div class="top-bar" id="top-bar">
            <div class="top-bar-title-container">
                <div class="top-bar-title" id="top-bar-title">プラタナス</div>
                <div class="search-container" id="search-container">
                    <input type="text" id="diary-search-input" placeholder="搜索日记...">
                </div>
            </div>
            <div class="top-bar-actions">
                <i class="fas fa-book notebook-icon" id="notebook-icon" title="选择日记本"></i>
                <i class="fas fa-search search-icon" id="search-icon"></i>
            </div>
            <img src="https://via.placeholder.com/100" alt="avatar" class="top-bar-avatar" id="topBarAvatar">
        </div>

        <!-- 中文注释：页面内容区域，所有页面都在这里切换显示 -->
        <div class="content-area">

            <!-- 中文注释：日记页面 -->
            <div id="diary-page" class="page active">
                <!-- 中文注释：快速日记编辑器 -->
                <div id="quick-diary-editor">
                    <!-- 中文注释：编辑器收起时的样子 -->
                    <div class="editor-collapsed-view">
                        <img src="https://via.placeholder.com/100" alt="avatar" id="quick-editor-avatar">
                        <span data-lang-key="write_something">写点什么...</span>
                    </div>
                    <!-- 中文注释：编辑器展开时的样子 -->
                    <div class="editor-expanded-view">
                        <div class="editor-toolbar">
                            <button data-format="bold" title="加粗"><b>B</b></button>
                            <button data-format="italic" title="斜体"><i>I</i></button>
                            <button data-format="underline" title="下划线"><u>U</u></button>
                            <button data-format="strikethrough" title="删除线"><s>S</s></button>
                            <button data-format="link" title="链接"><i class="fas fa-link"></i></button>
                        </div>
                        <textarea id="quick-diary-textarea" placeholder="写点什么吧..."></textarea>
                        <div class="editor-actions">
                            <div class="action-buttons">
                                <i class="fas fa-image" data-action="add-media" title="添加图片/视频"></i>
                                <i class="fas fa-microphone" data-action="add-audio" title="添加语音"></i>
                                <i class="far fa-smile" data-action="add-mood" title="添加心情"></i>
                                <i class="fas fa-cloud-sun" data-action="add-weather" title="添加天气"></i>
                                <i class="fas fa-folder-open" data-action="quick-select-notebook" title="选择日记本"></i>
                                <i class="fas fa-calendar-day" data-action="set-custom-date" title="自定义日期"></i>
                                <i class="fas fa-map-marker-alt" data-action="set-location" title="设置地点"></i>
                            </div>
                            <button class="send-btn">发送</button>
                        </div>
                    </div>
                </div>
                <!-- 中文注释：日记列表将在这里显示 -->
                <div id="diary-list"></div>
            </div>

            <!-- 中文注释：我的页面 -->
            <div id="my-page" class="page">
                <div class="profile-header">
                    <img src="https://via.placeholder.com/800x400" alt="background" class="profile-bg" id="profileBg">
                    <img src="https://via.placeholder.com/100" alt="avatar" class="profile-avatar" id="profileAvatar">
                    <div class="profile-info-wrapper">
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-id">ID: <span id="profileId"></span></div>
                        <div class="profile-bio" id="profileBio"></div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item"><div class="count" id="diaryCount">0</div><div class="label" data-lang-key="diaries">日记</div></div>
                    <div class="stat-item"><div class="count" id="notebookCount">1</div><div class="label" data-lang-key="notebooks">日记本</div></div>
                    <div class="stat-item"><div class="count" id="daysCount">0</div><div class="label" data-lang-key="days">记录天数</div></div>
                </div>
                <div id="my-page-content">
                    <div id="pinned-diary-container"></div>
                    <div id="recent-diaries-container">
                        <h3 style="margin-bottom: 10px;" data-lang-key="recent_diaries">近期日记</h3>
                        <div id="recent-diaries-list"></div>
                    </div>
                </div>
            </div>

            <!-- 中文注释：日历页面 -->
            <div id="calendar-page" class="page">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prev-month" class="button-secondary"><i class="fas fa-chevron-left"></i></button>
                        <span id="current-month-year"></span>
                        <button id="next-month" class="button-secondary"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-toggles-container">
                        <div>
                            <label for="lunar-calendar-toggle" data-lang-key="show_lunar_calendar">显示农历</label>
                            <input type="checkbox" id="lunar-calendar-toggle">
                        </div>
                        <div>
                            <label for="holiday-calendar-toggle" data-lang-key="show_holidays">显示节日</label>
                            <input type="checkbox" id="holiday-calendar-toggle">
                        </div>
                    </div>
                    <div class="calendar-grid" id="weekdays"></div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div id="selected-date-info" style="display: none;"></div>
                <div id="diaries-for-date" style="margin-top: 20px;"></div>
            </div>
            
            <!-- 中文注释：地图页面 -->
            <div id="map-page" class="page">
                <!-- 中文注释：地图将在这里显示 -->
                <div id="map"></div>
                <!-- 中文注释：地图页面的返回按钮 -->
                <div id="map-back-btn"><i class="fas fa-arrow-left"></i></div>
                <!-- 中文注释：在地图上选点后出现的确认栏 -->
                <div id="map-selection-bar">
                    <button class="button button-primary" data-action="confirm-map-selection" data-lang-key="confirm_selection">在此选定</button>
                </div>
            </div>
            
            <!-- 中文注释：主题设置页面 (美化版) -->
            <div id="theme-settings-page" class="page">
                 <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="theme_settings">主题设置</h2>
                </div>
                <div class="page-content" style="background-color: var(--global-bg);">
                    
                    <!-- 全局设置组 -->
                    <div class="theme-section">
                        <h3 data-lang-key="global_theme">全局外观</h3>
                        <div class="theme-card-group">
                            <div class="theme-setting-item">
                                <label data-lang-key="bg_color">背景色</label>
                                <div class="controls">
                                    <input type="color" id="theme-global-bg-color">
                                    <button class="button button-secondary" data-action="reset-theme" data-key="globalBgColor">重置</button>
                                </div>
                            </div>
                            <div class="theme-setting-item">
                                <label data-lang-key="bg_image">背景图片</label>
                                <div class="controls">
                                    <button class="button button-secondary" data-action="upload-theme-image" data-key="globalBgImage">更换图片</button>
                                    <button class="button button-secondary" data-action="reset-theme" data-key="globalBgImage">删除</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 日记文字组 -->
                    <div class="theme-section">
                        <h3 data-lang-key="diary_theme">文字颜色</h3>
                        <div class="theme-card-group">
                            <div class="theme-setting-item">
                                <label data-lang-key="primary_text_color">主要文字</label>
                                <div class="controls">
                                    <input type="color" id="theme-diary-primary-text-color">
                                    <button class="button button-secondary" data-action="reset-theme" data-key="diaryPrimaryTextColor">重置</button>
                                </div>
                            </div>
                            <div class="theme-setting-item">
                                <label data-lang-key="secondary_text_color">次要文字</label>
                                <div class="controls">
                                    <input type="color" id="theme-diary-secondary-text-color">
                                    <button class="button button-secondary" data-action="reset-theme" data-key="diarySecondaryTextColor">重置</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 强调色组 -->
                    <div class="theme-section">
                        <h3 data-lang-key="accent_color_theme">系统色彩</h3>
                        <div class="theme-card-group">
                            <div class="theme-setting-item">
                                <label data-lang-key="accent_color">强调色 (按钮/链接)</label>
                                <div class="controls">
                                    <input type="color" id="theme-accent-color">
                                    <button class="button button-secondary" data-action="reset-theme" data-key="accentColor">重置</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 高级组 -->
                    <div class="theme-section">
                        <h3>高级自定义</h3>
                        <div class="theme-card-group">
                            <div style="padding: 15px;">
                                <textarea id="custom-css-input" placeholder="在此输入自定义 CSS 代码..." style="border:none; background:var(--global-bg); width:100%; height:100px; border-radius:8px; padding:10px;"></textarea>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="button button-primary" data-action="apply-custom-css" style="flex:1; margin:0;">应用</button>
                                    <button class="button button-secondary" data-action="reset-custom-css" style="flex:1; margin:0;">清空</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 中文注释：收藏页面 -->
            <div id="favorites-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="my_favorites">我的收藏</h2>
                </div>
                <div id="favorites-list-container"></div>
            </div>

            <!-- 中文注释：字体设置页面 -->
            <div id="font-settings-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="font_settings">字体设置</h2>
                </div>
                <div id="font-settings-content">
                    <div class="theme-section">
                        <h3 data-lang-key="builtin_fonts">字体选择</h3>
                        <div class="theme-setting-item">
                            <select id="font-select" style="width: 100%; margin: 0;"></select>
                        </div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="web_font_url">网络字体URL</h3>
                        <div class="theme-setting-item font-url-container">
                            <input type="text" id="font-url-input" placeholder="https://...">
                            <button class="button button-secondary" data-action="manage-font-preset" data-lang-key="manage_presets">管理预设</button>
                        </div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="local_font_file">本地字体文件</h3>
                        <button class="button button-secondary" data-action="upload-local-font" style="width: 100%; margin: 0;">上传字体文件</button>
                        <p style="font-size: 12px; color: var(--danger-color); margin-top: 10px;" data-lang-key="local_font_warning">警告：上传本地字体文件可能会占用大量存储空间并导致应用卡顿。</p>
                    </div>
                    <div class="theme-section">
                        <button class="button button-primary" data-action="apply-font" style="width: 100%; margin: 10px 0 0 0;" data-lang-key="apply">应用</button>
                        <button class="button button-secondary" data-action="reset-font" style="width: 100%; margin: 10px 0 0 0;" data-lang-key="reset_to_default">重置为默认字体</button>
                    </div>
                </div>
            </div>

            <!-- 中文注释：纪念日页面 -->
            <div id="anniversary-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="anniversaries">纪念日</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-anniversary"></i>
                    </div>
                </div>
                <div class="page-content" id="anniversary-list-container"></div>
            </div>
            
           <!-- 修改后的：纪念日详情页结构 -->
            <div id="anniversary-detail-page">
                <!-- 这里的ID是用来放页面大背景的 -->
                <div id="anniversary-page-bg"></div>
                
                <div class="snippet-detail-header" style="z-index: 2;">
                    <!-- 修复返回按钮，明确 onclick 事件 -->
                    <i class="fas fa-arrow-left" style="font-size: 20px; cursor: pointer; padding:10px; color: var(--primary-text);" onclick="closeAnniversaryDetail()"></i>
                    <span style="font-weight: bold; font-size: 18px; color: var(--primary-text);">プラタナス</span>
                    <i class="fas fa-cog" style="font-size: 20px; cursor: pointer; padding:10px; color: var(--primary-text);" id="anniversary-setting-btn"></i>
                </div>
                
                <div id="anniversary-detail-content">
                    <!-- 卡片会渲染在这里 -->
                </div>
            </div>
            

            <!-- 中文注释：记账本页面 -->
            <div id="accounting-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="accounting">记账本</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-transaction"></i>
                    </div>
                </div>
                <div class="page-content">
                    <div class="accounting-controls">
                        <div class="view-toggle">
                            <button data-view="day" data-lang-key="view_day">日</button>
                            <button data-view="month" class="active" data-lang-key="view_month">月</button>
                            <button data-view="year" data-lang-key="view_year">年</button>
                        </div>
                        <div class="date-nav">
                            <button data-nav="prev"><i class="fas fa-chevron-left"></i></button>
                            <span id="accounting-current-period"></span>
                            <button data-nav="next"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="accounting-summary" id="accounting-summary-container"></div>
                    <div id="transaction-list-container"></div>
                </div>
            </div>

            <!-- 中文注释：言语集页面 -->
            <div id="snippets-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="snippets">言语集</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-snippet-collection"></i>
                    </div>
                </div>
                <div class="page-content" id="snippet-collection-container"></div>
            </div>
            
            <!-- 新增：言语集详情独立页面 -->
            <div id="snippet-detail-page">
                <div class="snippet-detail-overlay"></div>
                <div class="snippet-detail-header">
                    <i class="fas fa-arrow-left" style="font-size: 20px; cursor: pointer;" onclick="closeSnippetDetail()"></i>
                    <span id="snippet-detail-title" style="font-weight: bold; font-size: 18px;"></span>
                    <i class="fas fa-ellipsis-h" style="font-size: 20px; cursor: pointer;" id="snippet-detail-menu-btn"></i>
                </div>
                <div class="snippet-detail-body" id="snippet-detail-list">
                    <!-- 言语列表会显示在这里 -->
                </div>
                <!-- 底部输入栏 -->
                <div class="snippet-input-bar" id="snippet-input-bar">
                    <input type="text" id="snippet-quick-input" placeholder="写点什么...">
                    <button class="send-btn" id="snippet-quick-send"><i class="fas fa-paper-plane"></i></button>
                </div>
                <!-- 批量管理栏 (默认隐藏) -->
                <div class="snippet-input-bar" id="snippet-manage-bar" style="display: none; justify-content: space-between;">
                    <span id="snippet-selected-count">已选 0 项</span>
                    <button class="button button-danger" id="snippet-batch-delete-btn" style="margin:0; padding: 5px 15px;">删除</button>
                </div>
            </div>

            <!-- ======================================================================= -->
            <!-- 中文注释：小游戏页面 -->
            <!-- ======================================================================= -->
            <div id="games-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="games">小游戏</h2>
                </div>
                <div class="page-content">
                    <div class="game-selection-menu">
                        <button class="button button-primary" data-action="select-game" data-game="gobang">五子棋</button>
                        <button class="button button-primary" data-action="select-game" data-game="minesweeper">扫雷</button>
                        <button class="button button-primary" data-action="select-game" data-game="snake">贪吃蛇</button>
                        <button class="button button-primary" data-action="select-game" data-game="game2048">2048</button>
                        <button class="button button-primary" data-action="select-game" data-game="tetris" data-lang-key="game_tetris">俄罗斯方块</button>
                        <button class="button button-primary" data-action="select-game" data-game="tictactoe" data-lang-key="game_tictactoe">井字棋</button>
                        <button class="button button-primary" data-action="select-game" data-game="sudoku" data-lang-key="game_sudoku">数独</button>
                        <button class="button button-primary" data-action="select-game" data-game="blackjack" data-lang-key="game_blackjack">21点</button>
                        <button class="button button-primary" data-action="select-game" data-game="planetdefender" data-lang-key="game_planetdefender">星球保卫战</button>
                        <button class="button button-primary" data-action="select-game" data-game="lightsout" data-lang-key="game_lightsout">点灯游戏</button>
                        <button class="button button-primary" data-action="select-game" data-game="doodlejump" data-lang-key="game_doodlejump">是人就下100层</button>
                    </div>

                    <!-- 五子棋容器 -->
                    <div id="gobang-container" class="game-container">
                        <div class="game-status" id="gobang-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="gobang-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-gobang" data-lang-key="new_game"></button>
                        </div>
                        <div id="gobang-board"></div>
                    </div>

                    <!-- 扫雷容器 -->
                    <div id="minesweeper-container" class="game-container">
                        <div class="game-status" id="minesweeper-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="minesweeper-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-minesweeper" data-lang-key="new_game"></button>
                        </div>
                        <div id="minesweeper-grid"></div>
                    </div>
                    
                    <!-- 贪吃蛇容器 -->
                    <div id="snake-container" class="game-container">
                        <div class="game-status" id="snake-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="snake-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-snake" data-lang-key="start_game"></button>
                        </div>
                        <canvas id="snake-canvas" width="300" height="300"></canvas>
                        <div class="dpad-container">
                            <button class="dpad-btn" data-dir="up"><i class="fas fa-arrow-up"></i></button>
                            <button class="dpad-btn" data-dir="left"><i class="fas fa-arrow-left"></i></button>
                            <button class="dpad-btn" data-dir="right"><i class="fas fa-arrow-right"></i></button>
                            <button class="dpad-btn" data-dir="down"><i class="fas fa-arrow-down"></i></button>
                        </div>
                    </div>

                    <!-- 2048 容器 -->
                    <div id="game2048-container" class="game-container">
                        <div class="game-status" id="game2048-status"></div>
                        <div class="game-controls">
                            <button class="button button-secondary" data-action="start-game2048" data-lang-key="new_game"></button>
                        </div>
                        <div id="game2048-board"></div>
                    </div>
                    
                    <!-- 井字棋容器 -->
                    <div id="tictactoe-container" class="game-container">
                        <div class="game-status" id="tictactoe-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="tictactoe-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" data-lang-key="medium"></option>
                                <option value="hard" selected data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-tictactoe" data-lang-key="new_game"></button>
                        </div>
                        <div id="tictactoe-board"></div>
                    </div>
                    
                    <!-- 俄罗斯方块容器 -->
                    <div id="tetris-container" class="game-container">
                        <div class="game-status" id="tetris-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="tetris-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-tetris" data-lang-key="start_game"></button>
                        </div>
                        <div class="tetris-layout">
                            <canvas id="tetris-canvas" width="200" height="400"></canvas>
                            <div class="tetris-side-panel">
                                <h4 data-lang-key="game_tetris_next">下一个</h4>
                                <canvas id="tetris-next-canvas" class="tetris-next-piece" width="80" height="80"></canvas>
                            </div>
                        </div>
                         <div class="dpad-container">
                            <button class="dpad-btn" data-dir="up"><i class="fas fa-sync-alt"></i></button>
                            <button class="dpad-btn" data-dir="left"><i class="fas fa-arrow-left"></i></button>
                            <button class="dpad-btn" data-dir="right"><i class="fas fa-arrow-right"></i></button>
                            <button class="dpad-btn" data-dir="down"><i class="fas fa-arrow-down"></i></button>
                        </div>
                    </div>
                    
                    <!-- 21点容器 -->
                    <div id="blackjack-container" class="game-container">
                        <div class="game-status" id="blackjack-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="blackjack-difficulty">
                                <option value="easy" data-lang-key="easy">1 Deck</option>
                                <option value="medium" selected data-lang-key="medium">4 Decks</option>
                                <option value="hard" data-lang-key="hard">8 Decks</option>
                            </select>
                            <button class="button button-secondary" data-action="start-blackjack" data-lang-key="new_game"></button>
                        </div>
                        <div id="blackjack-table">
                            <div class="blackjack-area">
                                <h4>庄家 (<span id="blackjack-dealer-score">0</span>)</h4>
                                <div id="blackjack-dealer-hand" class="blackjack-hand"></div>
                            </div>
                            <div class="blackjack-area">
                                <h4>你 (<span id="blackjack-player-score">0</span>)</h4>
                                <div id="blackjack-player-hand" class="blackjack-hand"></div>
                            </div>
                        </div>
                        <div id="blackjack-actions" class="game-controls"></div>
                    </div>
                    
                    <!-- 数独容器 -->
                    <div id="sudoku-container" class="game-container">
                        <div class="game-status" id="sudoku-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                            <select id="sudoku-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-sudoku" data-lang-key="new_game"></button>
                            <button class="button button-secondary" data-action="check-sudoku" data-lang-key="game_sudoku_check">检查</button>
                            <button class="button button-secondary" data-action="hint-sudoku" data-lang-key="game_sudoku_hint">提示</button>
                        </div>
                        <div id="sudoku-board"></div>
                        <div id="sudoku-numpad"></div>
                    </div>
                    
                    <!-- 星球保卫战容器 -->
                    <div id="planetdefender-container" class="game-container">
                        <div class="game-status" id="planetdefender-status"></div>
                        <div class="game-controls">
                            <span data-lang-key="difficulty"></span>:
                             <select id="planetdefender-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-planetdefender" data-lang-key="start_game"></button>
                        </div>
                        <div class="fullscreen-canvas-container">
                            <canvas id="planetdefender-canvas"></canvas>
                        </div>
                        <div class="button-layout-container">
                            <button class="dpad-btn" data-dir="left"><i class="fas fa-undo-alt"></i></button>
                            <button class="dpad-btn" data-dir="fire" style="width: 80px; height: 80px;"><i class="fas fa-crosshairs"></i></button>
                            <button class="dpad-btn" data-dir="right"><i class="fas fa-redo-alt"></i></button>
                        </div>
                    </div>

                    <!-- 点灯游戏容器 -->
                    <div id="lightsout-container" class="game-container">
                        <div class="game-status" id="lightsout-status"></div>
                        <div class="game-controls">
                             <span data-lang-key="difficulty"></span>:
                             <select id="lightsout-difficulty">
                                <option value="easy" data-lang-key="easy">3x3</option>
                                <option value="medium" selected data-lang-key="medium">4x4</option>
                                <option value="hard" data-lang-key="hard">5x5</option>
                            </select>
                            <button class="button button-secondary" data-action="start-lightsout" data-lang-key="new_game"></button>
                        </div>
                        <div id="lightsout-grid"></div>
                    </div>

                    <!-- 是人就下100层容器 -->
                    <div id="doodlejump-container" class="game-container">
                        <div class="game-status" id="doodlejump-status"></div>
                        <div class="game-controls">
                             <span data-lang-key="difficulty"></span>:
                             <select id="doodlejump-difficulty">
                                <option value="easy" data-lang-key="easy"></option>
                                <option value="medium" selected data-lang-key="medium"></option>
                                <option value="hard" data-lang-key="hard"></option>
                            </select>
                            <button class="button button-secondary" data-action="start-doodlejump" data-lang-key="start_game"></button>
                        </div>
                         <div class="fullscreen-canvas-container">
                            <canvas id="doodlejump-canvas"></canvas>
                        </div>
                        <!-- 新增：为是人就下100层增加屏幕按钮 -->
                        <div class="button-layout-container">
                            <button class="dpad-btn" data-dir="left" style="width: 80px; height: 80px;"><i class="fas fa-arrow-left"></i></button>
                            <button class="dpad-btn" data-dir="right" style="width: 80px; height: 80px;"><i class="fas fa-arrow-right"></i></button>
                        </div>
                    </div>

                </div>
            </div>

        </div>

        <!-- 中文注释：底部导航栏 -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="diary-page"><i class="fas fa-book-open"></i><span data-lang-key="nav_diary">日记</span></div>
            <div class="nav-item" data-page="calendar-page"><i class="fas fa-calendar-alt"></i><span data-lang-key="date">日期</span></div>
            <div class="nav-item" data-page="my-page"><i class="fas fa-user"></i><span data-lang-key="my">我的</span></div>
        </nav>

    </div>

    <!-- 中文注释：日记本悬浮弹窗 -->
    <div id="notebook-popup" class="notebook-popup">
        <div class="notebook-popup-header">
            <h3 data-lang-key="notebooks">日记本</h3>
            <button id="add-notebook-popup-btn" title="新建日记本" data-action="add-notebook"><i class="fas fa-plus"></i></button>
        </div>
        <div id="notebook-popup-list" class="notebook-popup-list"></div>
    </div>

    <!-- 中文注释：所有弹窗的容器 -->
    <div id="modal-container"></div>
    
    <!-- 中文注释：侧边功能菜单 -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header"><img src="https://via.placeholder.com/100" alt="avatar" class="side-menu-avatar" id="sideMenuAvatar"><div class="side-menu-info"><div class="name" id="sideMenuName"></div><div class="bio" id="sideMenuBio"></div></div></div>
        <div class="menu-section">
            <div class="menu-item" data-action="edit-profile"><i class="fas fa-user-edit"></i> <span data-lang-key="edit_profile">编辑资料</span></div>
            <div class="menu-item" data-action="show-page" data-page="favorites-page"><i class="fas fa-star"></i> <span data-lang-key="my_favorites">我的收藏</span></div>
            <div class="menu-item" data-action="show-page" data-page="map-page"><i class="fas fa-map-marked-alt"></i> <span data-lang-key="map">地图</span></div>
            <div class="menu-item" data-action="show-page" data-page="anniversary-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path><path d="M16.5 10.5c-1.24 0-2.25 1.01-2.25 2.25s1.01 2.25 2.25 2.25 2.25-1.01 2.25-2.25-1.01-2.25-2.25-2.25zm0 3.5c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25z"></path></svg>
                <span data-lang-key="anniversaries">纪念日</span>
            </div>
            <div class="menu-item" data-action="show-page" data-page="accounting-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                <span data-lang-key="accounting">记账本</span>
            </div>
            <div class="menu-item" data-action="show-page" data-page="snippets-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"></path></svg>
                <span data-lang-key="snippets">言语集</span>
            </div>
        </div>
        <!-- 中文注释：小游戏菜单项 -->
        <div class="menu-section">
             <div class="menu-item" data-action="show-page" data-page="games-page"><i class="fas fa-gamepad"></i> <span data-lang-key="games">小游戏</span></div>
        </div>
        <div class="menu-section">
            <div class="menu-item" data-action="show-page" data-page="theme-settings-page"><i class="fas fa-palette"></i> <span data-lang-key="theme">主题</span></div>
            <div class="menu-item" data-action="show-page" data-page="font-settings-page"><i class="fas fa-font"></i> <span data-lang-key="font_settings">字体设置</span></div>
            <div class="menu-item" data-action="open-language-modal"><i class="fas fa-language"></i> <span data-lang-key="language">语言</span></div>
            <div class="menu-item"><i class="fas fa-moon"></i><span data-lang-key="dark_mode">黑夜模式</span><input type="checkbox" id="darkModeToggle" style="margin-left: auto;"></div>
        </div>
        <div class="menu-section">
            <div class="menu-item" data-action="export-data"><i class="fas fa-file-export"></i> <span data-lang-key="export_data">导出数据</span></div>
            <div class="menu-item" data-action="import-data"><i class="fas fa-file-import"></i> <span data-lang-key="import_data">导入数据</span></div>
        </div>
    </div>
    
    <!-- 中文注释：遮罩层，用于配合侧边栏和弹窗使用 -->
    <div class="overlay" id="overlay"></div>

    <!-- 中文注释：图片/视频全屏查看器 -->
    <div id="media-viewer">
        <i class="fas fa-times" id="media-viewer-close"></i>
        <img id="media-viewer-image" src="">
        <video id="media-viewer-video" src="" controls></video>
    </div>

</body>
<!-- 中文注释：这是我们应用的核心脚本，所有的交互和功能都在这里实现 -->
<script>
    /*
     * 中文注释：这是一个自我提醒，确保代码在整个页面加载完毕后才开始运行。
     */
    document.addEventListener('DOMContentLoaded', () => {
        // 【新增-代码健壮性】使用 try...catch 包裹整个应用逻辑，防止初始化错误导致整个应用白屏。
        try {
            main();
        } catch (error) {
            console.error("应用启动时发生致命错误:", error);
            document.body.innerHTML = `<h1>应用加载失败</h1><p>很抱歉，程序遇到一个无法恢复的错误。请尝试清除浏览器缓存后重试。</p><pre>${error.stack}</pre>`;
        }
    });

    async function main() {
        // =======================================================================
        // 1. 数据库核心 (IndexedDB)
        // 中文注释：这部分代码负责和手机本地的数据库打交道，用来存储你的所有数据（日记、设置等）。
        // 这样即使你关闭了网页再打开，数据也不会丢失。
        // =======================================================================
        const db = await idb.openDB('platanusDB', 3, {
            upgrade(db, oldVersion, newVersion, transaction) {
                // 中文注释：这个函数在数据库版本更新时运行，用来创建或修改数据“表”。
                if (oldVersion < 1) {
                    if (!db.objectStoreNames.contains('profile')) db.createObjectStore('profile');
                    if (!db.objectStoreNames.contains('diaries')) {
                        const store = db.createObjectStore('diaries', { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp');
                        store.createIndex('notebookId', 'notebookId');
                    }
                    if (!db.objectStoreNames.contains('notebooks')) db.createObjectStore('notebooks', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
                }
                if (oldVersion < 2) {
                    if (!db.objectStoreNames.contains('anniversaries')) db.createObjectStore('anniversaries', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('transactions')) {
                        const store = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp');
                    }
                    if (!db.objectStoreNames.contains('snippets')) {
                        const store = db.createObjectStore('snippets', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('collectionId', 'collectionId');
                    }
                    if (!db.objectStoreNames.contains('snippetCollections')) db.createObjectStore('snippetCollections', { keyPath: 'id', autoIncrement: true });
                }
                if (oldVersion < 3) {
                    console.log('数据库升级到版本3');
                }
            },
        });

        // 中文注释：这里封装了一些常用的数据库操作，比如“增删改查”，让后面的代码调用起来更方便。
        const dbActions = {
            get: (store, key) => db.get(store, key),
            set: (store, key, val) => db.put(store, val, key),
            delete: (store, key) => db.delete(store, key),
            getAll: (store) => db.getAll(store),
            add: (store, val) => db.add(store, val),
            put: (store, val) => db.put(store, val),
            getFromIndex: (store, indexName, query) => db.getAllFromIndex(store, indexName, query),
            clear: (store) => db.clear(store),
        };

        // =======================================================================
        // 2. 全局变量和状态
        // 中文注释：这里定义了一些全局变量，用来在内存中临时存放应用的状态和数据，方便随时取用。
        // =======================================================================
        let appData = { profile: {}, diaries: [], notebooks: [], settings: { darkMode: false, language: 'zh-CN', theme: {}, font: null, showLunarCalendar: false, showHolidays: false, fontPresets: [], customCss: '' }, anniversaries: [], transactions: [], snippets: [], snippetCollections: [] };
        let quickDiaryData = { media: [], mood: '', weather: '', location: null, notebookId: 1, customTimestamp: null };
        let pendingProfileImages = { avatar: null, background: null };
        let currentDate = new Date();
        let map, isMapInitialized = false, isMapInSelectionMode = false, tempMapMarker = null;
        let currentNotebookFilter = 'all';
        let diaryRenderer = { observer: null, diaries: [], currentIndex: 0, batchSize: 10 };
        let mediaRecorder, audioChunks = [];
        let tempFont = { type: null, data: null, name: null };
        let accountingState = { view: 'month', date: new Date() };
        // 中文注释：游戏相关的状态变量
        let activeGame = { name: null, instance: null };


        // =======================================================================
        // 3. 多语言引擎
        // 中文注释：这里存放了所有支持的语言文本。当切换语言时，程序会从这里找到对应的文字并显示在界面上。
        // =======================================================================
        const translations = {
            'zh-CN': { nav_diary: '日记', date: '日期', notebooks: '日记本', my: '我的', diaries: '日记', days: '记录天数', recent_diaries: '近期日记', new: '新建', map: '地图', theme: '主题', language: '语言', dark_mode: '黑夜模式', export_data: '导出数据', import_data: '导入数据', select_language: '选择语言', cancel: '取消', reset: '重置', upload: '上传', global_theme: '全局主题', bg_color: '背景色', bg_image: '背景图', diary_theme: '日记主题', primary_text_color: '主文字颜色', secondary_text_color: '次文字颜色', theme_settings: '主题设置', delete: '删除', no_diaries: '还没有日记', add_comment: '评论', year: '年', month: '月', edit: '编辑', save: '保存', new_diary: '写新日记', edit_diary: '编辑日记', content: '内容', mood: '心情', weather: '天气', location: '位置', images: '图片', notebook: '日记本', default_notebook: '默认日记本', all_diaries: '全部', new_notebook: '新建日记本', notebook_name: '日记本名称', confirm_delete: '确认删除吗？此操作不可撤销。', delete_success: '删除成功', import_confirm: '导入数据将覆盖当前所有数据，确定吗？此操作会清除包括纪念日、记账本等所有数据。', import_success: '导入成功！', export_success: '导出成功！', no_recent_diaries: '最近没有写日记哦', accent_color_theme: '一键主题色', accent_color: '强调色', edit_profile: '编辑资料', profile_name: '昵称', profile_id: 'ID', profile_bio: '个人简介', upload_avatar: '上传头像', upload_background: '上传背景', write_something: '写点什么...', select_notebook: '选择日记本', location_failed: '无法获取地理位置，日记将不包含位置信息。请检查手机定位服务和应用权限。', edit_notebook_name: '编辑日记本名称', change_notebook_cover: '更换封面', enter_cover_url: '请输入封面图片URL', upload_from_local: '本地上传', default_notebook_no_delete: '默认日记本不能删除', my_favorites: '收藏', no_favorites: '还没有收藏任何日记', set_custom_date: '设置发布时间', link_url: '链接地址', enter_link_url: '请输入网址', pin_diary: '置顶日记', unpin_diary: '取消置顶', pinned: '已置顶', show_lunar_calendar: '显示农历', show_holidays: '显示节日', no_holiday_today: '今天没有特别的节日', add_audio: '添加语音', live_record: '实时录音', upload_audio: '上传音频', recording: '录音中...', stop_recording: '停止录音', record_failed: '录音失败，请检查麦克风权限。', set_location: '设置地点', auto_detect: '自动获取', select_on_map: '地图选点', manual_entry: '手动输入', enter_location_name: '请输入地点名称', font_settings: '字体设置', builtin_fonts: '字体选择', web_font_url: '网络字体URL', local_font_file: '本地字体文件', local_font_warning: '警告：上传本地字体文件可能会占用大量存储空间并导致应用卡顿。', reset_to_default: '重置为默认字体', apply: '应用', manage_presets: '管理预设', save_as_preset: '保存为新预设', delete_preset: '删除预设', enter_preset_name: '请输入预设名称', preset_name: '预设名称', no_presets_to_delete: '没有可删除的预设', my_presets: '我的预设', built_in_group: '内置字体', anniversaries: '纪念日', accounting: '记账本', snippets: '言语集', add_anniversary: '添加纪念日', anniversary_name: '名称', anniversary_date: '日期', anniversary_type: '类型', anniversary: '纪念日', target_day: '目标日', passed: '已过', remaining: '还有', days_unit: '天', add_transaction: '添加账单', transaction_type: '类型', income: '收入', expense: '支出', amount: '金额', description: '描述', total_income: '总收入', total_expense: '总支出', balance: '结余', add_snippet_collection: '新建言语集', collection_name: '言语集名称', add_snippet: '发表言语', snippet_content: '言语内容', no_items_yet: '还没有任何记录，点击右上角“+”添加吧！', edit_anniversary: '编辑纪念日', edit_transaction: '编辑账单', edit_snippet: '编辑言语', pin: '置顶', unpin: '取消置顶', change_background: '更换背景', view_day: '日', view_month: '月', view_year: '年', confirm_selection: '在此选定', search_location: '搜索地点...', word_count_unit: '字', manage_snippets: '管理言语', delete_selected: '删除所选', games: '小游戏', copy: '复制', export_image: '导出为图片', difficulty: '难度', easy: '简单', medium: '中等', hard: '困难', new_game: '新游戏', start_game: '开始游戏', copied_success: '复制成功！', export_diary_success: '日记图片已保存到下载！', game_tetris: '俄罗斯方块', game_tictactoe: '井字棋', game_sudoku: '数独', game_blackjack: '21点', game_planetdefender: '星球保卫战', game_lightsout: '点灯游戏', game_doodlejump: '是人就下100层', game_tetris_next: '下一个', game_sudoku_check: '检查', game_sudoku_hint: '提示' },
            'zh-TW': { nav_diary: '日記', date: '日期', notebooks: '日記本', my: '我的', diaries: '日記', days: '記錄天數', recent_diaries: '近期日記', new: '新建', map: '地圖', theme: '主題', language: '語言', dark_mode: '黑夜模式', export_data: '匯出資料', import_data: '匯入資料', select_language: '選擇語言', cancel: '取消', reset: '重置', upload: '上傳', global_theme: '全域主題', bg_color: '背景顏色', bg_image: '背景圖片', diary_theme: '日記主題', primary_text_color: '主文字顏色', secondary_text_color: '次要文字顏色', theme_settings: '主題設定', delete: '刪除', no_diaries: '還沒有日記', add_comment: '评论', year: '年', month: '月', edit: '編輯', save: '儲存', new_diary: '寫新日記', edit_diary: '編輯日記', content: '內容', mood: '心情', weather: '天氣', location: '位置', images: '圖片', notebook: '日記本', default_notebook: '預設日記本', all_diaries: '全部', new_notebook: '新建日記本', notebook_name: '日記本名稱', confirm_delete: '確認刪除嗎？此操作不可撤銷。', delete_success: '刪除成功', import_confirm: '導入數據將覆蓋當前所有數據，確定嗎？此操作会清除包括紀念日、記賬本等所有數據。', import_success: '導入成功！', export_success: '導出成功！', no_recent_diaries: '最近沒有寫日記哦', accent_color_theme: '一鍵主題色', accent_color: '強調色', edit_profile: '編輯資料', profile_name: '暱稱', profile_id: 'ID', profile_bio: '個人簡介', upload_avatar: '上傳頭像', upload_background: '上傳背景', write_something: '寫點什麼...', select_notebook: '選擇日記本', location_failed: '無法獲取地理位置，日記將不包含位置信息。請檢查手機定位服務和應用權限。', edit_notebook_name: '編輯日記本名稱', change_notebook_cover: '更換封面', enter_cover_url: '請輸入封面圖片URL', upload_from_local: '本地上傳', default_notebook_no_delete: '預設日記本不能刪除', my_favorites: '收藏', no_favorites: '還沒有收藏任何日記', set_custom_date: '設定發佈時間', link_url: '連結網址', enter_link_url: '請輸入網址', pin_diary: '置頂日記', unpin_diary: '取消置頂', pinned: '已置頂', show_lunar_calendar: '顯示農曆', show_holidays: '顯示節日', no_holiday_today: '今天沒有特別的節日', add_audio: '添加語音', live_record: '即時錄音', upload_audio: '上傳音訊', recording: '錄音中...', stop_recording: '停止錄音', record_failed: '錄音失敗，請檢查麥克風權限。', set_location: '設定地點', auto_detect: '自動獲取', select_on_map: '地圖選點', manual_entry: '手動輸入', enter_location_name: '請輸入地點名稱', font_settings: '字體設定', builtin_fonts: '字體選擇', web_font_url: '網路字體URL', local_font_file: '本機字體檔案', local_font_warning: '警告：上傳本機字體檔案可能會佔用大量儲存空間並導致應用程式卡頓。', reset_to_default: '重設為預設字體', apply: '套用', manage_presets: '管理預設', save_as_preset: '另存為預設', delete_preset: '刪除預設', enter_preset_name: '請輸入預設名稱', preset_name: '預設名稱', no_presets_to_delete: '沒有可刪除的預設', my_presets: '我的預設', built_in_group: '內建字體', anniversaries: '紀念日', accounting: '記帳本', snippets: '言語集', add_anniversary: '新增紀念日', anniversary_name: '名稱', anniversary_date: '日期', anniversary_type: '類型', anniversary: '紀念日', target_day: '目標日', passed: '已過', remaining: '還有', days_unit: '天', add_transaction: '新增帳單', transaction_type: '類型', income: '收入', expense: '支出', amount: '金額', description: '描述', total_income: '總收入', total_expense: '總支出', balance: '結餘', add_snippet_collection: '新建言語集', collection_name: '言語集名稱', add_snippet: '發表言語', snippet_content: '言語內容', no_items_yet: '還沒有任何記錄，點擊右上角“+”新增吧！', edit_anniversary: '編輯紀念日', edit_transaction: '編輯帳單', edit_snippet: '編輯言語', pin: '置頂', unpin: '取消置頂', change_background: '更換背景', view_day: '日', view_month: '月', view_year: '年', confirm_selection: '在此選定', search_location: '搜尋地點...', word_count_unit: '字', manage_snippets: '管理言語', delete_selected: '刪除所選', games: '小遊戲', copy: '複製', export_image: '匯出為圖片', difficulty: '難度', easy: '簡單', medium: '中等', hard: '困難', new_game: '新遊戲', start_game: '開始遊戲', copied_success: '複製成功！', export_diary_success: '日記圖片已儲存到下載！', game_tetris: '俄羅斯方塊', game_tictactoe: '井字棋', game_sudoku: '數獨', game_blackjack: '21點', game_planetdefender: '星球保衛戰', game_lightsout: '點燈遊戲', game_doodlejump: '是男人就下100層', game_tetris_next: '下一個', game_sudoku_check: '檢查', game_sudoku_hint: '提示' },
            'ja': { nav_diary: '日記', date: '日付', notebooks: '日記帳', my: '私', diaries: '日記', days: '記録日数', recent_diaries: '最近の日記', new: '新規', map: '地図', theme: 'テーマ', language: '言語', dark_mode: 'ダークモード', export_data: 'データエクスポート', import_data: 'データインポート', select_language: '言語を選択', cancel: 'キャンセル', reset: 'リセット', upload: 'アップロード', global_theme: '全体テーマ', bg_color: '背景色', bg_image: '背景画像', diary_theme: '日記テーマ', primary_text_color: 'メインテキスト色', secondary_text_color: 'サブテキスト色', theme_settings: 'テーマ設定', delete: '削除', no_diaries: '日記がありません', add_comment: 'コメント', year: '年', month: '月', edit: '編集', save: '保存', new_diary: '新しい日記', edit_diary: '日記を編集', content: '内容', mood: '気分', weather: '天気', location: '場所', images: '写真', notebook: '日記帳', default_notebook: 'デフォルト', all_diaries: 'すべて', new_notebook: '新しい日記帳', notebook_name: '日記帳の名前', confirm_delete: '本当に削除しますか？', delete_success: '削除しました', import_confirm: 'インポートすると現在のデータが上書きされます。よろしいですか？この操作は記念日や会計帳などのデータもすべて消去します。', import_success: 'インポート成功！', export_success: 'エクスポート成功！', no_recent_diaries: '最近の日記はありません', accent_color_theme: 'アクセントカラー', accent_color: 'アクセントカラー', edit_profile: 'プロフィール編集', profile_name: 'ニックネーム', profile_id: 'ID', profile_bio: '自己紹介', upload_avatar: 'アバターをアップロード', upload_background: '背景をアップロード', write_something: '何か書く...', select_notebook: '日記帳を選択', location_failed: '位置情報を取得できませんでした。日記に位置情報は含まれません。端末の位置情報サービスとアプリの権限を確認してください。', edit_notebook_name: '日記帳名を編集', change_notebook_cover: 'カバーを変更', enter_cover_url: 'カバー画像のURLを入力', upload_from_local: 'ローカルからアップロード', default_notebook_no_delete: 'デフォルトの日記帳は削除できません', my_favorites: 'お気に入り', no_favorites: 'お気に入りの日記はありません', set_custom_date: '投稿日時を設定', link_url: 'リンクURL', enter_link_url: 'URLを入力してください', pin_diary: '日記をピン留め', unpin_diary: 'ピン留めを解除', pinned: 'ピン留め済み', show_lunar_calendar: '旧暦を表示', show_holidays: '祝日を表示', no_holiday_today: '今日は特別な祝日はありません', add_audio: '音声を追加', live_record: 'ライブ録音', upload_audio: '音声をアップロード', recording: '録音中...', stop_recording: '録音停止', record_failed: '録音に失敗しました。マイクの権限を確認してください。', set_location: '場所を設定', auto_detect: '自動検出', select_on_map: '地図で選択', manual_entry: '手動入力', enter_location_name: '場所の名前を入力', font_settings: 'フォント設定', builtin_fonts: 'フォント選択', web_font_url: 'WebフォントURL', local_font_file: 'ローカルフォントファイル', local_font_warning: '警告：ローカルフォントファイルをアップロードすると、ストレージを大量に消費し、アプリの動作が遅くなる可能性があります。', reset_to_default: 'デフォルトにリセット', apply: '適用', manage_presets: 'プリセット管理', save_as_preset: 'プリセットとして保存', delete_preset: 'プリセットを削除', enter_preset_name: 'プリセット名を入力', preset_name: 'プリセット名', no_presets_to_delete: '削除できるプリセットがありません', my_presets: 'マイプリセット', built_in_group: '内蔵フォント', anniversaries: '記念日', accounting: '会計帳', snippets: '言葉集', add_anniversary: '記念日を追加', anniversary_name: '名前', anniversary_date: '日付', anniversary_type: 'タイプ', anniversary: '記念日', target_day: '目標日', passed: '経過', remaining: '残り', days_unit: '日', add_transaction: '取引を追加', transaction_type: 'タイプ', income: '収入', expense: '支出', amount: '金額', description: '説明', total_income: '総収入', total_expense: '総支出', balance: '残高', add_snippet_collection: '新しい言葉集を作成', collection_name: '言葉集の名前', add_snippet: '言葉を追加', snippet_content: '内容', no_items_yet: 'まだ記録がありません。右上の「+」をクリックして追加してください。', edit_anniversary: '記念日を編集', edit_transaction: '取引を編集', edit_snippet: '言葉を編集', pin: 'ピン留め', unpin: 'ピン留め解除', change_background: '背景を変更', view_day: '日', view_month: '月', view_year: '年', confirm_selection: 'ここで選択', search_location: '場所を検索...', word_count_unit: '字', manage_snippets: '言葉を管理', delete_selected: '選択項目を削除', games: 'ミニゲーム', copy: 'コピー', export_image: '画像としてエクスポート', difficulty: '難易度', easy: '簡単', medium: '普通', hard: '難しい', new_game: '新しいゲーム', start_game: 'ゲーム開始', copied_success: 'コピーしました！', export_diary_success: '日記画像をダウンロードに保存しました！', game_tetris: 'テトリス', game_tictactoe: '三目並べ', game_sudoku: '数独', game_blackjack: 'ブラックジャック', game_planetdefender: '惑星防衛', game_lightsout: 'ライトアウト', game_doodlejump: '100階ダイブ', game_tetris_next: '次', game_sudoku_check: 'チェック', game_sudoku_hint: 'ヒント' },
            'en': { nav_diary: 'Diary', date: 'Date', notebooks: 'Notebooks', my: 'My', diaries: 'Diaries', days: 'Days', recent_diaries: 'Recent Diaries', new: 'New', map: 'Map', theme: 'Theme', language: 'Language', dark_mode: 'Dark Mode', export_data: 'Export Data', import_data: 'Import Data', select_language: 'Select Language', cancel: 'Cancel', reset: 'Reset', upload: 'Upload', global_theme: 'Global Theme', bg_color: 'Background Color', bg_image: 'Background Image', diary_theme: 'Diary Theme', primary_text_color: 'Primary Text Color', secondary_text_color: 'Secondary Text Color', theme_settings: 'Theme Settings', delete: 'Delete', no_diaries: 'No diaries yet', add_comment: 'Comment', year: 'Year', month: 'Month', edit: 'Edit', save: 'Save', new_diary: 'New Diary', edit_diary: 'Edit Diary', content: 'Content', mood: 'Mood', weather: 'Weather', location: 'Location', images: 'Images', notebook: 'Notebook', default_notebook: 'Default Notebook', all_diaries: 'All', new_notebook: 'New Notebook', notebook_name: 'Notebook Name', confirm_delete: 'Are you sure you want to delete this? This action cannot be undone.', delete_success: 'Deleted successfully', import_confirm: 'Importing will overwrite all current data. Are you sure? This action will also clear all data including anniversaries, transactions, etc.', import_success: 'Import successful!', export_success: 'Export successful!', no_recent_diaries: 'No recent diaries', accent_color_theme: 'Accent Color Theme', accent_color: 'Accent Color', edit_profile: 'Edit Profile', profile_name: 'Name', profile_id: 'ID', profile_bio: 'Bio', upload_avatar: 'Upload Avatar', upload_background: 'Upload Background', write_something: 'Write something...', select_notebook: 'Select Notebook', location_failed: 'Could not get location. The diary will not include location data. Please check your device\'s location services and app permissions.', edit_notebook_name: 'Edit Notebook Name', change_notebook_cover: 'Change Cover', enter_cover_url: 'Enter cover image URL', upload_from_local: 'Upload from Local', default_notebook_no_delete: 'The default notebook cannot be deleted', my_favorites: 'Favorite', no_favorites: 'No favorite diaries yet', set_custom_date: 'Set Post Time', link_url: 'Link URL', enter_link_url: 'Please enter a URL', pin_diary: 'Pin Diary', unpin_diary: 'Unpin Diary', pinned: 'Pinned', show_lunar_calendar: 'Show Lunar', show_holidays: 'Show Holidays', no_holiday_today: 'No special holiday today', add_audio: 'Add Audio', live_record: 'Live Record', upload_audio: 'Upload Audio', recording: 'Recording...', stop_recording: 'Stop Recording', record_failed: 'Recording failed. Please check microphone permissions.', set_location: 'Set Location', auto_detect: 'Auto-detect', select_on_map: 'Select on Map', manual_entry: 'Manual Entry', enter_location_name: 'Enter location name', font_settings: 'Font Settings', builtin_fonts: 'Font Selection', web_font_url: 'Web Font URL', local_font_file: 'Local Font File', local_font_warning: 'Warning: Uploading local font files may consume significant storage and cause performance issues.', reset_to_default: 'Reset to Default', apply: 'Apply', manage_presets: 'Manage Presets', save_as_preset: 'Save as Preset', delete_preset: 'Delete Preset', enter_preset_name: 'Enter preset name', preset_name: 'Preset Name', no_presets_to_delete: 'No presets to delete', my_presets: 'My Presets', built_in_group: 'Built-in', anniversaries: 'Anniversaries', accounting: 'Accounting', snippets: 'Snippets', add_anniversary: 'Add Anniversary', anniversary_name: 'Name', anniversary_date: 'Date', anniversary_type: 'Type', anniversary: 'Anniversary', target_day: 'Target Day', passed: 'passed', remaining: 'remaining', days_unit: 'days', add_transaction: 'Add Transaction', transaction_type: 'Type', income: 'Income', expense: 'Expense', amount: 'Amount', description: 'Description', total_income: 'Total Income', total_expense: 'Total Expense', balance: 'Balance', add_snippet_collection: 'New Collection', collection_name: 'Collection Name', add_snippet: 'Add Snippet', snippet_content: 'Snippet Content', no_items_yet: 'No items yet. Click the "+" icon in the top right to add one!', edit_anniversary: 'Edit Anniversary', edit_transaction: 'Edit Transaction', edit_snippet: 'Edit Snippet', pin: 'Pin', unpin: 'Unpin', change_background: 'Change Background', view_day: 'Day', view_month: 'Month', view_year: 'Year', confirm_selection: 'Confirm Selection', search_location: 'Search location...', word_count_unit: 'words', manage_snippets: 'Manage Snippets', delete_selected: 'Delete Selected', games: 'Games', copy: 'Copy', export_image: 'Export as Image', difficulty: 'Difficulty', easy: 'Easy', medium: 'Medium', hard: 'Hard', new_game: 'New Game', start_game: 'Start Game', copied_success: 'Copied successfully!', export_diary_success: 'Diary image saved to Downloads!', game_tetris: 'Tetris', game_tictactoe: 'Tic-Tac-Toe', game_sudoku: 'Sudoku', game_blackjack: 'Blackjack', game_planetdefender: 'Planet Defender', game_lightsout: 'Lights Out', game_doodlejump: 'Doodle Jump', game_tetris_next: 'Next', game_sudoku_check: 'Check', game_sudoku_hint: 'Hint' },
            'ko': { nav_diary: '일기', date: '날짜', notebooks: '일기장', my: '내 정보', diaries: '일기', days: '기록한 날', recent_diaries: '최근 일기', new: '새로 만들기', map: '지도', theme: '테마', language: '언어', dark_mode: '다크 모드', export_data: '데이터 내보내기', import_data: '데이터 가져오기', select_language: '언어 선택', cancel: '취소', reset: '초기화', upload: '업로드', global_theme: '전체 테마', bg_color: '배경색', bg_image: '배경 이미지', diary_theme: '일기 테마', primary_text_color: '기본 텍스트 색상', secondary_text_color: '보조 텍스트 색상', theme_settings: '테마 설정', delete: '삭제', no_diaries: '일기가 없습니다', add_comment: '댓글', year: '년', month: '월', edit: '수정', save: '저장', new_diary: '새 일기', edit_diary: '일기 수정', content: '내용', mood: '기분', weather: '날씨', location: '위치', images: '사진', notebook: '일기장', default_notebook: '기본 일기장', all_diaries: '전체', new_notebook: '새 일기장', notebook_name: '일기장 이름', confirm_delete: '정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', delete_success: '삭제 성공', import_confirm: '가져오기를 하면 현재 모든 데이터가 덮어쓰여집니다. 계속하시겠습니까? 이 작업은 기념일, 가계부 등 모든 데이터도 삭제합니다.', import_success: '가져오기 성공!', export_success: '내보내기 성공!', no_recent_diaries: '최근 일기가 없습니다', accent_color_theme: '악센트 컬러 테마', accent_color: '악센트 컬러', edit_profile: '프로필 편집', profile_name: '이름', profile_id: 'ID', profile_bio: '소개', upload_avatar: '아바타 업로드', upload_background: '배경 업로드', write_something: '무엇인가 쓰기...', select_notebook: '일기장 선택', location_failed: '위치 정보를 가져올 수 없습니다. 일기에는 위치 데이터가 포함되지 않습니다. 기기의 위치 서비스 및 앱 권한을 확인하십시오.', edit_notebook_name: '일기장 이름 편집', change_notebook_cover: '표지 변경', enter_cover_url: '표지 이미지 URL 입력', upload_from_local: '로컬에서 업로드', default_notebook_no_delete: '기본 일기장은 삭제할 수 없습니다', my_favorites: '즐겨찾기', no_favorites: '즐겨찾기한 일기가 없습니다', set_custom_date: '게시 시간 설정', link_url: '링크 URL', enter_link_url: 'URL을 입력하세요', pin_diary: '일기 고정', unpin_diary: '고정 해제', pinned: '고정됨', show_lunar_calendar: '음력 표시', show_holidays: '공휴일 표시', no_holiday_today: '오늘은 특별한 휴일이 없습니다', add_audio: '오디오 추가', live_record: '실시간 녹음', upload_audio: '오디오 업로드', recording: '녹음 중...', stop_recording: '녹음 중지', record_failed: '녹음에 실패했습니다. 마이크 권한을 확인하십시오.', set_location: '위치 설정', auto_detect: '자동 감지', select_on_map: '지도에서 선택', manual_entry: '수동 입력', enter_location_name: '위치 이름 입력', font_settings: '글꼴 설정', builtin_fonts: '글꼴 선택', web_font_url: '웹 글꼴 URL', local_font_file: '로컬 글꼴 파일', local_font_warning: '경고: 로컬 글꼴 파일을 업로드하면 상당한 저장 공간을 차지하고 성능 문제가 발생할 수 있습니다.', reset_to_default: '기본값으로 재설정', apply: '적용', manage_presets: '프리셋 관리', save_as_preset: '프리셋으로 저장', delete_preset: '프리셋 삭제', enter_preset_name: '프리셋 이름 입력', preset_name: '프리셋 이름', no_presets_to_delete: '삭제할 프리셋이 없습니다', my_presets: '내 프리셋', built_in_group: '내장 글꼴', anniversaries: '기념일', accounting: '가계부', snippets: '스니펫', add_anniversary: '기념일 추가', anniversary_name: '이름', anniversary_date: '날짜', anniversary_type: '유형', anniversary: '기념일', target_day: '목표일', passed: '지남', remaining: '남음', days_unit: '일', add_transaction: '거래 추가', transaction_type: '유형', income: '수입', expense: '지출', amount: '금액', description: '설명', total_income: '총 수입', total_expense: '총 지출', balance: '잔액', add_snippet_collection: '새 컬렉션', collection_name: '컬렉션 이름', add_snippet: '스니펫 추가', snippet_content: '스니펫 내용', no_items_yet: '아직 항목이 없습니다. 오른쪽 상단의 "+" 아이콘을 클릭하여 추가하세요!', edit_anniversary: '기념일 편집', edit_transaction: '거래 편집', edit_snippet: '스니펫 편집', pin: '고정', unpin: '고정 해제', change_background: '배경 변경', view_day: '일', view_month: '월', view_year: '년', confirm_selection: '여기서 선택', search_location: '위치 검색...', word_count_unit: '자', manage_snippets: '스니펫 관리', delete_selected: '선택 삭제', games: '미니 게임', copy: '복사', export_image: '이미지로 내보내기', difficulty: '난이도', easy: '쉬움', medium: '중간', hard: '어려움', new_game: '새 게임', start_game: '게임 시작', copied_success: '복사 성공!', export_diary_success: '일기 이미지가 다운로드에 저장되었습니다!', game_tetris: '테트리스', game_tictactoe: '틱택토', game_sudoku: '스도쿠', game_blackjack: '블랙잭', game_planetdefender: '행성 방어', game_lightsout: '라이트 아웃', game_doodlejump: '두들 점프', game_tetris_next: '다음', game_sudoku_check: '확인', game_sudoku_hint: '힌트' }
        };

        // 中文注释：一个辅助函数，用来根据当前设置的语言获取对应的文本。
        const getLangText = (key) => translations[appData.settings.language]?.[key] || translations['zh-CN'][key] || key;

        // 中文注释：设置界面语言的函数。
        async function setLanguage(lang) {
            if (!lang || !translations[lang]) lang = 'zh-CN';
            appData.settings.language = lang;
            await dbActions.set('settings', 'language', lang);
            document.documentElement.lang = lang.split('-')[0];
            // 中文注释：遍历所有带 `data-lang-key` 标记的元素，把它们的文本替换成当前语言的文本。
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const translation = getLangText(el.dataset.langKey);
                if (el.tagName === 'OPTION') { // Special handling for option elements
                    el.textContent = translation;
                } else if (el.placeholder) {
                    el.placeholder = translation;
                } else if (el.title) {
                    el.title = translation;
                } else {
                    el.textContent = translation;
                }
            });
            renderWeekdays();
            renderFontSelection();
            renderCalendar();
            if (document.getElementById('accounting-page').classList.contains('active')) {
                renderAccountingPage();
            }
        }

        // =======================================================================
        // 4. DOM元素获取
        // 中文注释：这里是把页面上所有的重要元素都“抓”到代码里来，并给它们起个名字，方便后面操作它们。
        // =======================================================================
        const body = document.body, appContainer = document.querySelector('.app-container'), contentArea = document.querySelector('.content-area'), pages = document.querySelectorAll('.page'), navItems = document.querySelectorAll('.nav-item'), topBar = document.getElementById('top-bar'), topBarTitle = document.getElementById('top-bar-title'), topBarAvatar = document.getElementById('topBarAvatar'), diaryListEl = document.getElementById('diary-list'), sideMenu = document.getElementById('sideMenu'), overlay = document.getElementById('overlay'), profileNameEl = document.getElementById('profileName'), profileIdEl = document.getElementById('profileId'), profileBioEl = document.getElementById('profileBio'), profileAvatarEl = document.getElementById('profileAvatar'), profileBgEl = document.getElementById('profileBg'), diaryCountEl = document.getElementById('diaryCount'), notebookCountEl = document.getElementById('notebookCount'), daysCountEl = document.getElementById('daysCount'), 
        pinnedDiaryContainer = document.getElementById('pinned-diary-container'),
        recentDiariesContainer = document.getElementById('recent-diaries-container'),
        recentDiariesListEl = document.getElementById('recent-diaries-list'), currentMonthYearEl = document.getElementById('current-month-year'), 
        lunarCalendarToggle = document.getElementById('lunar-calendar-toggle'),
        holidayCalendarToggle = document.getElementById('holiday-calendar-toggle'),
        calendarDaysEl = document.getElementById('calendar-days'), weekdaysEl = document.getElementById('weekdays'), diariesForDateEl = document.getElementById('diaries-for-date'), 
        selectedDateInfoEl = document.getElementById('selected-date-info'),
        sideMenuAvatar = document.getElementById('sideMenuAvatar'), sideMenuName = document.getElementById('sideMenuName'), sideMenuBio = document.getElementById('sideMenuBio'), darkModeToggle = document.getElementById('darkModeToggle'), modalContainer = document.getElementById('modal-container'), searchIcon = document.getElementById('search-icon'), searchContainer = document.getElementById('search-container'), diarySearchInput = document.getElementById('diary-search-input'), quickDiaryEditor = document.getElementById('quick-diary-editor'), quickEditorAvatar = document.getElementById('quick-editor-avatar'), quickDiaryTextarea = document.getElementById('quick-diary-textarea'), 
        mediaViewer = document.getElementById('media-viewer'), mediaViewerImage = document.getElementById('media-viewer-image'), mediaViewerVideo = document.getElementById('media-viewer-video'), mediaViewerClose = document.getElementById('media-viewer-close'),
        notebookPopup = document.getElementById('notebook-popup'), notebookPopupList = document.getElementById('notebook-popup-list'),
        favoritesListContainer = document.getElementById('favorites-list-container'),
        mapSelectionBar = document.getElementById('map-selection-bar'),
        fontSelect = document.getElementById('font-select'),
        fontUrlInput = document.getElementById('font-url-input'),
        anniversaryListContainer = document.getElementById('anniversary-list-container'),
        accountingControls = document.querySelector('.accounting-controls'),
        accountingSummaryContainer = document.getElementById('accounting-summary-container'),
        transactionListContainer = document.getElementById('transaction-list-container'),
        snippetCollectionContainer = document.getElementById('snippet-collection-container');

        // =======================================================================
        // 5. 核心渲染和更新函数
        // 中文注释：这些函数负责把数据（比如日记、个人信息）显示到屏幕上，也就是“渲染”页面。
        // =======================================================================
        
        // 中文注释：一个总的刷新函数，当数据有变动时调用它，它会重新加载所有数据并刷新整个界面。
        async function refreshAllDataAndRender() {
            try {
                await loadDataFromDB();
                await applySettings();
                updateProfileUI();
                displayDiaries();
                renderNotebookPopup();
                await setLanguage(appData.settings.language);
                renderCalendar();
            } catch (error) {
                console.error("刷新数据失败:", error);
                alert("加载数据时发生错误，请尝试刷新页面。");
            }
        }

        // 中文注释：从数据库加载所有数据到内存中。
        async function loadDataFromDB() {
            const [profile, diaries, notebooks, darkMode, language, theme, font, showLunarCalendar, showHolidays, fontPresets, anniversaries, transactions, snippets, snippetCollections, customCss] = await Promise.all([
                dbActions.get('profile', 'userProfile'), 
                dbActions.getAll('diaries'), 
                dbActions.getAll('notebooks'),
                dbActions.get('settings', 'darkMode'),
                dbActions.get('settings', 'language'),
                dbActions.get('settings', 'theme'),
                dbActions.get('settings', 'font'),
                dbActions.get('settings', 'showLunarCalendar'),
                dbActions.get('settings', 'showHolidays'),
                dbActions.get('settings', 'fontPresets'),
                dbActions.getAll('anniversaries'),
                dbActions.getAll('transactions'),
                dbActions.getAll('snippets'),
                dbActions.getAll('snippetCollections'),
                dbActions.get('settings', 'customCss')
            ]);
            
            appData = {
                profile: profile || {}, diaries: diaries || [], notebooks: notebooks || [],
                settings: {
                    darkMode: darkMode || false,
                    language: language || 'zh-CN',
                    theme: theme || {},
                    font: font || null,
                    showLunarCalendar: showLunarCalendar || false,
                    showHolidays: showHolidays || false,
                    fontPresets: fontPresets || [],
                    customCss: customCss || ''
                },
                anniversaries: anniversaries || [],
                transactions: transactions || [],
                snippets: snippets || [],
                snippetCollections: snippetCollections || []
            };
        }
        
        // 中文注释：应用用户的个性化设置，比如黑夜模式、主题颜色、字体等。
        async function applySettings() {
            const { theme, darkMode, font, showLunarCalendar, showHolidays, customCss } = appData.settings;
            
            body.classList.toggle('dark-mode', darkMode);
            darkModeToggle.checked = darkMode;
            
            document.documentElement.style.setProperty('--accent-color', theme?.accentColor || '#007aff');
            
            if (theme?.globalBgImage) {
                document.documentElement.style.setProperty('--theme-global-bg-image', `url(${theme.globalBgImage})`);
                body.classList.add('has-global-bg-image');
            } else {
                document.documentElement.style.removeProperty('--theme-global-bg-image');
                body.classList.remove('has-global-bg-image');
            }
            document.documentElement.style.setProperty('--theme-global-bg-color', theme?.globalBgColor || null);
            document.documentElement.style.setProperty('--theme-diary-primary-text-color', theme?.diaryPrimaryTextColor || null);
            document.documentElement.style.setProperty('--theme-diary-secondary-text-color', theme?.diarySecondaryTextColor || null);

            lunarCalendarToggle.checked = showLunarCalendar;
            holidayCalendarToggle.checked = showHolidays;
            
            applyCustomCss(customCss);
            document.getElementById('custom-css-input').value = customCss;

            await applyFont(font, false); // Just apply, don't re-render selections yet
        }

        // 新增：应用自定义CSS
        function applyCustomCss(css) {
            let styleEl = document.getElementById('custom-css-style');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'custom-css-style';
                document.head.appendChild(styleEl);
            }
            styleEl.textContent = css;
        }

        // 中文注释：更新所有显示个人信息的地方，比如头像、昵称。
        function updateProfileUI() {
            const { name, id, bio, avatar, background } = appData.profile;
            const avatarSrc = avatar || 'https://via.placeholder.com/100';
            const bgSrc = background || 'https://via.placeholder.com/800x400';
            [topBarAvatar, sideMenuAvatar, profileAvatarEl, quickEditorAvatar].forEach(el => el.src = avatarSrc);
            profileBgEl.src = bgSrc;
            profileNameEl.textContent = name;
            profileIdEl.textContent = id;
            profileBioEl.textContent = bio;
            sideMenuName.textContent = name;
            sideMenuBio.textContent = bio;
            diaryCountEl.textContent = appData.diaries.length;
            notebookCountEl.textContent = appData.notebooks.length;
            daysCountEl.textContent = new Set(appData.diaries.map(d => new Date(d.timestamp).toDateString())).size;
            renderMyPageContents();
        }

        // 中文注释：渲染“我的”页面里的具体内容，比如置顶日记和近期日记。
        function renderMyPageContents() {
            const pinnedDiary = appData.diaries.find(d => d.isPinned);
            pinnedDiaryContainer.innerHTML = '';
            if (pinnedDiary) {
                pinnedDiaryContainer.innerHTML = `<h3 style="margin-bottom: 10px;">${getLangText('pinned')}</h3>`;
                pinnedDiaryContainer.appendChild(createDiaryCard(pinnedDiary));
            }

            const sortedDiaries = appData.diaries
                .filter(d => !d.isPinned)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);
            recentDiariesListEl.innerHTML = '';
            if (sortedDiaries.length === 0 && !pinnedDiary) {
                recentDiariesContainer.style.display = 'none';
            } else {
                recentDiariesContainer.style.display = 'block';
                if (sortedDiaries.length === 0) {
                     recentDiariesListEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text);">${getLangText('no_recent_diaries')}</p>`;
                } else {
                    sortedDiaries.forEach(diary => recentDiariesListEl.appendChild(createDiaryCard(diary)));
                }
            }
        }
        
        // 中文注释：根据当前的筛选条件（比如选择了某个日记本或输入了搜索词）来显示日记列表。
        function displayDiaries(searchTerm = '') {
            if (diaryRenderer.observer) diaryRenderer.observer.disconnect();
            
            let diariesToFilter = (currentNotebookFilter === 'all') 
                ? appData.diaries 
                : appData.diaries.filter(d => d.notebookId === currentNotebookFilter);
            
            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                diariesToFilter = diariesToFilter.filter(d => (d.content || '').toLowerCase().includes(lowerCaseSearchTerm));
            }

            const pinnedDiary = searchTerm ? null : diariesToFilter.find(d => d.isPinned);
            const otherDiaries = diariesToFilter
                .filter(d => !d.isPinned)
                .sort((a, b) => b.timestamp - a.timestamp);

            const diariesToRender = pinnedDiary ? [pinnedDiary, ...otherDiaries] : otherDiaries;
            
            diaryRenderer.diaries = diariesToRender;
            diaryRenderer.currentIndex = 0;
            diaryListEl.innerHTML = '';
            
            if (diariesToRender.length === 0) {
                diaryListEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_diaries')}</p>`;
                return;
            }
            
            renderNextDiaryBatch();
        }

        // 中文注释：这是一个性能优化功能，叫做“无限滚动”。它每次只加载少量日记，当你快要滑到底部时，再自动加载下一批。
        function renderNextDiaryBatch() {
            const batch = diaryRenderer.diaries.slice(diaryRenderer.currentIndex, diaryRenderer.currentIndex + diaryRenderer.batchSize);
            if (batch.length === 0) return;

            batch.forEach(diary => diaryListEl.appendChild(createDiaryCard(diary)));
            diaryRenderer.currentIndex += batch.length;

            if (diaryRenderer.currentIndex < diaryRenderer.diaries.length) {
                const lastCard = diaryListEl.lastElementChild;
                if (lastCard) {
                    diaryRenderer.observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting) {
                            diaryRenderer.observer.disconnect();
                            renderNextDiaryBatch();
                        }
                    }, { root: contentArea, rootMargin: '200px' });
                    diaryRenderer.observer.observe(lastCard);
                }
            }
        }
        
        // 中文注释：渲染右上角的日记本选择弹窗。
        function renderNotebookPopup() {
            notebookPopupList.innerHTML = '';
            const allItem = createNotebookPopupItem({ id: 'all', name: getLangText('all_diaries'), cover: '' });
            notebookPopupList.appendChild(allItem);
            appData.notebooks.sort((a,b) => a.id === 1 ? -1 : b.id === 1 ? 1 : 0).forEach(nb => {
                const nbItem = createNotebookPopupItem(nb);
                notebookPopupList.appendChild(nbItem);
            });
        }

        // 中文注释：创建单个日记本弹窗里的项目。
        function createNotebookPopupItem(notebook) {
            const item = document.createElement('div');
            item.className = 'notebook-popup-item';
            item.dataset.action = 'filter-notebook';
            item.dataset.id = notebook.id;
            if (String(currentNotebookFilter) === String(notebook.id)) {
                item.classList.add('active');
            }
            const coverImg = notebook.cover ? `<img src="${notebook.cover}" class="notebook-popup-item-cover" alt="">` : '';
            item.innerHTML = `
                ${coverImg}
                <div class="notebook-popup-item-overlay"></div>
                <div class="notebook-popup-item-name">${notebook.name}</div>
            `;
            if (notebook.id !== 'all') {
                addLongPressListener(item, () => openNotebookMenu(notebook));
            }
            return item;
        }
        
        // 中文注释：渲染日历顶部的星期（日、一、二...）。
        function renderWeekdays() {
            const dayNames = { 'zh-CN': ['日', '一', '二', '三', '四', '五', '六'], 'zh-TW': ['日', '一', '二', '三', '四', '五', '六'], 'ja': ['日', '月', '火', '水', '木', '金', '土'], 'en': ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], 'ko': ['일', '월', '화', '수', '목', '금', '토'] };
            weekdaysEl.innerHTML = (dayNames[appData.settings.language] || dayNames['en']).map(d => `<div class="calendar-weekday">${d}</div>`).join('');
        }

        // 中文注释：渲染整个日历。
        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            selectedDateInfoEl.innerHTML = '';
            selectedDateInfoEl.style.display = 'none';
            diariesForDateEl.innerHTML = '';

            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${year} ${getLangText('year')} ${month + 1}${getLangText('month')}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const diariesByDate = appData.diaries.reduce((acc, diary) => {
                const dateStr = new Date(diary.timestamp).toDateString();
                if (!acc[dateStr]) acc[dateStr] = [];
                acc[dateStr].push(diary);
                return acc;
            }, {});

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarDaysEl.insertAdjacentHTML('beforeend', '<div></div>');
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const thisDate = new Date(year, month, i);
                let dayContent = `<span>${i}</span>`;

                if (typeof solarlunar !== 'undefined') {
                    const lunarData = solarlunar.solar2lunar(year, month + 1, i);
                    const holiday = lunarData.lunarFestival || lunarData.festival;

                    if (appData.settings.showHolidays && holiday) {
                        dayCell.classList.add('is-holiday');
                        dayCell.dataset.holiday = holiday;
                    }
                    
                    if (appData.settings.showLunarCalendar) {
                        dayContent += `<span class="lunar-date">${lunarData.IDayCn}</span>`;
                    }
                }

                dayCell.innerHTML = dayContent;
                dayCell.dataset.action = 'show-diaries-for-date';
                dayCell.dataset.date = thisDate.toDateString();
                
                if (thisDate.toDateString() === new Date().toDateString()) dayCell.classList.add('today');
                
                // 修改后的代码：显示数字
                const diariesToday = diariesByDate[thisDate.toDateString()];
                if (diariesToday && diariesToday.length > 0) {
                    // 不再使用 has-diary 类加点，而是直接插入数字 HTML
                    // dayCell.classList.add('has-diary'); // 这行删掉或注释掉
                    dayContent += `<span class="calendar-diary-count">${diariesToday.length}</span>`;
                    dayCell.innerHTML = dayContent; // 更新单元格内容
                }
                calendarDaysEl.appendChild(dayCell);
            }
        }
        
        // 中文注释：初始化地图的函数。
        function initMap() {
            if (isMapInitialized) return; // 如果已经初始化过了，就直接返回，避免重复创建。
            try {
                // 中文注释：在id为'map'的元素上创建一个地图实例，并设置初始视图中心和缩放级别。
                map = L.map('map').setView([31.2304, 121.4737], 10); // 默认中心点在上海
                
                // 中文注释：给地图添加一个瓦片图层，这是地图的底图，我们用的是免费的OpenStreetMap。
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 中文注释：给地图添加一个地理编码（搜索）控件。
                L.Control.geocoder({
                    defaultMarkGeocode: false, // 搜索后不在地图上自动打点
                    placeholder: getLangText('search_location'), // 搜索框的提示文字
                }).on('markgeocode', function(e) { // 监听搜索到结果的事件
                    map.fitBounds(e.geocode.bbox); // 将地图视图缩放到包含搜索结果的范围
                }).addTo(map);

                renderMapMarkers(); // 在地图上渲染所有带位置的日记标记。
                isMapInitialized = true; // 标记地图已初始化。
            } catch(e) {
                console.error("地图初始化失败:", e);
                document.getElementById('map').innerHTML = "地图加载失败，请检查网络连接。";
            }
        }

        // 中文注释：在地图上渲染所有日记的位置标记。
        function renderMapMarkers() {
            if (!map) return;
            // 中文注释：先清除地图上所有已存在的标记。
            map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
            // 中文注释：遍历所有日记，如果日记有位置信息，就在地图上创建一个标记。
            appData.diaries.forEach(diary => {
                if (diary.location && diary.location.lat && diary.location.lon) {
                    L.marker([diary.location.lat, diary.location.lon]).addTo(map)
                        .bindPopup(`<b>${new Date(diary.timestamp).toLocaleString()}</b><br>${(diary.content || '').substring(0, 30)}...`); // 点击标记时显示一个信息弹窗
                }
            });
        }

        // 中文注释：渲染收藏页面。
        function renderFavoritesPage() {
            const favoriteDiaries = appData.diaries
                .filter(d => d.isFavorite)
                .sort((a, b) => b.timestamp - a.timestamp);
            favoritesListContainer.innerHTML = '';
            if (favoriteDiaries.length === 0) {
                favoritesListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_favorites')}</p>`;
                return;
            }
            favoriteDiaries.forEach(diary => {
                favoritesListContainer.appendChild(createDiaryCard(diary));
            });
        }

        // =======================================================================
        // 6. 交互逻辑 (页面切换、弹窗等)
        // =======================================================================
        
        function cleanupActiveGame() {
            if (activeGame.instance && typeof activeGame.instance.cleanup === 'function') {
                activeGame.instance.cleanup();
            }
            activeGame.instance = null;
            activeGame.name = null;
        }

        // 中文注释：切换显示不同页面的函数。
        function showPage(pageId, options = {}) {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            
            // === 新增代码开始：控制底部导航栏的显示/隐藏 ===
            const bottomNav = document.querySelector('.bottom-nav');
            // 定义哪些页面是“主页”，需要显示底部栏
            const mainPages = ['diary-page', 'calendar-page', 'my-page'];
            
            if (mainPages.includes(pageId)) {
                bottomNav.style.display = 'flex'; // 主页显示
                // 也要处理 content-area 的底部内边距，防止内容被遮挡
                document.querySelector('.content-area').style.paddingBottom = '80px';
            } else {
                bottomNav.style.display = 'none'; // 其他功能页隐藏
                document.querySelector('.content-area').style.paddingBottom = '0'; // 释放底部空间
            }
            // === 新增代码结束 ===
            
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            
            const pagesWithHeaders = ['favorites-page', 'font-settings-page', 'theme-settings-page', 'anniversary-page', 'accounting-page', 'snippets-page', 'games-page'];
            body.className = body.classList.contains('dark-mode') ? 'dark-mode' : '';
            if (appData.settings.theme.globalBgImage) body.classList.add('has-global-bg-image');
            if (pageId === 'my-page') body.classList.add('my-page-active');
            if (pagesWithHeaders.includes(pageId)) body.classList.add('page-with-header');
            
            document.getElementById('notebook-icon').style.display = 'none';
            searchIcon.style.display = 'none';
            
            switch(pageId) {
                case 'diary-page':
                    topBarTitle.textContent = 'プラタナス';
                    document.getElementById('notebook-icon').style.display = 'block';
                    searchIcon.style.display = 'block';
                    break;
                case 'calendar-page':
                    topBarTitle.textContent = getLangText('date');
                    break;
                case 'my-page':
                case 'favorites-page':
                case 'font-settings-page':
                case 'theme-settings-page':
                case 'anniversary-page':
                case 'accounting-page':
                case 'snippets-page':
                case 'games-page': 
                    topBarTitle.textContent = '';
                    break;
            }
            
            if (pageId !== 'diary-page' && searchContainer.classList.contains('active')) {
                searchContainer.classList.remove('active');
                diarySearchInput.value = '';
                displayDiaries();
            }

            if (pageId === 'map-page') {
                initMap(); 
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 10);

                isMapInSelectionMode = options.selectionMode || false;
                mapSelectionBar.style.display = 'none';
                if (isMapInSelectionMode) {
                    map.on('click', onMapClickForSelection); 
                } else {
                    map.off('click', onMapClickForSelection); 
                    if(tempMapMarker) map.removeLayer(tempMapMarker);
                    tempMapMarker = null;
                }
            } else if (isMapInitialized) {
                isMapInSelectionMode = false;
                map.off('click', onMapClickForSelection);
            }
            
            // 如果切换到其他页面，则停止所有正在运行的游戏
            if (pageId !== 'games-page') {
                cleanupActiveGame();
            }

            // 根据切换到的页面，调用对应的渲染函数。
            if (pageId === 'my-page') renderMyPageContents();
            if (pageId === 'calendar-page') renderCalendar();
            if (pageId === 'favorites-page') renderFavoritesPage();
            if (pageId === 'font-settings-page') renderFontSelection();
            if (pageId === 'anniversary-page') renderAnniversaryPage();
            if (pageId === 'accounting-page') renderAccountingPage();
            if (pageId === 'snippets-page') renderSnippetsPage();
            
            toggleSideMenu(false);
            toggleNotebookPopup(false);
        }
        
        function toggleSideMenu(show) {
            sideMenu.classList.toggle('active', show);
            overlay.classList.toggle('active', show);
        }

        function toggleNotebookPopup(show) {
            notebookPopup.style.display = show ? 'block' : 'none';
        }
        
        // 中文注释：触发文件上传的函数。
        function triggerFileUpload(accept, isMultiple, maxFiles, callback) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = accept;
            input.multiple = isMultiple;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                if (isMultiple && (files.length > maxFiles)) return alert(`最多选择 ${maxFiles} 个文件`);
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        let type = 'file';
                        if (file.type.startsWith('image')) type = 'image';
                        else if (file.type.startsWith('video')) type = 'video';
                        else if (file.type.startsWith('audio')) type = 'audio';
                        else if (['.ttf', '.otf', '.woff', '.woff2'].some(ext => file.name.endsWith(ext))) type = 'font';
                        callback({ type: type, src: ev.target.result, name: file.name });
                    };
                    reader.readAsDataURL(file);
                });
            };
            input.click();
        }

        /*
         * 中文注释：这是一个给元素添加长按事件监听的函数。
         */
        function addLongPressListener(element, callback) {
            let timer;
            const start = (e) => { 
                timer = setTimeout(() => { 
                    if (navigator.vibrate) navigator.vibrate(50); 
                    callback(); 
                }, 800); 
            };
            const end = () => clearTimeout(timer);
            const move = () => clearTimeout(timer); // 如果手指移动（滚动），就取消长按计时
            
            element.addEventListener('touchstart', start);
            element.addEventListener('touchend', end);
            element.addEventListener('touchmove', move);
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); callback(); });
        }
        
        // 中文注释：将简单的标记语言（如**加粗**）转换成HTML。
        function formatRichText(text) {
            if (!text) return '';
            return text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                .replace(/\*(.*?)\*/g, '<i>$1</i>')
                .replace(/__(.*?)__/g, '<u>$1</u>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                .replace(/\n/g, '<br>');
        }
        // 中文注释：将富文本HTML转为纯文本，用于复制
        function stripHtml(html) {
            let tmp = document.createElement("DIV");
            // 将 <br> 转换回换行符
            tmp.innerHTML = html.replace(/<br\s*[\/]?>/gi, "\n");
            return tmp.textContent || tmp.innerText || "";
        }


        // 中文注释：根据一个日记的数据，创建对应的HTML卡片元素。
        function createDiaryCard(diary) {
            const card = document.createElement('div');
            card.className = 'diary-card';
            card.dataset.diaryId = diary.id;
            const date = new Date(diary.timestamp);
            const weekdays = { 'zh-CN': ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'], 'zh-TW': ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'], 'ja': ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'], 'en': ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], 'ko': ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'] };
            const dayString = (weekdays[appData.settings.language] || weekdays['en'])[date.getDay()];
            
            const mediaHTML = (diary.media || []).map((item, index) => {
                const commonAttrs = `class="media-item" data-action="view-media" data-index="${index}"`;
                if (item.type === 'image') return `<div ${commonAttrs}><img src="${item.src}" alt="diary media" loading="lazy"></div>`;
                if (item.type === 'video') return `<div ${commonAttrs}><video src="${item.src}#t=0.1" preload="metadata"></video><i class="fas fa-play video-play-icon"></i></div>`;
                if (item.type === 'audio') return `<div class="media-item audio-player"><i class="fas fa-music"></i><audio src="${item.src}" controls></audio></div>`;
                return '';
            }).join('');
            
            const pinnedIconHTML = diary.isPinned ? `<i class="fas fa-thumbtack pinned-icon" title="${getLangText('pinned')}"></i>` : '';
            const locationText = diary.location ? `<i class="fas fa-map-marker-alt"></i> ${diary.location.name || '未知地点'}` : '';
            const wordCount = stripHtml(diary.content || '').length;

            card.innerHTML = `
                ${pinnedIconHTML}
                <div class="diary-card-header">
                    <div class="diary-author">
                        <img src="${appData.profile.avatar || 'https://via.placeholder.com/100'}" alt="avatar" class="diary-author-avatar">
                        <div class="diary-author-info">
                            <div class="name">${appData.profile.name || ''}</div>
                            <div class="id">@${appData.profile.id || ''}</div>
                        </div>
                    </div>
                    <div class="diary-meta">
                        <div class="diary-timestamp">
                            <div>${date.getMonth() + 1}月${date.getDate()}日・${dayString}</div>
                            <div>${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}</div>
                        </div>
                        <div class="mood-weather">${diary.mood || ''} ${diary.weather || ''}</div>
                    </div>
                </div>
                <div class="diary-card-body">
                    <div class="diary-card-content">${formatRichText(diary.content)}</div>
                    ${mediaHTML ? `<div class="diary-media">${mediaHTML}</div>` : ''}
                </div>
                <div class="diary-card-footer">
                    <div class="diary-footer-left">
                        <span>${locationText}</span>
                        <span class="diary-word-count">${wordCount} ${getLangText('word_count_unit')}</span>
                    </div>
                    <div class="diary-footer-right">
                        <i class="fas fa-comment-dots comment-toggle-btn" data-action="toggle-comment-display" title="${getLangText('add_comment')}"></i>
                        <i class="${diary.isFavorite ? 'fas' : 'far'} fa-star favorite-btn ${diary.isFavorite ? 'favorited' : ''}" data-action="toggle-favorite" title="${getLangText('my_favorites')}"></i>
                    </div>
                </div>
                <div class="comment-section">
                    ${renderCommentsHTML(diary.id, diary.comments || [])}
                </div>
            `;
            addLongPressListener(card, () => openDiaryMenu(diary));
            
            // 为评论添加长按监听
            card.querySelectorAll('.comment').forEach(commentEl => {
                addLongPressListener(commentEl, () => openCommentMenu(commentEl));
            });
            return card;
        }

        // 中文注释：渲染评论区。
        function renderCommentsHTML(diaryId, comments) {
            let html = `<div class="comment-input-area"><input type="text" placeholder="${getLangText('add_comment')}..."><button class="send-comment-btn" data-action="send-comment"><i class="fas fa-paper-plane"></i></button></div>`;
            const commentsToShow = comments.slice(-3);
            if (comments.length > 3) {
                html += `<a class="view-more-comments" data-action="view-all-comments">查看全部 ${comments.length} 条评论</a>`;
            }
            commentsToShow.reverse().forEach(c => { // 让最新的评论在最上面
                html += `<div class="comment" data-comment-content="${c.content}"><img src="${appData.profile.avatar || 'https://via.placeholder.com/100'}" class="comment-avatar"><div class="comment-body"><div class="comment-header"><span class="id">@${c.authorId}</span> · <span>${new Date(c.timestamp).toLocaleString()}</span></div><div class="comment-content">${formatRichText(c.content)}</div></div></div>`;
            });
            return html;
        }
        
        // 中文注释：这是整个应用的总事件监听器，负责处理页面上几乎所有的点击事件。
        document.body.addEventListener('click', async (e) => {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            const formatTarget = target.closest('[data-format]');

            if (formatTarget) { applyFormatToTextarea(formatTarget.dataset.format); return; }

            if (actionTarget) {
                const action = actionTarget.dataset.action;
                const id = actionTarget.dataset.id;
                const key = actionTarget.dataset.key;
                const page = actionTarget.dataset.page;
                const game = actionTarget.dataset.game; 

                // 中文注释：使用一个switch语句来判断用户点击的是哪个带有`data-action`的按钮，并执行相应的操作。
                switch (action) {
                
                // 在 switch (action) { ... } 里面添加：

                    case 'copy-snippet': {
                        closeModal();
                        const content = actionTarget.dataset.value;
                        if(content) {
                            navigator.clipboard.writeText(content).then(() => {
                                alert('复制成功');
                            });
                        }
                        break;
                    }
                    case 'toggle-pin-snippet': {
                        closeModal();
                        const snippet = appData.snippets.find(s => s.id === Number(id));
                        if(snippet) {
                            snippet.isPinned = !snippet.isPinned;
                            await dbActions.put('snippets', snippet);
                            renderSnippetDetailList(); // 刷新列表，可以在列表渲染里根据isPinned改变样式（可选）
                        }
                        break;
                    }
                    
                    case 'show-page': showPage(page); break;
                    case 'back-to-my-page': showPage('my-page'); break;
                    case 'add-media': triggerFileUpload('image/*,video/*', true, 9, (mediaItem) => { quickDiaryData.media.push(mediaItem); alert('文件已添加'); }); break;
                    case 'add-audio': openAudioMenu(); break;
                    case 'set-custom-date': openCustomDateModal(); break;
                    case 'set-location': openLocationMenu(); break;
                    // 【修复】地点相关的action已移至 openLocationMenu 函数内部处理
                    case 'confirm-map-selection':
                        if (tempMapMarker) {
                            const latlng = tempMapMarker.getLatLng();
                            quickDiaryData.location = { type: 'map', lat: latlng.lat, lon: latlng.lng, name: `地图选点(${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)})` };
                            alert('地图选点成功！');
                            showPage('diary-page');
                        }
                        break;
                    case 'view-media': {
                        const diaryId = Number(target.closest('.diary-card').dataset.diaryId);
                        const mediaIndex = Number(target.closest('.media-item').dataset.index);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary && diary.media && diary.media[mediaIndex]) {
                            const mediaItem = diary.media[mediaIndex];
                            if (mediaItem.type === 'image') {
                                mediaViewerImage.src = mediaItem.src;
                                mediaViewerImage.style.display = 'block';
                                mediaViewerVideo.style.display = 'none';
                                mediaViewer.style.display = 'flex';
                            } else if (mediaItem.type === 'video') {
                                mediaViewerVideo.src = mediaItem.src;
                                mediaViewerVideo.style.display = 'block';
                                mediaViewerImage.style.display = 'none';
                                mediaViewer.style.display = 'flex';
                                mediaViewerVideo.play();
                            }
                        }
                        break;
                    }
                    case 'toggle-favorite': {
                        const diaryId = Number(actionTarget.closest('.diary-card').dataset.diaryId);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary) {
                            diary.isFavorite = !diary.isFavorite;
                            await dbActions.put('diaries', diary);
                            actionTarget.classList.toggle('fas', diary.isFavorite);
                            actionTarget.classList.toggle('far', !diary.isFavorite);
                            actionTarget.classList.toggle('favorited', diary.isFavorite);
                        }
                        break;
                    }
                    case 'toggle-pin': {
                        closeModal();
                        const diaryId = Number(id);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (!diary) return;
                        const isCurrentlyPinned = diary.isPinned;
                        appData.diaries.forEach(d => d.isPinned = false);
                        if (!isCurrentlyPinned) {
                            diary.isPinned = true;
                        }
                        for (const d of appData.diaries) {
                            await dbActions.put('diaries', d);
                        }
                        await refreshAllDataAndRender();
                        break;
                    }
                    case 'apply-font': {
                        const selectedValue = fontSelect.value;
                        if (!selectedValue) {
                            alert("请先选择一个字体！");
                            return;
                        }
                        
                        let fontSetting = { type: 'google', name: selectedValue };
                        
                        await dbActions.set('settings', 'font', fontSetting);
                        appData.settings.font = fontSetting;
                        await applyFont(fontSetting, true);
                        alert('字体应用成功！');
                        break;
                    }
                    case 'manage-font-preset': openFontPresetMenu(); break;
                    case 'upload-local-font': {
                        triggerFileUpload('.ttf,.otf,.woff,.woff2', false, 1, async (file) => {
                            tempFont = { type: 'local', name: file.name, data: file.src };
                            alert(`本地字体 "${file.name}" 已准备好，您可以点击“管理预设”将其保存。`);
                        });
                        break;
                    }
                    case 'reset-font': {
                        await dbActions.delete('settings', 'font');
                        appData.settings.font = null;
                        await applyFont(null, true);
                        renderFontSelection();
                        break;
                    }
                    case 'send-comment': {
                        const card = actionTarget.closest('.diary-card');
                        const input = card.querySelector('.comment-input-area input');
                        const diaryId = Number(card.dataset.diaryId);
                        if (!input.value.trim() || !diaryId) return;
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary) {
                            if (!diary.comments) diary.comments = [];
                            diary.comments.push({ id: Date.now(), authorId: appData.profile.id, content: input.value.trim(), timestamp: Date.now() });
                            await dbActions.put('diaries', diary);
                            const commentSection = card.querySelector('.comment-section');
                            commentSection.innerHTML = renderCommentsHTML(diaryId, diary.comments);
                            // 为新渲染的评论添加监听
                            commentSection.querySelectorAll('.comment').forEach(commentEl => {
                                addLongPressListener(commentEl, () => openCommentMenu(commentEl));
                            });
                            input.value = '';
                        }
                        break;
                    }
                    case 'toggle-comment-display': {
                        const card = actionTarget.closest('.diary-card');
                        const commentSection = card.querySelector('.comment-section');
                        commentSection.classList.toggle('active');
                        actionTarget.classList.toggle('active');
                        break;
                    }
                    case 'filter-notebook': {
                        const notebookId = actionTarget.dataset.id === 'all' ? 'all' : Number(actionTarget.dataset.id);
                        currentNotebookFilter = notebookId;
                        displayDiaries();
                        contentArea.scrollTop = 0;
                        renderNotebookPopup();
                        setTimeout(() => toggleNotebookPopup(false), 100);
                        break;
                    }
                    case 'quick-select-notebook': openQuickSelectNotebookModal(); break;
                    case 'add-notebook': openNotebookModal(); break;
                    case 'edit-profile': openProfileEditModal(); break;
                    case 'open-language-modal': openLanguageModal(); break;
                    case 'export-data': exportData(); break;
                    case 'import-data': importData(); break;
                    case 'show-diaries-for-date': {
                        const date = actionTarget.dataset.date;
                        const holiday = actionTarget.dataset.holiday;
                        
                        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        actionTarget.classList.add('selected');

                        selectedDateInfoEl.innerHTML = '';
                        if (holiday) {
                            selectedDateInfoEl.textContent = holiday;
                            selectedDateInfoEl.style.display = 'block';
                        } else {
                            selectedDateInfoEl.style.display = 'none';
                        }

                        const diaries = appData.diaries.filter(d => new Date(d.timestamp).toDateString() === date);
                        diariesForDateEl.innerHTML = '';
                        if (diaries.length > 0) {
                            diaries.sort((a,b) => b.timestamp - a.timestamp).forEach(d => diariesForDateEl.appendChild(createDiaryCard(d)));
                        } else {
                            diariesForDateEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 20px;">${getLangText('no_diaries')}</p>`;
                        }
                        break;
                    }
                    case 'add-mood': {
                        showPromptModal(getLangText('mood'), '请输入心情 (例如: 开心)', (mood) => {
                            if (mood) quickDiaryData.mood = mood;
                        });
                        break;
                    }
                    case 'add-weather': {
                        showPromptModal(getLangText('weather'), '请输入天气 (例如: 晴)', (weather) => {
                            if (weather) quickDiaryData.weather = weather;
                        });
                        break;
                    }
                    case 'reset-theme': {
                        delete appData.settings.theme[key];
                        await dbActions.set('settings', 'theme', appData.settings.theme);
                        applySettings();
                        break;
                    }
                    case 'upload-theme-image': {
                        triggerFileUpload('image/*', false, 1, async (file) => {
                            appData.settings.theme[key] = file.src;
                            await dbActions.set('settings', 'theme', appData.settings.theme);
                            applySettings();
                        });
                        break;
                    }
                    case 'apply-custom-css': {
                        const css = document.getElementById('custom-css-input').value;
                        appData.settings.customCss = css;
                        await dbActions.set('settings', 'customCss', css);
                        applyCustomCss(css);
                        alert('自定义样式已应用！');
                        break;
                    }
                    case 'reset-custom-css': {
                        showConfirmModal('确认重置', '确定要清除所有自定义CSS吗？', async () => {
                            appData.settings.customCss = '';
                            await dbActions.delete('settings', 'customCss');
                            applyCustomCss('');
                            document.getElementById('custom-css-input').value = '';
                        });
                        break;
                    }
                    case 'edit-diary': {
                        closeModal();
                        const diary = appData.diaries.find(d => d.id == id);
                        if (diary) openDiaryEditModal(diary);
                        break;
                    }
                    case 'delete-diary': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('diaries', Number(id));
                            await refreshAllDataAndRender();
                        });
                        break;
                    }
                     case 'copy-diary-content': {
                        closeModal();
                        const diary = appData.diaries.find(d => d.id == id);
                        if(diary && diary.content) {
                            const plainText = stripHtml(diary.content);
                            navigator.clipboard.writeText(plainText).then(() => {
                                alert(getLangText('copied_success'));
                            }).catch(err => console.error('复制失败: ', err));
                        }
                        break;
                    }
                    case 'export-diary-image': {
                        closeModal();
                        const cardToExport = document.querySelector(`.diary-card[data-diary-id="${id}"]`);
                        if (cardToExport && typeof html2canvas !== 'undefined') {
                            html2canvas(cardToExport, {
                                useCORS: true, // 允许加载跨域图片
                                backgroundColor: getComputedStyle(document.body).getPropertyValue('--card-bg'),
                            }).then(canvas => {
                                const link = document.createElement('a');
                                link.download = `diary-${id}.png`;
                                link.href = canvas.toDataURL("image/png").replace("image/png", "image/octet-stream");
                                link.click();
                                alert(getLangText('export_diary_success'));
                            });
                        }
                        break;
                    }
                    case 'copy-comment-content': {
                        closeModal();
                        const content = actionTarget.dataset.value;
                        if(content) {
                            navigator.clipboard.writeText(content).then(() => {
                                alert(getLangText('copied_success'));
                            }).catch(err => console.error('复制失败: ', err));
                        }
                        break;
                    }
                    case 'add-anniversary': openAddAnniversaryModal(); break;
                    case 'edit-anniversary': closeModal(); openAddAnniversaryModal(appData.anniversaries.find(item => item.id === Number(id))); break;
                    case 'delete-anniversary': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('anniversaries', Number(id));
                            await refreshAllDataAndRender();
                            renderAnniversaryPage();
                        });
                        break;
                    }
                    case 'toggle-pin-anniversary': await togglePinItem('anniversaries', Number(id), renderAnniversaryPage); break;
                    case 'change-anniversary-bg': await changeItemBackground('anniversaries', Number(id), renderAnniversaryPage); break;
                    case 'add-transaction': openAddTransactionModal(); break;
                    case 'edit-transaction': closeModal(); openAddTransactionModal(appData.transactions.find(item => item.id === Number(id))); break;
                    case 'delete-transaction': {
                         closeModal();
                         showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('transactions', Number(id));
                            await refreshAllDataAndRender();
                            renderAccountingPage();
                        });
                        break;
                    }
                    case 'add-snippet-collection': openAddSnippetCollectionModal(); break;
                    case 'toggle-snippet-collection': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        if (!collectionEl.classList.contains('manage-mode')) {
                            collectionEl.classList.toggle('expanded');
                        }
                        break;
                    }
                    case 'cancel-add-snippet': actionTarget.closest('.add-snippet-form').parentElement.innerHTML = `<button class="button button-primary" onclick="this.parentElement.innerHTML = document.getElementById('add-snippet-form-template').innerHTML.replace('__COLLECTION_ID__', ${actionTarget.closest('.snippet-collection').dataset.collectionId})" style="width: 100%; margin: 0;">${getLangText('add_snippet')}</button>`; break;
                    case 'save-snippet': {
                        const form = actionTarget.closest('.add-snippet-form');
                        const textarea = form.querySelector('textarea');
                        const content = textarea.value.trim();
                        const collectionId = Number(form.dataset.collectionId);
                        if (content) {
                            await dbActions.add('snippets', { collectionId, content, timestamp: Date.now() });
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                            const collectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${collectionId}"]`);
                            if (collectionEl) collectionEl.classList.add('expanded');
                        }
                        break;
                    }
                    case 'edit-snippet': closeModal(); openEditSnippetModal(appData.snippets.find(item => item.id === Number(id))); break;
                    case 'delete-snippet': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('snippets', Number(id));
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                        });
                        break;
                    }
                    case 'toggle-pin-snippet-collection': await togglePinItem('snippetCollections', Number(id), renderSnippetsPage); break;
                    case 'change-snippet-collection-bg': await changeItemBackground('snippetCollections', Number(id), renderSnippetsPage); break;
                    case 'manage-snippets': {
                        closeModal();
                        const collectionEl = document.querySelector(`.snippet-collection[data-collection-id="${id}"]`);
                        if (collectionEl) collectionEl.classList.add('manage-mode');
                        break;
                    }
                    
                    case 'change-cover': {
                        closeModal();
                        changeCollectionCover(Number(id));
                        break;
                    }
                    
                    case 'delete-snippet-collection': {
                        closeModal();
                        const collectionId = Number(id);
                        showConfirmModal('确认删除言语集', `确定要删除这个言语集以及它下面的所有言语吗？${getLangText('confirm_delete')}`, async () => {
                            await dbActions.delete('snippetCollections', collectionId);
                            const snippetsToDelete = appData.snippets.filter(s => s.collectionId === collectionId);
                            for (const snippet of snippetsToDelete) {
                                await dbActions.delete('snippets', snippet.id);
                            }
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                        });
                        break;
                    }
                    case 'cancel-snippet-manage': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        if (collectionEl) collectionEl.classList.remove('manage-mode');
                        break;
                    }
                    case 'delete-selected-snippets': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        const collectionId = Number(collectionEl.dataset.collectionId);
                        const checkedBoxes = collectionEl.querySelectorAll('.snippet-delete-checkbox:checked');
                        if (checkedBoxes.length === 0) {
                            alert('请先选择要删除的言语条');
                            return;
                        }
                        showConfirmModal('确认删除', `确定要删除这 ${checkedBoxes.length} 条言语吗？`, async () => {
                            const idsToDelete = Array.from(checkedBoxes).map(box => Number(box.dataset.snippetId));
                            for (const snippetId of idsToDelete) {
                                await dbActions.delete('snippets', snippetId);
                            }
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                            setTimeout(() => {
                                const refreshedCollectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${collectionId}"]`);
                                if (refreshedCollectionEl) refreshedCollectionEl.classList.add('expanded');
                            }, 100);
                        });
                        break;
                    }
                    // 中文注释：游戏相关操作
                    case 'select-game': {
                        document.querySelectorAll('.game-container').forEach(c => c.classList.remove('active'));
                        document.getElementById(`${game}-container`).classList.add('active');
                        
                        cleanupActiveGame(); // 清理上一个游戏
                        
                        activeGame.name = game;
                        // 初始化并开始新游戏
                        const gameClasses = {
                            gobang: Gobang, minesweeper: Minesweeper, snake: Snake, game2048: Game2048,
                            tetris: Tetris, tictactoe: TicTacToe, sudoku: Sudoku, blackjack: Blackjack,
                            planetdefender: PlanetDefender, lightsout: LightsOut, doodlejump: DoodleJump
                        };
                        if (gameClasses[game]) {
                            activeGame.instance = new gameClasses[game]();
                        }
                        break;
                    }
                    case 'start-gobang': if(activeGame.name === 'gobang') activeGame.instance.start(); break;
                    case 'start-minesweeper': if(activeGame.name === 'minesweeper') activeGame.instance.start(); break;
                    case 'start-snake': if(activeGame.name === 'snake') activeGame.instance.start(); break;
                    case 'start-game2048': if(activeGame.name === 'game2048') activeGame.instance.start(); break;
                    case 'start-tetris': if(activeGame.name === 'tetris') activeGame.instance.start(); break;
                    case 'start-tictactoe': if(activeGame.name === 'tictactoe') activeGame.instance.start(); break;
                    case 'start-blackjack': if(activeGame.name === 'blackjack') activeGame.instance.start(); break;
                    case 'start-sudoku': if(activeGame.name === 'sudoku') activeGame.instance.start(); break;
                    case 'check-sudoku': if(activeGame.name === 'sudoku') activeGame.instance.check(); break;
                    case 'hint-sudoku': if(activeGame.name === 'sudoku') activeGame.instance.hint(); break;
                    case 'start-planetdefender': if(activeGame.name === 'planetdefender') activeGame.instance.start(); break;
                    case 'start-lightsout': if(activeGame.name === 'lightsout') activeGame.instance.start(); break;
                    case 'start-doodlejump': if(activeGame.name === 'doodlejump') activeGame.instance.start(); break;
                }
                return;
            }

            if (target.closest('.nav-item')) { showPage(target.closest('.nav-item').dataset.page); }
            else if (target.closest('#topBarAvatar')) { toggleSideMenu(true); }
            else if (target.closest('#overlay')) { toggleSideMenu(false); }
            else if (target.closest('#notebook-icon')) { toggleNotebookPopup(notebookPopup.style.display !== 'block'); }
            else if (target.closest('#map-back-btn')) { showPage('diary-page'); }
            else if (target.closest('#prev-month')) { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
            else if (target.closest('#next-month')) { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
            else if (target.closest('#search-icon')) { searchContainer.classList.toggle('active'); if (searchContainer.classList.contains('active')) diarySearchInput.focus(); }
            else if (target.closest('.editor-collapsed-view')) { quickDiaryEditor.classList.add('expanded'); quickDiaryTextarea.focus(); }
            else if (target.id === 'media-viewer' || target.id === 'media-viewer-close') {
                mediaViewer.style.display = 'none';
                mediaViewerImage.src = '';
                mediaViewerVideo.src = '';
                mediaViewerVideo.pause();
            }
            // 处理游戏方向键点击
            else if (target.closest('.dpad-btn')) {
                const dir = target.closest('.dpad-btn').dataset.dir;
                if (activeGame.instance && typeof activeGame.instance.handleInput === 'function') {
                    activeGame.instance.handleInput(dir);
                }
            }
             else if (target.closest('.button-layout-container')) {
                const dir = target.closest('.dpad-btn')?.dataset.dir;
                if(dir && activeGame.instance && typeof activeGame.instance.handleInput === 'function') {
                    activeGame.instance.handleInput(dir);
                }
            }
            else {
                if (!target.closest('#notebook-popup') && !target.closest('#notebook-icon')) {
                    toggleNotebookPopup(false);
                }
            }
        });
        
        darkModeToggle.addEventListener('change', async () => {
            appData.settings.darkMode = darkModeToggle.checked;
            await dbActions.set('settings', 'darkMode', darkModeToggle.checked);
            await refreshAllDataAndRender();
        });

        lunarCalendarToggle.addEventListener('change', async () => {
            appData.settings.showLunarCalendar = lunarCalendarToggle.checked;
            await dbActions.set('settings', 'showLunarCalendar', lunarCalendarToggle.checked);
            renderCalendar();
        });

        holidayCalendarToggle.addEventListener('change', async () => {
            appData.settings.showHolidays = holidayCalendarToggle.checked;
            await dbActions.set('settings', 'showHolidays', holidayCalendarToggle.checked);
            renderCalendar();
        });
        
        // 中文注释：一个“防抖”函数，用于性能优化。比如在搜索框输入时，不会每输入一个字就搜索一次，而是等你停顿一小会再搜索。
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        diarySearchInput.addEventListener('input', debounce((e) => {
            displayDiaries(e.target.value.trim());
        }, 300));

        document.getElementById('theme-settings-page').addEventListener('input', async (e) => {
            if (e.target.type !== 'color') return;
            const key = e.target.id.replace('theme-', '').replace(/-(\w)/g, (_, p1) => p1.toUpperCase());
            appData.settings.theme[key] = e.target.value;
            await dbActions.set('settings', 'theme', appData.settings.theme);
            applySettings();
        });

        // =======================================================================
        // 8. 功能函数 (弹窗、数据处理等)
        // =======================================================================

        // 中文注释：显示一个通用的模态框（弹窗）。
        function showModal(title, bodyHtml, footerHtml, onSave) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">${title}</div>
                    <div class="modal-body">${bodyHtml}</div>
                    <div class="modal-footer">${footerHtml}</div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);
            
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            const cancelButton = modal.querySelector('#modal-cancel');
            if (cancelButton) cancelButton.onclick = closeModal;
            
            const saveButton = modal.querySelector('#modal-save');
            if (saveButton && onSave) saveButton.onclick = onSave;
        }

        // 中文注释：显示一个确认对话框（比如“确认删除吗？”）。
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-modal-content">
                    <div class="custom-modal-title">${title}</div>
                    <div class="custom-modal-message">${message}</div>
                    <div class="custom-modal-footer">
                        <button id="confirm-cancel">${getLangText('cancel')}</button>
                        <button id="confirm-ok" class="confirm-ok">OK</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);

            modal.querySelector('#confirm-cancel').onclick = closeModal;
            modal.querySelector('#confirm-ok').onclick = () => {
                onConfirm();
                closeModal();
            };
        }

        // 中文注释：显示一个带输入框的对话框。
        function showPromptModal(title, message, onConfirm, placeholder = '', inputType = 'text', defaultValue = '') {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-modal-content">
                    <div class="custom-modal-title">${title}</div>
                    <div class="custom-modal-message">${message}</div>
                    <input type="${inputType}" class="custom-modal-input" placeholder="${placeholder}" value="${defaultValue}">
                    <div class="custom-modal-footer">
                        <button id="confirm-cancel">${getLangText('cancel')}</button>
                        <button id="confirm-ok" class="confirm-ok">OK</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);

            const input = modal.querySelector('.custom-modal-input');
            input.focus();
            modal.querySelector('#confirm-cancel').onclick = closeModal;
            modal.querySelector('#confirm-ok').onclick = () => {
                onConfirm(input.value);
                closeModal();
            };
        }

        // 中文注释：显示一个操作菜单弹窗（比如长按后出现的“编辑/删除”菜单）。
        function showActionMenuModal(title, actions) {
            const actionItems = actions.map(action => 
                `<div class="menu-item" data-action="${action.action}" data-id="${action.id || ''}" data-value="${action.value || ''}">${action.text}</div>`
            ).join('');
            const bodyHtml = `<div class="menu-section">${actionItems}</div>`;
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `<div class="modal-content action-menu-modal"><div class="modal-header">${title}</div><div class="modal-body">${bodyHtml}</div></div>`;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function closeModal() {
            modalContainer.innerHTML = '';
        }

        // 中文注释：发送快速日记的函数。
        async function sendQuickDiary() {
            const sendButton = document.querySelector('.send-btn');
            if (sendButton.disabled) return;
            const content = quickDiaryTextarea.value;
            if (!content.trim() && quickDiaryData.media.length === 0) {
                alert('日记内容或媒体文件不能为空');
                return;
            }

            sendButton.disabled = true;
            sendButton.textContent = '发送中...';

            let locationData = null;
            if (quickDiaryData.location) {
                if (quickDiaryData.location.type === 'auto') {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000, enableHighAccuracy: false });
                        });
                        locationData = { 
                            type: 'auto',
                            lat: position.coords.latitude, 
                            lon: position.coords.longitude, 
                            name: '自动定位'
                        };
                    } catch (err) {
                        console.warn("自动获取地理位置失败:", err.message);
                        alert(getLangText('location_failed'));
                    }
                } else {
                    locationData = quickDiaryData.location;
                }
            }

            const diary = {
                id: Date.now(),
                timestamp: quickDiaryData.customTimestamp || Date.now(),
                content: content,
                mood: quickDiaryData.mood,
                weather: quickDiaryData.weather,
                notebookId: quickDiaryData.notebookId,
                media: quickDiaryData.media,
                location: locationData,
                comments: [],
                isFavorite: false,
                isPinned: false
            };

            await dbActions.put('diaries', diary);
            
            await refreshAllDataAndRender();
            
            quickDiaryTextarea.value = '';
            quickDiaryData = { media: [], mood: '', weather: '', location: null, notebookId: 1, customTimestamp: null };
            quickDiaryEditor.classList.remove('expanded');
            contentArea.scrollTop = 0;

            sendButton.disabled = false;
            sendButton.textContent = '发送';
        }
        
        function openDiaryMenu(diary) {
            const pinActionText = diary.isPinned ? getLangText('unpin_diary') : getLangText('pin_diary');
            showActionMenuModal('操作', [
                { text: pinActionText, action: 'toggle-pin', id: diary.id },
                { text: getLangText('copy'), action: 'copy-diary-content', id: diary.id },
                { text: getLangText('export_image'), action: 'export-diary-image', id: diary.id },
                { text: getLangText('edit'), action: 'edit-diary', id: diary.id },
                { text: getLangText('delete'), action: 'delete-diary', id: diary.id }
            ]);
        }

        function openCommentMenu(commentEl) {
            const content = commentEl.dataset.commentContent;
            showActionMenuModal('评论操作', [
                { text: getLangText('copy'), action: 'copy-comment-content', value: content }
            ]);
        }


        function openDiaryEditModal(diaryToEdit) {
            const notebookOptions = appData.notebooks.map(nb => 
                `<option value="${nb.id}" ${nb.id === diaryToEdit.notebookId ? 'selected' : ''}>${nb.name}</option>`
            ).join('');

            const bodyHtml = `
                <p>${getLangText('content')}:</p>
                <textarea id="diary-content-input">${diaryToEdit.content}</textarea>
                <p>${getLangText('mood')}: <input type="text" id="diary-mood-input" value="${diaryToEdit.mood || ''}"></p>
                <p>${getLangText('weather')}: <input type="text" id="diary-weather-input" value="${diaryToEdit.weather || ''}"></p>
                <p>${getLangText('notebook')}: <select id="diary-notebook-select">${notebookOptions}</select></p>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const updatedDiary = {
                    ...diaryToEdit,
                    content: document.getElementById('diary-content-input').value,
                    mood: document.getElementById('diary-mood-input').value,
                    weather: document.getElementById('diary-weather-input').value,
                    notebookId: Number(document.getElementById('diary-notebook-select').value),
                };
                await dbActions.put('diaries', updatedDiary);
                closeModal();
                await refreshAllDataAndRender();
            };

            showModal(getLangText('edit_diary'), bodyHtml, footerHtml, saveHandler);
        }
        
        function openQuickSelectNotebookModal() {
            const sortedNotebooks = [...appData.notebooks].sort((a, b) => a.id === 1 ? -1 : b.id === 1 ? 1 : 0);
            const notebookItems = sortedNotebooks.map(nb =>
                `<div class="menu-item" data-action="set-quick-notebook" data-id="${nb.id}" data-name="${nb.name}" style="border-bottom: 1px solid var(--border-color); ${nb.id === quickDiaryData.notebookId ? 'background-color: var(--accent-color); color: white;' : ''}">
                    <i class="fas fa-book" style="${nb.id === quickDiaryData.notebookId ? 'color: white;' : ''}"></i> ${nb.name}
                 </div>`
            ).join('');
            const bodyHtml = `<div class="menu-section" style="margin: -20px; border-radius: 0;">${notebookItems}</div>`;
            showModal(getLangText('select_notebook'), bodyHtml, `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button>`);
            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const notebookItem = e.target.closest('.menu-item[data-action="set-quick-notebook"]');
                if (notebookItem) {
                    quickDiaryData.notebookId = Number(notebookItem.dataset.id);
                    alert(`已选择: ${notebookItem.dataset.name}`);
                    closeModal();
                }
            });
        }

        function openAudioMenu() {
            showActionMenuModal(getLangText('add_audio'), [
                { text: getLangText('live_record'), action: 'record-audio' },
                { text: getLangText('upload_audio'), action: 'upload-audio-file' }
            ]);
            modalContainer.querySelector('.modal-content').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                closeModal();
                if (item.dataset.action === 'record-audio') {
                    startRecording();
                } else if (item.dataset.action === 'upload-audio-file') {
                    triggerFileUpload('audio/*', false, 1, (file) => {
                        quickDiaryData.media.push(file);
                        alert('音频已添加');
                    });
                }
            });
        }

        async function startRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        quickDiaryData.media.push({ type: 'audio', src: e.target.result });
                        alert('录音已添加');
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    closeModal();
                };
                mediaRecorder.start();
                showModal(getLangText('recording'), 
                    '<i class="fas fa-microphone-alt fa-beat" style="font-size: 40px; color: var(--danger-color);"></i>', 
                    `<button class="button button-danger" id="stop-recording-btn">${getLangText('stop_recording')}</button>`
                );
                document.getElementById('stop-recording-btn').onclick = () => mediaRecorder.stop();

            } catch (err) {
                console.error("录音错误:", err);
                alert(getLangText('record_failed'));
            }
        }

        // 【修复】将地点菜单的逻辑独立出来，避免全局事件监听的冲突
        function openLocationMenu() {
            showActionMenuModal(getLangText('set_location'), [
                { text: getLangText('auto_detect'), action: 'auto-detect-location' },
                { text: getLangText('select_on_map'), action: 'select-location-on-map' },
                { text: getLangText('manual_entry'), action: 'manual-entry' }
            ]);

            // 添加独立的事件监听器
            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item[data-action]');
                if (!item) return;

                const action = item.dataset.action;
                closeModal(); // 先关闭当前菜单

                switch (action) {
                    case 'auto-detect-location':
                        quickDiaryData.location = { type: 'auto' };
                        alert('已设为自动获取位置');
                        break;
                    case 'select-location-on-map':
                        showPage('map-page', { selectionMode: true });
                        break;
                    case 'manual-entry':
                        showPromptModal(getLangText('manual_entry'), getLangText('enter_location_name'), (name) => {
                            if (name) {
                                quickDiaryData.location = { type: 'manual', name: name };
                                alert(`地点已设为: ${name}`);
                            }
                        });
                        break;
                }
            });
        }


        function onMapClickForSelection(e) {
            if (tempMapMarker) map.removeLayer(tempMapMarker);
            tempMapMarker = L.marker(e.latlng).addTo(map);
            mapSelectionBar.style.display = 'block';
        }

        // =======================================================================
        // 7. 【字体库优化】
        // =======================================================================
        const googleFonts = {
            "默认": { "Default": "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif" },
            "中文 / CJK": {
                "得意黑": "'Smiley Sans', sans-serif",
                "思源宋体": "'Noto Serif SC', serif",
                "思源黑体": "'Noto Sans SC', sans-serif",
                "霞鹜文楷": "'LXGW WenKai', serif",
                "站酷快乐体": "'ZCOOL KuaiLe', cursive",
                "站酷酷黑": "'ZCOOL KuHei', sans-serif",
                "站酷小薇": "'ZCOOL XiaoWei', serif",
                "马善政毛笔": "'Ma Shan Zheng', cursive",
                "龙藏体": "'Long Cang', cursive",
                "植芒星手写": "'Zhi Mang Xing', cursive",
                "鸿雷板书": "'Honk', system-ui",
                "像素字体": "'Pixelify Sans', sans-serif",
                "圆体": "'M PLUS Rounded 1c', sans-serif",
                "台湾正黑体": "'Noto Sans TC', sans-serif",
                "日文黑体": "'Noto Sans JP', sans-serif",
                "韩文黑体": "'Noto Sans KR', sans-serif",
            },
            "英文衬线 / Serif": {
                "Merriweather": "'Merriweather', serif",
                "Playfair Display": "'Playfair Display', serif",
                "Lora": "'Lora', serif",
                "EB Garamond": "'EB Garamond', serif",
                "Roboto Slab": "'Roboto Slab', serif",
                "Cormorant": "'Cormorant', serif",
                "Bitter": "'Bitter', serif"
            },
            "英文无衬线 / Sans-serif": {
                "Roboto": "'Roboto', sans-serif",
                "Lato": "'Lato', sans-serif",
                "Montserrat": "'Montserrat', sans-serif",
                "Open Sans": "'Open Sans', sans-serif",
                "Nunito": "'Nunito', sans-serif",
                "Poppins": "'Poppins', sans-serif",
                "Raleway": "'Raleway', sans-serif",
                "Oswald": "'Oswald', sans-serif",
                "Bebas Neue": "'Bebas Neue', sans-serif",
                "Anton": "'Anton', sans-serif",
                "Varela Round": "'Varela Round', sans-serif", // 圆体
                "Kosugi Maru": "'Kosugi Maru', sans-serif" // 日式圆体
            },
            "手写 / Cursive": {
                "Dancing Script": "'Dancing Script', cursive",
                "Pacifico": "'Pacifico', cursive",
                "Caveat": "'Caveat', cursive",
                "Lobster": "'Lobster', cursive",
                "Indie Flower": "'Indie Flower', cursive",
                "Permanent Marker": "'Permanent Marker', cursive",
                "Shadows Into Light": "'Shadows Into Light', cursive",
                "Patrick Hand": "'Patrick Hand', cursive",
                "Gochi Hand": "'Gochi Hand', cursive",
                "Kalam": "'Kalam', cursive",
                "Zeyada": "'Zeyada', cursive",
                "Baloo 2": "'Baloo 2', cursive" // 可爱圆润
            },
            "等宽 / Monospace": {
                "Roboto Mono": "'Roboto Mono', monospace",
                "Source Code Pro": "'Source Code Pro', monospace",
                "Inconsolata": "'Inconsolata', monospace",
                "Space Mono": "'Space Mono', monospace"
            }
        };


        function renderFontSelection() {
            fontSelect.innerHTML = '';
            for (const groupName in googleFonts) {
                const group = document.createElement('optgroup');
                group.label = groupName;
                for (const fontName in googleFonts[groupName]) {
                    const option = document.createElement('option');
                    option.value = fontName;
                    option.textContent = fontName;
                    option.style.fontFamily = googleFonts[groupName][fontName];
                    if (appData.settings.font?.name === fontName) {
                        option.selected = true;
                    }
                    group.appendChild(option);
                }
                fontSelect.appendChild(group);
            }
        }
        
        // 【优化】简化字体应用逻辑，因为字体已在<head>中预加载
        async function applyFont(fontSetting, shouldSave) {
            const root = document.documentElement;
            if (!fontSetting || !fontSetting.name || fontSetting.name === "Default") {
                root.style.setProperty('--global-font-family', googleFonts["默认"]["Default"]);
                if (shouldSave) {
                    await dbActions.delete('settings', 'font');
                    appData.settings.font = null;
                }
                return;
            }

            for (const group in googleFonts) {
                if (googleFonts[group][fontSetting.name]) {
                    root.style.setProperty('--global-font-family', googleFonts[group][fontSetting.name]);
                    break;
                }
            }
        }

        function openCustomDateModal() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localDate = new Date(now - offset);
            const localISOString = localDate.toISOString().slice(0, 16);

            const bodyHtml = `<input type="datetime-local" id="custom-date-input" value="${localISOString}">`;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;

            const saveHandler = () => {
                const dateValue = document.getElementById('custom-date-input').value;
                if (dateValue) {
                    quickDiaryData.customTimestamp = new Date(dateValue).getTime();
                    alert('日期已设置！');
                    closeModal();
                }
            };

            showModal(getLangText('set_custom_date'), bodyHtml, footerHtml, saveHandler);
        }

        function applyFormatToTextarea(format) {
            const textarea = quickDiaryTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = selectedText;

            if (!selectedText) {
                alert("请先选中文本再应用格式");
                return;
            }

            switch (format) {
                case 'bold': replacement = `**${selectedText}**`; break;
                case 'italic': replacement = `*${selectedText}*`; break;
                case 'underline': replacement = `__${selectedText}__`; break;
                case 'strikethrough': replacement = `~~${selectedText}~~`; break;
                case 'link':
                    showPromptModal(getLangText('link_url'), getLangText('enter_link_url'), (url) => {
                        if (url) {
                            replacement = `[${selectedText}](${url})`;
                            textarea.setRangeText(replacement, start, end, 'end');
                        }
                    }, 'https://');
                    return;
            }

            textarea.setRangeText(replacement, start, end, 'end');
            textarea.focus();
        }

        async function exportData() {
            const dataToExport = { ...appData };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `platanus_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function importData() {
            showConfirmModal(getLangText('import_data'), getLangText('import_confirm'), () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const importedData = JSON.parse(ev.target.result);
                            await Promise.all([
                                dbActions.clear('profile'), dbActions.clear('diaries'), 
                                dbActions.clear('notebooks'), dbActions.clear('settings'),
                                dbActions.clear('anniversaries'), dbActions.clear('transactions'),
                                dbActions.clear('snippets'), dbActions.clear('snippetCollections')
                            ]);
                            
                            if(importedData.profile) await dbActions.set('profile', 'userProfile', importedData.profile);
                            if(importedData.diaries) for (const diary of importedData.diaries) await dbActions.put('diaries', diary);
                            if(importedData.notebooks) for (const notebook of importedData.notebooks) await dbActions.put('notebooks', notebook);
                            
                            if (importedData.settings) {
                                for (const key in importedData.settings) {
                                    await dbActions.set('settings', key, importedData.settings[key]);
                                }
                            }
                            
                            if(importedData.anniversaries) for (const item of importedData.anniversaries) await dbActions.put('anniversaries', item);
                            if(importedData.transactions) for (const item of importedData.transactions) await dbActions.put('transactions', item);
                            if(importedData.snippets) for (const item of importedData.snippets) await dbActions.put('snippets', item);
                            if(importedData.snippetCollections) for (const item of importedData.snippetCollections) await dbActions.put('snippetCollections', item);

                            alert(getLangText('import_success'));
                            await refreshAllDataAndRender();
                        } catch (err) {
                            alert('导入失败，文件格式错误！');
                            console.error(err);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });
        }

        function openProfileEditModal() {
            pendingProfileImages = { avatar: null, background: null };
            const bodyHtml = `
                <p>${getLangText('profile_name')}: <input type="text" id="profile-name-input" value="${appData.profile.name || ''}"></p>
                <p>${getLangText('profile_id')}: <input type="text" id="profile-id-input" value="${appData.profile.id || ''}"></p>
                <p>${getLangText('profile_bio')}: <textarea id="profile-bio-input">${appData.profile.bio || ''}</textarea></p>
                <button class="button button-secondary" id="upload-avatar-btn" style="width:100%; margin: 5px 0;">${getLangText('upload_avatar')}</button>
                <button class="button button-secondary" id="upload-background-btn" style="width:100%; margin: 5px 0;">${getLangText('upload_background')}</button>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const newProfile = {
                    ...appData.profile,
                    name: document.getElementById('profile-name-input').value,
                    id: document.getElementById('profile-id-input').value,
                    bio: document.getElementById('profile-bio-input').value,
                    avatar: pendingProfileImages.avatar || appData.profile.avatar,
                    background: pendingProfileImages.background || appData.profile.background,
                };
                await dbActions.set('profile', 'userProfile', newProfile);
                appData.profile = newProfile;
                updateProfileUI();
                closeModal();
            };

            showModal(getLangText('edit_profile'), bodyHtml, footerHtml, saveHandler);

            document.getElementById('upload-avatar-btn').onclick = () => {
                triggerFileUpload('image/*', false, 1, (file) => {
                    pendingProfileImages.avatar = file.src;
                    alert('新头像已准备好，点击保存后生效。');
                });
            };
            document.getElementById('upload-background-btn').onclick = () => {
                triggerFileUpload('image/*', false, 1, (file) => {
                    pendingProfileImages.background = file.src;
                    alert('新背景已准备好，点击保存后生效。');
                });
            };
        }

        function openLanguageModal() {
            const languages = [
                { code: 'zh-CN', name: '简体中文' },
                { code: 'zh-TW', name: '繁體中文' },
                { code: 'en', name: 'English' },
                { code: 'ja', name: '日本語' },
                { code: 'ko', name: '한국어' },
            ];
            const langActions = languages.map(lang => ({
                text: lang.name,
                action: 'select-language',
                value: lang.code
            }));
            showActionMenuModal(getLangText('select_language'), langActions);
            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const item = e.target.closest('.menu-item[data-action="select-language"]');
                if (item) {
                    const langCode = item.dataset.value;
                    await setLanguage(langCode);
                    closeModal();
                    toggleSideMenu(false);
                }
            });
        }

        function openNotebookModal(notebookToEdit = null) {
            const isEditing = !!notebookToEdit;
            const title = isEditing ? getLangText('edit_notebook_name') : getLangText('new_notebook');
            const nameValue = isEditing ? notebookToEdit.name : '';
            
            showPromptModal(title, getLangText('notebook_name'), async (name) => {
                if (name) {
                    if (isEditing) {
                        notebookToEdit.name = name;
                        await dbActions.put('notebooks', notebookToEdit);
                    } else {
                        const newNotebook = { id: Date.now(), name: name, cover: '' };
                        await dbActions.put('notebooks', newNotebook);
                    }
                    await refreshAllDataAndRender();
                }
            }, '', 'text', nameValue);
        }

        function openNotebookMenu(notebook) {
            if (notebook.id === 1) {
                showActionMenuModal(notebook.name, [
                    { text: getLangText('change_notebook_cover'), action: 'change-notebook-cover', id: notebook.id }
                ]);
            } else {
                showActionMenuModal(notebook.name, [
                    { text: getLangText('edit_notebook_name'), action: 'edit-notebook', id: notebook.id },
                    { text: getLangText('change_notebook_cover'), action: 'change-notebook-cover', id: notebook.id },
                    { text: getLangText('delete'), action: 'delete-notebook', id: notebook.id }
                ]);
            }

            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                const id = Number(item.dataset.id);
                const nb = appData.notebooks.find(n => n.id === id);
                closeModal();

                switch (action) {
                    case 'edit-notebook':
                        openNotebookModal(nb);
                        break;
                    case 'change-notebook-cover':
                        openNotebookCoverMenu(nb);
                        break;
                    case 'delete-notebook':
                        showConfirmModal(getLangText('delete'), getLangText('confirm_delete'), async () => {
                            await dbActions.delete('notebooks', id);
                            await refreshAllDataAndRender();
                        });
                        break;
                }
            });
        }

        function openNotebookCoverMenu(notebook) {
            showActionMenuModal(getLangText('change_notebook_cover'), [
                { text: getLangText('enter_cover_url'), action: 'set-cover-url', id: notebook.id },
                { text: getLangText('upload_from_local'), action: 'upload-cover-local', id: notebook.id }
            ]);

            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                closeModal();

                if (action === 'set-cover-url') {
                    showPromptModal(getLangText('enter_cover_url'), '', async (url) => {
                        if (url) {
                            notebook.cover = url;
                            await dbActions.put('notebooks', notebook);
                            await refreshAllDataAndRender();
                        }
                    });
                } else if (action === 'upload-cover-local') {
                    triggerFileUpload('image/*', false, 1, async (file) => {
                        notebook.cover = file.src;
                        await dbActions.put('notebooks', notebook);
                        await refreshAllDataAndRender();
                    });
                }
            });
        }

        function openFontPresetMenu() {
            showActionMenuModal(getLangText('manage_presets'), [
                { text: getLangText('save_as_preset'), action: 'save-font-preset' },
                { text: getLangText('delete_preset'), action: 'delete-font-preset' }
            ]);
            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                closeModal();
                if (action === 'save-font-preset') {
                    saveFontPreset();
                } else if (action === 'delete-font-preset') {
                    openDeleteFontPresetModal();
                }
            });
        }

        function saveFontPreset() {
            const url = fontUrlInput.value.trim();
            let fontToSave = null;

            if (url) {
                fontToSave = { type: 'url', url: url };
            } else if (tempFont.type === 'local') {
                fontToSave = tempFont;
            }

            if (!fontToSave) {
                alert('没有可保存的字体。请输入网络字体URL或上传本地字体文件。');
                return;
            }

            showPromptModal(getLangText('save_as_preset'), getLangText('enter_preset_name'), async (name) => {
                if (name) {
                    fontToSave.name = name;
                    appData.settings.fontPresets.push(fontToSave);
                    await dbActions.set('settings', 'fontPresets', appData.settings.fontPresets);
                    alert(`预设 "${name}" 已保存！`);
                    renderFontSelection();
                    fontUrlInput.value = '';
                    tempFont = { type: null, data: null, name: null };
                }
            }, fontToSave.name || 'My Custom Font');
        }

        function openDeleteFontPresetModal() {
            if (appData.settings.fontPresets.length === 0) {
                alert(getLangText('no_presets_to_delete'));
                return;
            }
            const presetsHtml = appData.settings.fontPresets.map(p => `
                <div class="delete-preset-item">
                    <span>${p.name}</span>
                    <button data-preset-name="${p.name}"><i class="fas fa-trash-alt"></i></button>
                </div>
            `).join('');
            
            showModal(getLangText('delete_preset'), presetsHtml, `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button>`);

            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-preset-name]');
                if (button) {
                    const presetName = button.dataset.presetName;
                    appData.settings.fontPresets = appData.settings.fontPresets.filter(p => p.name !== presetName);
                    await dbActions.set('settings', 'fontPresets', appData.settings.fontPresets);
                    alert(`预设 "${presetName}" 已删除。`);
                    closeModal();
                    renderFontSelection();
                }
            });
        }

        // =======================================================================
        // 9. 【新增/优化】新功能函数
        // =======================================================================

        // 修改后的：渲染纪念日页面
        function renderAnniversaryPage() {
            anniversaryListContainer.innerHTML = '';
            if (appData.anniversaries.length === 0) {
                anniversaryListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // 分离置顶项
            const pinnedItem = appData.anniversaries.find(a => a.isPinned);
            const otherItems = appData.anniversaries.filter(a => !a.isPinned).sort((a,b) => new Date(a.date) - new Date(b.date));

            // 1. 渲染置顶大卡片 (仿图二顶部)
            if (pinnedItem) {
                const days = calculateDays(pinnedItem.date);
                const isFuture = new Date(pinnedItem.date) > today;
                const label = isFuture ? '还有' : '已经';
                const color = pinnedItem.headerColor || 'var(--accent-color)'; // 跟随主题或自定义
                
                // 默认使用蓝色
                const card = document.createElement('div');
                card.className = `dm-pinned-card ${pinnedItem.styleType || 'dm-bg-flat'}`;
                card.style.backgroundColor = color;
                
                card.innerHTML = `
                    <div class="dm-header">
                        <span>${pinnedItem.name} ${label}</span>
                        <i class="fas fa-thumbtack" style="opacity:0.8"></i>
                    </div>
                    <div class="dm-body">
                        <div class="dm-days-big">${days}</div>
                        <div class="dm-label">${isFuture ? 'Days Left' : 'Days Gone'}</div>
                    </div>
                    <div class="dm-footer">${getLangText('target_day')}: ${pinnedItem.date}</div>
                `;
                card.onclick = () => openAnniversaryDetail(pinnedItem);
                anniversaryListContainer.appendChild(card);
            }

            // 2. 渲染普通列表 (仿图二列表)
            otherItems.forEach(item => {
                const days = calculateDays(item.date);
                const color = item.headerColor || 'var(--accent-color)';
                
                const el = document.createElement('div');
                el.className = 'dm-list-item';
                el.innerHTML = `
                    <div class="dm-list-strip" style="background-color: ${color};"></div>
                    <div class="dm-list-content">
                        <div class="dm-list-name">${item.name}</div>
                        <div class="dm-list-days" style="color:${color}">${days} <span style="font-size:12px;color:var(--secondary-text)">Days</span></div>
                    </div>
                `;
                // 长按删除，短按进入详情
                addLongPressListener(el, () => showActionMenuModal(item.name, [
    {text: item.isPinned ? getLangText('unpin') : getLangText('pin'), action:'toggle-pin-anniversary', id:item.id},
    {text: getLangText('delete'), action:'delete-anniversary', id:item.id}
]));
                el.onclick = () => openAnniversaryDetail(item);
                anniversaryListContainer.appendChild(el);
            });
        }

        // 辅助：计算天数
        function calculateDays(dateStr) {
            const today = new Date();
            today.setHours(0,0,0,0);
            const target = new Date(dateStr);
            target.setHours(0,0,0,0);
            return Math.ceil(Math.abs(target - today) / (1000 * 60 * 60 * 24));
        }
        
        // 生成里程碑数据 (目标日或纪念日)
        function generateMilestones(dateStr, type) {
            const targetDate = new Date(dateStr); targetDate.setHours(0,0,0,0);
            const today = new Date(); today.setHours(0,0,0,0);
            const list = [];
            const isFuture = targetDate > today;
            
            // 格式化日期辅助函数
            const fmt = d => `${d.getFullYear()}.${d.getMonth()+1}.${d.getDate()}`;
            const weekMap = ['周日','周一','周二','周三','周四','周五','周六'];

            if (type === 'target_day' || isFuture) {
                // === 目标日模式 (倒数) ===
                // 1. 刚好是这一天
                const diff = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));
                list.push({ label: '目标日', date: fmt(targetDate) + ' ' + weekMap[targetDate.getDay()], value: diff + ' 天' });

                // 2. 倒数整百天
                [10, 50, 100, 200, 300, 500, 1000].forEach(d => {
                     if (diff > d) { // 如果目标比现在还远d天以上
                         const checkDate = new Date(today.getTime() + (diff - d) * 86400000); // 还有d天的那一天
                         list.push({ label: `倒数 ${d} 天还有`, date: fmt(checkDate) + ' ' + weekMap[checkDate.getDay()], value: Math.ceil((checkDate - today)/86400000) + ' 天' });
                     } else if (d > diff) { // 如果d天比目标还远 (比如目标是10天后，我要看100天后) - 不适用倒数日逻辑
                     }
                });
            } else {
                // === 纪念日模式 (正数 - 累计) ===
                const diff = Math.ceil((today - targetDate) / (1000 * 60 * 60 * 24));
                list.push({ label: '起始日', date: fmt(targetDate) + ' ' + weekMap[targetDate.getDay()], value: '第 ' + diff + ' 天' });

                // 1. 周年
                for (let i = 1; i <= 10; i++) {
                     const nextAnn = new Date(targetDate);
                     nextAnn.setFullYear(targetDate.getFullYear() + i);
                     const daysLeft = Math.ceil((nextAnn - today) / (86400000));
                     if (daysLeft > 0) {
                         list.push({ label: `${i} 周年纪念日`, date: fmt(nextAnn) + ' ' + weekMap[nextAnn.getDay()], value: daysLeft + ' 天后' });
                     }
                }
                
                // 2. 累计整百天
                [100, 500, 1000, 2000, 3000, 520, 1314].forEach(d => {
                     const milestoneDate = new Date(targetDate.getTime() + d * 86400000);
                     if (milestoneDate > today) {
                         const daysLeft = Math.ceil((milestoneDate - today) / 86400000);
                         list.push({ label: `${d} 天纪念日`, date: fmt(milestoneDate) + ' ' + weekMap[milestoneDate.getDay()], value: daysLeft + ' 天后' });
                     }
                });
            }
            return list.sort((a,b) => parseInt(a.value) - parseInt(b.value)); // 按天数排序
        }
        
        
        // === 新增逻辑：纪念日详情页 ===
        let currentAnniversary = null;
        let isShowDateMode = false; // 是否显示具体日期模式

        function openAnniversaryDetail(item) {
            currentAnniversary = item;
            isShowDateMode = false; // 重置为显示天数
            const page = document.getElementById('anniversary-detail-page');
            const container = document.getElementById('anniversary-detail-content');
            
            page.classList.add('active');
            renderAnniversaryDetailCard();
            
            // 绑定设置按钮
            document.getElementById('anniversary-setting-btn').onclick = () => openAnniversarySettings(item);
        }

        function closeAnniversaryDetail() {
            document.getElementById('anniversary-detail-page').classList.remove('active');
            currentAnniversary = null;
            renderAnniversaryPage(); // 刷新列表
        }
        // 绑定到 window 确保 HTML 能调用
        window.closeAnniversaryDetail = closeAnniversaryDetail;

        // 渲染详情页卡片 (核心逻辑)
        // 渲染详情页卡片 (更新版：支持文字颜色和背景纹理)
        function renderAnniversaryDetailCard() {
            if (!currentAnniversary) return;
            const container = document.getElementById('anniversary-detail-content');
            const pageBg = document.getElementById('anniversary-page-bg');
            const item = currentAnniversary;
            const today = new Date(); today.setHours(0,0,0,0);
            const isFuture = new Date(item.date) > today;
            
            // 获取样式设置
            const headerColor = item.headerColor || 'var(--accent-color)';
            const headerTextColor = item.headerTextColor || '#ffffff'; // 新增
            const headerTex = item.headerTex || 'dm-tex-flat';
            
            const bodyColor = item.bodyColor || (document.body.classList.contains('dark-mode') ? '#1c1c1e' : '#ffffff');
            const bodyTextColor = item.bodyTextColor || (document.body.classList.contains('dark-mode') ? '#ffffff' : '#333333'); // 新增
            const bodyTex = item.bodyTex || 'dm-tex-flat';
            
            const pageBgSet = item.pageBg || null;
            const pageBgTex = item.pageBgTex || ''; // 新增
            const cardBgImg = item.cardBgImg || null;

            // 设置页面大背景 (增加纹理支持)
            pageBg.className = pageBgTex; // 应用纹理类
            if (pageBgSet) {
                if (pageBgSet.startsWith('#')) pageBg.style.backgroundColor = pageBgSet;
                else {
                     pageBg.style.backgroundImage = `url(${pageBgSet})`;
                     pageBg.style.backgroundColor = 'transparent';
                }
            } else {
                pageBg.style.backgroundImage = 'none';
                pageBg.style.backgroundColor = 'var(--global-bg)';
            }

            let days = calculateDays(item.date);
            let subText = (item.annType === 'target' || isFuture) ? 'Days Left' : 'Days Gone';
            let cardContentHtml = '';

            if (isShowDateMode) {
                // 列表视图
                const milestones = generateMilestones(item.date, item.annType || (isFuture ? 'target_day' : 'anniversary'));
                let listHtml = milestones.map(m => `
                    <div class="dm-milestone-item">
                        <div>
                            <div style="font-weight:bold;">${m.label}</div>
                            <div class="dm-ms-date">${m.date}</div>
                        </div>
                        <div class="dm-ms-value">${m.value}</div>
                    </div>
                `).join('');
                
                cardContentHtml = `
                    <div class="dm-milestone-list" style="overflow-y:auto; max-height:400px; border-radius:15px; color: var(--primary-text);">
                        ${listHtml}
                    </div>
                `;
            } else {
                // 大数字视图
                let bodyStyle = `background-color: ${bodyColor}; color: ${bodyTextColor};`;
                if (cardBgImg) {
                    bodyStyle = `background-image: url(${cardBgImg}); background-size: cover; color: ${bodyTextColor}; text-shadow: 0 1px 3px rgba(0,0,0,0.5);`;
                }

                cardContentHtml = `
                    <div class="dm-detail-header-area ${headerTex}" style="background-color: ${headerColor}; color: ${headerTextColor};">
                        <div style="font-size: 22px; font-weight: bold;">${item.name}</div>
                        <div style="font-size: 14px; opacity: 0.9; margin-top:5px; position:absolute; bottom:15px;">${isFuture ? '目标日' : '起始日'}: ${item.date}</div>
                    </div>
                    <div class="dm-detail-body-area ${!cardBgImg ? bodyTex : ''}" style="${bodyStyle}">
                        <div style="font-size: 80px; font-weight: bold; line-height: 1;">${days}</div>
                        <div style="font-size: 24px; opacity: 0.8; margin-top: 10px;">${subText}</div>
                    </div>
                    <div class="dm-paper-stack"></div>
                `;
            }

            container.innerHTML = `
                <div class="dm-detail-card" id="dm-click-target">
                    ${cardContentHtml}
                </div>
            `;
            
            document.getElementById('dm-click-target').onclick = () => {
                isShowDateMode = !isShowDateMode;
                renderAnniversaryDetailCard();
            };
        }
        

        // 打开设置菜单 (全面升级版)
        // 纪念日设置菜单 (修复颜色选择，新增纹理和字体颜色)
        function openAnniversarySettings(item) {
            // 预设颜色列表
            const colors = ['#007aff', '#ff3b30', '#ff9500', '#4cd964', '#5856d6', '#ff2d55', '#5ac8fa', '#2c2c2e', '#ffffff', '#000000'];
            
            // 辅助函数：生成颜色选项 HTML
            const renderColorOpts = (targetId) => `
                <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:5px; padding:5px 0;">
                    ${colors.map(c => `<div class="ann-color-swatch" style="background-color:${c};" onclick="selectAnnColor('${targetId}', '${c}', this)"></div>`).join('')}
                    <!-- 自定义颜色输入框，改为点击触发 -->
                    <div style="position:relative; width:30px; height:30px; border-radius:50%; border:2px solid var(--secondary-text); display:flex; align-items:center; justify-content:center;">
                        <i class="fas fa-palette" style="font-size:12px;"></i>
                        <input type="color" onchange="selectAnnColor('${targetId}', this.value, this.parentElement)" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0;">
                    </div>
                </div>`;

            const bodyHtml = `
                <div class="setting-group">
                    <span class="setting-label">基础信息</span>
                    <p>名称：<input type="text" id="set-name" value="${item.name}"></p>
                    <p>日期：<input type="date" id="set-date" value="${item.date}"></p>
                    <p>类型：
                        <select id="set-type">
                            <option value="anniversary" ${item.annType!=='target'?'selected':''}>纪念日 (累计)</option>
                            <option value="target" ${item.annType==='target'?'selected':''}>目标日 (倒数)</option>
                        </select>
                    </p>
                </div>

                <div class="setting-group">
                    <span class="setting-label">头部样式 (Header)</span>
                    <p style="font-size:12px;color:#888;">背景颜色：</p>
                    ${renderColorOpts('headerColor')}
                    <input type="hidden" id="set-headerColor" value="${item.headerColor || '#007aff'}">
                    
                    <p style="font-size:12px;color:#888;margin-top:5px;">文字颜色 (新增)：</p>
                    ${renderColorOpts('headerTextColor')}
                    <input type="hidden" id="set-headerTextColor" value="${item.headerTextColor || '#ffffff'}">

                    <p style="margin-top:5px;">纹理：
                        <select id="set-headerTex">
                            <option value="dm-tex-flat">纯色</option>
                            <option value="dm-tex-polka">波点</option>
                            <option value="dm-tex-stripe">条纹</option>
                            <option value="dm-tex-grid">网格</option>
                            <option value="dm-tex-wave">波浪</option>
                        </select>
                    </p>
                </div>

                <div class="setting-group">
                    <span class="setting-label">卡片主体样式 (Body)</span>
                    <p style="font-size:12px;color:#888;">背景颜色：</p>
                    ${renderColorOpts('bodyColor')}
                    <input type="hidden" id="set-bodyColor" value="${item.bodyColor || '#ffffff'}">

                    <p style="font-size:12px;color:#888;margin-top:5px;">文字颜色 (新增)：</p>
                    ${renderColorOpts('bodyTextColor')}
                    <input type="hidden" id="set-bodyTextColor" value="${item.bodyTextColor || '#333333'}">

                    <p style="margin-top:5px;">纹理：
                        <select id="set-bodyTex">
                            <option value="dm-tex-flat">纯色</option>
                            <option value="dm-tex-polka">波点</option>
                            <option value="dm-tex-stripe">条纹</option>
                            <option value="dm-tex-grid">网格</option>
                        </select>
                    </p>
                    <button class="button button-secondary" style="width:100%; margin:5px 0;" onclick="uploadCardImg()">上传卡片背景图</button>
                    <input type="hidden" id="set-cardBgImg" value="${item.cardBgImg || ''}">
                </div>

                <div class="setting-group">
                    <span class="setting-label">页面大背景</span>
                    <button class="button button-secondary" style="width:100%; margin-bottom:5px;" onclick="uploadPageBg()">上传背景图</button>
                    <p style="font-size:12px;color:#888;">或选择纯色背景：</p>
                    ${renderColorOpts('pageBg')}
                    <input type="hidden" id="set-pageBg" value="${item.pageBg || ''}">
                    
                    <p style="margin-top:5px;">背景纹理 (新增)：
                        <select id="set-pageBgTex">
                            <option value="">无纹理</option>
                            <option value="dm-tex-polka">波点</option>
                            <option value="dm-tex-stripe">条纹</option>
                            <option value="dm-tex-grid">网格</option>
                        </select>
                    </p>
                </div>

                <button class="button button-danger" id="btn-delete-ann" style="width:100%; margin-top:10px;">删除此纪念日</button>
            `;
            
            showModal('纪念日设置', bodyHtml, `
                <button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button>
                <button class="button button-primary" id="modal-save">${getLangText('save')}</button>
            `);

            // 初始化下拉框
            document.getElementById('set-headerTex').value = item.headerTex || 'dm-tex-flat';
            document.getElementById('set-bodyTex').value = item.bodyTex || 'dm-tex-flat';
            document.getElementById('set-pageBgTex').value = item.pageBgTex || '';

            // 全局函数挂载 (用于 onclick)
            window.selectAnnColor = (targetId, color, el) => {
                document.getElementById('set-' + targetId).value = color;
                // 视觉反馈
                const parent = el.parentElement;
                parent.querySelectorAll('.ann-color-swatch, div').forEach(d => d.style.border = '2px solid transparent');
                if (el.tagName === 'DIV') el.style.border = '2px solid var(--primary-text)';
            };
            
            window.uploadCardImg = () => {
                triggerFileUpload('image/*', false, 1, (f) => { document.getElementById('set-cardBgImg').value = f.src; alert('卡片背景已选'); });
            };
            window.uploadPageBg = () => {
                triggerFileUpload('image/*', false, 1, (f) => { document.getElementById('set-pageBg').value = f.src; alert('页面背景已选'); });
            };

            // 删除
            document.getElementById('btn-delete-ann').onclick = () => {
                showConfirmModal('确认删除', '确定要删除这个纪念日吗？', async () => {
                    await dbActions.delete('anniversaries', item.id);
                    closeAnniversaryDetail();
                });
            };

            // 保存
            document.getElementById('modal-save').onclick = async () => {
                item.name = document.getElementById('set-name').value;
                item.date = document.getElementById('set-date').value;
                item.annType = document.getElementById('set-type').value;
                
                item.headerColor = document.getElementById('set-headerColor').value;
                item.headerTextColor = document.getElementById('set-headerTextColor').value; // 新增
                item.headerTex = document.getElementById('set-headerTex').value;
                
                item.bodyColor = document.getElementById('set-bodyColor').value;
                item.bodyTextColor = document.getElementById('set-bodyTextColor').value; // 新增
                item.bodyTex = document.getElementById('set-bodyTex').value;
                
                item.cardBgImg = document.getElementById('set-cardBgImg').value;
                item.pageBg = document.getElementById('set-pageBg').value;
                item.pageBgTex = document.getElementById('set-pageBgTex').value; // 新增

                await dbActions.put('anniversaries', item);
                renderAnniversaryDetailCard();
                closeModal();
                
                delete window.selectAnnColor; delete window.uploadCardImg; delete window.uploadPageBg;
            };
        }
        
        

        function openAddAnniversaryModal(itemToEdit = null) {
            const isEditing = !!itemToEdit;
            const title = isEditing ? getLangText('edit_anniversary') : getLangText('add_anniversary');
            const bodyHtml = `
                <p>${getLangText('anniversary_name')}:</p>
                <input type="text" id="anniversary-name-input" value="${isEditing ? itemToEdit.name : ''}">
                <p>${getLangText('anniversary_date')}:</p>
                <input type="date" id="anniversary-date-input" value="${isEditing ? itemToEdit.date : ''}">
                <p>${getLangText('anniversary_type')}:</p>
                <select id="anniversary-type-select">
                    <option value="anniversary" ${isEditing && itemToEdit.type === 'anniversary' ? 'selected' : ''}>${getLangText('anniversary')}</option>
                    <option value="target_day" ${isEditing && itemToEdit.type === 'target_day' ? 'selected' : ''}>${getLangText('target_day')}</option>
                </select>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const name = document.getElementById('anniversary-name-input').value;
                const date = document.getElementById('anniversary-date-input').value
                
                const type = document.getElementById('anniversary-type-select').value;
                if (!name || !date) {
                    alert('名称和日期不能为空！');
                    return;
                }
                if (isEditing) {
                    itemToEdit.name = name;
                    itemToEdit.date = date;
                    itemToEdit.type = type;
                    await dbActions.put('anniversaries', itemToEdit);
                } else {
                    await dbActions.add('anniversaries', { name, date, type, isPinned: false, background: null });
                }
                await refreshAllDataAndRender();
                renderAnniversaryPage();
                closeModal();
            };
            showModal(title, bodyHtml, footerHtml, saveHandler);
        }

        function openAnniversaryMenu(item) {
            const pinText = item.isPinned ? getLangText('unpin') : getLangText('pin');
            showActionMenuModal(item.name, [
                { text: getLangText('edit'), action: 'edit-anniversary', id: item.id },
                { text: pinText, action: 'toggle-pin-anniversary', id: item.id },
                { text: getLangText('change_background'), action: 'change-anniversary-bg', id: item.id },
                { text: getLangText('delete'), action: 'delete-anniversary', id: item.id }
            ]);
        }

        accountingControls.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('[data-view]');
            const navBtn = e.target.closest('[data-nav]');
            if (viewBtn) {
                accountingState.view = viewBtn.dataset.view;
                renderAccountingPage();
            }
            if (navBtn) {
                const direction = navBtn.dataset.nav === 'next' ? 1 : -1;
                const d = accountingState.date;
                if (accountingState.view === 'day') d.setDate(d.getDate() + direction);
                if (accountingState.view === 'month') d.setMonth(d.getMonth() + direction);
                if (accountingState.view === 'year') d.setFullYear(d.getFullYear() + direction);
                renderAccountingPage();
            }
        });

        function renderAccountingPage() {
            const { view, date } = accountingState;
            
            accountingControls.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));
            accountingControls.querySelector(`[data-view="${view}"]`).classList.add('active');

            let start, end, periodLabel;
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();

            if (view === 'day') {
                start = new Date(year, month, day);
                end = new Date(year, month, day + 1);
                periodLabel = date.toLocaleDateString(appData.settings.language.replace('_', '-'));
            } else if (view === 'month') {
                start = new Date(year, month, 1);
                end = new Date(year, month + 1, 1);
                periodLabel = `${year} ${getLangText('year')} ${month + 1}${getLangText('month')}`;
            } else { // year
                start = new Date(year, 0, 1);
                end = new Date(year + 1, 0, 1);
                periodLabel = `${year} ${getLangText('year')}`;
            }
            document.getElementById('accounting-current-period').textContent = periodLabel;

            const periodTransactions = appData.transactions.filter(t => t.timestamp >= start.getTime() && t.timestamp < end.getTime());

            let totalIncome = 0, totalExpense = 0;
            periodTransactions.forEach(t => {
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            const balance = totalIncome - totalExpense;

            accountingSummaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="label">${getLangText('total_income')}</div>
                    <div class="amount income">+${totalIncome.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">${getLangText('total_expense')}</div>
                    <div class="amount expense">-${totalExpense.toFixed(2)}</div>
                </div>
                <div class="summary-card balance">
                    <div class="label">${getLangText('balance')}</div>
                    <div class="amount">${balance.toFixed(2)}</div>
                </div>
            `;

            transactionListContainer.innerHTML = '';
            if (periodTransactions.length === 0) {
                transactionListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }

            const grouped = periodTransactions.reduce((acc, t) => {
                const dateStr = new Date(t.timestamp).toLocaleDateString(appData.settings.language.replace('_', '-'));
                if (!acc[dateStr]) acc[dateStr] = [];
                acc[dateStr].push(t);
                return acc;
            }, {});

            Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(dateStr => {
                const groupEl = document.createElement('div');
                groupEl.className = 'transaction-group';
                groupEl.innerHTML = `<div class="transaction-group-header">${dateStr}</div>`;
                
                grouped[dateStr].sort((a, b) => b.timestamp - a.timestamp).forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'transaction-item';
                    const amountPrefix = t.type === 'income' ? '+' : '-';
                    el.innerHTML = `
                        <div class="transaction-info">
                            <div class="desc">${t.description}</div>
                            <div class="date">${new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <div class="transaction-amount ${t.type}">${amountPrefix}${t.amount.toFixed(2)}</div>
                    `;
                    addLongPressListener(el, () => openTransactionMenu(t));
                    groupEl.appendChild(el);
                });
                transactionListContainer.appendChild(groupEl);
            });
        }

        function openAddTransactionModal(itemToEdit = null) {
            const isEditing = !!itemToEdit;
            const title = isEditing ? getLangText('edit_transaction') : getLangText('add_transaction');
            const bodyHtml = `
                <p>${getLangText('transaction_type')}:</p>
                <select id="transaction-type-select">
                    <option value="expense" ${isEditing && itemToEdit.type === 'expense' ? 'selected' : ''}>${getLangText('expense')}</option>
                    <option value="income" ${isEditing && itemToEdit.type === 'income' ? 'selected' : ''}>${getLangText('income')}</option>
                </select>
                <p>${getLangText('amount')}:</p>
                <input type="number" id="transaction-amount-input" placeholder="0.00" value="${isEditing ? itemToEdit.amount : ''}">
                <p>${getLangText('description')}:</p>
                <input type="text" id="transaction-desc-input" value="${isEditing ? itemToEdit.description : ''}">
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const type = document.getElementById('transaction-type-select').value;
                const amount = parseFloat(document.getElementById('transaction-amount-input').value);
                const description = document.getElementById('transaction-desc-input').value;
                if (!description || isNaN(amount) || amount <= 0) {
                    alert('描述和有效的金额不能为空！');
                    return;
                }
                if (isEditing) {
                    itemToEdit.type = type;
                    itemToEdit.amount = amount;
                    itemToEdit.description = description;
                    await dbActions.put('transactions', itemToEdit);
                } else {
                    await dbActions.add('transactions', { type, amount, description, timestamp: Date.now() });
                }
                await refreshAllDataAndRender();
                renderAccountingPage();
                closeModal();
            };
            showModal(title, bodyHtml, footerHtml, saveHandler);
        }

        function openTransactionMenu(item) {
            showActionMenuModal(item.description, [
                { text: getLangText('edit'), action: 'edit-transaction', id: item.id },
                { text: getLangText('delete'), action: 'delete-transaction', id: item.id }
            ]);
        }

        // 修改后的：渲染言语集（九宫格书架模式）
        function renderSnippetsPage() {
            snippetCollectionContainer.innerHTML = '';
            // 如果没有言语集
            if (appData.snippetCollections.length === 0) {
                snippetCollectionContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }

            // 创建网格容器
            const grid = document.createElement('div');
            grid.className = 'snippet-grid';

            // 排序
            const sortedCollections = [...appData.snippetCollections].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return (a.name || '').localeCompare(b.name || '');
            });

            // 生成每一个“书本”
            sortedCollections.forEach(collection => {
                const book = document.createElement('div');
                book.className = 'snippet-book-card';
                book.dataset.id = collection.id;

                // 如果有封面图
                let coverHtml = '';
                if (collection.cover) {
                    coverHtml = `<img src="${collection.cover}" class="snippet-book-cover">`;
                }

                // 书名
                const pinnedIcon = collection.isPinned ? '<i class="fas fa-thumbtack" style="margin-right:4px;color:var(--accent-color)"></i>' : '';
                
                book.innerHTML = `
                    ${coverHtml}
                    <div class="snippet-book-info">${pinnedIcon}${collection.name}</div>
                `;

                // 点击进入详情页
                book.onclick = () => openSnippetDetail(collection.id);

                // 长按菜单（修改封面、删除等）
                addLongPressListener(book, () => openSnippetCollectionMenu(collection));

                grid.appendChild(book);
            });

            snippetCollectionContainer.appendChild(grid);
        }
        
        // === 新增逻辑：言语集详情页控制 ===
        let currentCollectionId = null;
        let isSnippetManageMode = false;

        // 打开详情页
        function openSnippetDetail(id) {
            currentCollectionId = id;
            const collection = appData.snippetCollections.find(c => c.id === id);
            if (!collection) return;

            const page = document.getElementById('snippet-detail-page');
            const title = document.getElementById('snippet-detail-title');
            const list = document.getElementById('snippet-detail-list');
            const menuBtn = document.getElementById('snippet-detail-menu-btn');

            // 设置背景（这是内部背景，不是封面）
            if (collection.background) {
                page.style.backgroundImage = `url(${collection.background})`;
            } else {
                page.style.backgroundImage = 'none';
            }

            title.textContent = collection.name;
            page.classList.add('active');
            
            // 退出管理模式
            exitSnippetManageMode();

            // 渲染列表
            renderSnippetDetailList();

            // 绑定菜单按钮
            menuBtn.onclick = () => openSnippetDetailMenu(collection);
            
            // 绑定发送按钮
            document.getElementById('snippet-quick-send').onclick = sendSnippetQuick;
        }

        // 关闭详情页
        window.closeSnippetDetail = function() {
            document.getElementById('snippet-detail-page').classList.remove('active');
            currentCollectionId = null;
            renderSnippetsPage(); // 刷新封面列表
        };

        
        // 渲染言语集详情列表 (修复版)
       // 渲染言语集详情列表 (新版UI：心形+长条)
        function renderSnippetDetailList() {
            const list = document.getElementById('snippet-detail-list');
            list.innerHTML = '';
            
            // 按时间倒序，最新的在最上面
            const snippets = appData.snippets
                .filter(s => s.collectionId === currentCollectionId)
                .sort((a, b) => b.timestamp - a.timestamp);

            if (snippets.length === 0) {
                list.innerHTML = `<p style="text-align:center;color:var(--secondary-text);padding-top:50px;">这里空空的...</p>`;
                return;
            }

            snippets.forEach(snippet => {
                const item = document.createElement('div');
                // 根据模式判断是否添加 select-mode 类
                item.className = isSnippetManageMode ? 'snippet-item select-mode' : 'snippet-item';
                
                // 格式化时间，只显示 时:分 (或者你可以改回 toLocaleString 显示完整日期)
                const dateObj = new Date(snippet.timestamp);
                // 简单的日期格式：月/日 时:分
                const timeStr = `${dateObj.getMonth()+1}/${dateObj.getDate()} ${dateObj.getHours().toString().padStart(2,'0')}:${dateObj.getMinutes().toString().padStart(2,'0')}`;

                item.innerHTML = `
                    <input type="checkbox" class="snippet-select-checkbox" data-id="${snippet.id}">
                    
                    <!-- 左侧爱心图标 -->
                    <i class="fas fa-heart snippet-heart-icon"></i>
                    
                    <!-- 右侧长条内容 -->
                    <div class="snippet-bubble">
                        <div class="snippet-content-text">${formatRichText(snippet.content)}</div>
                        <div class="snippet-time-tag">${timeStr}</div>
                    </div>
                `;

                if (isSnippetManageMode) {
                    item.onclick = (e) => {
                        if (e.target.type !== 'checkbox') {
                            const cb = item.querySelector('input');
                            cb.checked = !cb.checked;
                        }
                        updateSelectedCount();
                    };
                } else {
                    addLongPressListener(item, () => openSnippetMenu(snippet));
                }
                
                list.appendChild(item);
            });
        } 

        // 发送新言语
        // 发送新言语 (修复版：立即显示)
        async function sendSnippetQuick() {
            const input = document.getElementById('snippet-quick-input');
            const content = input.value.trim();
            if (!content || !currentCollectionId) return;

            const newItem = { 
                collectionId: currentCollectionId, 
                content: content, 
                timestamp: Date.now() 
            };

            // 1. 存入数据库，并获取生成的ID
            const newId = await dbActions.add('snippets', newItem);
            newItem.id = newId;

            // 2. 关键修复：把新数据推入内存中的 appData，这样渲染时才能看到！
            appData.snippets.push(newItem);

            input.value = '';
            
            // 3. 重新渲染列表
            renderSnippetDetailList();
            
            // 4. 自动滚动到最顶部（因为是最新的在上面）
            const list = document.getElementById('snippet-detail-list');
            list.scrollTop = 0;
        }

        // 详情页右上角菜单
        function openSnippetDetailMenu(collection) {
            showActionMenuModal(collection.name, [
                { text: '批量管理', action: 'manage-snippets-mode' },
                { text: '更换内部背景', action: 'change-collection-bg' },
                { text: '更换封面', action: 'change-collection-cover' } // 在这里也能换封面
            ]);
            
            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const action = e.target.dataset.action;
                if (!action) return;
                closeModal();

                if (action === 'manage-snippets-mode') {
                    enterSnippetManageMode();
                } else if (action === 'change-collection-bg') {
                    changeItemBackground('snippetCollections', collection.id, () => {
                         // 刷新背景显示
                         const c = appData.snippetCollections.find(x => x.id === collection.id);
                         if(c && c.background) document.getElementById('snippet-detail-page').style.backgroundImage = `url(${c.background})`;
                    });
                } else if (action === 'change-collection-cover') {
                     changeCollectionCover(collection.id);
                }
            });
        }

       
        // 进入言语集批量管理模式
        function enterSnippetManageMode() {
            isSnippetManageMode = true;
            document.getElementById('snippet-detail-page').classList.add('manage-mode');
            document.getElementById('snippet-input-bar').style.display = 'none';
            
            // 显示管理栏
            const manageBar = document.getElementById('snippet-manage-bar');
            manageBar.style.display = 'flex';
            manageBar.innerHTML = `
                <button class="button button-secondary" id="snippet-cancel-manage" style="margin:0; padding: 5px 15px;">取消</button>
                <span id="snippet-selected-count" style="font-size:14px; color:var(--primary-text);">已选 0 项</span>
                <button class="button button-danger" id="snippet-batch-delete-btn" style="margin:0; padding: 5px 15px;">删除</button>
            `;

            renderSnippetDetailList();
            
            // 绑定事件
            document.getElementById('snippet-batch-delete-btn').onclick = batchDeleteSnippets;
            document.getElementById('snippet-cancel-manage').onclick = exitSnippetManageMode;
        }
        

        // 退出批量管理模式
        function exitSnippetManageMode() {
            isSnippetManageMode = false;
            document.getElementById('snippet-detail-page').classList.remove('manage-mode');
            document.getElementById('snippet-input-bar').style.display = 'flex';
            document.getElementById('snippet-manage-bar').style.display = 'none';
            if(currentCollectionId) renderSnippetDetailList();
        }

        // 更新选中数量
        function updateSelectedCount() {
            const count = document.querySelectorAll('.snippet-select-checkbox:checked').length;
            document.getElementById('snippet-selected-count').textContent = `已选 ${count} 项`;
        }

        // 执行批量删除
        function batchDeleteSnippets() {
            const checked = document.querySelectorAll('.snippet-select-checkbox:checked');
            if (checked.length === 0) return exitSnippetManageMode();

            showConfirmModal('批量删除', `确定删除这 ${checked.length} 条言语吗？`, async () => {
                const ids = Array.from(checked).map(cb => Number(cb.dataset.id));
                for (const id of ids) {
                    await dbActions.delete('snippets', id);
                }
                await refreshAllDataAndRender(); // 刷新数据
                // 因为refreshAll会重置appData，我们需要重新找回当前collection
                renderSnippetDetailList();
                exitSnippetManageMode();
            });
        }
        

        function openAddSnippetCollectionModal() {
            showPromptModal(getLangText('add_snippet_collection'), getLangText('collection_name'), async (name) => {
                if (name) {
                    await dbActions.add('snippetCollections', { name, isPinned: false, background: null });
                    await refreshAllDataAndRender();
                    renderSnippetsPage();
                }
            });
        }

        function openEditSnippetModal(snippet) {
            const bodyHtml = `<textarea id="snippet-content-input">${snippet.content}</textarea>`;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const content = document.getElementById('snippet-content-input').value;
                if (!content.trim()) {
                    alert('内容不能为空！');
                    return;
                }
                snippet.content = content;
                await dbActions.put('snippets', snippet);
                await refreshAllDataAndRender();
                renderSnippetsPage();
                const collectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${snippet.collectionId}"]`);
                if (collectionEl) collectionEl.classList.add('expanded');
                closeModal();
            };
            showModal(getLangText('edit_snippet'), bodyHtml, footerHtml, saveHandler);
        }

        // 言语单条菜单 (新增复制和置顶)
        function openSnippetMenu(snippet) {
            // 注意：置顶功能需要在数据库结构里支持，这里我们简单实现逻辑，如果数据结构没isPinned字段会自动加上
            const pinText = snippet.isPinned ? '取消置顶' : '置顶';
            
            showActionMenuModal('操作', [
                { text: '复制内容', action: 'copy-snippet', value: snippet.content },
                { text: pinText, action: 'toggle-pin-snippet', id: snippet.id },
                { text: getLangText('edit'), action: 'edit-snippet', id: snippet.id },
                { text: getLangText('delete'), action: 'delete-snippet', id: snippet.id }
            ]);

            // 添加额外的事件监听处理复制和置顶
            // 由于showActionMenuModal是通用的，我们在下面的全局监听里处理 'copy-snippet' 和 'toggle-pin-snippet'
        }

        function openSnippetCollectionMenu(collection) {
            const pinText = collection.isPinned ? getLangText('unpin') : getLangText('pin');
            showActionMenuModal(collection.name, [
                { text: pinText, action: 'toggle-pin-snippet-collection', id: collection.id },
                { text: '更换封面', action: 'change-cover', id: collection.id }, // 新增
                { text: '更换内部背景', action: 'change-snippet-collection-bg', id: collection.id },
                { text: getLangText('delete'), action: 'delete-snippet-collection', id: collection.id }
            ]);

            // 这里需要绑定新的事件监听，因为 showActionMenuModal 是通用的
            // 我们可以在全局的 click 监听里处理 'change-cover'，或者在这里局部处理
            // 为了简单，我们去更新全局的 click 监听（见下一步）
        }
        
        // 新增：更换封面的具体逻辑
        function changeCollectionCover(id) {
             const item = appData.snippetCollections.find(i => i.id === id);
             if (!item) return;
             triggerFileUpload('image/*', false, 1, async (file) => {
                item.cover = file.src; // 保存到 cover 字段
                await dbActions.put('snippetCollections', item);
                await refreshAllDataAndRender();
                renderSnippetsPage();
            });
        }

        async function togglePinItem(storeName, id, renderFunc) {
            closeModal();
            const items = appData[storeName];
            const item = items.find(i => i.id === id);
            if (!item) return;
            
            item.isPinned = !item.isPinned;
            await dbActions.put(storeName, item);
            
            await refreshAllDataAndRender();
            if (renderFunc) renderFunc();
        }

        async function changeItemBackground(storeName, id, renderFunc) {
            closeModal();
            const item = appData[storeName].find(i => i.id === id);
            if (!item) return;

            triggerFileUpload('image/*', false, 1, async (file) => {
                item.background = file.src;
                await dbActions.put(storeName, item);
                await refreshAllDataAndRender();
                if (renderFunc) renderFunc();
            });
        }
        
        // =======================================================================
        // 10. 小游戏逻辑
        // =======================================================================

        class Gobang {
            constructor() {
                this.boardEl = document.getElementById('gobang-board');
                this.statusEl = document.getElementById('gobang-status');
                this.difficultySelect = document.getElementById('gobang-difficulty');
                this.size = 15;
                // 定义棋型和对应的分数
                this.patterns = {
                    five: { pattern: '11111', score: 100000 }, // 连五
                    live_four: { pattern: '011110', score: 10000 }, // 活四
                    rush_four_1: { pattern: '011112', score: 1000 }, // 冲四
                    rush_four_2: { pattern: '211110', score: 1000 }, // 冲四
                    rush_four_3: { pattern: '10111', score: 1000 }, // 冲四
                    rush_four_4: { pattern: '11011', score: 1000 }, // 冲四
                    live_three: { pattern: '01110', score: 1000 }, // 活三
                    sleep_three_1: { pattern: '001112', score: 100 }, // 眠三
                    sleep_three_2: { pattern: '211100', score: 100 }, // 眠三
                    sleep_three_3: { pattern: '010110', score: 100 }, // 眠三
                    live_two: { pattern: '001100', score: 100 }, // 活二
                    live_two_2: { pattern: '01010', score: 100 }, // 活二
                    sleep_two: { pattern: '000112', score: 10 }, // 眠二
                    live_one: { pattern: '00100', score: 10 }, // 活一
                };
                this.start();
            }

            cleanup() {} // For compatibility with other games

            start() {
                this.difficulty = this.difficultySelect.value;
                this.board = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                this.currentPlayer = 1; // 1 for black (player), 2 for white (AI)
                this.gameOver = false;
                this.statusEl.textContent = '执黑先行';
                this.renderBoard();
            }

            renderBoard() {
                this.boardEl.innerHTML = ''; // 清空棋盘和棋子
                for (let i = 0; i < this.size * this.size; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'gobang-cell';
                    const x = i % this.size;
                    const y = Math.floor(i / this.size);
                    cell.addEventListener('click', () => this.placePiece(x, y));
                    this.boardEl.appendChild(cell);
                }
            }

            placePiece(x, y) {
                if (this.gameOver || this.board[y][x] !== 0) {
                    return;
                }
                this.board[y][x] = this.currentPlayer;
                this.renderPiece(x, y, this.currentPlayer);

                if (this.checkWin(x, y, this.currentPlayer)) {
                    this.gameOver = true;
                    this.statusEl.textContent = `${this.currentPlayer === 1 ? '黑棋' : '白棋'}胜利!`;
                    return;
                }

                this.currentPlayer = this.currentPlayer === 1 ? 2 : 1;
                this.statusEl.textContent = `${this.currentPlayer === 1 ? '黑棋' : '白棋'}回合`;

                if (this.currentPlayer === 2 && !this.gameOver) {
                    this.boardEl.style.pointerEvents = 'none'; // AI思考时禁止玩家点击
                    setTimeout(() => {
                        this.aiMove();
                        this.boardEl.style.pointerEvents = 'auto';
                    }, 200);
                }
            }
            
            renderPiece(x, y, player) {
                const piece = document.createElement('div');
                piece.className = `gobang-piece ${player === 1 ? 'black' : 'white'}`;
                const cellWidth = this.boardEl.firstChild.offsetWidth;
                const pieceSize = cellWidth * 0.8;
                piece.style.width = `${pieceSize}px`;
                piece.style.height = `${pieceSize}px`;
                piece.style.left = `${(x + 0.5) * cellWidth}px`;
                piece.style.top = `${(y + 0.5) * cellWidth}px`;
                this.boardEl.appendChild(piece);
            }

            checkWin(x, y, player) {
                const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
                for (const [dx, dy] of directions) {
                    let count = 1;
                    for(let i = 1; i < 5; i++) { if(this.getPiece(x + i*dx, y + i*dy) === player) count++; else break; }
                    for(let i = 1; i < 5; i++) { if(this.getPiece(x - i*dx, y - i*dy) === player) count++; else break; }
                    if (count >= 5) return true;
                }
                return false;
            }
            
            getPiece(x, y) {
                if (x < 0 || x >= this.size || y < 0 || y >= this.size) return -1; // -1 is border
                return this.board[y][x];
            }

            aiMove() {
                if (this.gameOver) return;
                
                let bestMove = { x: -1, y: -1, score: -Infinity };

                for (let y = 0; y < this.size; y++) {
                    for (let x = 0; x < this.size; x++) {
                        if (this.board[y][x] === 0) {
                            // 只考虑附近有棋子的点，优化性能
                            if (!this.hasNeighbor(x, y, 2)) continue;

                            let score = this.calculateScore(x, y, 2) + this.calculateScore(x, y, 1);
                            
                            if (score > bestMove.score) {
                                bestMove = { x, y, score };
                            } else if (score === bestMove.score && Math.random() > 0.5) {
                                bestMove = { x, y, score };
                            }
                        }
                    }
                }
                if (bestMove.x !== -1) {
                    this.placePiece(bestMove.x, bestMove.y);
                } else { // 如果没有好棋，随机下在棋盘中央区域
                    let emptyCells = [];
                    for(let y=4; y<11; y++) for(let x=4; x<11; x++) if(this.board[y][x]===0) emptyCells.push({x,y});
                    if(emptyCells.length > 0) {
                        const move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                        this.placePiece(move.x, move.y);
                    }
                }
            }

            hasNeighbor(x, y, distance) {
                for(let i = -distance; i <= distance; i++) {
                    for(let j = -distance; j <= distance; j++) {
                        if (i === 0 && j === 0) continue;
                        if(this.getPiece(x+i, y+j) !== 0 && this.getPiece(x+i, y+j) !== -1) return true;
                    }
                }
                return false;
            }

            calculateScore(x, y, player) {
                let totalScore = 0;
                const directions = [[1, 0], [0, 1], [1, 1], [1, -1]];
                
                this.board[y][x] = player; // Temporarily place piece

                for (const [dx, dy] of directions) {
                    let line = '';
                    for (let i = -5; i <= 5; i++) {
                        const piece = this.getPiece(x + i * dx, y + i * dy);
                        line += piece === -1 ? '2' : piece; // Treat border as opponent
                    }
                    
                    for (const key in this.patterns) {
                        const p = this.patterns[key];
                        const opponent = player === 1 ? '2' : '1';
                        // Check original pattern
                        if (line.includes(p.pattern.replace(/1/g, player.toString()).replace(/2/g, opponent))) {
                            totalScore += p.score;
                        }
                        // Check reversed pattern
                        const reversedPattern = p.pattern.split('').reverse().join('');
                        if (line.includes(reversedPattern.replace(/1/g, player.toString()).replace(/2/g, opponent))) {
                            totalScore += p.score;
                        }
                    }
                }
                
                this.board[y][x] = 0; // Remove piece

                // 根据难度调整AI的进攻和防守倾向
                if (this.difficulty === 'hard') {
                    // 防守分权重更高
                    return player === 1 ? totalScore * 1.2 : totalScore;
                }
                if (this.difficulty === 'medium') {
                    return player === 1 ? totalScore * 1.1 : totalScore;
                }
                return totalScore; // Easy
            }
        }

        class Minesweeper {
            constructor() {
                this.gridEl = document.getElementById('minesweeper-grid');
                this.statusEl = document.getElementById('minesweeper-status');
                this.difficultySelect = document.getElementById('minesweeper-difficulty');
                this.configs = {
                    easy: { rows: 9, cols: 9, mines: 10 },
                    medium: { rows: 16, cols: 16, mines: 40 },
                    hard: { rows: 16, cols: 30, mines: 99 },
                };
                this.start();
            }
            cleanup() {}

            start() {
                const difficulty = this.difficultySelect.value;
                this.config = this.configs[difficulty];
                this.gameOver = false;
                this.firstClick = true;
                this.cellsToReveal = this.config.rows * this.config.cols - this.config.mines;
                this.flags = 0;
                this.statusEl.textContent = `雷数: ${this.config.mines}`;
                this.board = Array(this.config.rows).fill(null).map(() => Array(this.config.cols).fill(null).map(() => ({ isMine: false, isRevealed: false, isFlagged: false, adjacentMines: 0 })));
                this.renderBoard();
            }
            
            createBoard(safeRow, safeCol) {
                let minesPlaced = 0;
                while (minesPlaced < this.config.mines) {
                    const row = Math.floor(Math.random() * this.config.rows);
                    const col = Math.floor(Math.random() * this.config.cols);
                    if (!this.board[row][col].isMine && (row !== safeRow || col !== safeCol)) {
                        this.board[row][col].isMine = true;
                        minesPlaced++;
                    }
                }
                
                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        if (this.board[r][c].isMine) continue;
                        this.board[r][c].adjacentMines = this.countAdjacentMines(r, c);
                    }
                }
            }

            renderBoard() {
                this.gridEl.innerHTML = '';
                const cellSize = Math.min(25, (this.gridEl.parentElement.offsetWidth - 20) / this.config.cols);
                this.gridEl.style.gridTemplateColumns = `repeat(${this.config.cols}, ${cellSize}px)`;
                this.gridEl.style.gridTemplateRows = `repeat(${this.config.rows}, ${cellSize}px)`;
                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'minesweeper-cell';
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.addEventListener('click', () => this.revealCell(r, c));
                        cell.addEventListener('contextmenu', (e) => {
                            e.preventDefault();
                            this.toggleFlag(r, c);
                        });
                        this.gridEl.appendChild(cell);
                    }
                }
            }

            revealCell(row, col) {
                if (this.firstClick) {
                    this.createBoard(row, col);
                    this.firstClick = false;
                }
                
                if (this.gameOver || this.board[row][col].isRevealed || this.board[row][col].isFlagged) return;

                this.board[row][col].isRevealed = true;
                const cellEl = this.gridEl.querySelector(`[data-row='${row}'][data-col='${col}']`);
                cellEl.classList.add('revealed');

                if (this.board[row][col].isMine) {
                    cellEl.innerHTML = '<i class="fas fa-bomb"></i>';
                    cellEl.classList.add('mine');
                    this.endGame(false);
                    return;
                }

                this.cellsToReveal--;
                const adjacentMines = this.board[row][col].adjacentMines;
                if (adjacentMines > 0) {
                    cellEl.textContent = adjacentMines;
                    cellEl.dataset.mines = adjacentMines;
                } else {
                    this.getNeighbors(row, col).forEach(([nr, nc]) => this.revealCell(nr, nc));
                }

                if (this.cellsToReveal === 0) {
                    this.endGame(true);
                }
            }

            toggleFlag(row, col) {
                if (this.gameOver || this.board[row][col].isRevealed) return;
                const cell = this.board[row][col];
                cell.isFlagged = !cell.isFlagged;
                const cellEl = this.gridEl.querySelector(`[data-row='${row}'][data-col='${col}']`);
                cellEl.innerHTML = cell.isFlagged ? '<i class="fas fa-flag"></i>' : '';
            }
            
            endGame(isWin) {
                this.gameOver = true;
                this.statusEl.textContent = isWin ? 'You Win!' : 'Game Over!';
                for (let r = 0; r < this.config.rows; r++) {
                    for (let c = 0; c < this.config.cols; c++) {
                        if (this.board[r][c].isMine) {
                             const cellEl = this.gridEl.querySelector(`[data-row='${r}'][data-col='${c}']`);
                             cellEl.innerHTML = '<i class="fas fa-bomb"></i>';
                             cellEl.classList.add('mine');
                        }
                    }
                }
            }
            
            countAdjacentMines(row, col) {
                return this.getNeighbors(row, col).filter(([r,c]) => this.board[r][c].isMine).length;
            }

            getNeighbors(row, col) {
                const neighbors = [];
                for (let r = -1; r <= 1; r++) {
                    for (let c = -1; c <= 1; c++) {
                        if (r === 0 && c === 0) continue;
                        const nr = row + r;
                        const nc = col + c;
                        if (nr >= 0 && nr < this.config.rows && nc >= 0 && nc < this.config.cols) {
                            neighbors.push([nr, nc]);
                        }
                    }
                }
                return neighbors;
            }
        }

        class Snake {
            constructor() {
                this.canvas = document.getElementById('snake-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.statusEl = document.getElementById('snake-status');
                this.difficultySelect = document.getElementById('snake-difficulty');
                this.speeds = { easy: 200, medium: 120, hard: 70 }; // 修复：调整速度值
                this.gridSize = 20;
                this.tileCount = this.canvas.width / this.gridSize;
                
                this.animationFrameId = null;
                this.lastTime = 0;
                this.dropCounter = 0;
                
                this.handleKeyDown = this.handleKeyDown.bind(this);
            }

            start() {
                this.cleanup();
                document.addEventListener('keydown', this.handleKeyDown);

                this.snake = [{ x: 10, y: 10 }];
                this.food = this.generateFood();
                this.direction = { x: 0, y: 0 };
                this.nextDirection = { x: 0, y: 0 }; // 修复：缓冲下一个方向，避免快速按键导致180度掉头
                this.score = 0;
                this.gameOver = false;
                this.statusEl.textContent = '得分: 0';
                this.dropInterval = this.speeds[this.difficultySelect.value];
                
                this.lastTime = 0;
                this.gameLoop();
            }

            cleanup() {
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                document.removeEventListener('keydown', this.handleKeyDown);
            }

            gameLoop(time = 0) {
                if (this.gameOver) return;

                this.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
                
                const deltaTime = time - this.lastTime;
                this.lastTime = time;
                this.dropCounter += deltaTime;
                
                if (this.dropCounter > this.dropInterval) {
                    this.update();
                    this.dropCounter = 0;
                }
                
                this.draw();
            }

            update() {
                // Apply buffered direction
                if (this.snake.length === 1 || !(this.direction.x === -this.nextDirection.x && this.direction.y === -this.nextDirection.y)) {
                    this.direction = this.nextDirection;
                }

                if (this.direction.x === 0 && this.direction.y === 0) return; // Don't move if no direction is set

                const head = { x: this.snake[0].x + this.direction.x, y: this.snake[0].y + this.direction.y };
                
                if (head.x < 0 || head.x >= this.tileCount || head.y < 0 || head.y >= this.tileCount) {
                    this.endGame(); return;
                }
                
                for (let i = 1; i < this.snake.length; i++) {
                    if (head.x === this.snake[i].x && head.y === this.snake[i].y) {
                        this.endGame(); return;
                    }
                }

                this.snake.unshift(head);
                
                if (head.x === this.food.x && head.y === this.food.y) {
                    this.score++;
                    this.statusEl.textContent = `得分: ${this.score}`;
                    this.food = this.generateFood();
                } else {
                    this.snake.pop();
                }
            }

            draw() {
                this.ctx.fillStyle = getComputedStyle(this.canvas).backgroundColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Snake body
                this.ctx.fillStyle = '#4CAF50';
                for(let i = 1; i < this.snake.length; i++) {
                    const part = this.snake[i];
                    this.ctx.fillRect(part.x * this.gridSize, part.y * this.gridSize, this.gridSize - 1, this.gridSize - 1);
                }
                // Snake head
                this.ctx.fillStyle = '#2E7D32';
                const head = this.snake[0];
                this.ctx.fillRect(head.x * this.gridSize, head.y * this.gridSize, this.gridSize - 1, this.gridSize - 1);

                // Food
                this.ctx.fillStyle = '#f44336';
                this.ctx.fillRect(this.food.x * this.gridSize, this.food.y * this.gridSize, this.gridSize - 1, this.gridSize - 1);
            }
            
            generateFood() {
                while (true) {
                    const food = { x: Math.floor(Math.random() * this.tileCount), y: Math.floor(Math.random() * this.tileCount) };
                    if (!this.snake.some(part => part.x === food.x && part.y === food.y)) return food;
                }
            }
            
            handleKeyDown(e) {
                if (!document.getElementById('games-page').classList.contains('active')) return;
                e.preventDefault();
                const keyMap = { 37: {x: -1, y: 0}, 38: {x: 0, y: -1}, 39: {x: 1, y: 0}, 40: {x: 0, y: 1} };
                const newDir = keyMap[e.keyCode];
                if (newDir) {
                    // Prevent reversing direction immediately
                    if (this.snake.length > 1 && this.direction.x === -newDir.x && this.direction.y === -newDir.y) {
                        return;
                    }
                    this.nextDirection = newDir;
                }
            }
            
            handleInput(dir) {
                const dirMap = { left: {x: -1, y: 0}, up: {x: 0, y: -1}, right: {x: 1, y: 0}, down: {x: 0, y: 1} };
                const newDir = dirMap[dir];
                 if (newDir) {
                    if (this.snake.length > 1 && this.direction.x === -newDir.x && this.direction.y === -newDir.y) {
                        return;
                    }
                    this.nextDirection = newDir;
                }
            }

            endGame() {
                this.gameOver = true;
                this.cleanup();
                this.statusEl.textContent = `游戏结束! 最终得分: ${this.score}`;
            }
        }

        class Game2048 {
            constructor() {
                this.boardEl = document.getElementById('game2048-board');
                this.statusEl = document.getElementById('game2048-status');
                this.size = 4;
                this.board = [];
                this.score = 0;
                this.gameOver = false;
                this.handleKeyDown = this.handleKeyDown.bind(this);
                this.handleTouchStart = this.handleTouchStart.bind(this);
                this.handleTouchEnd = this.handleTouchEnd.bind(this);
                this.touchStartX = 0;
                this.touchStartY = 0;
                this.start();
            }

            start() {
                this.board = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                this.score = 0;
                this.gameOver = false;
                this.addRandomTile();
                this.addRandomTile();
                this.updateBoard();
                this.addEventListeners();
            }
            
            cleanup() {
                this.removeEventListeners();
            }

            addEventListeners() {
                document.addEventListener('keydown', this.handleKeyDown);
                this.boardEl.addEventListener('touchstart', this.handleTouchStart, { passive: false });
                this.boardEl.addEventListener('touchend', this.handleTouchEnd, { passive: false });
            }
            
            removeEventListeners() {
                document.removeEventListener('keydown', this.handleKeyDown);
                this.boardEl.removeEventListener('touchstart', this.handleTouchStart);
                this.boardEl.removeEventListener('touchend', this.handleTouchEnd);
            }

            handleKeyDown(e) {
                if (this.gameOver || !document.getElementById('games-page').classList.contains('active')) return;
                let moved = false;
                switch (e.keyCode) {
                    case 37: moved = this.move('left'); break;
                    case 38: moved = this.move('up'); break;  
                    case 39: moved = this.move('right'); break;
                    case 40: moved = this.move('down'); break;
                }
                if (moved) this.nextTurn();
            }
            
            handleTouchStart(e) {
                e.preventDefault();
                this.touchStartX = e.touches[0].clientX;
                this.touchStartY = e.touches[0].clientY;
            }

            handleTouchEnd(e) {
                e.preventDefault();
                if (this.gameOver) return;
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const dx = touchEndX - this.touchStartX;
                const dy = touchEndY - this.touchStartY;
                const swipeThreshold = 30;

                if (Math.abs(dx) > Math.abs(dy)) {
                    if (Math.abs(dx) > swipeThreshold) {
                        if (this.move(dx > 0 ? 'right' : 'left')) this.nextTurn();
                    }
                } else {
                    if (Math.abs(dy) > swipeThreshold) {
                        if (this.move(dy > 0 ? 'down' : 'up')) this.nextTurn();
                    }
                }
            }

            nextTurn() {
                this.addRandomTile();
                this.updateBoard();
                if (this.isGameOver()) {
                    this.gameOver = true;
                    this.statusEl.textContent = `游戏结束! 分数: ${this.score}`;
                }
            }

            updateBoard() {
                this.boardEl.innerHTML = '';
                const tileSize = (this.boardEl.offsetWidth - 10 * (this.size + 1)) / this.size;
                const fontSize = tileSize * 0.4;
                
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'game2048-cell';
                        this.boardEl.appendChild(cell);

                        if (this.board[r][c] !== 0) {
                            const tile = document.createElement('div');
                            tile.className = 'game2048-tile';
                            tile.dataset.value = this.board[r][c];
                            tile.textContent = this.board[r][c];
                            tile.style.width = `${tileSize}px`;
                            tile.style.height = `${tileSize}px`;
                            tile.style.top = `${r * (tileSize + 10) + 10}px`;
                            tile.style.left = `${c * (tileSize + 10) + 10}px`;
                            tile.style.fontSize = `${fontSize}px`;
                            if(this.board[r][c] > 1000) tile.style.fontSize = `${fontSize * 0.8}px`;
                            this.boardEl.appendChild(tile);
                        }
                    }
                }
                this.statusEl.textContent = `分数: ${this.score}`;
            }

            getEmptyCells() {
                const cells = [];
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (this.board[r][c] === 0) cells.push({ r, c });
                    }
                }
                return cells;
            }

            addRandomTile() {
                const emptyCells = this.getEmptyCells();
                if (emptyCells.length > 0) {
                    const { r, c } = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    this.board[r][c] = Math.random() > 0.9 ? 4 : 2;
                }
            }
            
            move(direction) {
                const initialBoard = JSON.stringify(this.board);
                let rotatedBoard = this.rotateBoard(this.board, direction);
                
                for (let r = 0; r < this.size; r++) {
                    let row = rotatedBoard[r].filter(val => val !== 0);
                    for (let c = 0; c < row.length - 1; c++) {
                        if (row[c] === row[c + 1]) {
                            row[c] *= 2;
                            this.score += row[c];
                            row.splice(c + 1, 1);
                        }
                    }
                    while (row.length < this.size) row.push(0);
                    rotatedBoard[r] = row;
                }
                
                this.board = this.rotateBoard(rotatedBoard, direction, true);
                return initialBoard !== JSON.stringify(this.board);
            }
            
            rotateBoard(board, direction, reverse = false) {
                const rotations = { 'up': reverse ? 3 : 1, 'right': reverse ? 2 : 2, 'down': reverse ? 1 : 3, 'left': 0 };
                let newBoard = board;
                for (let i = 0; i < rotations[direction]; i++) {
                    newBoard = this.rotateLeft(newBoard);
                }
                return newBoard;
            }

            rotateLeft(board) {
                const newBoard = Array(this.size).fill(0).map(() => Array(this.size).fill(0));
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        newBoard[r][c] = board[c][this.size - 1 - r];
                    }
                }
                return newBoard;
            }

            isGameOver() {
                if (this.getEmptyCells().length > 0) return false;
                for (let r = 0; r < this.size; r++) {
                    for (let c = 0; c < this.size; c++) {
                        if (c < this.size - 1 && this.board[r][c] === this.board[r][c + 1]) return false;
                        if (r < this.size - 1 && this.board[r][c] === this.board[r + 1][c]) return false;
                    }
                }
                return true;
            }
        }
        
        class TicTacToe {
             constructor() {
                this.boardEl = document.getElementById('tictactoe-board');
                this.statusEl = document.getElementById('tictactoe-status');
                this.difficultySelect = document.getElementById('tictactoe-difficulty');
                this.start();
            }
            cleanup() {}

            start() {
                this.board = Array(9).fill(null);
                this.isPlayerTurn = true;
                this.gameOver = false;
                this.statusEl.textContent = '你的回合';
                this.render();
            }

            render() {
                this.boardEl.innerHTML = '';
                this.board.forEach((val, i) => {
                    const cell = document.createElement('div');
                    cell.className = 'tictactoe-cell';
                    cell.textContent = val;
                    cell.addEventListener('click', () => this.playerMove(i));
                    this.boardEl.appendChild(cell);
                });
            }

            playerMove(i) {
                if (this.gameOver || this.board[i] || !this.isPlayerTurn) return;
                this.board[i] = 'X';
                this.isPlayerTurn = false;
                this.render();
                if (this.checkWinner('X')) {
                    this.statusEl.textContent = '你赢了!';
                    this.gameOver = true;
                } else if (!this.board.includes(null)) {
                    this.statusEl.textContent = '平局!';
                    this.gameOver = true;
                } else {
                    this.statusEl.textContent = 'AI 思考中...';
                    setTimeout(() => this.aiMove(), 500);
                }
            }

            aiMove() {
                let move;
                const difficulty = this.difficultySelect.value;
                if (difficulty === 'hard') {
                    move = this.minimax(this.board, 'O').index;
                } else if (difficulty === 'medium') {
                    // 50% chance of perfect move
                    move = Math.random() > 0.5 ? this.minimax(this.board, 'O').index : this.getRandomMove();
                } else { // Easy
                    move = this.getRandomMove();
                }
                
                this.board[move] = 'O';
                this.isPlayerTurn = true;
                this.render();

                if (this.checkWinner('O')) {
                    this.statusEl.textContent = 'AI 赢了!';
                    this.gameOver = true;
                } else if (!this.board.includes(null)) {
                    this.statusEl.textContent = '平局!';
                    this.gameOver = true;
                } else {
                    this.statusEl.textContent = '你的回合';
                }
            }
            
            getRandomMove() {
                const emptyCells = this.board.map((v, i) => v === null ? i : null).filter(v => v !== null);
                return emptyCells[Math.floor(Math.random() * emptyCells.length)];
            }

            checkWinner(player) {
                const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                return lines.some(line => line.every(i => this.board[i] === player));
            }

            minimax(newBoard, player) {
                const emptyCells = newBoard.map((v, i) => v === null ? i : null).filter(v => v !== null);

                if (this.checkWinner('X')) return { score: -10 };
                if (this.checkWinner('O')) return { score: 10 };
                if (emptyCells.length === 0) return { score: 0 };
                
                const moves = [];
                for (const i of emptyCells) {
                    const move = {};
                    move.index = i;
                    newBoard[i] = player;
                    
                    if (player === 'O') {
                        move.score = this.minimax(newBoard, 'X').score;
                    } else {
                        move.score = this.minimax(newBoard, 'O').score;
                    }
                    newBoard[i] = null;
                    moves.push(move);
                }

                let bestMove;
                if (player === 'O') {
                    bestMove = moves.reduce((best, move) => move.score > best.score ? move : best, { score: -Infinity });
                } else {
                    bestMove = moves.reduce((best, move) => move.score < best.score ? move : best, { score: Infinity });
                }
                return bestMove;
            }
        }
        
        class Tetris {
            // Simplified Tetris logic
            constructor() {
                this.canvas = document.getElementById('tetris-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.nextCanvas = document.getElementById('tetris-next-canvas');
                this.nextCtx = this.nextCanvas.getContext('2d');
                this.statusEl = document.getElementById('tetris-status');
                this.difficultySelect = document.getElementById('tetris-difficulty');
                this.speeds = { easy: 800, medium: 500, hard: 300 };
                
                this.gridSize = 20;
                this.rows = 20;
                this.cols = 10;
                this.board = Array(this.rows).fill(0).map(() => Array(this.cols).fill(0));
                
                this.shapes = {
                    'I': [[1,1,1,1]],
                    'J': [[1,0,0], [1,1,1]],
                    'L': [[0,0,1], [1,1,1]],
                    'O': [[1,1],[1,1]],
                    'S': [[0,1,1],[1,1,0]],
                    'T': [[0,1,0],[1,1,1]],
                    'Z': [[1,1,0],[0,1,1]]
                };
                this.colors = { 'I': 'cyan', 'J': 'blue', 'L': 'orange', 'O': 'yellow', 'S': 'green', 'T': 'purple', 'Z': 'red' };
                this.handleKeyDown = this.handleKeyDown.bind(this);
            }

            start() {
                this.cleanup();
                document.addEventListener('keydown', this.handleKeyDown);
                this.board.forEach(row => row.fill(0));
                this.score = 0;
                this.gameOver = false;
                this.dropCounter = 0;
                this.dropInterval = this.speeds[this.difficultySelect.value];
                this.lastTime = 0;
                this.playerReset();
                this.updateScore();
                this.gameLoop();
            }
            
            cleanup() {
                if (this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                document.removeEventListener('keydown', this.handleKeyDown);
            }

            playerReset() {
                const pieces = 'IJLOSTZ';
                if (!this.nextPiece) {
                    this.player = this.createPiece(pieces[Math.floor(Math.random() * pieces.length)]);
                } else {
                    this.player = this.nextPiece;
                }
                this.nextPiece = this.createPiece(pieces[Math.floor(Math.random() * pieces.length)]);
                
                this.player.pos.x = Math.floor(this.cols / 2) - Math.floor(this.player.matrix[0].length / 2);
                this.player.pos.y = 0;

                if (this.collide()) {
                    this.gameOver = true;
                    this.statusEl.textContent = `游戏结束! 分数: ${this.score}`;
                }
                this.drawNextPiece();
            }

            createPiece(type) {
                return {
                    pos: { x: 0, y: 0 },
                    matrix: this.shapes[type],
                    type: type,
                };
            }

            draw() {
                this.ctx.fillStyle = getComputedStyle(this.canvas).backgroundColor;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                this.drawMatrix(this.board, { x: 0, y: 0 });
                this.drawMatrix(this.player.matrix, this.player.pos);
            }

            drawMatrix(matrix, offset) {
                matrix.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value !== 0) {
                            this.ctx.fillStyle = this.colors[value] || this.colors[this.player.type];
                            this.ctx.fillRect((offset.x + x) * this.gridSize, (offset.y + y) * this.gridSize, this.gridSize - 1, this.gridSize - 1);
                        }
                    });
                });
            }

            drawNextPiece() {
                this.nextCtx.fillStyle = '#1a1a1a';
                this.nextCtx.fillRect(0,0, this.nextCanvas.width, this.nextCanvas.height);
                const matrix = this.nextPiece.matrix;
                const scale = this.gridSize * 0.8;
                const offsetX = (this.nextCanvas.width - matrix[0].length * scale) / 2;
                const offsetY = (this.nextCanvas.height - matrix.length * scale) / 2;
                this.nextCtx.fillStyle = this.colors[this.nextPiece.type];
                matrix.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value) {
                            this.nextCtx.fillRect(offsetX + x * scale, offsetY + y * scale, scale - 1, scale - 1);
                        }
                    });
                });
            }

            gameLoop(time = 0) {
                if (this.gameOver) return;
                const deltaTime = time - this.lastTime;
                this.lastTime = time;
                this.dropCounter += deltaTime;
                if (this.dropCounter > this.dropInterval) {
                    this.playerDrop();
                }
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
            }
            
            playerDrop() {
                this.player.pos.y++;
                if (this.collide()) {
                    this.player.pos.y--;
                    this.merge();
                    this.playerReset();
                    this.sweep();
                }
                this.dropCounter = 0;
            }

            collide() {
                const [m, o] = [this.player.matrix, this.player.pos];
                for (let y = 0; y < m.length; ++y) {
                    for (let x = 0; x < m[y].length; ++x) {
                        if (m[y][x] !== 0 && (this.board[y + o.y] && this.board[y + o.y][x + o.x]) !== 0) {
                            return true;
                        }
                    }
                }
                return false;
            }

            merge() {
                this.player.matrix.forEach((row, y) => {
                    row.forEach((value, x) => {
                        if (value !== 0) {
                            this.board[y + this.player.pos.y][x + this.player.pos.x] = this.player.type;
                        }
                    });
                });
            }

            sweep() {
                outer: for (let y = this.board.length - 1; y > 0; --y) {
                    for (let x = 0; x < this.board[y].length; ++x) {
                        if (this.board[y][x] === 0) continue outer;
                    }
                    const row = this.board.splice(y, 1)[0].fill(0);
                    this.board.unshift(row);
                    ++y;
                    this.score += 10;
                }
                this.updateScore();
            }

            rotate() {
                const matrix = this.player.matrix;
                const newMatrix = matrix[0].map((_, colIndex) => matrix.map(row => row[colIndex]).reverse());
                const pos = this.player.pos.x;
                let offset = 1;
                this.player.matrix = newMatrix;
                while (this.collide()) {
                    this.player.pos.x += offset;
                    offset = -(offset + (offset > 0 ? 1 : -1));
                    if (offset > newMatrix[0].length) {
                        this.rotate(); // Rotate back
                        this.player.pos.x = pos;
                        return;
                    }
                }
            }

            updateScore() { this.statusEl.textContent = `分数: ${this.score}`; }

            handleInput(dir) {
                if (dir === 'left') this.player.pos.x--;
                else if (dir === 'right') this.player.pos.x++;
                else if (dir === 'down') this.playerDrop();
                else if (dir === 'up') this.rotate();
                
                if (this.collide()) {
                    if (dir === 'left') this.player.pos.x++;
                    else if (dir === 'right') this.player.pos.x--;
                }
            }

            handleKeyDown(e) {
                if (!document.getElementById('games-page').classList.contains('active')) return;
                const keyMap = { 37: 'left', 39: 'right', 40: 'down', 38: 'up' };
                if (keyMap[e.keyCode]) {
                    e.preventDefault();
                    this.handleInput(keyMap[e.keyCode]);
                }
            }
        }
        
        class Blackjack {
            // Simplified Blackjack
            constructor() {
                this.statusEl = document.getElementById('blackjack-status');
                this.dealerHandEl = document.getElementById('blackjack-dealer-hand');
                this.playerHandEl = document.getElementById('blackjack-player-hand');
                this.dealerScoreEl = document.getElementById('blackjack-dealer-score');
                this.playerScoreEl = document.getElementById('blackjack-player-score');
                this.actionsEl = document.getElementById('blackjack-actions');
                this.difficultySelect = document.getElementById('blackjack-difficulty');
                this.deckCounts = { easy: 1, medium: 4, hard: 8 };
                this.start();
            }
            cleanup() {}

            start() {
                this.deck = this.createDeck();
                this.playerHand = [];
                this.dealerHand = [];
                this.gameOver = false;
                
                this.deal();
                this.updateUI();
                
                if (this.getHandValue(this.playerHand) === 21) {
                    setTimeout(() => this.stand(), 500);
                }
            }
            
            createDeck() {
                const suits = ['♥', '♦', '♣', '♠'];
                const ranks = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];
                const deckCount = this.deckCounts[this.difficultySelect.value];
                let deck = [];
                for(let i=0; i<deckCount; i++) {
                    for (const suit of suits) {
                        for (const rank of ranks) {
                            deck.push({ suit, rank });
                        }
                    }
                }
                // Shuffle
                for (let i = deck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [deck[i], deck[j]] = [deck[j], deck[i]];
                }
                return deck;
            }
            
            deal() {
                this.playerHand.push(this.deck.pop());
                this.dealerHand.push(this.deck.pop());
                this.playerHand.push(this.deck.pop());
                this.dealerHand.push(this.deck.pop());
            }

            hit() {
                if (this.gameOver) return;
                this.playerHand.push(this.deck.pop());
                this.updateUI();
                if (this.getHandValue(this.playerHand) > 21) {
                    this.endGame('你爆牌了, 庄家赢!');
                }
            }
            
            stand() {
                if(this.gameOver) return;
                this.gameOver = true;
                this.actionsEl.innerHTML = '';
                
                const dealerTurn = () => {
                    this.updateUI(true); // reveal dealer's card
                    const dealerValue = this.getHandValue(this.dealerHand);
                    if (dealerValue > 21) {
                        this.endGame('庄家爆牌了, 你赢了!');
                    } else if (dealerValue < 17) {
                        this.dealerHand.push(this.deck.pop());
                        setTimeout(dealerTurn, 1000);
                    } else {
                        const playerValue = this.getHandValue(this.playerHand);
                        if (dealerValue > playerValue) this.endGame('庄家赢!');
                        else if (dealerValue < playerValue) this.endGame('你赢了!');
                        else this.endGame('平局!');
                    }
                };
                setTimeout(dealerTurn, 500);
            }

            updateUI(reveal = false) {
                this.playerHandEl.innerHTML = this.playerHand.map(c => this.createCardEl(c)).join('');
                this.dealerHandEl.innerHTML = this.dealerHand.map((c, i) => this.createCardEl(c, i === 0 && !reveal)).join('');

                this.playerScoreEl.textContent = this.getHandValue(this.playerHand);
                this.dealerScoreEl.textContent = reveal ? this.getHandValue(this.dealerHand) : this.getHandValue([this.dealerHand[1]]);
                
                if (!this.gameOver) {
                    this.actionsEl.innerHTML = `<button class="button button-primary" id="bj-hit">要牌</button><button class="button button-secondary" id="bj-stand">停牌</button>`;
                    document.getElementById('bj-hit').onclick = () => this.hit();
                    document.getElementById('bj-stand').onclick = () => this.stand();
                } else {
                     this.actionsEl.innerHTML = '';
                }
            }
            
            createCardEl(card, isHidden = false) {
                if (isHidden) return '<div class="blackjack-card hidden"></div>';
                const color = ['♥', '♦'].includes(card.suit) ? 'red' : 'black';
                return `<div class="blackjack-card ${color}"><span class="rank">${card.rank}</span><span class="suit">${card.suit}</span></div>`;
            }

            getHandValue(hand) {
                let value = 0;
                let aces = 0;
                for (const card of hand) {
                    if (['J', 'Q', 'K'].includes(card.rank)) value += 10;
                    else if (card.rank === 'A') { value += 11; aces++; }
                    else value += parseInt(card.rank);
                }
                while (value > 21 && aces > 0) { value -= 10; aces--; }
                return value;
            }
            
            endGame(message) {
                this.gameOver = true;
                this.statusEl.textContent = message;
                this.updateUI(true);
            }
        }
        
        class Sudoku {
            // Simplified Sudoku
            constructor() {
                this.boardEl = document.getElementById('sudoku-board');
                this.numpadEl = document.getElementById('sudoku-numpad');
                this.statusEl = document.getElementById('sudoku-status');
                this.difficultySelect = document.getElementById('sudoku-difficulty');
                this.difficulties = { easy: 40, medium: 30, hard: 22 };
                this.start();
            }
            cleanup() {}

            start() {
                this.statusEl.textContent = '生成谜题中...';
                this.selectedCell = null;
                // Using timeout to prevent UI freeze during generation
                setTimeout(() => {
                    const { puzzle, solution } = this.generate();
                    this.puzzle = puzzle;
                    this.solution = solution;
                    this.board = puzzle.map(row => [...row]);
                    this.render();
                    this.statusEl.textContent = '';
                }, 10);
            }
            
            render() {
                this.boardEl.innerHTML = '';
                for(let r=0; r<9; r++) {
                    const rowEl = document.createElement('div');
                    rowEl.className = 'sudoku-row';
                    for(let c=0; c<9; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'sudoku-cell';
                        if(this.puzzle[r][c] !== 0) cell.classList.add('given');
                        cell.textContent = this.board[r][c] === 0 ? '' : this.board[r][c];
                        cell.dataset.row = r;
                        cell.dataset.col = c;
                        cell.addEventListener('click', () => this.selectCell(cell, r, c));
                        rowEl.appendChild(cell);
                    }
                    this.boardEl.appendChild(rowEl);
                }
                this.numpadEl.innerHTML = '';
                for(let i=1; i<=9; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'button button-secondary';
                    btn.textContent = i;
                    btn.onclick = () => this.placeNumber(i);
                    this.numpadEl.appendChild(btn);
                }
            }
            
            selectCell(cellEl, r, c) {
                if (this.puzzle[r][c] !== 0) return;
                if(this.selectedCell) this.selectedCell.classList.remove('selected');
                this.selectedCell = cellEl;
                this.selectedCell.classList.add('selected');
            }

            placeNumber(num) {
                if (!this.selectedCell) return;
                const r = this.selectedCell.dataset.row;
                const c = this.selectedCell.dataset.col;
                this.board[r][c] = num;
                this.selectedCell.textContent = num;
                this.check();
            }

            check() {
                let errors = 0;
                let completed = true;
                for(let r=0; r<9; r++) {
                    for(let c=0; c<9; c++) {
                        const cell = this.boardEl.querySelector(`[data-row='${r}'][data-col='${c}']`);
                        cell.classList.remove('error');
                        if (this.board[r][c] === 0) {
                            completed = false;
                        } else if (this.board[r][c] !== this.solution[r][c]) {
                            cell.classList.add('error');
                            errors++;
                        }
                    }
                }
                if (completed && errors === 0) {
                    this.statusEl.textContent = '恭喜！你完成了！';
                }
                return errors;
            }

            hint() {
                const emptyCells = [];
                for(let r=0; r<9; r++) for(let c=0; c<9; c++) if(this.board[r][c] === 0) emptyCells.push({r,c});
                
                if (emptyCells.length > 0) {
                    const {r,c} = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                    this.board[r][c] = this.solution[r][c];
                    this.render();
                    this.check();
                }
            }

            // --- Sudoku Generation ---
            generate() {
                let board = Array(9).fill(0).map(() => Array(9).fill(0));
                this.solve(board);
                const solution = board.map(row => [...row]);
                
                let puzzle = solution.map(row => [...row]);
                let cells = [];
                for(let i=0; i<81; i++) cells.push(i);
                this.shuffle(cells);

                let attempts = 81 - this.difficulties[this.difficultySelect.value];
                while(attempts > 0) {
                    const cellIndex = cells.pop();
                    const r = Math.floor(cellIndex / 9);
                    const c = cellIndex % 9;
                    const temp = puzzle[r][c];
                    puzzle[r][c] = 0;
                    
                    let tempPuzzle = puzzle.map(row => [...row]);
                    if (!this.hasUniqueSolution(tempPuzzle)) {
                        puzzle[r][c] = temp;
                    } else {
                        attempts--;
                    }
                }
                return { puzzle, solution };
            }
            
            hasUniqueSolution(board) {
                let solutions = 0;
                const solveCounter = (b) => {
                    for (let r = 0; r < 9; r++) {
                        for (let c = 0; c < 9; c++) {
                            if (b[r][c] === 0) {
                                for (let num = 1; num <= 9; num++) {
                                    if (this.isValid(b, r, c, num)) {
                                        b[r][c] = num;
                                        solveCounter(b);
                                        b[r][c] = 0;
                                        if (solutions > 1) return;
                                    }
                                }
                                return;
                            }
                        }
                    }
                    solutions++;
                };
                solveCounter(board);
                return solutions === 1;
            }
            
            solve(board) {
                 for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (board[r][c] === 0) {
                            const nums = [1,2,3,4,5,6,7,8,9];
                            this.shuffle(nums);
                            for (const num of nums) {
                                if (this.isValid(board, r, c, num)) {
                                    board[r][c] = num;
                                    if (this.solve(board)) return true;
                                    board[r][c] = 0;
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            }

            isValid(board, row, col, num) {
                for(let i=0; i<9; i++) if (board[row][i] === num || board[i][col] === num) return false;
                const startRow = row - row % 3, startCol = col - col % 3;
                for(let i=0; i<3; i++) for(let j=0; j<3; j++) if(board[i + startRow][j + startCol] === num) return false;
                return true;
            }

            shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
        }
        
        class PlanetDefender {
            constructor() {
                this.canvas = document.getElementById('planetdefender-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.statusEl = document.getElementById('planetdefender-status');
                this.difficultySelect = document.getElementById('planetdefender-difficulty');
                
                this.difficulties = {
                    easy: { enemySpeed: 1, spawnRate: 1500, rotateSpeed: 0.05 },
                    medium: { enemySpeed: 1.5, spawnRate: 1000, rotateSpeed: 0.07 },
                    hard: { enemySpeed: 2, spawnRate: 600, rotateSpeed: 0.1 },
                };
                
                this.handleKeyDown = this.handleKeyDown.bind(this);
                this.handleKeyUp = this.handleKeyUp.bind(this);
                // 修复：使用 mousedown 和 mouseup 模拟持续按压效果，更适合电脑端
                this.handleButtonDown = (e) => this.handleButtonInput(e, true);
                this.handleButtonUp = (e) => this.handleButtonInput(e, false);
            }

            start() {
                this.cleanup();
                this.config = this.difficulties[this.difficultySelect.value];
                
                this.canvas.width = this.canvas.parentElement.offsetWidth;
                this.canvas.height = this.canvas.parentElement.offsetHeight;
                this.center = { x: this.canvas.width / 2, y: this.canvas.height / 2 };
                
                this.planetRadius = 40;
                this.player = { angle: 0, length: 60, rotation: 0 }; // rotation: -1, 0, 1
                this.bullets = [];
                this.enemies = [];
                this.score = 0;
                this.lives = 3;
                this.gameOver = false;
                
                this.lastSpawn = 0;
                this.lastShot = 0;
                
                this.keys = {};
                document.addEventListener('keydown', this.handleKeyDown);
                document.addEventListener('keyup', this.handleKeyUp);
                const btnContainer = document.querySelector('#planetdefender-container .button-layout-container');
                btnContainer.addEventListener('touchstart', this.handleButtonDown);
                btnContainer.addEventListener('touchend', this.handleButtonUp);
                btnContainer.addEventListener('mousedown', this.handleButtonDown);
                btnContainer.addEventListener('mouseup', this.handleButtonUp);
                btnContainer.addEventListener('mouseleave', this.handleButtonUp); // 当鼠标移出按钮时也停止旋转


                this.gameLoop();
            }

            cleanup() {
                if(this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                document.removeEventListener('keydown', this.handleKeyDown);
                document.removeEventListener('keyup', this.handleKeyUp);
                const btnContainer = document.querySelector('#planetdefender-container .button-layout-container');
                if(btnContainer) {
                    btnContainer.removeEventListener('touchstart', this.handleButtonDown);
                    btnContainer.removeEventListener('touchend', this.handleButtonUp);
                    btnContainer.removeEventListener('mousedown', this.handleButtonDown);
                    btnContainer.removeEventListener('mouseup', this.handleButtonUp);
                    btnContainer.removeEventListener('mouseleave', this.handleButtonUp);
                }
            }

            handleButtonInput(e, isPressed) {
                e.preventDefault();
                const btn = e.target.closest('.dpad-btn');
                if(!btn) return;
                const dir = btn.dataset.dir;
                
                if (dir === 'left') {
                    this.keys['left'] = isPressed;
                }
                if (dir === 'right') {
                    this.keys['right'] = isPressed;
                }
                if (dir === 'fire' && isPressed) {
                    this.shoot();
                }
            }

            handleKeyDown(e) {
                if (!document.getElementById('games-page').classList.contains('active')) return;
                if (e.keyCode === 37) this.keys['left'] = true;
                if (e.keyCode === 39) this.keys['right'] = true;
                if (e.keyCode === 32) {
                    e.preventDefault();
                    this.shoot();
                }
            }
            handleKeyUp(e) {
                if (e.keyCode === 37) this.keys['left'] = false;
                if (e.keyCode === 39) this.keys['right'] = false;
            }

            update() {
                // Player movement
                if (this.keys['left']) this.player.rotation = -1;
                else if (this.keys['right']) this.player.rotation = 1;
                else this.player.rotation = 0;

                this.player.angle += this.player.rotation * this.config.rotateSpeed;
                
                // Update bullets
                this.bullets.forEach((b, i) => {
                    b.x += b.vx;
                    b.y += b.vy;
                    if (b.x < 0 || b.x > this.canvas.width || b.y < 0 || b.y > this.canvas.height) {
                        this.bullets.splice(i, 1);
                    }
                });
                
                // Update enemies
                this.enemies.forEach((e, i) => {
                    e.x += e.vx;
                    e.y += e.vy;
                    const dist = Math.hypot(e.x - this.center.x, e.y - this.center.y);
                    if (dist < this.planetRadius + e.radius) {
                        this.enemies.splice(i, 1);
                        this.lives--;
                        if (this.lives <= 0) this.gameOver = true;
                    }
                });

                // Spawn enemies
                if (Date.now() - this.lastSpawn > this.config.spawnRate) {
                    this.spawnEnemy();
                    this.lastSpawn = Date.now();
                }

                // Collision detection
                for (let bi = this.bullets.length - 1; bi >= 0; bi--) {
                    for (let ei = this.enemies.length - 1; ei >= 0; ei--) {
                        if (Math.hypot(this.bullets[bi].x - this.enemies[ei].x, this.bullets[bi].y - this.enemies[ei].y) < this.bullets[bi].radius + this.enemies[ei].radius) {
                            this.bullets.splice(bi, 1);
                            this.enemies.splice(ei, 1);
                            this.score += 10;
                            break; 
                        }
                    }
                }
            }

            draw() {
                // Background
                this.ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#000' : '#f0f2f5';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Planet
                this.ctx.fillStyle = 'blue';
                this.ctx.beginPath();
                this.ctx.arc(this.center.x, this.center.y, this.planetRadius, 0, Math.PI * 2);
                this.ctx.fill();

                // Player
                this.ctx.save();
                this.ctx.translate(this.center.x, this.center.y);
                this.ctx.rotate(this.player.angle);
                this.ctx.fillStyle = 'white';
                this.ctx.fillRect(this.planetRadius - 5, -5, this.player.length, 10);
                this.ctx.restore();

                // Bullets
                this.ctx.fillStyle = 'yellow';
                this.bullets.forEach(b => {
                    this.ctx.beginPath();
                    this.ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                
                // Enemies
                this.ctx.fillStyle = 'red';
                this.enemies.forEach(e => {
                    this.ctx.beginPath();
                    this.ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
                    this.ctx.fill();
                });
                
                // UI
                this.statusEl.textContent = `Score: ${this.score} | Lives: ${this.lives}`;
                
                if (this.gameOver) {
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '40px sans-serif';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Game Over', this.center.x, this.center.y);
                }
            }
            
            shoot() {
                if (Date.now() - this.lastShot < 200) return;
                const speed = 5;
                const angle = this.player.angle;
                this.bullets.push({
                    x: this.center.x + (this.planetRadius + this.player.length) * Math.cos(angle),
                    y: this.center.y + (this.planetRadius + this.player.length) * Math.sin(angle),
                    vx: speed * Math.cos(angle),
                    vy: speed * Math.sin(angle),
                    radius: 3,
                });
                this.lastShot = Date.now();
            }

            spawnEnemy() {
                const angle = Math.random() * Math.PI * 2;
                const dist = Math.hypot(this.canvas.width, this.canvas.height) / 2;
                const x = this.center.x + dist * Math.cos(angle);
                const y = this.center.y + dist * Math.sin(angle);
                
                const angleToCenter = Math.atan2(this.center.y - y, this.center.x - x);
                
                this.enemies.push({
                    x, y,
                    vx: this.config.enemySpeed * Math.cos(angleToCenter),
                    vy: this.config.enemySpeed * Math.sin(angleToCenter),
                    radius: 10 + Math.random() * 10
                });
            }

            gameLoop() {
                if (this.gameOver) {
                    this.draw(); // Draw final frame
                    return;
                }
                this.update();
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
            }
        }
        
        class DoodleJump {
             constructor() {
                this.canvas = document.getElementById('doodlejump-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.statusEl = document.getElementById('doodlejump-status');
                this.difficultySelect = document.getElementById('doodlejump-difficulty');
                // 【修复】调整难度参数，增加平台下落速度
                this.difficulties = {
                    easy: { gravity: 0.2, jump: -8, speed: 3, platformSpeed: 0.5 },
                    medium: { gravity: 0.3, jump: -9, speed: 4, platformSpeed: 1 },
                    hard: { gravity: 0.4, jump: -10, speed: 5, platformSpeed: 1.5 },
                };
                this.handleKeyDown = this.handleKeyDown.bind(this);
                this.handleKeyUp = this.handleKeyUp.bind(this);
                this.handleButtonDown = (e) => this.handleButtonInput(e, true);
                this.handleButtonUp = (e) => this.handleButtonInput(e, false);
            }

            start() {
                this.cleanup();
                this.config = this.difficulties[this.difficultySelect.value];
                
                this.canvas.width = this.canvas.parentElement.offsetWidth;
                this.canvas.height = this.canvas.parentElement.offsetHeight;
                
                // 【修复】玩家从中间平台开始
                this.platforms = [];
                this.platforms.push({ x: this.canvas.width / 2 - 30, y: this.canvas.height - 50, width: 60, height: 10, type: 'normal' });

                for (let i = 1; i < 10; i++) {
                    this.platforms.push({
                        x: Math.random() * (this.canvas.width - 60),
                        y: this.platforms[i-1].y - (60 + Math.random() * 20),
                        width: 60, height: 10,
                        type: Math.random() > 0.8 ? 'fragile' : 'normal' // 20%的概率是脆弱平台
                    });
                }
                
                this.player = { x: this.platforms[0].x + 15, y: this.platforms[0].y - 30, width: 30, height: 30, vx: 0, vy: 0 };

                this.score = 0;
                this.highestY = this.player.y;
                this.gameOver = false;
                this.keys = {};
                
                document.addEventListener('keydown', this.handleKeyDown);
                document.addEventListener('keyup', this.handleKeyUp);
                const btnContainer = document.querySelector('#doodlejump-container .button-layout-container');
                btnContainer.addEventListener('touchstart', this.handleButtonDown, { passive: false });
                btnContainer.addEventListener('touchend', this.handleButtonUp, { passive: false });
                btnContainer.addEventListener('mousedown', this.handleButtonDown);
                btnContainer.addEventListener('mouseup', this.handleButtonUp);

                this.gameLoop();
            }
            cleanup() {
                if(this.animationFrameId) cancelAnimationFrame(this.animationFrameId);
                document.removeEventListener('keydown', this.handleKeyDown);
                document.removeEventListener('keyup', this.handleKeyUp);
                const btnContainer = document.querySelector('#doodlejump-container .button-layout-container');
                if (btnContainer) {
                    btnContainer.removeEventListener('touchstart', this.handleButtonDown);
                    btnContainer.removeEventListener('touchend', this.handleButtonUp);
                    btnContainer.removeEventListener('mousedown', this.handleButtonDown);
                    btnContainer.removeEventListener('mouseup', this.handleButtonUp);
                }
            }
            handleKeyDown(e) { this.keys[e.keyCode] = true; }
            handleKeyUp(e) { this.keys[e.keyCode] = false; }
            handleButtonInput(e, isPressed) {
                e.preventDefault();
                const btn = e.target.closest('.dpad-btn');
                if(!btn) return;
                const dir = btn.dataset.dir;
                if (dir === 'left') this.keys['left'] = isPressed;
                if (dir === 'right') this.keys['right'] = isPressed;
            }

            update() {
                // Player horizontal movement
                if (this.keys[37] || this.keys['left']) this.player.vx = -this.config.speed; // Left
                else if (this.keys[39] || this.keys['right']) this.player.vx = this.config.speed; // Right
                else this.player.vx = 0;
                
                this.player.x += this.player.vx;

                // Wall wrap
                if (this.player.x > this.canvas.width) this.player.x = -this.player.width;
                else if (this.player.x < -this.player.width) this.player.x = this.canvas.width;

                // Player vertical movement (gravity)
                this.player.vy += this.config.gravity;
                this.player.y += this.player.vy;
                
                // 【修复】核心逻辑：向上移动相机
                if (this.player.y < this.canvas.height / 2) {
                    let displacement = -this.player.vy;
                    this.platforms.forEach(p => {
                        p.y += displacement;
                    });
                    this.player.y += displacement;
                    this.highestY += displacement;
                }
                
                // Collision with platforms
                this.platforms.forEach((p, index) => {
                    // 只在下落时检测碰撞
                    if (this.player.vy > 0 && 
                        this.player.x < p.x + p.width && 
                        this.player.x + this.player.width > p.x &&
                        this.player.y + this.player.height > p.y &&
                        this.player.y + this.player.height < p.y + p.height + 10) 
                    {
                        if (p.type === 'fragile') {
                            p.isBroken = true; // 标记为踩碎
                            setTimeout(() => {
                                const pIndex = this.platforms.indexOf(p);
                                if (pIndex > -1) this.platforms.splice(pIndex, 1);
                            }, 300);
                        }
                        this.player.vy = this.config.jump;
                    }
                });
                
                 // 更新分数
                if (this.player.y < this.highestY) {
                    this.score += Math.floor(this.highestY - this.player.y);
                    this.highestY = this.player.y;
                }

                // Game over
                if (this.player.y > this.canvas.height) {
                    this.gameOver = true;
                }

                // 移除屏幕下方的平台并生成新平台
                while (this.platforms.length > 0 && this.platforms[0].y > this.canvas.height) {
                    this.platforms.shift();
                }

                while (this.platforms[this.platforms.length - 1].y > -this.canvas.height) {
                    this.platforms.push({
                         x: Math.random() * (this.canvas.width - 60),
                         y: this.platforms[this.platforms.length - 1].y - (60 + Math.random() * 30),
                         width: 60, height: 10,
                         type: Math.random() > 0.8 ? 'fragile' : 'normal'
                    });
                }
            }

            draw() {
                this.ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#1c1c1e' : '#f0f2f5';
                this.ctx.fillRect(0,0,this.canvas.width, this.canvas.height);

                // Platforms
                this.platforms.forEach(p => {
                    if (p.type === 'fragile') {
                        this.ctx.fillStyle = p.isBroken ? 'rgba(139, 69, 19, 0.3)' : '#8B4513';
                    } else {
                        this.ctx.fillStyle = 'green';
                    }
                    this.ctx.fillRect(p.x, p.y, p.width, p.height);
                });

                // Player
                this.ctx.fillStyle = 'purple';
                this.ctx.fillRect(this.player.x, this.player.y, this.player.width, this.player.height);

                // Score
                this.statusEl.textContent = `Score: ${this.score}`;
                
                if(this.gameOver) {
                    this.ctx.fillStyle = document.body.classList.contains('dark-mode') ? 'white' : 'black';
                    this.ctx.font = '40px sans-serif';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText('Game Over', this.canvas.width/2, this.canvas.height/2);
                    this.ctx.font = '20px sans-serif';
                    this.ctx.fillText(`Final Score: ${this.score}`, this.canvas.width/2, this.canvas.height/2 + 40);
                }
            }
            
            gameLoop() {
                if (this.gameOver) {
                    this.draw();
                    return;
                }
                this.update();
                this.draw();
                this.animationFrameId = requestAnimationFrame(this.gameLoop.bind(this));
            }
        }

        class LightsOut {
            constructor() {
                this.gridEl = document.getElementById('lightsout-grid');
                this.statusEl = document.getElementById('lightsout-status');
                this.difficultySelect = document.getElementById('lightsout-difficulty');
                this.sizes = { easy: 3, medium: 4, hard: 5 };
                this.start();
            }
            cleanup() {}

            start() {
                this.size = this.sizes[this.difficultySelect.value];
                this.steps = 0;
                this.gameOver = false;
                this.board = Array(this.size).fill(0).map(() => Array(this.size).fill(false));
                this.generatePuzzle();
                this.render();
                this.statusEl.textContent = `步数: 0`;
            }

            generatePuzzle() {
                // Ensure the puzzle is solvable by starting from a solved state and clicking random cells
                for (let i = 0; i < this.size * this.size; i++) {
                    if (Math.random() > 0.5) {
                        this.toggleLights(Math.floor(i / this.size), i % this.size);
                    }
                }
                 // If it's accidentally solved, click one more time
                if (this.board.flat().every(light => !light)) {
                    this.toggleLights(0, 0);
                }
            }

            render() {
                this.gridEl.innerHTML = '';
                this.gridEl.style.gridTemplateColumns = `repeat(${this.size}, 1fr)`;
                const cellSize = Math.min(60, (this.gridEl.parentElement.offsetWidth - 40) / this.size);
                this.gridEl.style.width = `${this.size * (cellSize + 5)}px`;

                for(let r=0; r<this.size; r++) {
                    for(let c=0; c<this.size; c++) {
                        const cell = document.createElement('div');
                        cell.className = 'lightsout-cell';
                        cell.classList.add(this.board[r][c] ? 'on' : 'off');
                        cell.style.width = `${cellSize}px`;
                        cell.addEventListener('click', () => this.handleClick(r,c));
                        this.gridEl.appendChild(cell);
                    }
                }
            }

            handleClick(r, c) {
                if (this.gameOver) return;
                this.steps++;
                this.toggleLights(r, c);
                this.render();
                this.statusEl.textContent = `步数: ${this.steps}`;
                if (this.board.flat().every(light => !light)) { // 目标是关掉所有灯
                    this.gameOver = true;
                    this.statusEl.textContent += ` - 恭喜通关！`;
                }
            }

            toggleLights(r, c) {
                const positions = [[0,0], [0,1], [0,-1], [1,0], [-1,0]];
                positions.forEach(([dr, dc]) => {
                    const nr = r + dr;
                    const nc = c + dc;
                    if (nr >= 0 && nr < this.size && nc >= 0 && nc < this.size) {
                        this.board[nr][nc] = !this.board[nr][nc];
                    }
                });
            }
        }
        
        
        
        // =======================================================================
        // 11. 初始化
        // =======================================================================
        async function initializeApp() {
            document.querySelector('.send-btn').addEventListener('mousedown', (e) => {
                e.preventDefault();
                sendQuickDiary();
            });
            
            // 中文注释：检查是否是第一次使用，如果是，就创建一些默认数据。
            const profile = await dbActions.get('profile', 'userProfile');
            if (!profile) {
                await dbActions.set('profile', 'userProfile', { name: '新用户', id: 'yun000812', bio: '这个人很懒...', avatar: '', background: '' });
                await dbActions.set('settings', 'language', 'zh-CN');
                await dbActions.set('settings', 'darkMode', false);
                await dbActions.set('settings', 'theme', {});
                await dbActions.set('settings', 'font', null);
                await dbActions.set('settings', 'showLunarCalendar', false);
                await dbActions.set('settings', 'showHolidays', false);
                await dbActions.set('settings', 'fontPresets', []);
                await dbActions.set('settings', 'customCss', '');
            }
            const defaultNotebook = await dbActions.get('notebooks', 1);
            if (!defaultNotebook) {
                await dbActions.put('notebooks', { id: 1, name: '默认日记本', cover: '' });
            }

            await refreshAllDataAndRender();
            showPage('diary-page');
        }

        initializeApp();
    }
</script>
</html>
