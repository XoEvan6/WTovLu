<!DOCTYPE html>
<!-- 中文注释：这是整个HTML文档的开始 -->
<html lang="ja">
<!-- 中文注释：上面这行是网页的头部信息区域 -->
<head>
    <!-- 中文注释：设置网页使用UTF-8编码，这是国际通用的标准，可以防止中文乱码 -->
    <meta charset="UTF-8">
    <!-- 中文注释：这是针对手机等移动设备的重要设置，让网页能更好地适应不同大小的屏幕 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- 中文注释：下面这些是专门为苹果iOS设备设置的，当用户把这个网页添加到手机主屏幕时，它看起来会更像一个真正的App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="プラタナス">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/h4y5qkCL/IMG-3987.jpg">

    <!-- 中文注释：这是网页的标题，会显示在浏览器的标签页上 -->
    <title>プラタナス</title>
    
    <!-- 中文注释：下面这些是引用的外部文件，它们提供了图标、地图、字体等功能和样式 -->
    <!-- 中文注释：Font Awesome图标库，提供了你在页面上看到的各种小图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- 中文注释：【修复问题2】将地图相关的样式(CSS)和脚本(JS)文件提前到这里加载，确保在使用前它们已经准备就绪 -->
    <!-- 中文注释：Leaflet地图库的样式文件，定义了地图的外观 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- 中文注释：Leaflet地图搜索框插件的样式文件 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    <!-- 中文注释：Leaflet地图库的核心脚本文件，提供了地图功能 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- 中文注释：Leaflet地图搜索框插件的脚本文件 -->
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- 中文注释：IndexedDB的辅助库，让数据存储操作更简单 -->
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <!-- 中文注释：一个用于农历和公历转换的库 -->
    <script src="https://unpkg.com/solarlunar@2.0.7/solarlunar.min.js"></script>
    
    <!-- 中文注释：从Google Fonts加载网络字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=ZCOOL+KuaiLe&family=Ma+Shan+Zheng&family=Long+Cang&family=Zhi+Mang+Xing&family=Smiley+Sans&display=swap" rel="stylesheet">

    <!-- 中文注释：下面是CSS样式部分，它决定了网页的所有外观，比如颜色、布局、大小等 -->
    <style>
        /* 中文注释：CSS样式部分开始 */

        /* 中文注释：定义全局的设计变量，比如颜色、字体等，方便统一修改 */
        :root {
            /* 全局颜色变量 */
            --global-bg: #f0f2f5; /* 全局背景色 */
            --primary-text: #333; /* 主要文字颜色 */
            --secondary-text: #888; /* 次要文字颜色，比如时间戳 */
            --card-bg: #ffffff; /* 卡片背景色 */
            --nav-bg: #ffffff; /* 导航栏背景色 */
            --nav-icon-color: #999; /* 导航栏图标颜色 */
            --nav-icon-active-color: #007aff; /* 导航栏当前选中项的图标颜色 */
            --accent-color: #007aff; /* 强调色，比如按钮、链接 */
            --border-color: #e0e0e0; /* 边框颜色 */
            --diary-header-bg: #f7f7f7; /* 日记卡片头部的背景色 */
            --danger-color: #ff3b30; /* 危险操作颜色，比如删除按钮 */
            --global-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; /* 全局默认字体 */
            --income-color: #28a745; /* 记账本中“收入”的颜色 */
            --expense-color: #dc3545; /* 记账本中“支出”的颜色 */
        }

        /* 中文注释：黑夜模式下的颜色变量 */
        .dark-mode {
            /* 修正黑夜模式颜色 */
            --global-bg: #000000;
            --primary-text: #f5f5f7;
            --secondary-text: #8e8e93;
            --card-bg: #1c1c1e;
            --nav-bg: #1c1c1e;
            --nav-icon-color: #8e8e93;
            --nav-icon-active-color: var(--accent-color);
            --border-color: #3a3a3c;
            --diary-header-bg: #2c2c2e;
            --danger-color: #ff453a;
            --income-color: #34c759;
            --expense-color: #ff453a;
        }

        /* 中文注释：基础样式重置，清除所有元素的默认边距和内边距，让所有东西从零开始，方便我们自己控制 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* 点击元素时去除手机上的默认高亮效果 */
        }

        /* 中文注释：让html和body元素占满整个屏幕 */
        html, body {
            overflow: hidden; /* 隐藏滚动条，由内部的 content-area 区域来滚动 */
            height: 100%;
            width: 100%;
        }

        /* 中文注释：整个页面的基础样式 */
        body {
            font-family: var(--global-font-family); /* 使用我们定义的全局字体 */
            background-color: var(--theme-global-bg-color, var(--global-bg)); /* 使用主题背景色，如果没有就用默认的 */
            background-image: var(--theme-global-bg-image); /* 使用主题背景图片 */
            background-repeat: no-repeat; /* 背景图不重复 */
            background-size: cover; /* 背景图铺满 */
            background-position: center; /* 背景图居中 */
            color: var(--primary-text); /* 使用主题主文字颜色 */
            transition: background-color 0.3s, color 0.3s; /* 颜色变化时有0.3秒的过渡动画 */
            font-size: 16px; /* 默认字号 */
        }
        /* 中文注释：如果设置了全局背景图，做一些特殊处理 */
        body.has-global-bg-image {
            background-color: transparent !important; /* 背景色设为透明 */
        }
        body.has-global-bg-image .app-container,
        body.has-global-bg-image .content-area {
            background-color: transparent !important; /* 应用容器和内容区的背景也设为透明 */
        }


        /* 中文注释：整个应用的主容器，它是一个垂直排列的弹性盒子 */
        .app-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--global-bg);
        }

        /* 中文注释：页面内容区域，它会占据除了顶部和底部导航栏之外的所有空间 */
        .content-area {
            flex-grow: 1; /* 占据所有剩余空间 */
            overflow-y: auto; /* 内容超出时可以垂直滚动 */
            padding-bottom: 60px; /* 底部留出空间，防止被导航栏遮挡 */
            background-color: transparent;
            -webkit-overflow-scrolling: touch; /* 在iOS上实现更平滑的滚动效果 */
        }

        /* 中文注释：每一个功能页面（如日记、我的、日历）的通用样式 */
        .page {
            display: none; /* 默认隐藏 */
            animation: fadeIn 0.3s ease-in-out; /* 出现时有淡入动画 */
            background-color: transparent;
            padding: 15px; /* 页面内边距 */
            padding-top: 85px; /* 顶部留出空间，防止被顶部栏遮挡 */
        }
        
        /* 中文注释：为特定页面设置自定义背景 */
        #diary-page { background-color: var(--theme-diary-page-bg-color); background-image: var(--theme-diary-page-bg-image); }

        /* 中文注释：当前显示的页面的样式 */
        .page.active {
            display: block; /* 设置为块级元素，使其显示出来 */
        }

        /* 中文注释：定义一个名为fadeIn的动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; } /* 从完全透明开始 */
            to { opacity: 1; } /* 到完全不透明结束 */
        }

        /* 中文注释：底部导航栏样式 */
        .bottom-nav {
            position: fixed; /* 固定在屏幕底部 */
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px; /* 高度60像素 */
            background-color: var(--nav-bg); /* 背景色 */
            border-top: 1px solid var(--border-color); /* 顶部有一条细线 */
            display: flex; /* 使用flex布局 */
            justify-content: space-around; /* 项目平均分布 */
            align-items: center; /* 项目垂直居中 */
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05); /* 顶部有轻微的阴影 */
            z-index: 100; /* 层级较高，确保在其他元素之上 */
            flex-shrink: 0; /* 防止被压缩 */
        }

        /* 中文注释：底部导航栏里每一个项目的样式 */
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--nav-icon-color); font-size: 12px; cursor: pointer; flex: 1; }
        .nav-item i { font-size: 22px; margin-bottom: 4px; } /* 图标样式 */
        .nav-item.active { color: var(--nav-icon-active-color); } /* 选中项的样式 */

        /* 中文注释：顶部栏样式 */
        .top-bar {
            position: fixed; /* 固定在屏幕顶部 */
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            padding-top: 30px; /* 为手机状态栏留出空间 */
            background-color: var(--card-bg);
            z-index: 90;
            border-bottom: 1px solid var(--border-color);
            transition: opacity 0.3s;
        }
        /* 中文注释：当在“我的”页面或有独立头部的页面时，隐藏这个通用的顶部栏 */
        body.my-page-active .top-bar,
        body.page-with-header .top-bar {
            opacity: 0;
            pointer-events: none; /* 不可点击 */
        }
        .top-bar-title-container { display: flex; align-items: center; gap: 10px; flex-grow: 1; }
        .top-bar-title { font-size: 24px; font-weight: bold; } /* 标题样式 */
        .top-bar-avatar { width: 36px; height: 36px; border-radius: 50%; cursor: pointer; object-fit: cover; flex-shrink: 0; margin-left: 15px; } /* 头像样式 */
        
        /* 中文注释：顶部栏右侧的功能区图标样式 (日记本、搜索) */
        .top-bar-actions { display: flex; align-items: center; gap: 15px; }
        .notebook-icon, .search-icon { cursor: pointer; font-size: 20px; color: var(--primary-text); }
        
        /* 中文注释：搜索框的样式和动画 */
        .search-container { display: flex; align-items: center; width: 0; opacity: 0; transition: width 0.3s, opacity 0.3s; overflow: hidden; }
        .search-container.active { width: calc(100% - 200px); opacity: 1; } /* 激活时展开 */
        #diary-search-input { width: 100%; font-size: 14px; margin-bottom: 0; }

        /* 中文注释：快速日记编辑器的样式 */
        #quick-diary-editor {
            background-color: var(--card-bg);
            border-radius: 12px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        /* 中文注释：编辑器收起时的样式 */
        .editor-collapsed-view { display: flex; align-items: center; cursor: pointer; }
        .editor-collapsed-view img { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; }
        .editor-collapsed-view span { color: var(--secondary-text); }
        /* 中文注释：编辑器展开时的样式 */
        .editor-expanded-view { display: none; }
        #quick-diary-editor.expanded .editor-collapsed-view { display: none; }
        #quick-diary-editor.expanded .editor-expanded-view { display: block; }
        
        /* 中文注释：富文本编辑工具栏样式 */
        .editor-toolbar {
            display: flex;
            gap: 15px;
            padding: 8px 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .editor-toolbar button {
            background: none;
            border: none;
            font-size: 16px;
            color: var(--secondary-text);
            cursor: pointer;
            padding: 5px;
        }
        .editor-toolbar button:hover {
            color: var(--primary-text);
        }

        /* 中文注释：快速日记的文本输入框样式 */
        #quick-diary-textarea { width: 100%; min-height: 100px; border: none; background: transparent; color: var(--primary-text); resize: vertical; font-size: 16px; padding: 0; }
        #quick-diary-textarea:focus { outline: none; } /* 获得焦点时去掉边框 */
        /* 中文注释：编辑器底部的操作区样式 */
        .editor-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 10px; }
        .editor-actions .action-buttons { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; }
        .editor-actions .action-buttons i { font-size: 20px; color: var(--secondary-text); cursor: pointer; }
        .editor-actions .send-btn { background-color: var(--accent-color); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        .editor-actions .send-btn:disabled { background-color: #999; cursor: not-allowed; } /* 发送按钮禁用时的样式 */

        /* 中文注释：日记卡片样式 */
        .diary-card { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden; color: var(--theme-diary-primary-text-color, var(--primary-text)); contain: content; position: relative; }
        .diary-card-header { background-color: var(--diary-header-bg); padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; }
        .diary-author { display: flex; align-items: center; }
        .diary-author-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
        .diary-author-info .name { font-weight: bold; font-size: 16px; color: var(--theme-diary-primary-text-color, var(--primary-text)); }
        .diary-author-info .id { font-size: 12px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); }
        .diary-meta { display: flex; flex-direction: column; align-items: flex-end; }
        .diary-meta .mood-weather { font-size: 12px; text-align: right; margin-top: 4px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); }
        .diary-timestamp { font-size: 12px; color: var(--theme-diary-secondary-text-color, var(--secondary-text)); text-align: right; }
        .diary-card-body { padding: 15px; border-bottom: 1px solid var(--border-color); }
        .diary-card-content { line-height: 1.7; white-space: pre-wrap; font-size: 15px; word-break: break-word; color: var(--theme-diary-primary-text-color, var(--primary-text)); }
        /* 中文注释：处理日记内容中的粗体、斜体等格式 */
        .diary-card-content b, .diary-card-content strong { font-weight: bold; }
        .diary-card-content i, .diary-card-content em { font-style: italic; }
        .diary-card-content u { text-decoration: underline; }
        .diary-card-content del, .diary-card-content s { text-decoration: line-through; }
        .diary-card-content a { color: var(--accent-color); text-decoration: none; }
        .diary-card-content a:hover { text-decoration: underline; }
        
        /* 中文注释：置顶图标样式 */
        .pinned-icon {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 14px;
            color: var(--accent-color);
        }

        /* 中文注释：日记中的图片、视频、音频的网格布局 */
        .diary-media { margin-top: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 5px; }
        .media-item { width: 100%; height: 100px; position: relative; cursor: pointer; background-color: #eee; border-radius: 8px; overflow: hidden; }
        .dark-mode .media-item { background-color: #333; }
        .media-item img, .media-item video { width: 100%; height: 100%; object-fit: cover; }
        .media-item .video-play-icon { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 30px; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5); pointer-events: none; }
        .media-item.audio-player { width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px; }
        .media-item.audio-player i { font-size: 30px; margin-bottom: 10px; color: var(--primary-text); }
        .media-item.audio-player audio { display: block; width: 100%; height: 30px; }

        /* 中文注释：日记卡片底部的页脚UI */
        .diary-card-footer { padding: 8px 15px; font-size: 12px; color: var(--secondary-text); display: flex; justify-content: space-between; align-items: center; }
        .diary-footer-left { display: flex; align-items: center; gap: 10px; }
        .diary-footer-right { display: flex; align-items: center; gap: 18px; }
        .diary-footer-right i { cursor: pointer; font-size: 16px; color: var(--secondary-text); transition: color 0.2s, transform 0.2s; }
        .diary-footer-right .favorite-btn.favorited { color: var(--accent-color); transform: scale(1.2); } /* 收藏按钮激活后的样式 */
        .diary-footer-right .comment-toggle-btn.active { color: var(--accent-color); }

        /* 中文注释：评论区UI */
        .comment-section { padding: 10px 15px; display: none; border-top: 1px solid var(--border-color); }
        .comment-section.active { display: block; }
        .comment-input-area { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
        .comment-input-area input { flex-grow: 1; margin-bottom: 0; }
        .comment-input-area .send-comment-btn {
            flex-shrink: 0;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }
        .view-more-comments { color: var(--accent-color); cursor: pointer; font-size: 14px; margin-top: 10px; }
        .comment { display: flex; margin-top: 10px; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .comment-body { flex-grow: 1; }
        .comment-header { font-size: 12px; color: var(--secondary-text); margin-bottom: 4px; }
        .comment-header .id { font-weight: bold; color: var(--primary-text); }
        .comment-content { font-size: 14px; word-break: break-word; color: var(--primary-text); }

        /* 中文注释：模态框/弹窗的通用样式 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background-color: var(--card-bg); width: 90%; max-width: 500px; border-radius: 15px; display: flex; flex-direction: column; max-height: 90vh; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { font-size: 20px; font-weight: bold; padding: 15px 20px; border-bottom: 1px solid var(--border-color); }
        .modal-body { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .modal-footer { padding: 10px 20px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; background-color: var(--global-bg); border-bottom-left-radius: 15px; border-bottom-right-radius: 15px; }
        .dark-mode .modal-footer { background-color: var(--card-bg); }

        /* 中文注释：自定义的确认/输入/菜单弹窗样式 */
        .custom-modal-content { text-align: center; padding: 30px 20px; max-width: 340px; }
        .custom-modal-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .custom-modal-message { font-size: 14px; color: var(--secondary-text); margin-bottom: 20px; padding: 0; }
        .custom-modal-input { margin: 0 0 20px; }
        .custom-modal-footer { display: flex; border-top: 1px solid var(--border-color); padding: 0; margin: 0 -20px -30px; }
        .custom-modal-footer button { flex: 1; background: transparent; border: none; padding: 15px; font-size: 16px; cursor: pointer; }
        .custom-modal-footer button:first-child { border-right: 1px solid var(--border-color); color: var(--secondary-text); }
        .custom-modal-footer button.confirm-ok { color: var(--accent-color); font-weight: bold; }
        .action-menu-modal .menu-section { margin: -20px; }

        /* 中文注释：表单元素（输入框、选择框等）的通用样式 */
        textarea, input[type="text"], input[type="password"], input[type="datetime-local"], input[type="date"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--global-bg); color: var(--primary-text); font-size: 16px; margin-bottom: 10px; }
        .dark-mode textarea, .dark-mode input[type="text"], .dark-mode input[type="password"], .dark-mode input[type="datetime-local"], .dark-mode input[type="date"], .dark-mode input[type="number"], .dark-mode select { background-color: #333; color: var(--primary-text); border-color: #444; }
        textarea { min-height: 150px; resize: vertical; }
        .button { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-left: 10px; }
        .button-primary { background-color: var(--accent-color); color: white; }
        .button-secondary { background-color: var(--border-color); color: var(--primary-text); }
        
        /* 中文注释："我的" 页面样式 */
        #my-page { padding: 0; padding-top: 0; }
        #my-page .profile-header { position: relative; height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; color: white; text-shadow: 0 1px 3px rgba(0,0,0,0.5); padding-top: 50px; margin-bottom: -30px; }
        #my-page .profile-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        #my-page .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); object-fit: cover; margin-bottom: 10px; }
        #my-page .profile-info-wrapper { text-align: center; position: relative; }
        #my-page .profile-name { font-size: 22px; font-weight: bold; }
        #my-page .profile-id { font-size: 13px; background-color: rgba(0,0,0,0.2); padding: 2px 8px; border-radius: 10px; margin-top: 5px; }
        #my-page .profile-bio { font-size: 14px; margin-top: 8px; }
        #my-page .profile-stats { display: flex; justify-content: space-around; padding: 20px; background-color: var(--card-bg); margin: 0 15px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); position: relative; z-index: 1; }
        .stat-item { text-align: center; }
        .stat-item .count { font-size: 20px; font-weight: bold; }
        .stat-item .label { font-size: 12px; color: var(--secondary-text); }
        #my-page-content { padding: 15px; }

        /* 中文注释：从右侧滑出的侧边功能菜单样式 */
        .side-menu { position: fixed; top: 0; right: -100%; width: 80%; max-width: 320px; height: 100%; background-color: var(--global-bg); box-shadow: -5px 0 15px rgba(0,0,0,0.1); z-index: 1001; transition: right 0.3s ease-in-out; padding: 20px; padding-top: 50px; overflow-y: auto; }
        .side-menu.active { right: 0; }
        .side-menu-header { display: flex; align-items: center; margin-bottom: 30px; }
        .side-menu-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; }
        .side-menu-info .name { font-size: 18px; font-weight: bold; }
        .side-menu-info .bio { font-size: 14px; color: var(--secondary-text); }
        .menu-section { background-color: var(--card-bg); border-radius: 12px; margin-bottom: 20px; overflow: hidden; }
        .menu-item { display: flex; align-items: center; padding: 15px; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .menu-item:last-child { border-bottom: none; }
        .menu-item i { width: 20px; margin-right: 15px; color: var(--secondary-text); text-align: center; }
        .menu-item svg { width: 20px; height: 20px; margin-right: 15px; fill: currentColor; color: var(--secondary-text); }
        
        /* 中文注释：日记本选择的悬浮弹窗样式 */
        .notebook-popup {
            position: absolute;
            top: 75px;
            right: 60px;
            width: 280px;
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 95;
            padding: 10px;
            display: none;
            animation: fadeIn 0.2s ease-out;
        }
        .notebook-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 5px 10px 5px;
            border-bottom: 1px solid var(--border-color);
        }
        .notebook-popup-header h3 { font-size: 16px; margin: 0; }
        #add-notebook-popup-btn { background: none; border: none; color: var(--accent-color); font-size: 22px; cursor: pointer; }
        .notebook-popup-list { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 5px 5px 5px; max-height: 200px; overflow-y: auto; }
        .notebook-popup-item { width: 55px; height: 80px; border-radius: 4px; background-color: #e9e9e9; cursor: pointer; position: relative; display: flex; align-items: flex-end; padding: 8px 5px; overflow: hidden; border: 2px solid transparent; transition: border-color 0.2s; }
        .dark-mode .notebook-popup-item { background-color: #3a3a3c; }
        .notebook-popup-item.active { border-color: var(--accent-color); }
        .notebook-popup-item-cover { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .notebook-popup-item-name { position: relative; z-index: 2; color: white; font-size: 12px; font-weight: bold; text-shadow: 0 1px 2px rgba(0,0,0,0.7); writing-mode: vertical-rl; text-orientation: mixed; white-space: nowrap; transform: rotate(180deg); margin-left: auto; margin-right: auto; }
        .notebook-popup-item-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.6) 0%, transparent 50%); z-index: 1; }


        /* 中文注释：地图页面样式 */
        #map-page { padding: 0; height: 100vh; position: relative; }
        #map { width: 100%; height: 100%; z-index: 400; }
        #map-back-btn { position: absolute; top: 80px; right: 15px; left: auto; z-index: 401; background: rgba(255,255,255,0.8); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        .dark-mode #map-back-btn { background: rgba(30,30,30,0.8); color: white; }
        #map-selection-bar {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 401;
            background-color: var(--card-bg);
            padding: 10px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
        }
        /* 中文注释：【修复问题2】确保地图搜索框在深色模式下也清晰可见 */
        .leaflet-control-geocoder { z-index: 402 !important; }
        .leaflet-control-geocoder-form input {
            background-color: var(--card-bg) !important;
            color: var(--primary-text) !important;
            border: 1px solid var(--border-color) !important;
        }
        .leaflet-control-geocoder-alternatives {
            background-color: var(--card-bg) !important;
        }
        .leaflet-control-geocoder-alternatives a {
            color: var(--primary-text) !important;
        }
        .leaflet-control-geocoder-alternatives a:hover {
            background-color: var(--global-bg) !important;
        }

        /* 中文注释：遮罩层样式，用于弹出侧边栏时覆盖主页面 */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); z-index: 1000; display: none; }
        .overlay.active { display: block; }
        
        /* 中文注释：日历样式 */
        .calendar-container { background-color: var(--card-bg); border-radius: 12px; padding: 15px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 18px; font-weight: bold; }
        .calendar-toggles-container { font-size: 12px; display: flex; align-items: center; gap: 15px; font-weight: normal; margin-bottom: 15px; justify-content: flex-end; }
        .calendar-toggles-container > div { display: flex; align-items: center; gap: 5px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-day, .calendar-weekday { padding: 5px 0; font-size: 14px; display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 38px; }
        .calendar-weekday { color: var(--secondary-text); font-weight: bold; }
        .calendar-day { cursor: pointer; position: relative; border-radius: 50%; }
        .calendar-day.other-month { color: var(--secondary-text); opacity: 0.5; }
        .calendar-day.today { background-color: var(--accent-color); color: white; }
        .calendar-day.today .lunar-date { color: white; }
        .calendar-day.selected { border: 2px solid var(--accent-color); }
        .calendar-day.has-diary::after { content: '●'; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--accent-color); } /* 有日记的日期下面有个小点 */
        .calendar-day.is-holiday::before { content: '●'; position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 8px; color: var(--danger-color); } /* 节假日上面有个小点 */
        .dark-mode .calendar-day.today { color: var(--primary-text); }
        .lunar-date { font-size: 10px; color: var(--secondary-text); }
        .lunar-date.is-festival { color: var(--danger-color); font-weight: bold; }
        #selected-date-info { text-align: center; margin-top: 15px; padding: 10px; background-color: var(--card-bg); border-radius: 8px; font-size: 14px; color: var(--danger-color); font-weight: bold; }

        /* 中文注释：图片/视频全屏查看器样式 */
        #media-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        #media-viewer img, #media-viewer video {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        #media-viewer-close {
            position: absolute;
            top: 40px;
            right: 20px;
            font-size: 28px;
            color: white;
            cursor: pointer;
            z-index: 2001;
        }

        /* 中文注释：通用的页面头部样式（用于收藏、设置等页面） */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            align-items: center;
            padding: 15px;
            padding-top: 30px;
            background-color: var(--card-bg);
            z-index: 90;
            border-bottom: 1px solid var(--border-color);
        }
        .page-header .back-btn {
            font-size: 20px;
            cursor: pointer;
            width: 40px;
        }
        .page-header .title {
            flex-grow: 1;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-right: 40px; /* 为右侧按钮留出空间 */
        }
        .page-header .actions {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            padding-top: 15px; /* 适配padding-top */
        }
        .page-header .actions .action-btn {
            font-size: 20px;
            color: var(--primary-text);
            cursor: pointer;
        }
        
        /* 中文注释：收藏、字体、主题等带头部的页面专属样式 */
        #favorites-page, #font-settings-page, #theme-settings-page, #anniversary-page, #accounting-page, #snippets-page { padding: 0; }
        #favorites-list-container, #font-settings-content, .page-content {
            padding: 15px;
            padding-top: 85px; /* 85px = 70px header + 15px padding */
        }
        
        /* 中文注释：字体预设相关样式 */
        .font-url-container { display: flex; align-items: center; gap: 10px; }
        .font-url-container input { flex-grow: 1; margin: 0 !important; }
        .font-url-container .button { margin-left: 0; flex-shrink: 0; }
        .delete-preset-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
        .delete-preset-item:last-child { border-bottom: none; }
        .delete-preset-item button { background-color: var(--danger-color); color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer; }

        /* 中文注释：纪念日页面样式 */
        .anniversary-item { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            padding: 15px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            background-size: cover;
            background-position: center;
        }
        .anniversary-item .pinned-icon { top: 15px; left: 15px; }
        .anniversary-item-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.3);
            z-index: 1;
            display: none;
        }
        .anniversary-item.has-background .anniversary-item-overlay { display: block; }
        .anniversary-item.has-background .anniversary-info,
        .anniversary-item.has-background .anniversary-days,
        .anniversary-item.has-background .pinned-icon {
            position: relative;
            z-index: 2;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .anniversary-info .name { font-size: 18px; font-weight: bold; }
        .anniversary-info .date { font-size: 12px; color: var(--secondary-text); }
        .anniversary-item.has-background .anniversary-info .date { color: rgba(255,255,255,0.8); }
        .anniversary-days .count { font-size: 24px; font-weight: bold; color: var(--accent-color); }
        .anniversary-item.has-background .anniversary-days .count { color: white; }
        .anniversary-days .label { font-size: 12px; color: var(--secondary-text); text-align: right; }
        .anniversary-item.has-background .anniversary-days .label { color: rgba(255,255,255,0.8); }

        /* 中文注释：记账本页面样式 */
        .accounting-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--card-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .accounting-controls .view-toggle {
            display: flex;
            background-color: var(--global-bg);
            border-radius: 6px;
            padding: 2px;
        }
        .accounting-controls .view-toggle button {
            padding: 5px 10px;
            border: none;
            background: transparent;
            color: var(--secondary-text);
            font-size: 14px;
            cursor: pointer;
            border-radius: 5px;
        }
        .accounting-controls .view-toggle button.active {
            background-color: var(--card-bg);
            color: var(--primary-text);
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .accounting-controls .date-nav {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .accounting-controls .date-nav button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--primary-text);
        }
        .accounting-controls .date-nav #accounting-current-period {
            font-weight: bold;
            font-size: 16px;
        }

        .accounting-summary { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .summary-card { background-color: var(--card-bg); border-radius: 12px; padding: 15px; text-align: center; }
        .summary-card .label { font-size: 14px; color: var(--secondary-text); }
        .summary-card .amount { font-size: 22px; font-weight: bold; margin-top: 5px; }
        .summary-card .amount.income { color: var(--income-color); }
        .summary-card .amount.expense { color: var(--expense-color); }
        .summary-card.balance .amount { color: var(--primary-text); }
        .accounting-summary .summary-card:nth-child(3) { grid-column: span 2; }
        .transaction-group { margin-bottom: 15px; }
        .transaction-group-header {
            font-size: 14px;
            font-weight: bold;
            color: var(--secondary-text);
            padding: 5px 15px;
            background-color: var(--global-bg);
            border-radius: 6px;
            margin-bottom: 5px;
        }
        .transaction-item { background-color: var(--card-bg); border-radius: 8px; padding: 10px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .transaction-info .desc { font-size: 16px; }
        .transaction-info .date { font-size: 12px; color: var(--secondary-text); }
        .transaction-amount.income { color: var(--income-color); font-weight: bold; }
        .transaction-amount.expense { color: var(--expense-color); font-weight: bold; }

        /* 中文注释：言语集页面样式 */
        .snippet-collection { 
            background-color: var(--card-bg); 
            border-radius: 12px; 
            margin-bottom: 15px; 
            overflow: hidden;
            position: relative;
            background-size: cover;
            background-position: center;
        }
        .snippet-collection-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.4);
            z-index: 1;
            display: none;
        }
        .snippet-collection.has-background .snippet-collection-overlay { display: block; }
        .snippet-collection.has-background .snippet-collection-header,
        .snippet-collection.has-background .snippet-item,
        .snippet-collection.has-background .add-snippet-form {
            position: relative;
            z-index: 2;
            color: white;
            border-color: rgba(255,255,255,0.2) !important;
        }
        .snippet-collection.has-background .snippet-collection-header h3,
        .snippet-collection.has-background .snippet-collection-header i,
        .snippet-collection.has-background .snippet-item .timestamp {
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .snippet-collection-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-color); }
        .snippet-collection-header h3 { margin: 0; }
        .snippet-collection-header .actions { display: flex; align-items: center; gap: 15px; }
        .snippet-collection-header .actions i { color: var(--secondary-text); transition: transform 0.3s; }
        .snippet-collection.expanded .snippet-collection-header .actions i { transform: rotate(180deg); }
        .snippet-collection-body { padding: 0 15px 15px; display: none; }
        .snippet-collection.expanded .snippet-collection-body { display: block; }
        .snippet-item { border-top: 1px solid var(--border-color); padding: 10px 0; display: flex; align-items: center; gap: 10px; }
        .snippet-item .content { white-space: pre-wrap; word-break: break-word; flex-grow: 1; }
        .snippet-item .timestamp { font-size: 12px; color: var(--secondary-text); margin-top: 5px; text-align: right; }
        .add-snippet-form {
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .add-snippet-form textarea {
            min-height: 60px;
            margin-bottom: 10px;
        }
        .add-snippet-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .add-snippet-form-actions .button {
            margin-left: 0;
            padding: 5px 15px;
        }
        /* 中文注释：言语集管理模式样式 */
        .snippet-delete-checkbox { display: none; }
        .snippet-collection.manage-mode .snippet-delete-checkbox { display: inline-block; }
        .snippet-collection.manage-mode .add-snippet-btn-container { display: none; }
        .snippet-collection-manage-header { display: none; padding: 15px; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .snippet-collection.manage-mode .snippet-collection-header { display: none; }
        .snippet-collection.manage-mode .snippet-collection-manage-header { display: flex; }

    </style>
</head>
<!-- 中文注释：网页的主体部分开始，所有可见内容都在这里 -->
<body>

    <!-- 中文注释：整个应用的主容器 -->
    <div class="app-container">

        <!-- 中文注释：顶部通用栏 -->
        <div class="top-bar" id="top-bar">
            <div class="top-bar-title-container">
                <div class="top-bar-title" id="top-bar-title">プラタナス</div>
                <div class="search-container" id="search-container">
                    <input type="text" id="diary-search-input" placeholder="搜索日记...">
                </div>
            </div>
            <div class="top-bar-actions">
                <i class="fas fa-book notebook-icon" id="notebook-icon" title="选择日记本"></i>
                <i class="fas fa-search search-icon" id="search-icon"></i>
            </div>
            <img src="https://via.placeholder.com/100" alt="avatar" class="top-bar-avatar" id="topBarAvatar">
        </div>

        <!-- 中文注释：页面内容区域，所有页面都在这里切换显示 -->
        <div class="content-area">

            <!-- 中文注释：日记页面 -->
            <div id="diary-page" class="page active">
                <!-- 中文注释：快速日记编辑器 -->
                <div id="quick-diary-editor">
                    <!-- 中文注释：编辑器收起时的样子 -->
                    <div class="editor-collapsed-view">
                        <img src="https://via.placeholder.com/100" alt="avatar" id="quick-editor-avatar">
                        <span data-lang-key="write_something">写点什么...</span>
                    </div>
                    <!-- 中文注释：编辑器展开时的样子 -->
                    <div class="editor-expanded-view">
                        <div class="editor-toolbar">
                            <button data-format="bold" title="加粗"><b>B</b></button>
                            <button data-format="italic" title="斜体"><i>I</i></button>
                            <button data-format="underline" title="下划线"><u>U</u></button>
                            <button data-format="strikethrough" title="删除线"><s>S</s></button>
                            <button data-format="link" title="链接"><i class="fas fa-link"></i></button>
                        </div>
                        <textarea id="quick-diary-textarea" placeholder="写点什么吧..."></textarea>
                        <div class="editor-actions">
                            <div class="action-buttons">
                                <i class="fas fa-image" data-action="add-media" title="添加图片/视频"></i>
                                <i class="fas fa-microphone" data-action="add-audio" title="添加语音"></i>
                                <i class="far fa-smile" data-action="add-mood" title="添加心情"></i>
                                <i class="fas fa-cloud-sun" data-action="add-weather" title="添加天气"></i>
                                <i class="fas fa-folder-open" data-action="quick-select-notebook" title="选择日记本"></i>
                                <i class="fas fa-calendar-day" data-action="set-custom-date" title="自定义日期"></i>
                                <i class="fas fa-map-marker-alt" data-action="set-location" title="设置地点"></i>
                            </div>
                            <button class="send-btn">发送</button>
                        </div>
                    </div>
                </div>
                <!-- 中文注释：日记列表将在这里显示 -->
                <div id="diary-list"></div>
            </div>

            <!-- 中文注释：我的页面 -->
            <div id="my-page" class="page">
                <div class="profile-header">
                    <img src="https://via.placeholder.com/800x400" alt="background" class="profile-bg" id="profileBg">
                    <img src="https://via.placeholder.com/100" alt="avatar" class="profile-avatar" id="profileAvatar">
                    <div class="profile-info-wrapper">
                        <div class="profile-name" id="profileName"></div>
                        <div class="profile-id">ID: <span id="profileId"></span></div>
                        <div class="profile-bio" id="profileBio"></div>
                    </div>
                </div>
                <div class="profile-stats">
                    <div class="stat-item"><div class="count" id="diaryCount">0</div><div class="label" data-lang-key="diaries">日记</div></div>
                    <div class="stat-item"><div class="count" id="notebookCount">1</div><div class="label" data-lang-key="notebooks">日记本</div></div>
                    <div class="stat-item"><div class="count" id="daysCount">0</div><div class="label" data-lang-key="days">记录天数</div></div>
                </div>
                <div id="my-page-content">
                    <div id="pinned-diary-container"></div>
                    <div id="recent-diaries-container">
                        <h3 style="margin-bottom: 10px;" data-lang-key="recent_diaries">近期日记</h3>
                        <div id="recent-diaries-list"></div>
                    </div>
                </div>
            </div>

            <!-- 中文注释：日历页面 -->
            <div id="calendar-page" class="page">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <button id="prev-month" class="button-secondary"><i class="fas fa-chevron-left"></i></button>
                        <span id="current-month-year"></span>
                        <button id="next-month" class="button-secondary"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-toggles-container">
                        <div>
                            <label for="lunar-calendar-toggle" data-lang-key="show_lunar_calendar">显示农历</label>
                            <input type="checkbox" id="lunar-calendar-toggle">
                        </div>
                        <div>
                            <label for="holiday-calendar-toggle" data-lang-key="show_holidays">显示节日</label>
                            <input type="checkbox" id="holiday-calendar-toggle">
                        </div>
                    </div>
                    <div class="calendar-grid" id="weekdays"></div>
                    <div class="calendar-grid" id="calendar-days"></div>
                </div>
                <div id="selected-date-info" style="display: none;"></div>
                <div id="diaries-for-date" style="margin-top: 20px;"></div>
            </div>
            
            <!-- 中文注释：地图页面 -->
            <div id="map-page" class="page">
                <!-- 中文注释：地图将在这里显示 -->
                <div id="map"></div>
                <!-- 中文注释：地图页面的返回按钮 -->
                <div id="map-back-btn"><i class="fas fa-arrow-left"></i></div>
                <!-- 中文注释：在地图上选点后出现的确认栏 -->
                <div id="map-selection-bar">
                    <button class="button button-primary" data-action="confirm-map-selection" data-lang-key="confirm_selection">在此选定</button>
                </div>
            </div>
            
            <!-- 中文注释：主题设置页面 -->
            <div id="theme-settings-page" class="page">
                 <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="theme_settings">主题设置</h2>
                </div>
                <div class="page-content">
                    <div class="theme-section">
                        <h3 data-lang-key="global_theme">全局主题</h3>
                        <div class="theme-setting-item"><label data-lang-key="bg_color">背景色</label><div class="controls"><input type="color" id="theme-global-bg-color"><button class="button button-secondary" data-action="reset-theme" data-key="globalBgColor">重置</button></div></div>
                        <div class="theme-setting-item"><label data-lang-key="bg_image">背景图</label><div class="controls"><button class="button button-secondary" data-action="upload-theme-image" data-key="globalBgImage">上传</button><button class="button button-secondary" data-action="reset-theme" data-key="globalBgImage">重置</button></div></div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="diary_theme">日记主题</h3>
                        <div class="theme-setting-item"><label data-lang-key="primary_text_color">主文字颜色</label><div class="controls"><input type="color" id="theme-diary-primary-text-color"><button class="button button-secondary" data-action="reset-theme" data-key="diaryPrimaryTextColor">重置</button></div></div>
                        <div class="theme-setting-item"><label data-lang-key="secondary_text_color">次文字颜色</label><div class="controls"><input type="color" id="theme-diary-secondary-text-color"><button class="button button-secondary" data-action="reset-theme" data-key="diarySecondaryTextColor">重置</button></div></div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="accent_color_theme">一键主题色</h3>
                        <div class="theme-setting-item"><label data-lang-key="accent_color">强调色</label><div class="controls"><input type="color" id="theme-accent-color"><button class="button button-secondary" data-action="reset-theme" data-key="accentColor">重置</button></div></div>
                    </div>
                </div>
            </div>

            <!-- 中文注释：收藏页面 -->
            <div id="favorites-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="my_favorites">我的收藏</h2>
                </div>
                <div id="favorites-list-container"></div>
            </div>

            <!-- 中文注释：字体设置页面 -->
            <div id="font-settings-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="font_settings">字体设置</h2>
                </div>
                <div id="font-settings-content">
                    <div class="theme-section">
                        <h3 data-lang-key="builtin_fonts">字体选择</h3>
                        <div class="theme-setting-item">
                            <select id="font-select" style="width: 100%; margin: 0;"></select>
                        </div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="web_font_url">网络字体URL</h3>
                        <div class="theme-setting-item font-url-container">
                            <input type="text" id="font-url-input" placeholder="https://...">
                            <button class="button button-secondary" data-action="manage-font-preset" data-lang-key="manage_presets">管理预设</button>
                        </div>
                    </div>
                    <div class="theme-section">
                        <h3 data-lang-key="local_font_file">本地字体文件</h3>
                        <button class="button button-secondary" data-action="upload-local-font" style="width: 100%; margin: 0;">上传字体文件</button>
                        <p style="font-size: 12px; color: var(--danger-color); margin-top: 10px;" data-lang-key="local_font_warning">警告：上传本地字体文件可能会占用大量存储空间并导致应用卡顿。</p>
                    </div>
                    <div class="theme-section">
                        <button class="button button-primary" data-action="apply-font" style="width: 100%; margin: 10px 0 0 0;" data-lang-key="apply">应用</button>
                        <button class="button button-secondary" data-action="reset-font" style="width: 100%; margin: 10px 0 0 0;" data-lang-key="reset_to_default">重置为默认字体</button>
                    </div>
                </div>
            </div>

            <!-- 中文注释：纪念日页面 -->
            <div id="anniversary-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="anniversaries">纪念日</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-anniversary"></i>
                    </div>
                </div>
                <div class="page-content" id="anniversary-list-container"></div>
            </div>

            <!-- 中文注释：记账本页面 -->
            <div id="accounting-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="accounting">记账本</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-transaction"></i>
                    </div>
                </div>
                <div class="page-content">
                    <div class="accounting-controls">
                        <div class="view-toggle">
                            <button data-view="day" data-lang-key="view_day">日</button>
                            <button data-view="month" class="active" data-lang-key="view_month">月</button>
                            <button data-view="year" data-lang-key="view_year">年</button>
                        </div>
                        <div class="date-nav">
                            <button data-nav="prev"><i class="fas fa-chevron-left"></i></button>
                            <span id="accounting-current-period"></span>
                            <button data-nav="next"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    <div class="accounting-summary" id="accounting-summary-container"></div>
                    <div id="transaction-list-container"></div>
                </div>
            </div>

            <!-- 中文注释：言语集页面 -->
            <div id="snippets-page" class="page">
                <div class="page-header">
                    <i class="fas fa-arrow-left back-btn" data-action="back-to-my-page"></i>
                    <h2 class="title" data-lang-key="snippets">言语集</h2>
                    <div class="actions">
                        <i class="fas fa-plus action-btn" data-action="add-snippet-collection"></i>
                    </div>
                </div>
                <div class="page-content" id="snippet-collection-container"></div>
            </div>

        </div>

        <!-- 中文注释：底部导航栏 -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-page="diary-page"><i class="fas fa-book-open"></i><span data-lang-key="nav_diary">日记</span></div>
            <div class="nav-item" data-page="calendar-page"><i class="fas fa-calendar-alt"></i><span data-lang-key="date">日期</span></div>
            <div class="nav-item" data-page="my-page"><i class="fas fa-user"></i><span data-lang-key="my">我的</span></div>
        </nav>

    </div>

    <!-- 中文注释：日记本悬浮弹窗 -->
    <div id="notebook-popup" class="notebook-popup">
        <div class="notebook-popup-header">
            <h3 data-lang-key="notebooks">日记本</h3>
            <button id="add-notebook-popup-btn" title="新建日记本" data-action="add-notebook"><i class="fas fa-plus"></i></button>
        </div>
        <div id="notebook-popup-list" class="notebook-popup-list"></div>
    </div>

    <!-- 中文注释：所有弹窗的容器 -->
    <div id="modal-container"></div>
    
    <!-- 中文注释：侧边功能菜单 -->
    <div class="side-menu" id="sideMenu">
        <div class="side-menu-header"><img src="https://via.placeholder.com/100" alt="avatar" class="side-menu-avatar" id="sideMenuAvatar"><div class="side-menu-info"><div class="name" id="sideMenuName"></div><div class="bio" id="sideMenuBio"></div></div></div>
        <div class="menu-section">
            <div class="menu-item" data-action="edit-profile"><i class="fas fa-user-edit"></i> <span data-lang-key="edit_profile">编辑资料</span></div>
            <div class="menu-item" data-action="show-page" data-page="favorites-page"><i class="fas fa-star"></i> <span data-lang-key="my_favorites">我的收藏</span></div>
            <div class="menu-item" data-action="show-page" data-page="map-page"><i class="fas fa-map-marked-alt"></i> <span data-lang-key="map">地图</span></div>
            <div class="menu-item" data-action="show-page" data-page="anniversary-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path><path d="M16.5 10.5c-1.24 0-2.25 1.01-2.25 2.25s1.01 2.25 2.25 2.25 2.25-1.01 2.25-2.25-1.01-2.25-2.25-2.25zm0 3.5c-.69 0-1.25-.56-1.25-1.25s.56-1.25 1.25-1.25 1.25.56 1.25 1.25-.56 1.25-1.25 1.25z"></path></svg>
                <span data-lang-key="anniversaries">纪念日</span>
            </div>
            <div class="menu-item" data-action="show-page" data-page="accounting-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 18v1c0 1.1-.9 2-2 2H5c-1.11 0-2-.9-2-2V5c0-1.1.89-2 2-2h14c1.1 0 2 .9 2 2v1h-9c-1.11 0-2 .9-2 2v8c0 1.1.89 2 2 2h9zm-9-2h10V8H12v8zm4-2.5c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5z"></path></svg>
                <span data-lang-key="accounting">记账本</span>
            </div>
            <div class="menu-item" data-action="show-page" data-page="snippets-page">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"></path></svg>
                <span data-lang-key="snippets">言语集</span>
            </div>
        </div>
        <div class="menu-section">
            <div class="menu-item" data-action="show-page" data-page="theme-settings-page"><i class="fas fa-palette"></i> <span data-lang-key="theme">主题</span></div>
            <div class="menu-item" data-action="show-page" data-page="font-settings-page"><i class="fas fa-font"></i> <span data-lang-key="font_settings">字体设置</span></div>
            <div class="menu-item" data-action="open-language-modal"><i class="fas fa-language"></i> <span data-lang-key="language">语言</span></div>
            <div class="menu-item"><i class="fas fa-moon"></i><span data-lang-key="dark_mode">黑夜模式</span><input type="checkbox" id="darkModeToggle" style="margin-left: auto;"></div>
        </div>
        <div class="menu-section">
            <div class="menu-item" data-action="export-data"><i class="fas fa-file-export"></i> <span data-lang-key="export_data">导出数据</span></div>
            <div class="menu-item" data-action="import-data"><i class="fas fa-file-import"></i> <span data-lang-key="import_data">导入数据</span></div>
        </div>
    </div>
    
    <!-- 中文注释：遮罩层，用于配合侧边栏和弹窗使用 -->
    <div class="overlay" id="overlay"></div>

    <!-- 中文注释：图片/视频全屏查看器 -->
    <div id="media-viewer">
        <i class="fas fa-times" id="media-viewer-close"></i>
        <img id="media-viewer-image" src="">
        <video id="media-viewer-video" src="" controls></video>
    </div>

</body>
<!-- 中文注释：这是我们应用的核心脚本，所有的交互和功能都在这里实现 -->
<script>
    /*
     * 中文注释：这是一个自我提醒，确保代码在整个页面加载完毕后才开始运行。
     * 【修复#1】卡顿和无响应问题：
     * 问题的根源在于 e.preventDefault() 在 touchstart 事件中被立即调用，这阻止了浏览器的默认滚动行为。
     * 正确的做法是只在确认长按（计时器触发）后才阻止默认行为（比如弹出菜单时阻止后续的点击），
     * 或者在 touchmove 时清除计时器，让滚动正常发生。
     * 这里的修复是：从 touchstart 的处理函数中移除了 e.preventDefault()。
     */
    document.addEventListener('DOMContentLoaded', async () => {

        // =======================================================================
        // 1. 数据库核心 (IndexedDB)
        // 中文注释：这部分代码负责和手机本地的数据库打交道，用来存储你的所有数据（日记、设置等）。
        // 这样即使你关闭了网页再打开，数据也不会丢失。
        // =======================================================================
        const db = await idb.openDB('platanusDB', 3, {
            upgrade(db, oldVersion, newVersion, transaction) {
                // 中文注释：这个函数在数据库版本更新时运行，用来创建或修改数据“表”。
                if (oldVersion < 1) {
                    if (!db.objectStoreNames.contains('profile')) db.createObjectStore('profile');
                    if (!db.objectStoreNames.contains('diaries')) {
                        const store = db.createObjectStore('diaries', { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp');
                        store.createIndex('notebookId', 'notebookId');
                    }
                    if (!db.objectStoreNames.contains('notebooks')) db.createObjectStore('notebooks', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings');
                }
                if (oldVersion < 2) {
                    if (!db.objectStoreNames.contains('anniversaries')) db.createObjectStore('anniversaries', { keyPath: 'id', autoIncrement: true });
                    if (!db.objectStoreNames.contains('transactions')) {
                        const store = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp');
                    }
                    if (!db.objectStoreNames.contains('snippets')) {
                        const store = db.createObjectStore('snippets', { keyPath: 'id', autoIncrement: true });
                        store.createIndex('collectionId', 'collectionId');
                    }
                    if (!db.objectStoreNames.contains('snippetCollections')) db.createObjectStore('snippetCollections', { keyPath: 'id', autoIncrement: true });
                }
                if (oldVersion < 3) {
                    console.log('数据库升级到版本3');
                }
            },
        });

        // 中文注释：这里封装了一些常用的数据库操作，比如“增删改查”，让后面的代码调用起来更方便。
        const dbActions = {
            get: (store, key) => db.get(store, key),
            set: (store, key, val) => db.put(store, val, key),
            delete: (store, key) => db.delete(store, key),
            getAll: (store) => db.getAll(store),
            add: (store, val) => db.add(store, val),
            put: (store, val) => db.put(store, val),
            getFromIndex: (store, indexName, query) => db.getAllFromIndex(store, indexName, query),
            clear: (store) => db.clear(store),
        };

        // =======================================================================
        // 2. 全局变量和状态
        // 中文注释：这里定义了一些全局变量，用来在内存中临时存放应用的状态和数据，方便随时取用。
        // =======================================================================
        let appData = { profile: {}, diaries: [], notebooks: [], settings: { darkMode: false, language: 'zh-CN', theme: {}, font: null, showLunarCalendar: false, showHolidays: false, fontPresets: [] }, anniversaries: [], transactions: [], snippets: [], snippetCollections: [] };
        let quickDiaryData = { media: [], mood: '', weather: '', location: null, notebookId: 1, customTimestamp: null };
        let pendingProfileImages = { avatar: null, background: null };
        let currentDate = new Date();
        let map, isMapInitialized = false, isMapInSelectionMode = false, tempMapMarker = null;
        let currentNotebookFilter = 'all';
        let diaryRenderer = { observer: null, diaries: [], currentIndex: 0, batchSize: 10 };
        let mediaRecorder, audioChunks = [];
        let tempFont = { type: null, data: null, name: null };
        let accountingState = { view: 'month', date: new Date() };

        // =======================================================================
        // 3. 多语言引擎
        // 中文注释：这里存放了所有支持的语言文本。当切换语言时，程序会从这里找到对应的文字并显示在界面上。
        // =======================================================================
        const translations = {
            'zh-CN': { nav_diary: '日记', date: '日期', notebooks: '日记本', my: '我的', diaries: '日记', days: '记录天数', recent_diaries: '近期日记', new: '新建', map: '地图', theme: '主题', language: '语言', dark_mode: '黑夜模式', export_data: '导出数据', import_data: '导入数据', select_language: '选择语言', cancel: '取消', reset: '重置', upload: '上传', global_theme: '全局主题', bg_color: '背景色', bg_image: '背景图', diary_theme: '日记主题', primary_text_color: '主文字颜色', secondary_text_color: '次文字颜色', theme_settings: '主题设置', delete: '删除', no_diaries: '还没有日记', add_comment: '评论', year: '年', month: '月', edit: '编辑', save: '保存', new_diary: '写新日记', edit_diary: '编辑日记', content: '内容', mood: '心情', weather: '天气', location: '位置', images: '图片', notebook: '日记本', default_notebook: '默认日记本', all_diaries: '全部', new_notebook: '新建日记本', notebook_name: '日记本名称', confirm_delete: '确认删除吗？此操作不可撤销。', delete_success: '删除成功', import_confirm: '导入数据将覆盖当前所有数据，确定吗？此操作会清除包括纪念日、记账本等所有数据。', import_success: '导入成功！', export_success: '导出成功！', no_recent_diaries: '最近没有写日记哦', accent_color_theme: '一键主题色', accent_color: '强调色', edit_profile: '编辑资料', profile_name: '昵称', profile_id: 'ID', profile_bio: '个人简介', upload_avatar: '上传头像', upload_background: '上传背景', write_something: '写点什么...', select_notebook: '选择日记本', location_failed: '无法获取地理位置，日记将不包含位置信息。请检查手机定位服务和应用权限。', edit_notebook_name: '编辑日记本名称', change_notebook_cover: '更换封面', enter_cover_url: '请输入封面图片URL', upload_from_local: '本地上传', default_notebook_no_delete: '默认日记本不能删除', my_favorites: '收藏', no_favorites: '还没有收藏任何日记', set_custom_date: '设置发布时间', link_url: '链接地址', enter_link_url: '请输入网址', pin_diary: '置顶日记', unpin_diary: '取消置顶', pinned: '已置顶', show_lunar_calendar: '显示农历', show_holidays: '显示节日', no_holiday_today: '今天没有特别的节日', add_audio: '添加语音', live_record: '实时录音', upload_audio: '上传音频', recording: '录音中...', stop_recording: '停止录音', record_failed: '录音失败，请检查麦克风权限。', set_location: '设置地点', auto_detect: '自动获取', select_on_map: '地图选点', manual_entry: '手动输入', enter_location_name: '请输入地点名称', font_settings: '字体设置', builtin_fonts: '字体选择', web_font_url: '网络字体URL', local_font_file: '本地字体文件', local_font_warning: '警告：上传本地字体文件可能会占用大量存储空间并导致应用卡顿。', reset_to_default: '重置为默认字体', apply: '应用', manage_presets: '管理预设', save_as_preset: '保存为新预设', delete_preset: '删除预设', enter_preset_name: '请输入预设名称', preset_name: '预设名称', no_presets_to_delete: '没有可删除的预设', my_presets: '我的预设', built_in_group: '内置字体', anniversaries: '纪念日', accounting: '记账本', snippets: '言语集', add_anniversary: '添加纪念日', anniversary_name: '名称', anniversary_date: '日期', anniversary_type: '类型', anniversary: '纪念日', target_day: '目标日', passed: '已过', remaining: '还有', days_unit: '天', add_transaction: '添加账单', transaction_type: '类型', income: '收入', expense: '支出', amount: '金额', description: '描述', total_income: '总收入', total_expense: '总支出', balance: '结余', add_snippet_collection: '新建言语集', collection_name: '言语集名称', add_snippet: '发表言语', snippet_content: '言语内容', no_items_yet: '还没有任何记录，点击右上角“+”添加吧！', edit_anniversary: '编辑纪念日', edit_transaction: '编辑账单', edit_snippet: '编辑言语', pin: '置顶', unpin: '取消置顶', change_background: '更换背景', view_day: '日', view_month: '月', view_year: '年', confirm_selection: '在此选定', search_location: '搜索地点...', word_count_unit: '字', manage_snippets: '管理言语', delete_selected: '删除所选' },
            'zh-TW': { nav_diary: '日記', date: '日期', notebooks: '日記本', my: '我的', diaries: '日記', days: '記錄天數', recent_diaries: '近期日記', new: '新建', map: '地圖', theme: '主題', language: '語言', dark_mode: '黑夜模式', export_data: '匯出資料', import_data: '匯入資料', select_language: '選擇語言', cancel: '取消', reset: '重置', upload: '上傳', global_theme: '全域主題', bg_color: '背景顏色', bg_image: '背景圖片', diary_theme: '日記主題', primary_text_color: '主文字顏色', secondary_text_color: '次要文字顏色', theme_settings: '主題設定', delete: '刪除', no_diaries: '還沒有日記', add_comment: '評論', year: '年', month: '月', edit: '編輯', save: '儲存', new_diary: '寫新日記', edit_diary: '編輯日記', content: '內容', mood: '心情', weather: '天氣', location: '位置', images: '圖片', notebook: '日記本', default_notebook: '預設日記本', all_diaries: '全部', new_notebook: '新建日記本', notebook_name: '日記本名稱', confirm_delete: '確認刪除嗎？此操作不可撤銷。', delete_success: '刪除成功', import_confirm: '導入數據將覆蓋當前所有數據，確定嗎？此操作會清除包括紀念日、記賬本等所有數據。', import_success: '導入成功！', export_success: '導出成功！', no_recent_diaries: '最近沒有寫日記哦', accent_color_theme: '一鍵主題色', accent_color: '強調色', edit_profile: '編輯資料', profile_name: '暱稱', profile_id: 'ID', profile_bio: '個人簡介', upload_avatar: '上傳頭像', upload_background: '上傳背景', write_something: '寫點什麼...', select_notebook: '選擇日記本', location_failed: '無法獲取地理位置，日記將不包含位置信息。請檢查手機定位服務和應用權限。', edit_notebook_name: '編輯日記本名稱', change_notebook_cover: '更換封面', enter_cover_url: '請輸入封面圖片URL', upload_from_local: '本地上傳', default_notebook_no_delete: '預設日記本不能刪除', my_favorites: '收藏', no_favorites: '還沒有收藏任何日記', set_custom_date: '設定發佈時間', link_url: '連結網址', enter_link_url: '請輸入網址', pin_diary: '置頂日記', unpin_diary: '取消置頂', pinned: '已置頂', show_lunar_calendar: '顯示農曆', show_holidays: '顯示節日', no_holiday_today: '今天沒有特別的節日', add_audio: '添加語音', live_record: '即時錄音', upload_audio: '上傳音訊', recording: '錄音中...', stop_recording: '停止錄音', record_failed: '錄音失敗，請檢查麥克風權限。', set_location: '設定地點', auto_detect: '自動獲取', select_on_map: '地圖選點', manual_entry: '手動輸入', enter_location_name: '請輸入地點名稱', font_settings: '字體設定', builtin_fonts: '字體選擇', web_font_url: '網路字體URL', local_font_file: '本機字體檔案', local_font_warning: '警告：上傳本機字體檔案可能會佔用大量儲存空間並導致應用程式卡頓。', reset_to_default: '重設為預設字體', apply: '套用', manage_presets: '管理預設', save_as_preset: '另存為預設', delete_preset: '刪除預設', enter_preset_name: '請輸入預設名稱', preset_name: '預設名稱', no_presets_to_delete: '沒有可刪除的預設', my_presets: '我的預設', built_in_group: '內建字體', anniversaries: '紀念日', accounting: '記帳本', snippets: '言語集', add_anniversary: '新增紀念日', anniversary_name: '名稱', anniversary_date: '日期', anniversary_type: '類型', anniversary: '紀念日', target_day: '目標日', passed: '已過', remaining: '還有', days_unit: '天', add_transaction: '新增帳單', transaction_type: '類型', income: '收入', expense: '支出', amount: '金額', description: '描述', total_income: '總收入', total_expense: '總支出', balance: '結餘', add_snippet_collection: '新建言語集', collection_name: '言語集名稱', add_snippet: '發表言語', snippet_content: '言語內容', no_items_yet: '還沒有任何記錄，點擊右上角“+”新增吧！', edit_anniversary: '編輯紀念日', edit_transaction: '編輯帳單', edit_snippet: '編輯言語', pin: '置頂', unpin: '取消置頂', change_background: '更換背景', view_day: '日', view_month: '月', view_year: '年', confirm_selection: '在此選定', search_location: '搜尋地點...', word_count_unit: '字', manage_snippets: '管理言語', delete_selected: '刪除所選' },
            'ja': { nav_diary: '日記', date: '日付', notebooks: '日記帳', my: '私', diaries: '日記', days: '記録日数', recent_diaries: '最近の日記', new: '新規', map: '地図', theme: 'テーマ', language: '言語', dark_mode: 'ダークモード', export_data: 'データエクスポート', import_data: 'データインポート', select_language: '言語を選択', cancel: 'キャンセル', reset: 'リセット', upload: 'アップロード', global_theme: '全体テーマ', bg_color: '背景色', bg_image: '背景画像', diary_theme: '日記テーマ', primary_text_color: 'メインテキスト色', secondary_text_color: 'サブテキスト色', theme_settings: 'テーマ設定', delete: '削除', no_diaries: '日記がありません', add_comment: 'コメント', year: '年', month: '月', edit: '編集', save: '保存', new_diary: '新しい日記', edit_diary: '日記を編集', content: '内容', mood: '気分', weather: '天気', location: '場所', images: '写真', notebook: '日記帳', default_notebook: 'デフォルト', all_diaries: 'すべて', new_notebook: '新しい日記帳', notebook_name: '日記帳の名前', confirm_delete: '本当に削除しますか？', delete_success: '削除しました', import_confirm: 'インポートすると現在のデータが上書きされます。よろしいですか？この操作は記念日や会計帳などのデータもすべて消去します。', import_success: 'インポート成功！', export_success: 'エクスポート成功！', no_recent_diaries: '最近の日記はありません', accent_color_theme: 'アクセントカラー', accent_color: 'アクセントカラー', edit_profile: 'プロフィール編集', profile_name: 'ニックネーム', profile_id: 'ID', profile_bio: '自己紹介', upload_avatar: 'アバターをアップロード', upload_background: '背景をアップロード', write_something: '何か書く...', select_notebook: '日記帳を選択', location_failed: '位置情報を取得できませんでした。日記に位置情報は含まれません。端末の位置情報サービスとアプリの権限を確認してください。', edit_notebook_name: '日記帳名を編集', change_notebook_cover: 'カバーを変更', enter_cover_url: 'カバー画像のURLを入力', upload_from_local: 'ローカルからアップロード', default_notebook_no_delete: 'デフォルトの日記帳は削除できません', my_favorites: 'お気に入り', no_favorites: 'お気に入りの日記はありません', set_custom_date: '投稿日時を設定', link_url: 'リンクURL', enter_link_url: 'URLを入力してください', pin_diary: '日記をピン留め', unpin_diary: 'ピン留めを解除', pinned: 'ピン留め済み', show_lunar_calendar: '旧暦を表示', show_holidays: '祝日を表示', no_holiday_today: '今日は特別な祝日はありません', add_audio: '音声を追加', live_record: 'ライブ録音', upload_audio: '音声をアップロード', recording: '録音中...', stop_recording: '録音停止', record_failed: '録音に失敗しました。マイクの権限を確認してください。', set_location: '場所を設定', auto_detect: '自動検出', select_on_map: '地図で選択', manual_entry: '手動入力', enter_location_name: '場所の名前を入力', font_settings: 'フォント設定', builtin_fonts: 'フォント選択', web_font_url: 'WebフォントURL', local_font_file: 'ローカルフォントファイル', local_font_warning: '警告：ローカルフォントファイルをアップロードすると、ストレージを大量に消費し、アプリの動作が遅くなる可能性があります。', reset_to_default: 'デフォルトにリセット', apply: '適用', manage_presets: 'プリセット管理', save_as_preset: 'プリセットとして保存', delete_preset: 'プリセットを削除', enter_preset_name: 'プリセット名を入力', preset_name: 'プリセット名', no_presets_to_delete: '削除できるプリセットがありません', my_presets: 'マイプリセット', built_in_group: '内蔵フォント', anniversaries: '記念日', accounting: '会計帳', snippets: '言葉集', add_anniversary: '記念日を追加', anniversary_name: '名前', anniversary_date: '日付', anniversary_type: 'タイプ', anniversary: '記念日', target_day: '目標日', passed: '経過', remaining: '残り', days_unit: '日', add_transaction: '取引を追加', transaction_type: 'タイプ', income: '収入', expense: '支出', amount: '金額', description: '説明', total_income: '総収入', total_expense: '総支出', balance: '残高', add_snippet_collection: '新しい言葉集を作成', collection_name: '言葉集の名前', add_snippet: '言葉を追加', snippet_content: '内容', no_items_yet: 'まだ記録がありません。右上の「+」をクリックして追加してください。', edit_anniversary: '記念日を編集', edit_transaction: '取引を編集', edit_snippet: '言葉を編集', pin: 'ピン留め', unpin: 'ピン留め解除', change_background: '背景を変更', view_day: '日', view_month: '月', view_year: '年', confirm_selection: 'ここで選択', search_location: '場所を検索...', word_count_unit: '字', manage_snippets: '言葉を管理', delete_selected: '選択項目を削除' },
            'en': { nav_diary: 'Diary', date: 'Date', notebooks: 'Notebooks', my: 'My', diaries: 'Diaries', days: 'Days', recent_diaries: 'Recent Diaries', new: 'New', map: 'Map', theme: 'Theme', language: 'Language', dark_mode: 'Dark Mode', export_data: 'Export Data', import_data: 'Import Data', select_language: 'Select Language', cancel: 'Cancel', reset: 'Reset', upload: 'Upload', global_theme: 'Global Theme', bg_color: 'Background Color', bg_image: 'Background Image', diary_theme: 'Diary Theme', primary_text_color: 'Primary Text Color', secondary_text_color: 'Secondary Text Color', theme_settings: 'Theme Settings', delete: 'Delete', no_diaries: 'No diaries yet', add_comment: 'Comment', year: 'Year', month: 'Month', edit: 'Edit', save: 'Save', new_diary: 'New Diary', edit_diary: 'Edit Diary', content: 'Content', mood: 'Mood', weather: 'Weather', location: 'Location', images: 'Images', notebook: 'Notebook', default_notebook: 'Default Notebook', all_diaries: 'All', new_notebook: 'New Notebook', notebook_name: 'Notebook Name', confirm_delete: 'Are you sure you want to delete this? This action cannot be undone.', delete_success: 'Deleted successfully', import_confirm: 'Importing will overwrite all current data. Are you sure? This action will also clear all data including anniversaries, transactions, etc.', import_success: 'Import successful!', export_success: 'Export successful!', no_recent_diaries: 'No recent diaries', accent_color_theme: 'Accent Color Theme', accent_color: 'Accent Color', edit_profile: 'Edit Profile', profile_name: 'Name', profile_id: 'ID', profile_bio: 'Bio', upload_avatar: 'Upload Avatar', upload_background: 'Upload Background', write_something: 'Write something...', select_notebook: 'Select Notebook', location_failed: 'Could not get location. The diary will not include location data. Please check your device\'s location services and app permissions.', edit_notebook_name: 'Edit Notebook Name', change_notebook_cover: 'Change Cover', enter_cover_url: 'Enter cover image URL', upload_from_local: 'Upload from Local', default_notebook_no_delete: 'The default notebook cannot be deleted', my_favorites: 'Favorite', no_favorites: 'No favorite diaries yet', set_custom_date: 'Set Post Time', link_url: 'Link URL', enter_link_url: 'Please enter a URL', pin_diary: 'Pin Diary', unpin_diary: 'Unpin Diary', pinned: 'Pinned', show_lunar_calendar: 'Show Lunar', show_holidays: 'Show Holidays', no_holiday_today: 'No special holiday today', add_audio: 'Add Audio', live_record: 'Live Record', upload_audio: 'Upload Audio', recording: 'Recording...', stop_recording: 'Stop Recording', record_failed: 'Recording failed. Please check microphone permissions.', set_location: 'Set Location', auto_detect: 'Auto-detect', select_on_map: 'Select on Map', manual_entry: 'Manual Entry', enter_location_name: 'Enter location name', font_settings: 'Font Settings', builtin_fonts: 'Font Selection', web_font_url: 'Web Font URL', local_font_file: 'Local Font File', local_font_warning: 'Warning: Uploading local font files may consume significant storage and cause performance issues.', reset_to_default: 'Reset to Default', apply: 'Apply', manage_presets: 'Manage Presets', save_as_preset: 'Save as Preset', delete_preset: 'Delete Preset', enter_preset_name: 'Enter preset name', preset_name: 'Preset Name', no_presets_to_delete: 'No presets to delete', my_presets: 'My Presets', built_in_group: 'Built-in', anniversaries: 'Anniversaries', accounting: 'Accounting', snippets: 'Snippets', add_anniversary: 'Add Anniversary', anniversary_name: 'Name', anniversary_date: 'Date', anniversary_type: 'Type', anniversary: 'Anniversary', target_day: 'Target Day', passed: 'passed', remaining: 'remaining', days_unit: 'days', add_transaction: 'Add Transaction', transaction_type: 'Type', income: 'Income', expense: 'Expense', amount: 'Amount', description: 'Description', total_income: 'Total Income', total_expense: 'Total Expense', balance: 'Balance', add_snippet_collection: 'New Collection', collection_name: 'Collection Name', add_snippet: 'Add Snippet', snippet_content: 'Snippet Content', no_items_yet: 'No items yet. Click the "+" icon in the top right to add one!', edit_anniversary: 'Edit Anniversary', edit_transaction: 'Edit Transaction', edit_snippet: 'Edit Snippet', pin: 'Pin', unpin: 'Unpin', change_background: 'Change Background', view_day: 'Day', view_month: 'Month', view_year: 'Year', confirm_selection: 'Confirm Selection', search_location: 'Search location...', word_count_unit: 'words', manage_snippets: 'Manage Snippets', delete_selected: 'Delete Selected' },
            'ko': { nav_diary: '일기', date: '날짜', notebooks: '일기장', my: '내 정보', diaries: '일기', days: '기록한 날', recent_diaries: '최근 일기', new: '새로 만들기', map: '지도', theme: '테마', language: '언어', dark_mode: '다크 모드', export_data: '데이터 내보내기', import_data: '데이터 가져오기', select_language: '언어 선택', cancel: '취소', reset: '초기화', upload: '업로드', global_theme: '전체 테마', bg_color: '배경색', bg_image: '배경 이미지', diary_theme: '일기 테마', primary_text_color: '기본 텍스트 색상', secondary_text_color: '보조 텍스트 색상', theme_settings: '테마 설정', delete: '삭제', no_diaries: '일기가 없습니다', add_comment: '댓글', year: '년', month: '월', edit: '수정', save: '저장', new_diary: '새 일기', edit_diary: '일기 수정', content: '내용', mood: '기분', weather: '날씨', location: '위치', images: '사진', notebook: '일기장', default_notebook: '기본 일기장', all_diaries: '전체', new_notebook: '새 일기장', notebook_name: '일기장 이름', confirm_delete: '정말 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.', delete_success: '삭제 성공', import_confirm: '가져오기를 하면 현재 모든 데이터가 덮어쓰여집니다. 계속하시겠습니까? 이 작업은 기념일, 가계부 등 모든 데이터도 삭제합니다.', import_success: '가져오기 성공!', export_success: '내보내기 성공!', no_recent_diaries: '최근 일기가 없습니다', accent_color_theme: '악센트 컬러 테마', accent_color: '악센트 컬러', edit_profile: '프로필 편집', profile_name: '이름', profile_id: 'ID', profile_bio: '소개', upload_avatar: '아바타 업로드', upload_background: '배경 업로드', write_something: '무엇인가 쓰기...', select_notebook: '일기장 선택', location_failed: '위치 정보를 가져올 수 없습니다. 일기에는 위치 데이터가 포함되지 않습니다. 기기의 위치 서비스 및 앱 권한을 확인하십시오.', edit_notebook_name: '일기장 이름 편집', change_notebook_cover: '표지 변경', enter_cover_url: '표지 이미지 URL 입력', upload_from_local: '로컬에서 업로드', default_notebook_no_delete: '기본 일기장은 삭제할 수 없습니다', my_favorites: '즐겨찾기', no_favorites: '즐겨찾기한 일기가 없습니다', set_custom_date: '게시 시간 설정', link_url: '링크 URL', enter_link_url: 'URL을 입력하세요', pin_diary: '일기 고정', unpin_diary: '고정 해제', pinned: '고정됨', show_lunar_calendar: '음력 표시', show_holidays: '공휴일 표시', no_holiday_today: '오늘은 특별한 휴일이 없습니다', add_audio: '오디오 추가', live_record: '실시간 녹음', upload_audio: '오디오 업로드', recording: '녹음 중...', stop_recording: '녹음 중지', record_failed: '녹음에 실패했습니다. 마이크 권한을 확인하십시오.', set_location: '위치 설정', auto_detect: '자동 감지', select_on_map: '지도에서 선택', manual_entry: '수동 입력', enter_location_name: '위치 이름 입력', font_settings: '글꼴 설정', builtin_fonts: '글꼴 선택', web_font_url: '웹 글꼴 URL', local_font_file: '로컬 글꼴 파일', local_font_warning: '경고: 로컬 글꼴 파일을 업로드하면 상당한 저장 공간을 차지하고 성능 문제가 발생할 수 있습니다.', reset_to_default: '기본값으로 재설정', apply: '적용', manage_presets: '프리셋 관리', save_as_preset: '프리셋으로 저장', delete_preset: '프리셋 삭제', enter_preset_name: '프리셋 이름 입력', preset_name: '프리셋 이름', no_presets_to_delete: '삭제할 프리셋이 없습니다', my_presets: '내 프리셋', built_in_group: '내장 글꼴', anniversaries: '기념일', accounting: '가계부', snippets: '스니펫', add_anniversary: '기념일 추가', anniversary_name: '이름', anniversary_date: '날짜', anniversary_type: '유형', anniversary: '기념일', target_day: '목표일', passed: '지남', remaining: '남음', days_unit: '일', add_transaction: '거래 추가', transaction_type: '유형', income: '수입', expense: '지출', amount: '금액', description: '설명', total_income: '총 수입', total_expense: '총 지출', balance: '잔액', add_snippet_collection: '새 컬렉션', collection_name: '컬렉션 이름', add_snippet: '스니펫 추가', snippet_content: '스니펫 내용', no_items_yet: '아직 항목이 없습니다. 오른쪽 상단의 "+" 아이콘을 클릭하여 추가하세요!', edit_anniversary: '기념일 편집', edit_transaction: '거래 편집', edit_snippet: '스니펫 편집', pin: '고정', unpin: '고정 해제', change_background: '배경 변경', view_day: '일', view_month: '월', view_year: '년', confirm_selection: '여기서 선택', search_location: '위치 검색...', word_count_unit: '자', manage_snippets: '스니펫 관리', delete_selected: '선택 삭제' }
        };

        // 中文注释：一个辅助函数，用来根据当前设置的语言获取对应的文本。
        const getLangText = (key) => translations[appData.settings.language]?.[key] || translations['zh-CN'][key] || key;

        // 中文注释：设置界面语言的函数。
        async function setLanguage(lang) {
            if (!lang || !translations[lang]) lang = 'zh-CN';
            appData.settings.language = lang;
            await dbActions.set('settings', 'language', lang);
            document.documentElement.lang = lang.split('-')[0];
            // 中文注释：遍历所有带 `data-lang-key` 标记的元素，把它们的文本替换成当前语言的文本。
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const translation = getLangText(el.dataset.langKey);
                if (el.placeholder) el.placeholder = translation;
                else if (el.title) el.title = translation;
                else el.textContent = translation;
            });
            renderWeekdays();
            renderFontSelection();
            renderCalendar();
            if (document.getElementById('accounting-page').classList.contains('active')) {
                renderAccountingPage();
            }
        }

        // =======================================================================
        // 4. DOM元素获取
        // 中文注释：这里是把页面上所有的重要元素都“抓”到代码里来，并给它们起个名字，方便后面操作它们。
        // =======================================================================
        const body = document.body, appContainer = document.querySelector('.app-container'), contentArea = document.querySelector('.content-area'), pages = document.querySelectorAll('.page'), navItems = document.querySelectorAll('.nav-item'), topBar = document.getElementById('top-bar'), topBarTitle = document.getElementById('top-bar-title'), topBarAvatar = document.getElementById('topBarAvatar'), diaryListEl = document.getElementById('diary-list'), sideMenu = document.getElementById('sideMenu'), overlay = document.getElementById('overlay'), profileNameEl = document.getElementById('profileName'), profileIdEl = document.getElementById('profileId'), profileBioEl = document.getElementById('profileBio'), profileAvatarEl = document.getElementById('profileAvatar'), profileBgEl = document.getElementById('profileBg'), diaryCountEl = document.getElementById('diaryCount'), notebookCountEl = document.getElementById('notebookCount'), daysCountEl = document.getElementById('daysCount'), 
        pinnedDiaryContainer = document.getElementById('pinned-diary-container'),
        recentDiariesContainer = document.getElementById('recent-diaries-container'),
        recentDiariesListEl = document.getElementById('recent-diaries-list'), currentMonthYearEl = document.getElementById('current-month-year'), 
        lunarCalendarToggle = document.getElementById('lunar-calendar-toggle'),
        holidayCalendarToggle = document.getElementById('holiday-calendar-toggle'),
        calendarDaysEl = document.getElementById('calendar-days'), weekdaysEl = document.getElementById('weekdays'), diariesForDateEl = document.getElementById('diaries-for-date'), 
        selectedDateInfoEl = document.getElementById('selected-date-info'),
        sideMenuAvatar = document.getElementById('sideMenuAvatar'), sideMenuName = document.getElementById('sideMenuName'), sideMenuBio = document.getElementById('sideMenuBio'), darkModeToggle = document.getElementById('darkModeToggle'), modalContainer = document.getElementById('modal-container'), searchIcon = document.getElementById('search-icon'), searchContainer = document.getElementById('search-container'), diarySearchInput = document.getElementById('diary-search-input'), quickDiaryEditor = document.getElementById('quick-diary-editor'), quickEditorAvatar = document.getElementById('quick-editor-avatar'), quickDiaryTextarea = document.getElementById('quick-diary-textarea'), 
        mediaViewer = document.getElementById('media-viewer'), mediaViewerImage = document.getElementById('media-viewer-image'), mediaViewerVideo = document.getElementById('media-viewer-video'), mediaViewerClose = document.getElementById('media-viewer-close'),
        notebookPopup = document.getElementById('notebook-popup'), notebookPopupList = document.getElementById('notebook-popup-list'),
        favoritesListContainer = document.getElementById('favorites-list-container'),
        mapSelectionBar = document.getElementById('map-selection-bar'),
        fontSelect = document.getElementById('font-select'),
        fontUrlInput = document.getElementById('font-url-input'),
        anniversaryListContainer = document.getElementById('anniversary-list-container'),
        accountingControls = document.querySelector('.accounting-controls'),
        accountingSummaryContainer = document.getElementById('accounting-summary-container'),
        transactionListContainer = document.getElementById('transaction-list-container'),
        snippetCollectionContainer = document.getElementById('snippet-collection-container');

        // =======================================================================
        // 5. 核心渲染和更新函数
        // 中文注释：这些函数负责把数据（比如日记、个人信息）显示到屏幕上，也就是“渲染”页面。
        // =======================================================================
        
        // 中文注释：一个总的刷新函数，当数据有变动时调用它，它会重新加载所有数据并刷新整个界面。
        async function refreshAllDataAndRender() {
            try {
                await loadDataFromDB();
                await applySettings();
                updateProfileUI();
                displayDiaries();
                renderNotebookPopup();
                await setLanguage(appData.settings.language);
                renderCalendar();
            } catch (error) {
                console.error("刷新数据失败:", error);
                alert("加载数据时发生错误，请尝试刷新页面。");
            }
        }

        // 中文注释：从数据库加载所有数据到内存中。
        async function loadDataFromDB() {
            const [profile, diaries, notebooks, darkMode, language, theme, font, showLunarCalendar, showHolidays, fontPresets, anniversaries, transactions, snippets, snippetCollections] = await Promise.all([
                dbActions.get('profile', 'userProfile'), 
                dbActions.getAll('diaries'), 
                dbActions.getAll('notebooks'),
                dbActions.get('settings', 'darkMode'),
                dbActions.get('settings', 'language'),
                dbActions.get('settings', 'theme'),
                dbActions.get('settings', 'font'),
                dbActions.get('settings', 'showLunarCalendar'),
                dbActions.get('settings', 'showHolidays'),
                dbActions.get('settings', 'fontPresets'),
                dbActions.getAll('anniversaries'),
                dbActions.getAll('transactions'),
                dbActions.getAll('snippets'),
                dbActions.getAll('snippetCollections')
            ]);
            
            appData = {
                profile: profile || {}, diaries: diaries || [], notebooks: notebooks || [],
                settings: {
                    darkMode: darkMode || false,
                    language: language || 'zh-CN',
                    theme: theme || {},
                    font: font || null,
                    showLunarCalendar: showLunarCalendar || false,
                    showHolidays: showHolidays || false,
                    fontPresets: fontPresets || []
                },
                anniversaries: anniversaries || [],
                transactions: transactions || [],
                snippets: snippets || [],
                snippetCollections: snippetCollections || []
            };
        }
        
        // 中文注释：应用用户的个性化设置，比如黑夜模式、主题颜色、字体等。
        async function applySettings() {
            const { theme, darkMode, font, showLunarCalendar, showHolidays } = appData.settings;
            
            body.classList.toggle('dark-mode', darkMode);
            darkModeToggle.checked = darkMode;
            
            document.documentElement.style.setProperty('--accent-color', theme?.accentColor || '#007aff');
            
            if (theme?.globalBgImage) {
                document.documentElement.style.setProperty('--theme-global-bg-image', `url(${theme.globalBgImage})`);
                body.classList.add('has-global-bg-image');
            } else {
                document.documentElement.style.removeProperty('--theme-global-bg-image');
                body.classList.remove('has-global-bg-image');
            }
            document.documentElement.style.setProperty('--theme-global-bg-color', theme?.globalBgColor || null);
            document.documentElement.style.setProperty('--theme-diary-primary-text-color', theme?.diaryPrimaryTextColor || null);
            document.documentElement.style.setProperty('--theme-diary-secondary-text-color', theme?.diarySecondaryTextColor || null);

            lunarCalendarToggle.checked = showLunarCalendar;
            holidayCalendarToggle.checked = showHolidays;
            await applyFont(font);
        }

        // 中文注释：更新所有显示个人信息的地方，比如头像、昵称。
        function updateProfileUI() {
            const { name, id, bio, avatar, background } = appData.profile;
            const avatarSrc = avatar || 'https://via.placeholder.com/100';
            const bgSrc = background || 'https://via.placeholder.com/800x400';
            [topBarAvatar, sideMenuAvatar, profileAvatarEl, quickEditorAvatar].forEach(el => el.src = avatarSrc);
            profileBgEl.src = bgSrc;
            profileNameEl.textContent = name;
            profileIdEl.textContent = id;
            profileBioEl.textContent = bio;
            sideMenuName.textContent = name;
            sideMenuBio.textContent = bio;
            diaryCountEl.textContent = appData.diaries.length;
            notebookCountEl.textContent = appData.notebooks.length;
            daysCountEl.textContent = new Set(appData.diaries.map(d => new Date(d.timestamp).toDateString())).size;
            renderMyPageContents();
        }

        // 中文注释：渲染“我的”页面里的具体内容，比如置顶日记和近期日记。
        function renderMyPageContents() {
            const pinnedDiary = appData.diaries.find(d => d.isPinned);
            pinnedDiaryContainer.innerHTML = '';
            if (pinnedDiary) {
                pinnedDiaryContainer.innerHTML = `<h3 style="margin-bottom: 10px;">${getLangText('pinned')}</h3>`;
                pinnedDiaryContainer.appendChild(createDiaryCard(pinnedDiary));
            }

            const sortedDiaries = appData.diaries
                .filter(d => !d.isPinned)
                .sort((a, b) => b.timestamp - a.timestamp)
                .slice(0, 5);
            recentDiariesListEl.innerHTML = '';
            if (sortedDiaries.length === 0 && !pinnedDiary) {
                recentDiariesContainer.style.display = 'none';
            } else {
                recentDiariesContainer.style.display = 'block';
                if (sortedDiaries.length === 0) {
                     recentDiariesListEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text);">${getLangText('no_recent_diaries')}</p>`;
                } else {
                    sortedDiaries.forEach(diary => recentDiariesListEl.appendChild(createDiaryCard(diary)));
                }
            }
        }
        
        // 中文注释：根据当前的筛选条件（比如选择了某个日记本或输入了搜索词）来显示日记列表。
        function displayDiaries(searchTerm = '') {
            if (diaryRenderer.observer) diaryRenderer.observer.disconnect();
            
            let diariesToFilter = (currentNotebookFilter === 'all') 
                ? appData.diaries 
                : appData.diaries.filter(d => d.notebookId === currentNotebookFilter);
            
            if (searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                diariesToFilter = diariesToFilter.filter(d => (d.content || '').toLowerCase().includes(lowerCaseSearchTerm));
            }

            const pinnedDiary = searchTerm ? null : diariesToFilter.find(d => d.isPinned);
            const otherDiaries = diariesToFilter
                .filter(d => !d.isPinned)
                .sort((a, b) => b.timestamp - a.timestamp);

            const diariesToRender = pinnedDiary ? [pinnedDiary, ...otherDiaries] : otherDiaries;
            
            diaryRenderer.diaries = diariesToRender;
            diaryRenderer.currentIndex = 0;
            diaryListEl.innerHTML = '';
            
            if (diariesToRender.length === 0) {
                diaryListEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_diaries')}</p>`;
                return;
            }
            
            renderNextDiaryBatch();
        }

        // 中文注释：这是一个性能优化功能，叫做“无限滚动”。它每次只加载少量日记，当你快要滑到底部时，再自动加载下一批。
        function renderNextDiaryBatch() {
            const batch = diaryRenderer.diaries.slice(diaryRenderer.currentIndex, diaryRenderer.currentIndex + diaryRenderer.batchSize);
            if (batch.length === 0) return;

            batch.forEach(diary => diaryListEl.appendChild(createDiaryCard(diary)));
            diaryRenderer.currentIndex += batch.length;

            if (diaryRenderer.currentIndex < diaryRenderer.diaries.length) {
                const lastCard = diaryListEl.lastElementChild;
                if (lastCard) {
                    diaryRenderer.observer = new IntersectionObserver((entries) => {
                        if (entries[0].isIntersecting) {
                            diaryRenderer.observer.disconnect();
                            renderNextDiaryBatch();
                        }
                    }, { root: contentArea, rootMargin: '200px' });
                    diaryRenderer.observer.observe(lastCard);
                }
            }
        }
        
        // 中文注释：渲染右上角的日记本选择弹窗。
        function renderNotebookPopup() {
            notebookPopupList.innerHTML = '';
            const allItem = createNotebookPopupItem({ id: 'all', name: getLangText('all_diaries'), cover: '' });
            notebookPopupList.appendChild(allItem);
            appData.notebooks.sort((a,b) => a.id === 1 ? -1 : b.id === 1 ? 1 : 0).forEach(nb => {
                const nbItem = createNotebookPopupItem(nb);
                notebookPopupList.appendChild(nbItem);
            });
        }

        // 中文注释：创建单个日记本弹窗里的项目。
        function createNotebookPopupItem(notebook) {
            const item = document.createElement('div');
            item.className = 'notebook-popup-item';
            item.dataset.action = 'filter-notebook';
            item.dataset.id = notebook.id;
            if (String(currentNotebookFilter) === String(notebook.id)) {
                item.classList.add('active');
            }
            const coverImg = notebook.cover ? `<img src="${notebook.cover}" class="notebook-popup-item-cover" alt="">` : '';
            item.innerHTML = `
                ${coverImg}
                <div class="notebook-popup-item-overlay"></div>
                <div class="notebook-popup-item-name">${notebook.name}</div>
            `;
            if (notebook.id !== 'all') {
                addLongPressListener(item, () => openNotebookMenu(notebook));
            }
            return item;
        }
        
        // 中文注释：渲染日历顶部的星期（日、一、二...）。
        function renderWeekdays() {
            const dayNames = { 'zh-CN': ['日', '一', '二', '三', '四', '五', '六'], 'zh-TW': ['日', '一', '二', '三', '四', '五', '六'], 'ja': ['日', '月', '火', '水', '木', '金', '土'], 'en': ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], 'ko': ['일', '월', '화', '수', '목', '금', '토'] };
            weekdaysEl.innerHTML = (dayNames[appData.settings.language] || dayNames['en']).map(d => `<div class="calendar-weekday">${d}</div>`).join('');
        }

        // 中文注释：渲染整个日历。
        function renderCalendar() {
            calendarDaysEl.innerHTML = '';
            selectedDateInfoEl.innerHTML = '';
            selectedDateInfoEl.style.display = 'none';
            diariesForDateEl.innerHTML = '';

            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            currentMonthYearEl.textContent = `${year} ${getLangText('year')} ${month + 1}${getLangText('month')}`;
            
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const diariesByDate = appData.diaries.reduce((acc, diary) => {
                const dateStr = new Date(diary.timestamp).toDateString();
                if (!acc[dateStr]) acc[dateStr] = [];
                acc[dateStr].push(diary);
                return acc;
            }, {});

            for (let i = 0; i < firstDayOfMonth; i++) {
                calendarDaysEl.insertAdjacentHTML('beforeend', '<div></div>');
            }

            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                
                const thisDate = new Date(year, month, i);
                let dayContent = `<span>${i}</span>`;

                if (typeof solarlunar !== 'undefined') {
                    const lunarData = solarlunar.solar2lunar(year, month + 1, i);
                    const holiday = lunarData.lunarFestival || lunarData.festival;

                    if (appData.settings.showHolidays && holiday) {
                        dayCell.classList.add('is-holiday');
                        dayCell.dataset.holiday = holiday;
                    }
                    
                    if (appData.settings.showLunarCalendar) {
                        dayContent += `<span class="lunar-date">${lunarData.IDayCn}</span>`;
                    }
                }

                dayCell.innerHTML = dayContent;
                dayCell.dataset.action = 'show-diaries-for-date';
                dayCell.dataset.date = thisDate.toDateString();
                
                if (thisDate.toDateString() === new Date().toDateString()) dayCell.classList.add('today');
                
                if (diariesByDate[thisDate.toDateString()]) {
                    dayCell.classList.add('has-diary');
                }
                calendarDaysEl.appendChild(dayCell);
            }
        }
        
        // 中文注释：初始化地图的函数。
        function initMap() {
            if (isMapInitialized) return; // 如果已经初始化过了，就直接返回，避免重复创建。
            try {
                // 中文注释：在id为'map'的元素上创建一个地图实例，并设置初始视图中心和缩放级别。
                map = L.map('map').setView([31.2304, 121.4737], 10); // 默认中心点在上海
                
                // 中文注释：给地图添加一个瓦片图层，这是地图的底图，我们用的是免费的OpenStreetMap。
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 中文注释：给地图添加一个地理编码（搜索）控件。
                L.Control.geocoder({
                    defaultMarkGeocode: false, // 搜索后不在地图上自动打点
                    placeholder: getLangText('search_location'), // 搜索框的提示文字
                }).on('markgeocode', function(e) { // 监听搜索到结果的事件
                    map.fitBounds(e.geocode.bbox); // 将地图视图缩放到包含搜索结果的范围
                }).addTo(map);

                renderMapMarkers(); // 在地图上渲染所有带位置的日记标记。
                isMapInitialized = true; // 标记地图已初始化。
            } catch(e) {
                console.error("地图初始化失败:", e);
                document.getElementById('map').innerHTML = "地图加载失败，请检查网络连接。";
            }
        }

        // 中文注释：在地图上渲染所有日记的位置标记。
        function renderMapMarkers() {
            if (!map) return;
            // 中文注释：先清除地图上所有已存在的标记。
            map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });
            // 中文注释：遍历所有日记，如果日记有位置信息，就在地图上创建一个标记。
            appData.diaries.forEach(diary => {
                if (diary.location && diary.location.lat && diary.location.lon) {
                    L.marker([diary.location.lat, diary.location.lon]).addTo(map)
                        .bindPopup(`<b>${new Date(diary.timestamp).toLocaleString()}</b><br>${(diary.content || '').substring(0, 30)}...`); // 点击标记时显示一个信息弹窗
                }
            });
        }

        // 中文注释：渲染收藏页面。
        function renderFavoritesPage() {
            const favoriteDiaries = appData.diaries
                .filter(d => d.isFavorite)
                .sort((a, b) => b.timestamp - a.timestamp);
            favoritesListContainer.innerHTML = '';
            if (favoriteDiaries.length === 0) {
                favoritesListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_favorites')}</p>`;
                return;
            }
            favoriteDiaries.forEach(diary => {
                favoritesListContainer.appendChild(createDiaryCard(diary));
            });
        }

        // =======================================================================
        // 6. 交互逻辑 (页面切换、弹窗等)
        // 中文注释：这部分代码处理用户的各种操作，比如点击按钮、切换页面等。
        // =======================================================================
        
        // 中文注释：切换显示不同页面的函数。
        function showPage(pageId, options = {}) {
            pages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
            
            navItems.forEach(item => item.classList.toggle('active', item.dataset.page === pageId));
            
            const pagesWithHeaders = ['favorites-page', 'font-settings-page', 'theme-settings-page', 'anniversary-page', 'accounting-page', 'snippets-page'];
            body.className = body.classList.contains('dark-mode') ? 'dark-mode' : '';
            if (appData.settings.theme.globalBgImage) body.classList.add('has-global-bg-image');
            if (pageId === 'my-page') body.classList.add('my-page-active');
            if (pagesWithHeaders.includes(pageId)) body.classList.add('page-with-header');
            
            document.getElementById('notebook-icon').style.display = 'none';
            searchIcon.style.display = 'none';
            
            switch(pageId) {
                case 'diary-page':
                    topBarTitle.textContent = 'プラタナス';
                    document.getElementById('notebook-icon').style.display = 'block';
                    searchIcon.style.display = 'block';
                    break;
                case 'calendar-page':
                    topBarTitle.textContent = getLangText('date');
                    break;
                case 'my-page':
                case 'favorites-page':
                case 'font-settings-page':
                case 'theme-settings-page':
                case 'anniversary-page':
                case 'accounting-page':
                case 'snippets-page':
                    topBarTitle.textContent = '';
                    break;
            }
            
            if (pageId !== 'diary-page' && searchContainer.classList.contains('active')) {
                searchContainer.classList.remove('active');
                diarySearchInput.value = '';
                displayDiaries();
            }

            // 中文注释：【修复问题2】切换到地图页面时的特殊处理。
            if (pageId === 'map-page') {
                initMap(); // 初始化地图
                // 中文注释：延迟一小段时间后，强制地图重新计算尺寸，这是解决地图显示不全的常见技巧。
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 10);

                isMapInSelectionMode = options.selectionMode || false;
                mapSelectionBar.style.display = 'none';
                if (isMapInSelectionMode) {
                    map.on('click', onMapClickForSelection); // 如果是选点模式，就监听地图点击事件
                } else {
                    map.off('click', onMapClickForSelection); // 否则就取消监听
                    if(tempMapMarker) map.removeLayer(tempMapMarker);
                    tempMapMarker = null;
                }
            } else if (isMapInitialized) {
                isMapInSelectionMode = false;
                map.off('click', onMapClickForSelection);
            }

            // 中文注释：根据切换到的页面，调用对应的渲染函数。
            if (pageId === 'my-page') renderMyPageContents();
            if (pageId === 'calendar-page') renderCalendar();
            if (pageId === 'favorites-page') renderFavoritesPage();
            if (pageId === 'font-settings-page') renderFontSelection();
            if (pageId === 'anniversary-page') renderAnniversaryPage();
            if (pageId === 'accounting-page') renderAccountingPage();
            if (pageId === 'snippets-page') renderSnippetsPage();
            
            toggleSideMenu(false);
            toggleNotebookPopup(false);
        }
        
        function toggleSideMenu(show) {
            sideMenu.classList.toggle('active', show);
            overlay.classList.toggle('active', show);
        }

        function toggleNotebookPopup(show) {
            notebookPopup.style.display = show ? 'block' : 'none';
        }
        
        // 中文注释：触发文件上传的函数。
        function triggerFileUpload(accept, isMultiple, maxFiles, callback) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = accept;
            input.multiple = isMultiple;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (!files.length) return;
                if (isMultiple && (files.length > maxFiles)) return alert(`最多选择 ${maxFiles} 个文件`);
                
                files.forEach(file => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        let type = 'file';
                        if (file.type.startsWith('image')) type = 'image';
                        else if (file.type.startsWith('video')) type = 'video';
                        else if (file.type.startsWith('audio')) type = 'audio';
                        else if (['.ttf', '.otf', '.woff', '.woff2'].some(ext => file.name.endsWith(ext))) type = 'font';
                        callback({ type: type, src: ev.target.result, name: file.name });
                    };
                    reader.readAsDataURL(file);
                });
            };
            input.click();
        }

        /*
         * 中文注释：【修复#1】卡顿和滑动问题
         * 这是一个给元素添加长按事件监听的函数。
         * 修复方案：在手指移动（滚动）时，清除长按计时器，这样就不会错误地触发长按事件，保证了页面的正常滚动。
         */
        function addLongPressListener(element, callback) {
            let timer;
            const start = (e) => { 
                timer = setTimeout(() => { 
                    if (navigator.vibrate) navigator.vibrate(50); 
                    callback(); 
                }, 800); 
            };
            const end = () => clearTimeout(timer);
            const move = () => clearTimeout(timer); // 如果手指移动（滚动），就取消长按计时
            
            element.addEventListener('touchstart', start);
            element.addEventListener('touchend', end);
            element.addEventListener('touchmove', move);
            element.addEventListener('contextmenu', (e) => { e.preventDefault(); callback(); });
        }
        
        // 中文注释：将简单的标记语言（如**加粗**）转换成HTML。
        function formatRichText(text) {
            if (!text) return '';
            return text.replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/\*\*(.*?)\*\*/g, '<b>\\$1</b>')
                .replace(/\*(.*?)\*/g, '<i>\\$1</i>')
                .replace(/__(.*?)__/g, '<u>\\$1</u>')
                .replace(/~~(.*?)~~/g, '<del>\\$1</del>')
                .replace(/$$(.*?)$$$(.*?)$/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                .replace(/\n/g, '<br>');
        }

        // 中文注释：根据一个日记的数据，创建对应的HTML卡片元素。
        function createDiaryCard(diary) {
            const card = document.createElement('div');
            card.className = 'diary-card';
            card.dataset.diaryId = diary.id;
            const date = new Date(diary.timestamp);
            const weekdays = { 'zh-CN': ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'], 'zh-TW': ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'], 'ja': ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'], 'en': ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'], 'ko': ['일요일', '월요일', '화요일', '수요일', '목요일', '금요일', '토요일'] };
            const dayString = (weekdays[appData.settings.language] || weekdays['en'])[date.getDay()];
            
            const mediaHTML = (diary.media || []).map((item, index) => {
                const commonAttrs = `class="media-item" data-action="view-media" data-index="${index}"`;
                if (item.type === 'image') return `<div ${commonAttrs}><img src="${item.src}" alt="diary media" loading="lazy"></div>`;
                if (item.type === 'video') return `<div ${commonAttrs}><video src="${item.src}#t=0.1" preload="metadata"></video><i class="fas fa-play video-play-icon"></i></div>`;
                if (item.type === 'audio') return `<div class="media-item audio-player"><i class="fas fa-music"></i><audio src="${item.src}" controls></audio></div>`;
                return '';
            }).join('');
            
            const pinnedIconHTML = diary.isPinned ? `<i class="fas fa-thumbtack pinned-icon" title="${getLangText('pinned')}"></i>` : '';
            const locationText = diary.location ? `<i class="fas fa-map-marker-alt"></i> ${diary.location.name || '未知地点'}` : '';
            const wordCount = (diary.content || '').replace(/\s/g, '').length;

            card.innerHTML = `
                ${pinnedIconHTML}
                <div class="diary-card-header">
                    <div class="diary-author">
                        <img src="${appData.profile.avatar || 'https://via.placeholder.com/100'}" alt="avatar" class="diary-author-avatar">
                        <div class="diary-author-info">
                            <div class="name">${appData.profile.name || ''}</div>
                            <div class="id">@${appData.profile.id || ''}</div>
                        </div>
                    </div>
                    <div class="diary-meta">
                        <div class="diary-timestamp">
                            <div>${date.getMonth() + 1}月${date.getDate()}日・${dayString}</div>
                            <div>${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}</div>
                        </div>
                        <div class="mood-weather">${diary.mood || ''} ${diary.weather || ''}</div>
                    </div>
                </div>
                <div class="diary-card-body">
                    <div class="diary-card-content">${formatRichText(diary.content)}</div>
                    ${mediaHTML ? `<div class="diary-media">${mediaHTML}</div>` : ''}
                </div>
                <div class="diary-card-footer">
                    <div class="diary-footer-left">
                        <span>${locationText}</span>
                        <span class="diary-word-count">${wordCount} ${getLangText('word_count_unit')}</span>
                    </div>
                    <div class="diary-footer-right">
                        <i class="fas fa-comment-dots comment-toggle-btn" data-action="toggle-comment-display" title="${getLangText('add_comment')}"></i>
                        <i class="${diary.isFavorite ? 'fas' : 'far'} fa-star favorite-btn ${diary.isFavorite ? 'favorited' : ''}" data-action="toggle-favorite" title="${getLangText('my_favorites')}"></i>
                    </div>
                </div>
                <div class="comment-section">
                    ${renderCommentsHTML(diary.id, diary.comments || [])}
                </div>
            `;
            addLongPressListener(card, () => openDiaryMenu(diary));
            return card;
        }

        // 中文注释：渲染评论区。
        function renderCommentsHTML(diaryId, comments) {
            let html = `<div class="comment-input-area"><input type="text" placeholder="${getLangText('add_comment')}..."><button class="send-comment-btn" data-action="send-comment"><i class="fas fa-paper-plane"></i></button></div>`;
            const commentsToShow = comments.slice(-3);
            if (comments.length > 3) {
                html += `<a class="view-more-comments" data-action="view-all-comments">查看全部 ${comments.length} 条评论</a>`;
            }
            commentsToShow.reverse().forEach(c => { // 让最新的评论在最上面
                html += `<div class="comment"><img src="${appData.profile.avatar || 'https://via.placeholder.com/100'}" class="comment-avatar"><div class="comment-body"><div class="comment-header"><span class="id">@${c.authorId}</span> · <span>${new Date(c.timestamp).toLocaleString()}</span></div><div class="comment-content">${formatRichText(c.content)}</div></div></div>`;
            });
            return html;
        }
        
        // 中文注释：这是整个应用的总事件监听器，负责处理页面上几乎所有的点击事件。
        document.body.addEventListener('click', async (e) => {
            const target = e.target;
            const actionTarget = target.closest('[data-action]');
            const formatTarget = target.closest('[data-format]');

            if (formatTarget) { applyFormatToTextarea(formatTarget.dataset.format); return; }

            if (actionTarget) {
                const action = actionTarget.dataset.action;
                const id = actionTarget.dataset.id;
                const key = actionTarget.dataset.key;
                const page = actionTarget.dataset.page;

                // 中文注释：使用一个switch语句来判断用户点击的是哪个带有`data-action`的按钮，并执行相应的操作。
                switch (action) {
                    case 'show-page': showPage(page); break;
                    case 'back-to-my-page': showPage('my-page'); break;
                    case 'add-media': triggerFileUpload('image/*,video/*', true, 9, (mediaItem) => { quickDiaryData.media.push(mediaItem); alert('文件已添加'); }); break;
                    case 'add-audio': openAudioMenu(); break;
                    case 'set-custom-date': openCustomDateModal(); break;
                    case 'set-location': openLocationMenu(); break;
                    case 'auto-detect-location':
                        closeModal();
                        quickDiaryData.location = { type: 'auto' };
                        alert('已设为自动获取位置');
                        break;
                    case 'select-location-on-map':
                        closeModal();
                        showPage('map-page', { selectionMode: true });
                        break;
                    // 中文注释：【修复问题3】修复手动输入地点功能。
                    case 'manual-location-entry':
                        closeModal();
                        showPromptModal(getLangText('manual_entry'), getLangText('enter_location_name'), (name) => {
                            if (name) {
                                quickDiaryData.location = { type: 'manual', name: name };
                                alert(`地点已设为: ${name}`);
                            }
                        });
                        break;
                    case 'confirm-map-selection':
                        if (tempMapMarker) {
                            const latlng = tempMapMarker.getLatLng();
                            quickDiaryData.location = { type: 'map', lat: latlng.lat, lon: latlng.lng, name: `地图选点(${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)})` };
                            alert('地图选点成功！');
                            showPage('diary-page');
                        }
                        break;
                    case 'view-media': {
                        const diaryId = Number(target.closest('.diary-card').dataset.diaryId);
                        const mediaIndex = Number(target.closest('.media-item').dataset.index);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary && diary.media && diary.media[mediaIndex]) {
                            const mediaItem = diary.media[mediaIndex];
                            if (mediaItem.type === 'image') {
                                mediaViewerImage.src = mediaItem.src;
                                mediaViewerImage.style.display = 'block';
                                mediaViewerVideo.style.display = 'none';
                                mediaViewer.style.display = 'flex';
                            } else if (mediaItem.type === 'video') {
                                mediaViewerVideo.src = mediaItem.src;
                                mediaViewerVideo.style.display = 'block';
                                mediaViewerImage.style.display = 'none';
                                mediaViewer.style.display = 'flex';
                                mediaViewerVideo.play();
                            }
                        }
                        break;
                    }
                    case 'toggle-favorite': {
                        const diaryId = Number(actionTarget.closest('.diary-card').dataset.diaryId);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary) {
                            diary.isFavorite = !diary.isFavorite;
                            await dbActions.put('diaries', diary);
                            actionTarget.classList.toggle('fas', diary.isFavorite);
                            actionTarget.classList.toggle('far', !diary.isFavorite);
                            actionTarget.classList.toggle('favorited', diary.isFavorite);
                        }
                        break;
                    }
                    case 'toggle-pin': {
                        closeModal();
                        const diaryId = Number(id);
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (!diary) return;
                        const isCurrentlyPinned = diary.isPinned;
                        appData.diaries.forEach(d => d.isPinned = false);
                        if (!isCurrentlyPinned) {
                            diary.isPinned = true;
                        }
                        for (const d of appData.diaries) {
                            await dbActions.put('diaries', d);
                        }
                        await refreshAllDataAndRender();
                        break;
                    }
                    case 'apply-font': {
                        const selectedValue = fontSelect.value;
                        if (!selectedValue) {
                            alert("请先选择一个字体！");
                            return;
                        }
                        const selectedOption = fontSelect.options[fontSelect.selectedIndex];
                        const fontType = selectedOption.dataset.fontType;
                        
                        let fontSetting = null;
                        if (fontType === 'builtin') {
                            fontSetting = { type: 'google', name: selectedValue };
                        } else if (fontType === 'preset') {
                            fontSetting = appData.settings.fontPresets.find(p => p.name === selectedValue);
                        }
                        
                        if (fontSetting) {
                            await dbActions.set('settings', 'font', fontSetting);
                            appData.settings.font = fontSetting;
                            await applyFont(fontSetting);
                            alert('字体应用成功！');
                        }
                        break;
                    }
                    case 'manage-font-preset': openFontPresetMenu(); break;
                    case 'upload-local-font': {
                        triggerFileUpload('.ttf,.otf,.woff,.woff2', false, 1, async (file) => {
                            tempFont = { type: 'local', name: file.name, data: file.src };
                            alert(`本地字体 "${file.name}" 已准备好，您可以点击“管理预设”将其保存。`);
                        });
                        break;
                    }
                    case 'reset-font': {
                        await dbActions.delete('settings', 'font');
                        appData.settings.font = null;
                        await applyFont(null);
                        renderFontSelection();
                        break;
                    }
                    case 'send-comment': {
                        const card = actionTarget.closest('.diary-card');
                        const input = card.querySelector('.comment-input-area input');
                        const diaryId = Number(card.dataset.diaryId);
                        if (!input.value.trim() || !diaryId) return;
                        const diary = appData.diaries.find(d => d.id === diaryId);
                        if (diary) {
                            if (!diary.comments) diary.comments = [];
                            diary.comments.push({ id: Date.now(), authorId: appData.profile.id, content: input.value.trim(), timestamp: Date.now() });
                            await dbActions.put('diaries', diary);
                            card.querySelector('.comment-section').innerHTML = renderCommentsHTML(diaryId, diary.comments);
                            input.value = '';
                        }
                        break;
                    }
                    case 'toggle-comment-display': {
                        const card = actionTarget.closest('.diary-card');
                        const commentSection = card.querySelector('.comment-section');
                        commentSection.classList.toggle('active');
                        actionTarget.classList.toggle('active');
                        break;
                    }
                    case 'filter-notebook': {
                        const notebookId = actionTarget.dataset.id === 'all' ? 'all' : Number(actionTarget.dataset.id);
                        currentNotebookFilter = notebookId;
                        displayDiaries();
                        contentArea.scrollTop = 0;
                        renderNotebookPopup();
                        setTimeout(() => toggleNotebookPopup(false), 100);
                        break;
                    }
                    case 'quick-select-notebook': openQuickSelectNotebookModal(); break;
                    case 'add-notebook': openNotebookModal(); break;
                    case 'edit-profile': openProfileEditModal(); break;
                    case 'open-language-modal': openLanguageModal(); break;
                    case 'export-data': exportData(); break;
                    case 'import-data': importData(); break;
                    case 'show-diaries-for-date': {
                        const date = actionTarget.dataset.date;
                        const holiday = actionTarget.dataset.holiday;
                        
                        document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
                        actionTarget.classList.add('selected');

                        selectedDateInfoEl.innerHTML = '';
                        if (holiday) {
                            selectedDateInfoEl.textContent = holiday;
                            selectedDateInfoEl.style.display = 'block';
                        } else {
                            selectedDateInfoEl.style.display = 'none';
                        }

                        const diaries = appData.diaries.filter(d => new Date(d.timestamp).toDateString() === date);
                        diariesForDateEl.innerHTML = '';
                        if (diaries.length > 0) {
                            diaries.sort((a,b) => b.timestamp - a.timestamp).forEach(d => diariesForDateEl.appendChild(createDiaryCard(d)));
                        } else {
                            diariesForDateEl.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 20px;">${getLangText('no_diaries')}</p>`;
                        }
                        break;
                    }
                    case 'add-mood': {
                        showPromptModal(getLangText('mood'), '请输入心情 (例如: 开心)', (mood) => {
                            if (mood) quickDiaryData.mood = mood;
                        });
                        break;
                    }
                    case 'add-weather': {
                        showPromptModal(getLangText('weather'), '请输入天气 (例如: 晴)', (weather) => {
                            if (weather) quickDiaryData.weather = weather;
                        });
                        break;
                    }
                    case 'reset-theme': {
                        delete appData.settings.theme[key];
                        await dbActions.set('settings', 'theme', appData.settings.theme);
                        applySettings();
                        break;
                    }
                    case 'upload-theme-image': {
                        triggerFileUpload('image/*', false, 1, async (file) => {
                            appData.settings.theme[key] = file.src;
                            await dbActions.set('settings', 'theme', appData.settings.theme);
                            applySettings();
                        });
                        break;
                    }
                    case 'edit-diary': {
                        closeModal();
                        const diary = appData.diaries.find(d => d.id == id);
                        if (diary) openDiaryEditModal(diary);
                        break;
                    }
                    case 'delete-diary': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('diaries', Number(id));
                            await refreshAllDataAndRender();
                        });
                        break;
                    }
                    case 'add-anniversary': openAddAnniversaryModal(); break;
                    case 'edit-anniversary': closeModal(); openAddAnniversaryModal(appData.anniversaries.find(item => item.id === Number(id))); break;
                    case 'delete-anniversary': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('anniversaries', Number(id));
                            await refreshAllDataAndRender();
                            renderAnniversaryPage();
                        });
                        break;
                    }
                    case 'toggle-pin-anniversary': await togglePinItem('anniversaries', Number(id), renderAnniversaryPage); break;
                    case 'change-anniversary-bg': await changeItemBackground('anniversaries', Number(id), renderAnniversaryPage); break;
                    case 'add-transaction': openAddTransactionModal(); break;
                    case 'edit-transaction': closeModal(); openAddTransactionModal(appData.transactions.find(item => item.id === Number(id))); break;
                    case 'delete-transaction': {
                         closeModal();
                         showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('transactions', Number(id));
                            await refreshAllDataAndRender();
                            renderAccountingPage();
                        });
                        break;
                    }
                    case 'add-snippet-collection': openAddSnippetCollectionModal(); break;
                    case 'toggle-snippet-collection': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        if (!collectionEl.classList.contains('manage-mode')) {
                            collectionEl.classList.toggle('expanded');
                        }
                        break;
                    }
                    case 'cancel-add-snippet': actionTarget.closest('.add-snippet-form').parentElement.innerHTML = `<button class="button button-primary" onclick="this.parentElement.innerHTML = document.getElementById('add-snippet-form-template').innerHTML.replace('__COLLECTION_ID__', ${actionTarget.closest('.snippet-collection').dataset.collectionId})" style="width: 100%; margin: 0;">${getLangText('add_snippet')}</button>`; break;
                    case 'save-snippet': {
                        const form = actionTarget.closest('.add-snippet-form');
                        const textarea = form.querySelector('textarea');
                        const content = textarea.value.trim();
                        const collectionId = Number(form.dataset.collectionId);
                        if (content) {
                            await dbActions.add('snippets', { collectionId, content, timestamp: Date.now() });
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                            const collectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${collectionId}"]`);
                            if (collectionEl) collectionEl.classList.add('expanded');
                        }
                        break;
                    }
                    case 'edit-snippet': closeModal(); openEditSnippetModal(appData.snippets.find(item => item.id === Number(id))); break;
                    case 'delete-snippet': {
                        closeModal();
                        showConfirmModal('确认删除', getLangText('confirm_delete'), async () => {
                            await dbActions.delete('snippets', Number(id));
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                        });
                        break;
                    }
                    case 'toggle-pin-snippet-collection': await togglePinItem('snippetCollections', Number(id), renderSnippetsPage); break;
                    case 'change-snippet-collection-bg': await changeItemBackground('snippetCollections', Number(id), renderSnippetsPage); break;
                    case 'manage-snippets': {
                        closeModal();
                        const collectionEl = document.querySelector(`.snippet-collection[data-collection-id="${id}"]`);
                        if (collectionEl) collectionEl.classList.add('manage-mode');
                        break;
                    }
                    // 中文注释：【修复问题1】新增删除言语集（你说的“言语条”）的功能。
                    case 'delete-snippet-collection': {
                        closeModal();
                        const collectionId = Number(id);
                        // 弹出确认删除的对话框
                        showConfirmModal('确认删除言语集', `确定要删除这个言语集以及它下面的所有言语吗？${getLangText('confirm_delete')}`, async () => {
                            // 1. 从数据库删除这个言语集本身
                            await dbActions.delete('snippetCollections', collectionId);
                            
                            // 2. 找到这个言语集下面的所有言语
                            const snippetsToDelete = appData.snippets.filter(s => s.collectionId === collectionId);
                            
                            // 3. 遍历并删除这些言语
                            for (const snippet of snippetsToDelete) {
                                await dbActions.delete('snippets', snippet.id);
                            }
                            
                            // 4. 重新加载数据并刷新页面
                            await refreshAllDataAndRender();
                            renderSnippetsPage(); // 重新渲染言语集页面
                        });
                        break;
                    }
                    case 'cancel-snippet-manage': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        if (collectionEl) collectionEl.classList.remove('manage-mode');
                        break;
                    }
                    case 'delete-selected-snippets': {
                        const collectionEl = actionTarget.closest('.snippet-collection');
                        const collectionId = Number(collectionEl.dataset.collectionId);
                        const checkedBoxes = collectionEl.querySelectorAll('.snippet-delete-checkbox:checked');
                        if (checkedBoxes.length === 0) {
                            alert('请先选择要删除的言语条');
                            return;
                        }
                        showConfirmModal('确认删除', `确定要删除这 ${checkedBoxes.length} 条言语吗？`, async () => {
                            const idsToDelete = Array.from(checkedBoxes).map(box => Number(box.dataset.snippetId));
                            for (const snippetId of idsToDelete) {
                                await dbActions.delete('snippets', snippetId);
                            }
                            await refreshAllDataAndRender();
                            renderSnippetsPage();
                            // 保持展开状态
                            setTimeout(() => {
                                const refreshedCollectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${collectionId}"]`);
                                if (refreshedCollectionEl) refreshedCollectionEl.classList.add('expanded');
                            }, 100);
                        });
                        break;
                    }
                }
                return;
            }

            if (target.closest('.nav-item')) { showPage(target.closest('.nav-item').dataset.page); }
            else if (target.closest('#topBarAvatar')) { toggleSideMenu(true); }
            else if (target.closest('#overlay')) { toggleSideMenu(false); }
            else if (target.closest('#notebook-icon')) { toggleNotebookPopup(notebookPopup.style.display !== 'block'); }
            else if (target.closest('#map-back-btn')) { showPage('diary-page'); }
            else if (target.closest('#prev-month')) { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }
            else if (target.closest('#next-month')) { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }
            else if (target.closest('#search-icon')) { searchContainer.classList.toggle('active'); if (searchContainer.classList.contains('active')) diarySearchInput.focus(); }
            else if (target.closest('.editor-collapsed-view')) { quickDiaryEditor.classList.add('expanded'); quickDiaryTextarea.focus(); }
            else if (target.id === 'media-viewer' || target.id === 'media-viewer-close') {
                mediaViewer.style.display = 'none';
                mediaViewerImage.src = '';
                mediaViewerVideo.src = '';
                mediaViewerVideo.pause();
            }
            else {
                if (!target.closest('#notebook-popup') && !target.closest('#notebook-icon')) {
                    toggleNotebookPopup(false);
                }
            }
        });
        
        darkModeToggle.addEventListener('change', async () => {
            appData.settings.darkMode = darkModeToggle.checked;
            await dbActions.set('settings', 'darkMode', darkModeToggle.checked);
            await refreshAllDataAndRender();
        });

        lunarCalendarToggle.addEventListener('change', async () => {
            appData.settings.showLunarCalendar = lunarCalendarToggle.checked;
            await dbActions.set('settings', 'showLunarCalendar', lunarCalendarToggle.checked);
            renderCalendar();
        });

        holidayCalendarToggle.addEventListener('change', async () => {
            appData.settings.showHolidays = holidayCalendarToggle.checked;
            await dbActions.set('settings', 'showHolidays', holidayCalendarToggle.checked);
            renderCalendar();
        });
        
        // 中文注释：一个“防抖”函数，用于性能优化。比如在搜索框输入时，不会每输入一个字就搜索一次，而是等你停顿一小会再搜索。
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        diarySearchInput.addEventListener('input', debounce((e) => {
            displayDiaries(e.target.value.trim());
        }, 300));

        document.getElementById('theme-settings-page').addEventListener('input', async (e) => {
            if (e.target.type !== 'color') return;
            const key = e.target.id.replace('theme-', '').replace(/-(\w)/g, (_, p1) => p1.toUpperCase());
            appData.settings.theme[key] = e.target.value;
            await dbActions.set('settings', 'theme', appData.settings.theme);
            applySettings();
        });

        // =======================================================================
        // 8. 功能函数 (弹窗、数据处理等)
        // 中文注释：这里是一些通用的功能函数，比如显示各种弹窗、处理数据等。
        // =======================================================================

        // 中文注释：显示一个通用的模态框（弹窗）。
        function showModal(title, bodyHtml, footerHtml, onSave) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">${title}</div>
                    <div class="modal-body">${bodyHtml}</div>
                    <div class="modal-footer">${footerHtml}</div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);
            
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            const cancelButton = modal.querySelector('#modal-cancel');
            if (cancelButton) cancelButton.onclick = closeModal;
            
            const saveButton = modal.querySelector('#modal-save');
            if (saveButton && onSave) saveButton.onclick = onSave;
        }

        // 中文注释：显示一个确认对话框（比如“确认删除吗？”）。
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-modal-content">
                    <div class="custom-modal-title">${title}</div>
                    <div class="custom-modal-message">${message}</div>
                    <div class="custom-modal-footer">
                        <button id="confirm-cancel">${getLangText('cancel')}</button>
                        <button id="confirm-ok" class="confirm-ok">OK</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);

            modal.querySelector('#confirm-cancel').onclick = closeModal;
            modal.querySelector('#confirm-ok').onclick = () => {
                onConfirm();
                closeModal();
            };
        }

        // 中文注释：显示一个带输入框的对话框。
        function showPromptModal(title, message, onConfirm, placeholder = '', inputType = 'text', defaultValue = '') {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content custom-modal-content">
                    <div class="custom-modal-title">${title}</div>
                    <div class="custom-modal-message">${message}</div>
                    <input type="${inputType}" class="custom-modal-input" placeholder="${placeholder}" value="${defaultValue}">
                    <div class="custom-modal-footer">
                        <button id="confirm-cancel">${getLangText('cancel')}</button>
                        <button id="confirm-ok" class="confirm-ok">OK</button>
                    </div>
                </div>
            `;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);

            const input = modal.querySelector('.custom-modal-input');
            input.focus();
            modal.querySelector('#confirm-cancel').onclick = closeModal;
            modal.querySelector('#confirm-ok').onclick = () => {
                onConfirm(input.value);
                closeModal();
            };
        }

        // 中文注释：显示一个操作菜单弹窗（比如长按后出现的“编辑/删除”菜单）。
        function showActionMenuModal(title, actions) {
            const actionItems = actions.map(action => 
                `<div class="menu-item" data-action="${action.action}" data-id="${action.id || ''}" data-value="${action.value || ''}">${action.text}</div>`
            ).join('');
            const bodyHtml = `<div class="menu-section">${actionItems}</div>`;
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `<div class="modal-content action-menu-modal"><div class="modal-header">${title}</div><div class="modal-body">${bodyHtml}</div></div>`;
            modalContainer.innerHTML = '';
            modalContainer.appendChild(modal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
        }

        function closeModal() {
            modalContainer.innerHTML = '';
        }

        // 中文注释：发送快速日记的函数。
        async function sendQuickDiary() {
            const sendButton = document.querySelector('.send-btn');
            if (sendButton.disabled) return;
            const content = quickDiaryTextarea.value;
            if (!content.trim() && quickDiaryData.media.length === 0) {
                alert('日记内容或媒体文件不能为空');
                return;
            }

            sendButton.disabled = true;
            sendButton.textContent = '发送中...';

            let locationData = null;
            if (quickDiaryData.location) {
                if (quickDiaryData.location.type === 'auto') {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 10000, enableHighAccuracy: false });
                        });
                        locationData = { 
                            type: 'auto',
                            lat: position.coords.latitude, 
                            lon: position.coords.longitude, 
                            name: '自动定位'
                        };
                    } catch (err) {
                        console.warn("自动获取地理位置失败:", err.message);
                        alert(getLangText('location_failed'));
                    }
                } else {
                    locationData = quickDiaryData.location;
                }
            }

            const diary = {
                id: Date.now(),
                timestamp: quickDiaryData.customTimestamp || Date.now(),
                content: content,
                mood: quickDiaryData.mood,
                weather: quickDiaryData.weather,
                notebookId: quickDiaryData.notebookId,
                media: quickDiaryData.media,
                location: locationData,
                comments: [],
                isFavorite: false,
                isPinned: false
            };

            await dbActions.put('diaries', diary);
            
            await refreshAllDataAndRender();
            
            quickDiaryTextarea.value = '';
            quickDiaryData = { media: [], mood: '', weather: '', location: null, notebookId: 1, customTimestamp: null };
            quickDiaryEditor.classList.remove('expanded');
            contentArea.scrollTop = 0;

            sendButton.disabled = false;
            sendButton.textContent = '发送';
        }
        
        function openDiaryMenu(diary) {
            const pinActionText = diary.isPinned ? getLangText('unpin_diary') : getLangText('pin_diary');
            showActionMenuModal('操作', [
                { text: pinActionText, action: 'toggle-pin', id: diary.id },
                { text: getLangText('edit'), action: 'edit-diary', id: diary.id },
                { text: getLangText('delete'), action: 'delete-diary', id: diary.id }
            ]);
        }

        function openDiaryEditModal(diaryToEdit) {
            const notebookOptions = appData.notebooks.map(nb => 
                `<option value="${nb.id}" ${nb.id === diaryToEdit.notebookId ? 'selected' : ''}>${nb.name}</option>`
            ).join('');

            const bodyHtml = `
                <p>${getLangText('content')}:</p>
                <textarea id="diary-content-input">${diaryToEdit.content}</textarea>
                <p>${getLangText('mood')}: <input type="text" id="diary-mood-input" value="${diaryToEdit.mood || ''}"></p>
                <p>${getLangText('weather')}: <input type="text" id="diary-weather-input" value="${diaryToEdit.weather || ''}"></p>
                <p>${getLangText('notebook')}: <select id="diary-notebook-select">${notebookOptions}</select></p>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const updatedDiary = {
                    ...diaryToEdit,
                    content: document.getElementById('diary-content-input').value,
                    mood: document.getElementById('diary-mood-input').value,
                    weather: document.getElementById('diary-weather-input').value,
                    notebookId: Number(document.getElementById('diary-notebook-select').value),
                };
                await dbActions.put('diaries', updatedDiary);
                closeModal();
                await refreshAllDataAndRender();
            };

            showModal(getLangText('edit_diary'), bodyHtml, footerHtml, saveHandler);
        }
        
        function openQuickSelectNotebookModal() {
            const sortedNotebooks = [...appData.notebooks].sort((a, b) => a.id === 1 ? -1 : b.id === 1 ? 1 : 0);
            const notebookItems = sortedNotebooks.map(nb =>
                `<div class="menu-item" data-action="set-quick-notebook" data-id="${nb.id}" data-name="${nb.name}" style="border-bottom: 1px solid var(--border-color); ${nb.id === quickDiaryData.notebookId ? 'background-color: var(--accent-color); color: white;' : ''}">
                    <i class="fas fa-book" style="${nb.id === quickDiaryData.notebookId ? 'color: white;' : ''}"></i> ${nb.name}
                 </div>`
            ).join('');
            const bodyHtml = `<div class="menu-section" style="margin: -20px; border-radius: 0;">${notebookItems}</div>`;
            showModal(getLangText('select_notebook'), bodyHtml, `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button>`);
            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const notebookItem = e.target.closest('.menu-item[data-action="set-quick-notebook"]');
                if (notebookItem) {
                    quickDiaryData.notebookId = Number(notebookItem.dataset.id);
                    alert(`已选择: ${notebookItem.dataset.name}`);
                    closeModal();
                }
            });
        }

        function openAudioMenu() {
            showActionMenuModal(getLangText('add_audio'), [
                { text: getLangText('live_record'), action: 'record-audio' },
                { text: getLangText('upload_audio'), action: 'upload-audio-file' }
            ]);
            modalContainer.querySelector('.modal-content').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                closeModal();
                if (item.dataset.action === 'record-audio') {
                    startRecording();
                } else if (item.dataset.action === 'upload-audio-file') {
                    triggerFileUpload('audio/*', false, 1, (file) => {
                        quickDiaryData.media.push(file);
                        alert('音频已添加');
                    });
                }
            });
        }

        async function startRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                return;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        quickDiaryData.media.push({ type: 'audio', src: e.target.result });
                        alert('录音已添加');
                    };
                    reader.readAsDataURL(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                    closeModal();
                };
                mediaRecorder.start();
                showModal(getLangText('recording'), 
                    '<i class="fas fa-microphone-alt fa-beat" style="font-size: 40px; color: var(--danger-color);"></i>', 
                    `<button class="button button-danger" id="stop-recording-btn">${getLangText('stop_recording')}</button>`
                );
                document.getElementById('stop-recording-btn').onclick = () => mediaRecorder.stop();

            } catch (err) {
                console.error("录音错误:", err);
                alert(getLangText('record_failed'));
            }
        }

        // 中文注释：【修复问题3】打开设置地点的菜单。
        function openLocationMenu() {
            showActionMenuModal(getLangText('set_location'), [
                { text: getLangText('auto_detect'), action: 'auto-detect-location' },
                { text: getLangText('select_on_map'), action: 'select-location-on-map' },
                { text: getLangText('manual_entry'), action: 'manual-location-entry' } // 这里的action名称已修正
            ]);
        }

        // 中文注释：在地图上点击以选择地点的处理函数。
        function onMapClickForSelection(e) {
            if (tempMapMarker) map.removeLayer(tempMapMarker);
            tempMapMarker = L.marker(e.latlng).addTo(map);
            mapSelectionBar.style.display = 'block';
        }

        const builtInFonts = {
            'Default': '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif',
            '思源宋体': '"Noto Serif SC", serif',
            '站酷快乐体': '"ZCOOL KuaiLe", cursive',
            '马善政毛笔': '"Ma Shan Zheng", cursive',
            '龙藏体': '"Long Cang", cursive',
            '植芒星手写': '"Zhi Mang Xing", cursive',
            '得意黑': '"Smiley Sans", sans-serif',
        };

        function renderFontSelection() {
            fontSelect.innerHTML = '';

            const builtInGroup = document.createElement('optgroup');
            builtInGroup.label = getLangText('built_in_group');
            for (const name in builtInFonts) {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                option.dataset.fontType = 'builtin';
                if (appData.settings.font?.type === 'google' && appData.settings.font?.name === name) {
                    option.selected = true;
                }
                builtInGroup.appendChild(option);
            }
            fontSelect.appendChild(builtInGroup);

            if (appData.settings.fontPresets.length > 0) {
                const presetGroup = document.createElement('optgroup');
                presetGroup.label = getLangText('my_presets');
                appData.settings.fontPresets.forEach(preset => {
                    const option = document.createElement('option');
                    option.value = preset.name;
                    option.textContent = preset.name;
                    option.dataset.fontType = 'preset';
                    if (appData.settings.font?.name === preset.name) {
                        option.selected = true;
                    }
                    presetGroup.appendChild(option);
                });
                fontSelect.appendChild(presetGroup);
            }
            
            fontUrlInput.value = '';
            tempFont = { type: null, data: null, name: null };
        }

        async function applyFont(fontSetting) {
            const root = document.documentElement;
            const styleId = 'custom-font-style';
            let styleElement = document.getElementById(styleId);
            if (styleElement) styleElement.remove();

            if (!fontSetting) {
                root.style.setProperty('--global-font-family', builtInFonts['Default']);
                return;
            }

            styleElement = document.createElement('style');
            styleElement.id = styleId;
            document.head.appendChild(styleElement);

            let finalCssFontFamily = '';

            if (fontSetting.type === 'google') {
                finalCssFontFamily = builtInFonts[fontSetting.name];
            } else if (fontSetting.type === 'url' || fontSetting.type === 'local') {
                const fontFamilyName = fontSetting.name;
                const src = fontSetting.type === 'url' ? `url("${fontSetting.url}")` : `url("${fontSetting.data}")`;
                styleElement.innerHTML = `@font-face { font-family: "${fontFamilyName}"; src: ${src}; }`;
                finalCssFontFamily = `"${fontFamilyName}", ${builtInFonts['Default']}`;
            }
            
            if (finalCssFontFamily) {
                root.style.setProperty('--global-font-family', finalCssFontFamily);
            }
        }

        function openCustomDateModal() {
            const now = new Date();
            const offset = now.getTimezoneOffset() * 60000;
            const localDate = new Date(now - offset);
            const localISOString = localDate.toISOString().slice(0, 16);

            const bodyHtml = `<input type="datetime-local" id="custom-date-input" value="${localISOString}">`;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;

            const saveHandler = () => {
                const dateValue = document.getElementById('custom-date-input').value;
                if (dateValue) {
                    quickDiaryData.customTimestamp = new Date(dateValue).getTime();
                    alert('日期已设置！');
                    closeModal();
                }
            };

            showModal(getLangText('set_custom_date'), bodyHtml, footerHtml, saveHandler);
        }

        function applyFormatToTextarea(format) {
            const textarea = quickDiaryTextarea;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            let replacement = selectedText;

            if (!selectedText) {
                alert("请先选中文本再应用格式");
                return;
            }

            switch (format) {
                case 'bold': replacement = `**${selectedText}**`; break;
                case 'italic': replacement = `*${selectedText}*`; break;
                case 'underline': replacement = `__${selectedText}__`; break;
                case 'strikethrough': replacement = `~~${selectedText}~~`; break;
                case 'link':
                    showPromptModal(getLangText('link_url'), getLangText('enter_link_url'), (url) => {
                        if (url) {
                            replacement = `[${selectedText}](${url})`;
                            textarea.setRangeText(replacement, start, end, 'end');
                        }
                    }, 'https://');
                    return;
            }

            textarea.setRangeText(replacement, start, end, 'end');
            textarea.focus();
        }

        async function exportData() {
            const dataToExport = { 
                profile: appData.profile, 
                diaries: appData.diaries, 
                notebooks: appData.notebooks, 
                settings: appData.settings,
                anniversaries: appData.anniversaries,
                transactions: appData.transactions,
                snippets: appData.snippets,
                snippetCollections: appData.snippetCollections
            };
            const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `platanus_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function importData() {
            showConfirmModal(getLangText('import_data'), getLangText('import_confirm'), () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = async (ev) => {
                        try {
                            const importedData = JSON.parse(ev.target.result);
                            await Promise.all([
                                dbActions.clear('profile'), dbActions.clear('diaries'), 
                                dbActions.clear('notebooks'), dbActions.clear('settings'),
                                dbActions.clear('anniversaries'), dbActions.clear('transactions'),
                                dbActions.clear('snippets'), dbActions.clear('snippetCollections')
                            ]);
                            
                            if(importedData.profile) await dbActions.set('profile', 'userProfile', importedData.profile);
                            if(importedData.diaries) for (const diary of importedData.diaries) await dbActions.put('diaries', diary);
                            if(importedData.notebooks) for (const notebook of importedData.notebooks) await dbActions.put('notebooks', notebook);
                            
                            if (importedData.settings) {
                                for (const key in importedData.settings) {
                                    await dbActions.set('settings', key, importedData.settings[key]);
                                }
                            }
                            
                            if(importedData.anniversaries) for (const item of importedData.anniversaries) await dbActions.put('anniversaries', item);
                            if(importedData.transactions) for (const item of importedData.transactions) await dbActions.put('transactions', item);
                            if(importedData.snippets) for (const item of importedData.snippets) await dbActions.put('snippets', item);
                            if(importedData.snippetCollections) for (const item of importedData.snippetCollections) await dbActions.put('snippetCollections', item);

                            alert(getLangText('import_success'));
                            await refreshAllDataAndRender();
                        } catch (err) {
                            alert('导入失败，文件格式错误！');
                            console.error(err);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            });
        }

        function openProfileEditModal() {
            pendingProfileImages = { avatar: null, background: null };
            const bodyHtml = `
                <p>${getLangText('profile_name')}: <input type="text" id="profile-name-input" value="${appData.profile.name || ''}"></p>
                <p>${getLangText('profile_id')}: <input type="text" id="profile-id-input" value="${appData.profile.id || ''}"></p>
                <p>${getLangText('profile_bio')}: <textarea id="profile-bio-input">${appData.profile.bio || ''}</textarea></p>
                <button class="button button-secondary" id="upload-avatar-btn" style="width:100%; margin: 5px 0;">${getLangText('upload_avatar')}</button>
                <button class="button button-secondary" id="upload-background-btn" style="width:100%; margin: 5px 0;">${getLangText('upload_background')}</button>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const newProfile = {
                    ...appData.profile,
                    name: document.getElementById('profile-name-input').value,
                    id: document.getElementById('profile-id-input').value,
                    bio: document.getElementById('profile-bio-input').value,
                    avatar: pendingProfileImages.avatar || appData.profile.avatar,
                    background: pendingProfileImages.background || appData.profile.background,
                };
                await dbActions.set('profile', 'userProfile', newProfile);
                appData.profile = newProfile;
                updateProfileUI();
                closeModal();
            };

            showModal(getLangText('edit_profile'), bodyHtml, footerHtml, saveHandler);

            document.getElementById('upload-avatar-btn').onclick = () => {
                triggerFileUpload('image/*', false, 1, (file) => {
                    pendingProfileImages.avatar = file.src;
                    alert('新头像已准备好，点击保存后生效。');
                });
            };
            document.getElementById('upload-background-btn').onclick = () => {
                triggerFileUpload('image/*', false, 1, (file) => {
                    pendingProfileImages.background = file.src;
                    alert('新背景已准备好，点击保存后生效。');
                });
            };
        }

        function openLanguageModal() {
            const languages = [
                { code: 'zh-CN', name: '简体中文' },
                { code: 'zh-TW', name: '繁體中文' },
                { code: 'en', name: 'English' },
                { code: 'ja', name: '日本語' },
                { code: 'ko', name: '한국어' },
            ];
            const langActions = languages.map(lang => ({
                text: lang.name,
                action: 'select-language',
                value: lang.code
            }));
            showActionMenuModal(getLangText('select_language'), langActions);
            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const item = e.target.closest('.menu-item[data-action="select-language"]');
                if (item) {
                    const langCode = item.dataset.value;
                    await setLanguage(langCode);
                    closeModal();
                    toggleSideMenu(false);
                }
            });
        }

        function openNotebookModal(notebookToEdit = null) {
            const isEditing = !!notebookToEdit;
            const title = isEditing ? getLangText('edit_notebook_name') : getLangText('new_notebook');
            const nameValue = isEditing ? notebookToEdit.name : '';
            
            showPromptModal(title, getLangText('notebook_name'), async (name) => {
                if (name) {
                    if (isEditing) {
                        notebookToEdit.name = name;
                        await dbActions.put('notebooks', notebookToEdit);
                    } else {
                        const newNotebook = { id: Date.now(), name: name, cover: '' };
                        await dbActions.put('notebooks', newNotebook);
                    }
                    await refreshAllDataAndRender();
                }
            }, '', 'text', nameValue);
        }

        function openNotebookMenu(notebook) {
            if (notebook.id === 1) {
                showActionMenuModal(notebook.name, [
                    { text: getLangText('change_notebook_cover'), action: 'change-notebook-cover', id: notebook.id }
                ]);
            } else {
                showActionMenuModal(notebook.name, [
                    { text: getLangText('edit_notebook_name'), action: 'edit-notebook', id: notebook.id },
                    { text: getLangText('change_notebook_cover'), action: 'change-notebook-cover', id: notebook.id },
                    { text: getLangText('delete'), action: 'delete-notebook', id: notebook.id }
                ]);
            }

            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                const id = Number(item.dataset.id);
                const nb = appData.notebooks.find(n => n.id === id);
                closeModal();

                switch (action) {
                    case 'edit-notebook':
                        openNotebookModal(nb);
                        break;
                    case 'change-notebook-cover':
                        openNotebookCoverMenu(nb);
                        break;
                    case 'delete-notebook':
                        showConfirmModal(getLangText('delete'), getLangText('confirm_delete'), async () => {
                            await dbActions.delete('notebooks', id);
                            await refreshAllDataAndRender();
                        });
                        break;
                }
            });
        }

        function openNotebookCoverMenu(notebook) {
            showActionMenuModal(getLangText('change_notebook_cover'), [
                { text: getLangText('enter_cover_url'), action: 'set-cover-url', id: notebook.id },
                { text: getLangText('upload_from_local'), action: 'upload-cover-local', id: notebook.id }
            ]);

            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                closeModal();

                if (action === 'set-cover-url') {
                    showPromptModal(getLangText('enter_cover_url'), '', async (url) => {
                        if (url) {
                            notebook.cover = url;
                            await dbActions.put('notebooks', notebook);
                            await refreshAllDataAndRender();
                        }
                    });
                } else if (action === 'upload-cover-local') {
                    triggerFileUpload('image/*', false, 1, async (file) => {
                        notebook.cover = file.src;
                        await dbActions.put('notebooks', notebook);
                        await refreshAllDataAndRender();
                    });
                }
            });
        }

        function openFontPresetMenu() {
            showActionMenuModal(getLangText('manage_presets'), [
                { text: getLangText('save_as_preset'), action: 'save-font-preset' },
                { text: getLangText('delete_preset'), action: 'delete-font-preset' }
            ]);
            modalContainer.querySelector('.modal-body').addEventListener('click', (e) => {
                const item = e.target.closest('.menu-item');
                if (!item) return;
                const action = item.dataset.action;
                closeModal();
                if (action === 'save-font-preset') {
                    saveFontPreset();
                } else if (action === 'delete-font-preset') {
                    openDeleteFontPresetModal();
                }
            });
        }

        function saveFontPreset() {
            const url = fontUrlInput.value.trim();
            let fontToSave = null;

            if (url) {
                fontToSave = { type: 'url', url: url };
            } else if (tempFont.type === 'local') {
                fontToSave = tempFont;
            }

            if (!fontToSave) {
                alert('没有可保存的字体。请输入网络字体URL或上传本地字体文件。');
                return;
            }

            showPromptModal(getLangText('save_as_preset'), getLangText('enter_preset_name'), async (name) => {
                if (name) {
                    fontToSave.name = name;
                    appData.settings.fontPresets.push(fontToSave);
                    await dbActions.set('settings', 'fontPresets', appData.settings.fontPresets);
                    alert(`预设 "${name}" 已保存！`);
                    renderFontSelection();
                    fontUrlInput.value = '';
                    tempFont = { type: null, data: null, name: null };
                }
            }, fontToSave.name || 'My Custom Font');
        }

        function openDeleteFontPresetModal() {
            if (appData.settings.fontPresets.length === 0) {
                alert(getLangText('no_presets_to_delete'));
                return;
            }
            const presetsHtml = appData.settings.fontPresets.map(p => `
                <div class="delete-preset-item">
                    <span>${p.name}</span>
                    <button data-preset-name="${p.name}"><i class="fas fa-trash-alt"></i></button>
                </div>
            `).join('');
            
            showModal(getLangText('delete_preset'), presetsHtml, `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button>`);

            modalContainer.querySelector('.modal-body').addEventListener('click', async (e) => {
                const button = e.target.closest('button[data-preset-name]');
                if (button) {
                    const presetName = button.dataset.presetName;
                    appData.settings.fontPresets = appData.settings.fontPresets.filter(p => p.name !== presetName);
                    await dbActions.set('settings', 'fontPresets', appData.settings.fontPresets);
                    alert(`预设 "${presetName}" 已删除。`);
                    closeModal();
                    renderFontSelection();
                }
            });
        }

        // =======================================================================
        // 9. 【新增/优化】新功能函数
        // =======================================================================

        function renderAnniversaryPage() {
            anniversaryListContainer.innerHTML = '';
            if (appData.anniversaries.length === 0) {
                anniversaryListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const sortedItems = [...appData.anniversaries].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return new Date(a.date) - new Date(b.date);
            });

            sortedItems.forEach(item => {
                const itemDate = new Date(item.date);
                itemDate.setHours(0, 0, 0, 0);
                const diffTime = Math.abs(today - itemDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let label, count;
                if (item.type === 'anniversary') {
                    label = getLangText('passed');
                    count = diffDays;
                } else { 
                    label = today > itemDate ? getLangText('passed') : getLangText('remaining');
                    count = diffDays;
                }

                const el = document.createElement('div');
                el.className = 'anniversary-item';
                el.classList.toggle('has-background', !!item.background);
                if (item.background) {
                    el.style.backgroundImage = `url(${item.background})`;
                }

                el.innerHTML = `
                    <div class="anniversary-item-overlay"></div>
                    ${item.isPinned ? `<i class="fas fa-thumbtack pinned-icon" title="${getLangText('pinned')}"></i>` : ''}
                    <div class="anniversary-info">
                        <div class="name">${item.name}</div>
                        <div class="date">${item.date}</div>
                    </div>
                    <div class="anniversary-days">
                        <div class="count">${count}</div>
                        <div class="label">${label} ${getLangText('days_unit')}</div>
                    </div>
                `;
                addLongPressListener(el, () => openAnniversaryMenu(item));
                anniversaryListContainer.appendChild(el);
            });
        }

        function openAddAnniversaryModal(itemToEdit = null) {
            const isEditing = !!itemToEdit;
            const title = isEditing ? getLangText('edit_anniversary') : getLangText('add_anniversary');
            const bodyHtml = `
                <p>${getLangText('anniversary_name')}:</p>
                <input type="text" id="anniversary-name-input" value="${isEditing ? itemToEdit.name : ''}">
                <p>${getLangText('anniversary_date')}:</p>
                <input type="date" id="anniversary-date-input" value="${isEditing ? itemToEdit.date : ''}">
                <p>${getLangText('anniversary_type')}:</p>
                <select id="anniversary-type-select">
                    <option value="anniversary" ${isEditing && itemToEdit.type === 'anniversary' ? 'selected' : ''}>${getLangText('anniversary')}</option>
                    <option value="target_day" ${isEditing && itemToEdit.type === 'target_day' ? 'selected' : ''}>${getLangText('target_day')}</option>
                </select>
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const name = document.getElementById('anniversary-name-input').value;
                const date = document.getElementById('anniversary-date-input').value;
                const type = document.getElementById('anniversary-type-select').value;
                if (!name || !date) {
                    alert('名称和日期不能为空！');
                    return;
                }
                if (isEditing) {
                    itemToEdit.name = name;
                    itemToEdit.date = date;
                    itemToEdit.type = type;
                    await dbActions.put('anniversaries', itemToEdit);
                } else {
                    await dbActions.add('anniversaries', { name, date, type, isPinned: false, background: null });
                }
                await refreshAllDataAndRender();
                renderAnniversaryPage();
                closeModal();
            };
            showModal(title, bodyHtml, footerHtml, saveHandler);
        }

        function openAnniversaryMenu(item) {
            const pinText = item.isPinned ? getLangText('unpin') : getLangText('pin');
            showActionMenuModal(item.name, [
                { text: getLangText('edit'), action: 'edit-anniversary', id: item.id },
                { text: pinText, action: 'toggle-pin-anniversary', id: item.id },
                { text: getLangText('change_background'), action: 'change-anniversary-bg', id: item.id },
                { text: getLangText('delete'), action: 'delete-anniversary', id: item.id }
            ]);
        }

        accountingControls.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('[data-view]');
            const navBtn = e.target.closest('[data-nav]');
            if (viewBtn) {
                accountingState.view = viewBtn.dataset.view;
                renderAccountingPage();
            }
            if (navBtn) {
                const direction = navBtn.dataset.nav === 'next' ? 1 : -1;
                const d = accountingState.date;
                if (accountingState.view === 'day') d.setDate(d.getDate() + direction);
                if (accountingState.view === 'month') d.setMonth(d.getMonth() + direction);
                if (accountingState.view === 'year') d.setFullYear(d.getFullYear() + direction);
                renderAccountingPage();
            }
        });

        function renderAccountingPage() {
            const { view, date } = accountingState;
            
            accountingControls.querySelectorAll('[data-view]').forEach(btn => btn.classList.remove('active'));
            accountingControls.querySelector(`[data-view="${view}"]`).classList.add('active');

            let start, end, periodLabel;
            const year = date.getFullYear();
            const month = date.getMonth();
            const day = date.getDate();

            if (view === 'day') {
                start = new Date(year, month, day);
                end = new Date(year, month, day + 1);
                periodLabel = date.toLocaleDateString(appData.settings.language.replace('_', '-'));
            } else if (view === 'month') {
                start = new Date(year, month, 1);
                end = new Date(year, month + 1, 1);
                periodLabel = `${year} ${getLangText('year')} ${month + 1}${getLangText('month')}`;
            } else { // year
                start = new Date(year, 0, 1);
                end = new Date(year + 1, 0, 1);
                periodLabel = `${year} ${getLangText('year')}`;
            }
            document.getElementById('accounting-current-period').textContent = periodLabel;

            const periodTransactions = appData.transactions.filter(t => t.timestamp >= start.getTime() && t.timestamp < end.getTime());

            let totalIncome = 0, totalExpense = 0;
            periodTransactions.forEach(t => {
                if (t.type === 'income') totalIncome += t.amount;
                else totalExpense += t.amount;
            });
            const balance = totalIncome - totalExpense;

            accountingSummaryContainer.innerHTML = `
                <div class="summary-card">
                    <div class="label">${getLangText('total_income')}</div>
                    <div class="amount income">+${totalIncome.toFixed(2)}</div>
                </div>
                <div class="summary-card">
                    <div class="label">${getLangText('total_expense')}</div>
                    <div class="amount expense">-${totalExpense.toFixed(2)}</div>
                </div>
                <div class="summary-card balance">
                    <div class="label">${getLangText('balance')}</div>
                    <div class="amount">${balance.toFixed(2)}</div>
                </div>
            `;

            transactionListContainer.innerHTML = '';
            if (periodTransactions.length === 0) {
                transactionListContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }

            const grouped = periodTransactions.reduce((acc, t) => {
                const dateStr = new Date(t.timestamp).toLocaleDateString(appData.settings.language.replace('_', '-'));
                if (!acc[dateStr]) acc[dateStr] = [];
                acc[dateStr].push(t);
                return acc;
            }, {});

            Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a)).forEach(dateStr => {
                const groupEl = document.createElement('div');
                groupEl.className = 'transaction-group';
                groupEl.innerHTML = `<div class="transaction-group-header">${dateStr}</div>`;
                
                grouped[dateStr].sort((a, b) => b.timestamp - a.timestamp).forEach(t => {
                    const el = document.createElement('div');
                    el.className = 'transaction-item';
                    const amountPrefix = t.type === 'income' ? '+' : '-';
                    el.innerHTML = `
                        <div class="transaction-info">
                            <div class="desc">${t.description}</div>
                            <div class="date">${new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
                        </div>
                        <div class="transaction-amount ${t.type}">${amountPrefix}${t.amount.toFixed(2)}</div>
                    `;
                    addLongPressListener(el, () => openTransactionMenu(t));
                    groupEl.appendChild(el);
                });
                transactionListContainer.appendChild(groupEl);
            });
        }

        function openAddTransactionModal(itemToEdit = null) {
            const isEditing = !!itemToEdit;
            const title = isEditing ? getLangText('edit_transaction') : getLangText('add_transaction');
            const bodyHtml = `
                <p>${getLangText('transaction_type')}:</p>
                <select id="transaction-type-select">
                    <option value="expense" ${isEditing && itemToEdit.type === 'expense' ? 'selected' : ''}>${getLangText('expense')}</option>
                    <option value="income" ${isEditing && itemToEdit.type === 'income' ? 'selected' : ''}>${getLangText('income')}</option>
                </select>
                <p>${getLangText('amount')}:</p>
                <input type="number" id="transaction-amount-input" placeholder="0.00" value="${isEditing ? itemToEdit.amount : ''}">
                <p>${getLangText('description')}:</p>
                <input type="text" id="transaction-desc-input" value="${isEditing ? itemToEdit.description : ''}">
            `;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const type = document.getElementById('transaction-type-select').value;
                const amount = parseFloat(document.getElementById('transaction-amount-input').value);
                const description = document.getElementById('transaction-desc-input').value;
                if (!description || isNaN(amount) || amount <= 0) {
                    alert('描述和有效的金额不能为空！');
                    return;
                }
                if (isEditing) {
                    itemToEdit.type = type;
                    itemToEdit.amount = amount;
                    itemToEdit.description = description;
                    await dbActions.put('transactions', itemToEdit);
                } else {
                    await dbActions.add('transactions', { type, amount, description, timestamp: Date.now() });
                }
                await refreshAllDataAndRender();
                renderAccountingPage();
                closeModal();
            };
            showModal(title, bodyHtml, footerHtml, saveHandler);
        }

        function openTransactionMenu(item) {
            showActionMenuModal(item.description, [
                { text: getLangText('edit'), action: 'edit-transaction', id: item.id },
                { text: getLangText('delete'), action: 'delete-transaction', id: item.id }
            ]);
        }

        function renderSnippetsPage() {
            snippetCollectionContainer.innerHTML = '';
            if (appData.snippetCollections.length === 0) {
                snippetCollectionContainer.innerHTML = `<p style="text-align: center; color: var(--secondary-text); margin-top: 50px;">${getLangText('no_items_yet')}</p>`;
                return;
            }

            const sortedCollections = [...appData.snippetCollections].sort((a, b) => {
                if (a.isPinned && !b.isPinned) return -1;
                if (!a.isPinned && b.isPinned) return 1;
                return (a.name || '').localeCompare(b.name || '');
            });

            sortedCollections.forEach(collection => {
                const collectionEl = document.createElement('div');
                collectionEl.className = 'snippet-collection';
                collectionEl.dataset.collectionId = collection.id;
                collectionEl.classList.toggle('has-background', !!collection.background);
                if (collection.background) {
                    collectionEl.style.backgroundImage = `url(${collection.background})`;
                }

                const collectionSnippets = appData.snippets
                    .filter(s => s.collectionId === collection.id)
                    .sort((a, b) => b.timestamp - a.timestamp);

                const snippetsHtml = collectionSnippets.map(snippet => `
                    <div class="snippet-item" data-snippet-id="${snippet.id}">
                        <input type="checkbox" class="snippet-delete-checkbox" data-snippet-id="${snippet.id}">
                        <div class="content">${formatRichText(snippet.content)}</div>
                        <div class="timestamp">${new Date(snippet.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');

                collectionEl.innerHTML = `
                    <div class="snippet-collection-overlay"></div>
                    <div class="snippet-collection-header" data-action="toggle-snippet-collection">
                        <h3>${collection.isPinned ? '<i class="fas fa-thumbtack" style="font-size: 0.8em; margin-right: 5px;"></i>' : ''}${collection.name}</h3>
                        <div class="actions">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="snippet-collection-manage-header">
                        <button class="button button-secondary" data-action="cancel-snippet-manage">${getLangText('cancel')}</button>
                        <button class="button button-danger" data-action="delete-selected-snippets">${getLangText('delete_selected')}</button>
                    </div>
                    <div class="snippet-collection-body">
                        ${snippetsHtml}
                        <div class="add-snippet-btn-container">
                            <button class="button button-primary" onclick="this.parentElement.innerHTML = document.getElementById('add-snippet-form-template').innerHTML.replace('__COLLECTION_ID__', ${collection.id})" style="width: 100%; margin: 0;">${getLangText('add_snippet')}</button>
                        </div>
                    </div>
                `;
                
                addLongPressListener(collectionEl.querySelector('.snippet-collection-header'), () => openSnippetCollectionMenu(collection));

                collectionEl.querySelectorAll('.snippet-item').forEach(itemEl => {
                    addLongPressListener(itemEl, () => {
                        if (collectionEl.classList.contains('manage-mode')) return;
                        const snippetId = Number(itemEl.dataset.snippetId);
                        const snippet = appData.snippets.find(s => s.id === snippetId);
                        openSnippetMenu(snippet);
                    });
                });

                snippetCollectionContainer.appendChild(collectionEl);
            });

            if (!document.getElementById('add-snippet-form-template')) {
                const template = document.createElement('template');
                template.id = 'add-snippet-form-template';
                template.innerHTML = `
                    <div class="add-snippet-form" data-collection-id="__COLLECTION_ID__">
                        <textarea placeholder="${getLangText('snippet_content')}..."></textarea>
                        <div class="add-snippet-form-actions">
                            <button class="button button-secondary" data-action="cancel-add-snippet">${getLangText('cancel')}</button>
                            <button class="button button-primary" data-action="save-snippet">${getLangText('save')}</button>
                        </div>
                    </div>
                `;
                body.appendChild(template);
            }
        }

        function openAddSnippetCollectionModal() {
            showPromptModal(getLangText('add_snippet_collection'), getLangText('collection_name'), async (name) => {
                if (name) {
                    await dbActions.add('snippetCollections', { name, isPinned: false, background: null });
                    await refreshAllDataAndRender();
                    renderSnippetsPage();
                }
            });
        }

        function openEditSnippetModal(snippet) {
            const bodyHtml = `<textarea id="snippet-content-input">${snippet.content}</textarea>`;
            const footerHtml = `<button class="button button-secondary" id="modal-cancel">${getLangText('cancel')}</button><button class="button button-primary" id="modal-save">${getLangText('save')}</button>`;
            
            const saveHandler = async () => {
                const content = document.getElementById('snippet-content-input').value;
                if (!content.trim()) {
                    alert('内容不能为空！');
                    return;
                }
                snippet.content = content;
                await dbActions.put('snippets', snippet);
                await refreshAllDataAndRender();
                renderSnippetsPage();
                const collectionEl = snippetCollectionContainer.querySelector(`.snippet-collection[data-collection-id="${snippet.collectionId}"]`);
                if (collectionEl) collectionEl.classList.add('expanded');
                closeModal();
            };
            showModal(getLangText('edit_snippet'), bodyHtml, footerHtml, saveHandler);
        }

        function openSnippetMenu(snippet) {
            showActionMenuModal('操作', [
                { text: getLangText('edit'), action: 'edit-snippet', id: snippet.id },
                { text: getLangText('delete'), action: 'delete-snippet', id: snippet.id }
            ]);
        }

        function openSnippetCollectionMenu(collection) {
            const pinText = collection.isPinned ? getLangText('unpin') : getLangText('pin');
            showActionMenuModal(collection.name, [
                { text: pinText, action: 'toggle-pin-snippet-collection', id: collection.id },
                { text: getLangText('change_background'), action: 'change-snippet-collection-bg', id: collection.id },
                { text: getLangText('manage_snippets'), action: 'manage-snippets', id: collection.id },
                { text: getLangText('delete'), action: 'delete-snippet-collection', id: collection.id }
            ]);
        }

        async function togglePinItem(storeName, id, renderFunc) {
            closeModal();
            const items = appData[storeName];
            const item = items.find(i => i.id === id);
            if (!item) return;
            
            const isCurrentlyPinned = item.isPinned;
            items.forEach(i => i.isPinned = false);
            if (!isCurrentlyPinned) {
                item.isPinned = true;
            }
            
            for (const i of items) {
                await dbActions.put(storeName, i);
            }
            
            await refreshAllDataAndRender();
            if (renderFunc) renderFunc();
        }

        async function changeItemBackground(storeName, id, renderFunc) {
            closeModal();
            const item = appData[storeName].find(i => i.id === id);
            if (!item) return;

            triggerFileUpload('image/*', false, 1, async (file) => {
                item.background = file.src;
                await dbActions.put(storeName, item);
                await refreshAllDataAndRender();
                if (renderFunc) renderFunc();
            });
        }

        // =======================================================================
        // 10. 初始化
        // 中文注释：这是应用的入口，当页面加载完成后，这个函数会被调用，开始执行整个应用的逻辑。
        // =======================================================================
        async function initializeApp() {
            try {
                document.querySelector('.send-btn').addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    sendQuickDiary();
                });
                
                // 中文注释：检查是否是第一次使用，如果是，就创建一些默认数据。
                const profile = await dbActions.get('profile', 'userProfile');
                if (!profile) {
                    await dbActions.set('profile', 'userProfile', { name: '新用户', id: 'yun000812', bio: '这个人很懒...', avatar: '', background: '' });
                    await dbActions.set('settings', 'language', 'zh-CN');
                    await dbActions.set('settings', 'darkMode', false);
                    await dbActions.set('settings', 'theme', {});
                    await dbActions.set('settings', 'font', null);
                    await dbActions.set('settings', 'showLunarCalendar', false);
                    await dbActions.set('settings', 'showHolidays', false);
                    await dbActions.set('settings', 'fontPresets', []);
                }
                const defaultNotebook = await dbActions.get('notebooks', 1);
                if (!defaultNotebook) {
                    await dbActions.put('notebooks', { id: 1, name: '默认日记本', cover: '' });
                }

                await refreshAllDataAndRender();
                showPage('diary-page');
            } catch (error) {
                console.error("初始化失败:", error);
                document.body.innerHTML = `<h1>应用初始化失败</h1><p>请尝试清除浏览器缓存后重试。</p><pre>${error.stack}</pre>`;
            }
        }

        initializeApp();
    });
</script>
</html>